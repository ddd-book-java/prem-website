<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="Premanand Chandrasekaran, Karthik Krishnan">
<title>Domain-Driven Design with Java&#8201;&#8212;&#8201;A Practitioner&#8217;s Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Domain-Driven Design with Java&#8201;&#8212;&#8201;A Practitioner&#8217;s Guide</h1>
<div class="details">
<span id="author" class="author">Premanand Chandrasekaran</span><br>
<span id="email" class="email"><a href="mailto:premanandc@acm.org">premanandc@acm.org</a></span><br>
<span id="author2" class="author">Karthik Krishnan</span><br>
<span id="email2" class="email"><a href="mailto:me@karthiks.in">me@karthiks.in</a></span><br>
<span id="revnumber">version 1.0.0-SNAPSHOT,</span>
<span id="revdate">May 15 2022 11:05 PM UTC</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface">Preface</a>
<ul class="sectlevel2">
<li><a href="#who-this-book-is-for">Who This Book Is For</a></li>
<li><a href="#what-you-will-learn">What You Will Learn</a></li>
<li><a href="#acknowledgements">Acknowledgements</a></li>
</ul>
</li>
<li><a href="#part-1-foundations">Part 1: Foundations</a>
<ul class="sectlevel1">
<li><a href="#_the_rationale_for_domain_driven_design">1. The Rationale for Domain-Driven Design</a>
<ul class="sectlevel2">
<li><a href="#introduction">1.1. Introduction</a></li>
<li><a href="#why-do-software-projects-fail">1.2. Why do software projects fail?</a>
<ul class="sectlevel3">
<li><a href="#inaccurate-requirements">1.2.1. Inaccurate requirements</a></li>
<li><a href="#too-much-architecture">1.2.2. Too much architecture</a></li>
<li><a href="#too-little-architecture">1.2.3. Too little architecture</a></li>
<li><a href="#excessive-incidental-complexity">1.2.4. Excessive incidental complexity</a></li>
<li><a href="#uncontrolled-technical-debt">1.2.5. Uncontrolled technical debt</a></li>
<li><a href="#_ignoring_non_functional_requirements">1.2.6. Ignoring Non-Functional Requirements (NFRs)</a></li>
</ul>
</li>
<li><a href="#modern-systems-and-dealing-with-complexity">1.3. Modern systems and dealing with complexity</a>
<ul class="sectlevel3">
<li><a href="#how-software-gets-built">1.3.1. How software gets built</a></li>
<li><a href="#complexity-is-inevitable">1.3.2. Complexity is inevitable</a></li>
<li><a href="#optimizing-the-feedback-loop">1.3.3. Optimizing the feedback loop</a></li>
</ul>
</li>
<li><a href="#what-is-domain-driven-design">1.4. What is Domain-Driven Design?</a>
<ul class="sectlevel3">
<li><a href="#understanding-the-problem-using-strategic-design">1.4.1. Understanding the problem using strategic design</a></li>
<li><a href="#implementing-the-solution-using-tactical-design">1.4.2. Implementing the solution using tactical design</a></li>
</ul>
</li>
<li><a href="#why-is-ddd-relevant-why-now">1.5. Why is DDD Relevant? Why Now?</a>
<ul class="sectlevel3">
<li><a href="#rise-of-open-source">1.5.1. Rise of Open Source</a></li>
<li><a href="#advances-in-technology">1.5.2. Advances in Technology</a></li>
<li><a href="#rise-of-distributed-computing">1.5.3. Rise of Distributed Computing</a></li>
</ul>
</li>
<li><a href="#summary">1.6. Summary</a></li>
<li><a href="#questions">1.7. Questions</a></li>
<li><a href="#further-reading">1.8. Further Reading</a></li>
</ul>
</li>
<li><a href="#_where_does_ddd_fit">2. Where and How Does DDD Fit?</a>
<ul class="sectlevel2">
<li><a href="#architecture-styles">2.1. Architecture Styles</a>
<ul class="sectlevel3">
<li><a href="#layered-architecture">2.1.1. Layered Architecture</a></li>
<li><a href="#_vertical_slice_architecture">2.1.2. Vertical slice architecture</a></li>
<li><a href="#service-oriented-architecture-soa">2.1.3. Service Oriented Architecture (SOA)</a></li>
<li><a href="#microservices-architecture">2.1.4. Microservices architecture</a></li>
<li><a href="#event-driven-architecture-eda">2.1.5. Event-Driven Architecture (EDA)</a></li>
<li><a href="#_cqrs_pattern">2.1.6. Command Query Responsibility Segregation (CQRS)</a></li>
<li><a href="#_serverless_architecture">2.1.7. Serverless Architecture</a></li>
<li><a href="#_big_ball_of_mud">2.1.8. Big ball of mud</a></li>
<li><a href="#which-architecture-style-should-you-use">2.1.9. Which architecture style should you use?</a></li>
</ul>
</li>
<li><a href="#programming-paradigms">2.2. Programming paradigms</a>
<ul class="sectlevel3">
<li><a href="#object-oriented-programming">2.2.1. Object-oriented programming</a></li>
<li><a href="#functional-programming">2.2.2. Functional programming</a></li>
<li><a href="#which-paradigm-should-you-choose">2.2.3. Which paradigm should you choose?</a></li>
</ul>
</li>
<li><a href="#summary-2">2.3. Summary</a></li>
<li><a href="#questions-2">2.4. Questions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#part-2-implementing-ddd-in-the-real-world">Part 2: Implementing DDD in the real world</a>
<ul class="sectlevel1">
<li><a href="#understanding-the-domain">3. Understanding the Domain</a>
<ul class="sectlevel2">
<li><a href="#introduction-2">3.1. Introduction</a></li>
<li><a href="#the-domain-of-international-trade">3.2. The domain of international trade</a></li>
<li><a href="#international-trade-at-kp-bank">3.3. International trade at KP Bank</a></li>
<li><a href="#understanding-international-trade-strategy-at-kp-bank">3.4. Understanding international trade strategy at KP Bank</a>
<ul class="sectlevel3">
<li><a href="#business-model-canvas">3.4.1. Business model canvas</a></li>
<li><a href="#lean-canvas">3.4.2. Lean canvas</a></li>
<li><a href="#impact-maps">3.4.3. Impact maps</a></li>
<li><a href="#wardley-maps">3.4.4. Wardley maps</a></li>
</ul>
</li>
<li><a href="#international-trade-products-and-services">3.5. International trade products and services</a></li>
<li><a href="#summary-3">3.6. Summary</a></li>
<li><a href="#further-reading-2">3.7. Further reading</a></li>
</ul>
</li>
<li><a href="#_domain_analysis_and_modeling">4. Domain analysis and modeling</a>
<ul class="sectlevel2">
<li><a href="#introduction-3">4.1. Introduction</a></li>
<li><a href="#technical-requirements">4.2. Technical requirements</a>
<ul class="sectlevel3">
<li><a href="#understanding-letter-of-credit-lc">4.2.1. Understanding Letter of Credit (LC)</a></li>
</ul>
</li>
<li><a href="#the-lc-issuance-application">4.3. The LC issuance application</a></li>
<li><a href="#enhancing-shared-understanding">4.4. Enhancing shared understanding</a></li>
<li><a href="#domain-storytelling">4.5. Domain storytelling</a>
<ul class="sectlevel3">
<li><a href="#_introducing_domain_storytelling">4.5.1. Introducing Domain Storytelling</a></li>
<li><a href="#using-dst-for-the-lc-application">4.5.2. Using DST for the LC application</a></li>
</ul>
</li>
<li><a href="#eventstorming">4.6. EventStorming</a>
<ul class="sectlevel3">
<li><a href="#_introducing_eventstorming">4.6.1. Introducing EventStorming</a></li>
<li><a href="#using-eventstorming-for-the-lc-issuance-application">4.6.2. Using eventStorming for the LC issuance application</a></li>
</ul>
</li>
<li><a href="#summary-4">4.7. Summary</a></li>
<li><a href="#questions-3">4.8. Questions</a></li>
<li><a href="#further-reading-3">4.9. Further reading</a></li>
<li><a href="#answers">4.10. Answers</a></li>
</ul>
</li>
<li><a href="#_implementing_domain_logic">5. Implementing Domain Logic</a>
<ul class="sectlevel2">
<li><a href="#technical-requirements-2">5.1. Technical requirements</a></li>
<li><a href="#continuing-our-design-journey">5.2. Continuing our design journey</a></li>
<li><a href="#_implementing_the_command_side">5.3. Implementing the command side</a>
<ul class="sectlevel3">
<li><a href="#tooling-choices">5.3.1. Tooling choices</a></li>
<li><a href="#_bootstapping_the_application">5.3.2. Bootstrapping the application</a></li>
<li><a href="#identifying-commands">5.3.3. Identifying commands</a></li>
<li><a href="#_identifying_aggregates">5.3.4. Identifying aggregates</a></li>
<li><a href="#discovering-bounded-contexts">5.3.5. Discovering bounded contexts</a></li>
<li><a href="#correlating-aggregates-to-bounded-contexts">5.3.6. Correlating aggregates to bounded contexts</a></li>
<li><a href="#test-driving-the-system">5.3.7. Test-driving the system</a></li>
<li><a href="#implementing-the-command">5.3.8. Implementing the command</a></li>
<li><a href="#_implementing_the_event">5.3.9. Implementing the event</a></li>
<li><a href="#designing-the-aggregate">5.3.10. Designing the aggregate</a></li>
</ul>
</li>
<li><a href="#_persisting_aggregates">5.4. Persisting aggregates</a>
<ul class="sectlevel3">
<li><a href="#_state_stored_aggregates">5.4.1. State stored aggregates</a></li>
<li><a href="#_event_sourced_aggregates">5.4.2. Event sourced aggregates</a></li>
<li><a href="#persistence-technology-choices">5.4.3. Persistence technology choices</a></li>
<li><a href="#which-persistence-mechanism-should-we-choose">5.4.4. Which persistence mechanism should we choose?</a></li>
</ul>
</li>
<li><a href="#enforcing-policies">5.5. Enforcing policies</a>
<ul class="sectlevel3">
<li><a href="#structural-validations">5.5.1. Structural validations</a></li>
<li><a href="#business-rule-enforcements">5.5.2. Business rule enforcements</a></li>
</ul>
</li>
<li><a href="#summary-5">5.6. Summary</a></li>
<li><a href="#questions-4">5.7. Questions</a></li>
<li><a href="#further-reading-4">5.8. Further reading</a></li>
<li><a href="#answers-2">5.9. Answers</a></li>
</ul>
</li>
<li><a href="#implementing-the-user-interfacetask-based">6. Implementing the User Interface&#8201;&#8212;&#8201;Task-based</a>
<ul class="sectlevel2">
<li><a href="#technical-requirements-3">6.1. Technical requirements</a></li>
<li><a href="#api-styles">6.2. API Styles</a>
<ul class="sectlevel3">
<li><a href="#crud-based-apis">6.2.1. CRUD-based APIs</a></li>
<li><a href="#task-based-apis">6.2.2. Task-based APIs</a></li>
<li><a href="#task-based-or-crud-based">6.2.3. Task-based or CRUD-based?</a></li>
</ul>
</li>
<li><a href="#bootstrapping-the-ui">6.3. Bootstrapping the UI</a></li>
<li><a href="#implementing-the-ui">6.4. Implementing the UI</a>
<ul class="sectlevel3">
<li><a href="#model-view-view-model-mvvm-primer">6.4.1. Model View View-Model (MVVM) primer</a></li>
<li><a href="#creating-a-new-lc">6.4.2. Creating a new LC</a></li>
</ul>
</li>
<li><a href="#summary-6">6.5. Summary</a></li>
<li><a href="#questions-5">6.6. Questions</a></li>
<li><a href="#further-reading-5">6.7. Further reading</a></li>
</ul>
</li>
<li><a href="#implementing-queries">7. Implementing Queries</a>
<ul class="sectlevel2">
<li><a href="#technical-requirements-4">7.1. Technical requirements</a></li>
<li><a href="#continuing-our-design-journey-2">7.2. Continuing our design journey</a></li>
<li><a href="#implementing-the-query-side">7.3. Implementing the query side</a>
<ul class="sectlevel3">
<li><a href="#tooling-choices-2">7.3.1. Tooling choices</a></li>
<li><a href="#identifying-queries">7.3.2. Identifying queries</a></li>
<li><a href="#_creating_the_query_model">7.3.3. Creating the query model</a></li>
<li><a href="#query-side-persistence-choices">7.3.4. Query side persistence choices</a></li>
<li><a href="#exposing-a-query-api">7.3.5. Exposing a query API</a></li>
<li><a href="#advanced-query-scenarios">7.3.6. Advanced query scenarios</a></li>
</ul>
</li>
<li><a href="#_historic_event_replays">7.4. Historic event replays</a>
<ul class="sectlevel3">
<li><a href="#types-of-replays">7.4.1. Types of replays</a></li>
<li><a href="#event-replay-considerations">7.4.2. Event replay considerations</a></li>
<li><a href="#event-design">7.4.3. Event design</a></li>
<li><a href="#event-handlers-with-side-effects">7.4.4. Event handlers with side effects</a></li>
</ul>
</li>
<li><a href="#summary-7">7.5. Summary</a></li>
<li><a href="#questions-6">7.6. Questions</a></li>
</ul>
</li>
<li><a href="#long-running-workflows">8. Long-Running Workflows</a>
<ul class="sectlevel2">
<li><a href="#technical-requirements-5">8.1. Technical requirements</a></li>
<li><a href="#continuing-our-design-journey-3">8.2. Continuing our design journey</a></li>
<li><a href="#implementing-sagas">8.3. Implementing sagas</a>
<ul class="sectlevel3">
<li><a href="#orchestration">8.3.1. Orchestration</a></li>
<li><a href="#choreography">8.3.2. Choreography</a></li>
</ul>
</li>
<li><a href="#handling-deadlines">8.4. Handling deadlines</a></li>
<li><a href="#summary-8">8.5. Summary</a></li>
<li><a href="#questions-7">8.6. Questions</a></li>
<li><a href="#further-reading-6">8.7. Further reading</a></li>
</ul>
</li>
<li><a href="#_integrating_with_external_systems">9. Integrating with External Systems</a>
<ul class="sectlevel2">
<li><a href="#continuing-our-design-journey-4">9.1. Continuing our design journey</a></li>
<li><a href="#bounded-context-relationships">9.2. Bounded context relationships</a>
<ul class="sectlevel3">
<li><a href="#symmetric-relationship-patterns">9.2.1. Symmetric relationship patterns</a></li>
<li><a href="#asymmetric-relationship-patterns">9.2.2. Asymmetric relationship patterns</a></li>
</ul>
</li>
<li><a href="#implementation-patterns">9.3. Implementation patterns</a>
<ul class="sectlevel3">
<li><a href="#data-based">9.3.1. Data-based</a></li>
<li><a href="#code-based">9.3.2. Code-based</a></li>
<li><a href="#ipc-based">9.3.3. IPC-based</a></li>
</ul>
</li>
<li><a href="#summary-9">9.4. Summary</a></li>
<li><a href="#questions-8">9.5. Questions</a></li>
<li><a href="#further-reading-7">9.6. Further reading</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#part-3-advanced-patterns">Part 3: Advanced Patterns</a>
<ul class="sectlevel1">
<li><a href="#distributing-into-remote-components">10. Distributing into remote components</a>
<ul class="sectlevel2">
<li><a href="#continuing-our-design-journey-5">10.1. Continuing our design journey</a></li>
<li><a href="#decomposing-our-monolith">10.2. Decomposing our monolith</a>
<ul class="sectlevel3">
<li><a href="#changes-for-frontend-interactions">10.2.1. Changes for frontend interactions</a></li>
<li><a href="#changes-for-event-interactions">10.2.2. Changes for event interactions</a></li>
<li><a href="#_changes_for_database_interactions">10.2.3. Changes for database interactions</a></li>
</ul>
</li>
<li><a href="#summary-10">10.3. Summary</a></li>
</ul>
</li>
<li><a href="#decomposing-into-finer-grained-components">11. Decomposing into finer grained components</a>
<ul class="sectlevel2">
<li><a href="#continuing-our-design-journey-6">11.1. Continuing our design journey</a>
<ul class="sectlevel3">
<li><a href="#saga-as-standalone-component">11.1.1. Saga as standalone component</a></li>
<li><a href="#commands-and-queries-as-standalone-components">11.1.2. Commands and queries as standalone components</a></li>
<li><a href="#distributing-individual-query-components">11.1.3. Distributing individual query components</a></li>
</ul>
</li>
<li><a href="#even-more-fine-grained-distribution">11.2. Even more fine-grained distribution</a>
<ul class="sectlevel3">
<li><a href="#effects-on-the-domain-model">11.2.1. Effects on the domain model</a></li>
</ul>
</li>
<li><a href="#decomposing-the-frontend">11.3. Decomposing the frontend</a></li>
<li><a href="#where-to-draw-the-line">11.4. Where to draw the line?</a></li>
<li><a href="#summary-11">11.5. Summary</a></li>
<li><a href="#further-reading-8">11.6. Further reading</a></li>
</ul>
</li>
<li><a href="#non-functional-requirements-25-pages">12. Non-Functional Requirements (25 pages)</a>
<ul class="sectlevel2">
<li><a href="#dealing-with-eventual-consistency">12.1. Dealing With Eventual Consistency</a></li>
<li><a href="#scaling-the-event-store-with-snapshots">12.2. Scaling the Event Store with Snapshots</a></li>
<li><a href="#event-versioning-and-upcasting">12.3. Event Versioning and Upcasting</a></li>
<li><a href="#monitoring-metrics-and-tracing">12.4. Monitoring, Metrics and Tracing</a></li>
<li><a href="#enhancing-performance">12.5. Enhancing Performance</a>
<ul class="sectlevel3">
<li><a href="#scaling-the-event-bus">12.5.1. Scaling the event bus</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface"><a class="anchor" href="#preface"></a><a class="link" href="#preface">Preface</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Domain-Driven Design makes available a set of techniques and patterns that non-technical experts, architects and developers to work together and decompose complex systems into well-factored, collaborating, loosely coupled subsystems.
Write more here&#8230;&#8203; TODO.</p>
</div>
<div class="sect2">
<h3 id="who-this-book-is-for"><a class="anchor" href="#who-this-book-is-for"></a><a class="link" href="#who-this-book-is-for">Who This Book Is For</a></h3>
<div class="paragraph">
<p>Developers working with Domain-Driven Design will be able to put their knowledge to work with this practical guide to create elegant software designs that are pleasant to work with and easy to work with and reason about. The book provides a hands-on approach to implementation and associated methodologies that will have you up-and-running, and productive in no time.</p>
</div>
</div>
<div class="sect2">
<h3 id="what-you-will-learn"><a class="anchor" href="#what-you-will-learn"></a><a class="link" href="#what-you-will-learn">What You Will Learn</a></h3>
<div class="paragraph">
<p>By the end of this book, you will be able to architect, design and implement robust, modern and loosely coupled distributed architectures employing domain-driven design.</p>
</div>
</div>
<div class="sect2">
<h3 id="acknowledgements"><a class="anchor" href="#acknowledgements"></a><a class="link" href="#acknowledgements">Acknowledgements</a></h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>
<h1 id="part-1-foundations" class="sect0"><a class="anchor" href="#part-1-foundations"></a><a class="link" href="#part-1-foundations">Part 1: Foundations</a></h1>
<div class="openblock partintro">
<div class="content">
    While the IT industry prides itself on being at the very bleeding edge of technology, it also oversees a relatively high proportion of projects that fail outright or do not meet their originally intended goals for one reason or another. In Part 1, we will look at reasons for software projects not achieving their intended objectives and how practising Domain-Driven Design (DDD) can significantly help improve the odds of achieving success. We will also do a quick tour of the main concepts that Eric Evans elaborated in his seminal book by the same name and examine why/how it is extremely relevant in today&#8217;s distributed systems age.
</div>
</div>
<div class="sect1 text-justify">
<h2 id="_the_rationale_for_domain_driven_design"><a class="anchor" href="#_the_rationale_for_domain_driven_design"></a><a class="link" href="#_the_rationale_for_domain_driven_design">1. The Rationale for Domain-Driven Design</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The being cannot be termed rational or virtuous, who obeys any authority, but that of reason.
</blockquote>
<div class="attribution">
&#8212; Mary Wollstonecraft
</div>
</div>
<div class="sect2">
<h3 id="introduction"><a class="anchor" href="#introduction"></a><a class="link" href="#introduction">1.1. Introduction</a></h3>
<div class="paragraph">
<p>According to the Project Management Institute&#8217;s (PMI) <a href="https://www.pmi.org/learning/library/forging-future-focused-culture-11908"><em>Pulse of the Profession</em></a> report published in February 2020, only <strong>77%</strong> of all projects meet their intended goals&#8201;&#8212;&#8201;and even this is true only in the most mature organizations.For less mature organizations, this number falls to just <strong>56%</strong> i.e. approximately one in every two projects does not meet its intended goals.Furthermore, approximately one in every five projects is declared an outright failure.At the same time, we also seem to be embarking on our most ambitious and complex projects.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will examine the main causes for project failure and look at how applying domain-driven design provides a set of guidelines and techniques to improve the odds of success in our favor.While Eric Evans wrote his classic book on the subject way back in 2003, we look at why that work is still extremely relevant in today&#8217;s times.</p>
</div>
</div>
<div class="sect2">
<h3 id="why-do-software-projects-fail"><a class="anchor" href="#why-do-software-projects-fail"></a><a class="link" href="#why-do-software-projects-fail">1.2. Why do software projects fail?</a></h3>
<div class="quoteblock">
<blockquote>
Failure is simply the opportunity to begin again, this time more intelligently.
</blockquote>
<div class="attribution">
&#8212; Henry Ford
</div>
</div>
<div class="paragraph">
<p>According to the <a href="https://www.pmi.org/learning/library/project-success-definitions-measurement-techniques-5460">project success report</a> published in the Project Management Journal of the PMI, the following six factors need to be true for a project to be deemed successful:</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Project Success Factors</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Category</th>
<th class="tableblock halign-left valign-top">Criterion</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">Project</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It meets the desired time schedules</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Its cost does not exceed budget</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Performance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">It works as intended</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Its intended clients use it</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Satisfaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Its intended clients are happy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Effectiveness</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Its intended clients derive direct benefits through its implementation</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>With all of these criteria being applied to assess project success, a large percentage of projects fail for one reason or another. Let&#8217;s examine some of the top reasons in more detail:</p>
</div>
<div class="sect3">
<h4 id="inaccurate-requirements"><a class="anchor" href="#inaccurate-requirements"></a><a class="link" href="#inaccurate-requirements">1.2.1. Inaccurate requirements</a></h4>
<div class="paragraph">
<p>PMI&#8217;s <em>Pulse of the Profession</em> report from 2017 highlights a very starking fact&#8201;&#8212;&#8201;a vast majority of projects fail due to inaccurate or misinterpreted requirements. It follows that it is impossible to build something that clients can use, are happy with and makes them more effective at their jobs if the wrong thing gets built&#8201;&#8212;&#8201;even much less for the project to be built on time, and under budget.</p>
</div>
<div class="paragraph">
<p>IT teams, especially in large organizations are staffed with mono-skilled roles such as UX designer, developer, tester, architect, business analyst, project manager, product owner, business sponsor, etc. In a lot of cases, these people are parts of distinct organization units/departments&#8201;&#8212;&#8201;each with its own set of priorities and motivations. To make matters even worse, the geographical separation between these people only keeps increasing. The need to keep costs down and the current COVID-19 ecosystem does not help matters either.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/silo-mentality.png" alt="silo mentality">
</div>
<div class="title">Figure 1- 1. Silo mentality and the loss of information fidelity</div>
</div>
<div class="paragraph">
<p>All this results in a loss in fidelity of information at every stage in the <em>assembly line</em>, which then results in misconceptions, inaccuracies, delays and eventually failure!</p>
</div>
</div>
<div class="sect3">
<h4 id="too-much-architecture"><a class="anchor" href="#too-much-architecture"></a><a class="link" href="#too-much-architecture">1.2.2. Too much architecture</a></h4>
<div class="paragraph">
<p>Writing complex software is quite a task. One cannot just hope to sit down and start typing code&#8201;&#8212;&#8201;although that approach might work in some trivial cases. Before translating business ideas into working software, a thorough understanding of the problem at hand is necessary. For example, it is not possible (or at least extremely hard) to build credit card software without understanding how credit cards work in the first place. To communicate one&#8217;s understanding of a problem, it is not uncommon to create software models of the problem, before writing code. This model or collection of models represents the understanding of the problem and the architecture of the solution.</p>
</div>
<div class="paragraph">
<p>Efforts to create a perfect model of the problem&#8201;&#8212;&#8201;one that is accurate in a very broad context, are not dissimilar to the proverbial holy grail quest. Those accountable to produce the architecture can get stuck in <a href="https://proxy.c2.com/cgi/wiki?AnalysisParalysis">analysis paralysis</a> and/or <a href="https://wiki.c2.com/?BigDesignUpFront">big design up front</a>, producing artifacts that are one or more of too high level, wishful, gold-plated, buzzword-driven, disconnected from the real world&#8201;&#8212;&#8201;while not solving any real business problems. This kind of <em>lock-in</em> can be especially detrimental during the early phases of the project when knowledge levels of team members are still up and coming. Needless to say, projects adopting such approaches find it hard to meet with success consistently.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For a more comprehensive list of <a href="http://agilemodeling.com/essays/enterpriseModelingAntiPatterns.htm">modeling anti-patterns</a>, refer to Scott W. Ambler&#8217;s <a href="http://agilemodeling.com">website</a> (<a href="http://agilemodeling.com" class="bare">http://agilemodeling.com</a>) and <a href="https://www.amazon.com/Agile-Modeling-Effective-Practices-Programming/dp/0471202827">book</a> dedicated to the subject.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="too-little-architecture"><a class="anchor" href="#too-little-architecture"></a><a class="link" href="#too-little-architecture">1.2.3. Too little architecture</a></h4>
<div class="paragraph">
<p>Agile software delivery methods manifested themselves in the late 90s, early 2000s in response to heavyweight processes collectively known as <em>waterfall</em>. These processes seemed to favor <a href="https://en.wikipedia.org/wiki/Big_Design_Up_Front">big design up front</a> and abstract ivory tower thinking based on wishful, ideal world scenarios. This was based on the premise that thinking things out well in advance ends up saving serious development headaches later on as the project progresses.</p>
</div>
<div class="paragraph">
<p>In contrast, agile methods seem to favor a much more nimble and iterative approach to software development with a high focus on working software over other artifacts such as documentation. Most teams these days claim to practice some form of iterative software development. However, this obsession to claim conformance to a specific family of <a href="https://thedigitalprojectmanager.com/agile-methodologies">agile methodologies</a> as opposed to the underlying principles, a lot of teams misconstrue having just enough architecture with having no perceptible architecture. This results in a situation where adding new features or enhancing existing ones takes a lot longer than what it previously used to&#8201;&#8212;&#8201;which then accelerates the devolution of the solution to become the dreaded <a href="http://www.laputan.org/mud/mud.html#BigBallOfMud">big ball of mud</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="excessive-incidental-complexity"><a class="anchor" href="#excessive-incidental-complexity"></a><a class="link" href="#excessive-incidental-complexity">1.2.4. Excessive incidental complexity</a></h4>
<div class="paragraph">
<p>Mike Cohn popularized the notion of the <a href="https://www.mountaingoatsoftware.com/blog/the-forgotten-layer-of-the-test-automation-pyramid">test pyramid</a> where he talks about how a large number of unit tests should form the foundation of a sound testing strategy&#8201;&#8212;&#8201;with numbers decreasing significantly as one moves up the pyramid. The rationale here is that as one moves up the pyramid, the cost of upkeep goes up copiously while speed of execution slows down manifold. In reality though, a lot of teams seem to adopt a strategy that is the exact opposite of this&#8201;&#8212;&#8201;known as the testing ice cream cone as depicted below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/test-pyramid-reality.png" alt="test pyramid reality">
</div>
<div class="title">Figure 1- 2. Testing Strategy: Expectation vs. Reality</div>
</div>
<div class="paragraph">
<p>The testing ice cream cone is a classic case of what Fred Brooks calls incidental complexity in his seminal paper titled <a href="http://faculty.salisbury.edu/~xswang/Research/Papers/SERelated/no-silver-bullet.pdf">No Silver Bullet&#8201;&#8212;&#8201;Essence and Accident in Software Engineering</a>. All software has some amount of <a href="https://en.wikipedia.org/wiki/Essential_complexity">essential complexity</a> that is inherent to the problem being solved. This is especially true when creating solutions for non-trivial problems.  However, incidental or accidental complexity is not directly attributable to the problem itself&#8201;&#8212;&#8201;but is caused by limitations of the people involved, their skill levels, the tools and/or abstractions being used. Not keeping tabs on incidental complexity causes teams to veer away from focusing on the real problems, solving which provide the most value. It naturally follows that such teams minimize their odds of success appreciably.</p>
</div>
</div>
<div class="sect3">
<h4 id="uncontrolled-technical-debt"><a class="anchor" href="#uncontrolled-technical-debt"></a><a class="link" href="#uncontrolled-technical-debt">1.2.5. Uncontrolled technical debt</a></h4>
<div class="paragraph">
<p>Financial debt is the act of borrowing money from an outside party to quickly finance the operations of a business&#8201;&#8212;&#8201;with the promise to repay the principal plus the agreed upon rate of interest in a timely manner. Under the right circumstances, this can accelerate the growth of a business considerably while allowing the owner to retain ownership, reduced taxes and lower interest rates. On the other hand, the inability to pay back this debt on time can adversely affect credit rating, result in higher interest rates, cash flow difficulties, and other restrictions.</p>
</div>
<div class="paragraph">
<p>Technical debt is what results when development teams take arguably sub-optimal actions to expedite the delivery of a set of features or projects. For a period of time, just like borrowed money allows you to do things sooner than you could otherwise, technical debt can result in short term speed. In the long term, however, software teams will have to dedicate a lot more time and effort towards simply managing complexity as opposed to thinking about producing architecturally sound solutions. This can result in a vicious negative cycle as illustrated in the diagram below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/tech-debt.png" alt="tech debt" width="1131" height="483">
</div>
<div class="title">Figure 1- 3. Technical Debt&#8201;&#8212;&#8201;Implications</div>
</div>
<div class="paragraph">
<p>In a recent <a href="https://www.mckinsey.com/business-functions/mckinsey-digital/our-insights/tech-debt-reclaiming-tech-equity">McKinsey survey</a> sent out to CIOs, around 60% reported that the amount of tech debt increased over the past three years. At the same time, over 90% of CIOs allocated less than a fifth of their tech budget towards paying it off. Martin Fowler <a href="https://martinfowler.com/articles/is-quality-worth-cost.html#WeAreUsedToATrade-offBetweenQualityAndCost">explores</a> the deep correlation between high software quality (or the lack thereof) and the ability to enhance software predictably. While carrying a certain amount of tech debt is inevitable and part of doing business, not having a plan to systematically pay off this debt can have significantly detrimental effects on team productivity and ability to deliver value.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ignoring_non_functional_requirements"><a class="anchor" href="#_ignoring_non_functional_requirements"></a><a class="link" href="#_ignoring_non_functional_requirements">1.2.6. Ignoring Non-Functional Requirements (NFRs)</a></h4>
<div class="paragraph">
<p>Stakeholders often want software teams to spend a majority (if not all) of their time working on features that provide enhanced functionality. This is understandable given that such features provide the highest ROI.These features are called functional requirements.</p>
</div>
<div class="paragraph">
<p>Non-functional requirements, on the other hand, are those aspects of the system that do not affect functionality directly, but have a profound effect on the efficacy of those using these using and maintaining these systems. There are many kinds of NFRs. A partial list of common NFRs is depicted below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/nfrs.png" alt="nfrs" width="520" height="400">
</div>
<div class="title">Figure 1- 4. Non-Functional Requirements</div>
</div>
<div class="paragraph">
<p>Very rarely do users explicitly request non-functional requirements, but almost always expect these features to be part of any system they use. Oftentimes, systems may continue to function without NFRs being met, but not without having an adverse impact on the <em>quality</em> of the user experience. For example, the home page of a web site that loads in under 1 second under low load and takes upwards of 30 seconds under higher loads may not be usable during those times of stress. Needless to say, not treating non-functional requirements with the same amount of rigor as explicit, value-adding functional features, can lead to unusable systems&#8201;&#8212;&#8201;and subsequently failure.</p>
</div>
<div class="paragraph">
<p>In this section we examined some common reasons that cause software projects to fail. Is it possible to improve our odds? Before we do that, let&#8217;s look at the nature of modern software systems and how we can deal with the ensuing complexity.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modern-systems-and-dealing-with-complexity"><a class="anchor" href="#modern-systems-and-dealing-with-complexity"></a><a class="link" href="#modern-systems-and-dealing-with-complexity">1.3. Modern systems and dealing with complexity</a></h3>
<div class="quoteblock">
<blockquote>
We can not solve our problems with the same level of thinking that created them.
</blockquote>
<div class="attribution">
&#8212; Albert Einstein
</div>
</div>
<div class="paragraph">
<p>As we have seen in the previous section, there are several reasons that cause software endeavors to fail. In this section, we will look to understand how software gets built, what the currently prevailing realities are and what adjustments we need to make in order to cope.</p>
</div>
<div class="sect3">
<h4 id="how-software-gets-built"><a class="anchor" href="#how-software-gets-built"></a><a class="link" href="#how-software-gets-built">1.3.1. How software gets built</a></h4>
<div class="paragraph">
<p>Building successful software is an iterative process of constantly refining knowledge and expressing it in the form of models. We have attempted to capture the essence of the process at a high level here:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/how-software-gets-built.png" alt="how software gets built">
</div>
<div class="title">Figure 1- 5. Building software is a continuous refinement of knowledge and models</div>
</div>
<div class="paragraph">
<p>Before we express a solution in working code, it is necessary to understand <strong>what</strong> the problem entails, <strong>why</strong> the problem is important to solve, and finally, <strong>how</strong> it can be solved. Irrespective of the methodology used (waterfall, agile, and/or anything in between), the process of building software is one where we need to constantly use our knowledge to refine mental/conceptual models to be able to create valuable solutions.</p>
</div>
</div>
<div class="sect3">
<h4 id="complexity-is-inevitable"><a class="anchor" href="#complexity-is-inevitable"></a><a class="link" href="#complexity-is-inevitable">1.3.2. Complexity is inevitable</a></h4>
<div class="paragraph">
<p>We find ourselves in the midst of the fourth industrial revolution where the world is becoming more and more digital&#8201;&#8212;&#8201;with technology being a significant driver of value for businesses. Exponential advances in computing technology as illustrated by Moore&#8217;s Law below,</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/moores-law.png" alt="Moore&#8217;s Law">
</div>
<div class="title">Figure 1- 6. Moore&#8217;s Law</div>
</div>
<div class="paragraph">
<p>along with the rise of the internet as illustrated below,</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/global-internet-traffic.png" alt="Global Internet Traffic">
</div>
<div class="title">Figure 1- 7. Global Internet Traffic</div>
</div>
<div class="paragraph">
<p>has meant that companies are being required to modernize their software systems much more rapidly than they ever have. Along with all this, the onset of commodity computing services such as the public cloud has led to a move away from expensive centralized computing systems to more distributed computing ecosystems. As we attempt building our most complex solutions, monoliths are being replaced by an environ of distributed, collaborating microservices. Modern philosophies and practices such as automated testing, architecture fitness functions, continuous integration, continuous delivery, devops, security automation, infrastructure as code, to name a few, are disrupting the way we deliver software solutions.</p>
</div>
<div class="paragraph">
<p>All these advances introduce their own share of complexity. Instead of attempting to control the amount of complexity, there is a need to embrace and cope with it.</p>
</div>
</div>
<div class="sect3">
<h4 id="optimizing-the-feedback-loop"><a class="anchor" href="#optimizing-the-feedback-loop"></a><a class="link" href="#optimizing-the-feedback-loop">1.3.3. Optimizing the feedback loop</a></h4>
<div class="paragraph">
<p>As we enter an age of encountering our most complex business problems, we need to embrace new ways of thinking, a development philosophy and an arsenal of techniques to iteratively evolve mature software solutions that will stand the test of time. We need better ways of communicating, analyzing problems, arriving at a collective understanding, creating and modeling abstractions, and then implementing, enhancing the solution.</p>
</div>
<div class="paragraph">
<p>To state the obvious&#8201;&#8212;&#8201;were all building software with seemingly brilliant business ideas on one side and our ever-demanding customers on the other, as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/optimizing-the-feedback-loop.png" alt="optimizing the feedback loop">
</div>
<div class="title">Figure 1- 8. The software delivery continuum</div>
</div>
<div class="paragraph">
<p>In between, we have two chasms to cross&#8201;&#8212;&#8201;the <em>delivery pipeline</em> and the <em>feedback pipeline</em>. The delivery pipeline enables us to put software in the hands of our customers, whereas the feedback pipeline allows us to adjust and adapt. As we can see, this is a continuum. And if we are to build better, more valuable software, this continuum, this potentially infinite loop has to be optimized!</p>
</div>
<div class="paragraph">
<p>To optimize this loop, we need three characteristics to be present: we need to be fast, we need to be reliable, and we need to do this over and over again. In other words, we need to be rapid, reliable and repeatable&#8201;&#8212;&#8201;all at the same time!! Take any one of these away, and it just wont sustain.</p>
</div>
<div class="paragraph">
<p>Domain-driven design promises to provide answers on how to do this in a systematic manner. In the upcoming section, and indeed the rest of this book, we will examine what DDD is and why it is indispensable when working to provide solutions for non-trivial problems in today&#8217;s world of massively distributed teams and applications.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="what-is-domain-driven-design"><a class="anchor" href="#what-is-domain-driven-design"></a><a class="link" href="#what-is-domain-driven-design">1.4. What is Domain-Driven Design?</a></h3>
<div class="quoteblock">
<blockquote>
Life is really simple, but we insist on making it complicated.
</blockquote>
<div class="attribution">
&#8212; Confucius
</div>
</div>
<div class="paragraph">
<p>In the previous section, we saw how a myriad of reasons coupled with system complexity get in the way of software project success. The idea of domain-driven design, originally conceived by Eric Evans in his 2003 book, is an approach to software development that focuses on expressing software solutions in the form of a model that closely embodies the core of the problem being solved. It provides a set of principles and systematic techniques to analyze, architect and implement software solutions in a manner that enhances chances of success.</p>
</div>
<div class="paragraph">
<p>While Evans' work is indeed seminal, ground-breaking, and way ahead of its time, it is not prescriptive at all. This is a strength in that it has enabled evolution of DDD beyond what Evans had originally conceived at the time. On the other hand, it also makes it extremely hard to define what DDD actually encompasses, making practical application a challenge. In this section, we will look at some foundational terms and concepts behind domain-driven design. Elaboration and practical application of these concepts will happen in upcoming chapters of this book.</p>
</div>
<div class="paragraph">
<p>When encountered with a complex business problem:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Understand the problem</strong>: To have a deep, shared understanding of the problem, it is necessary for business experts and technology experts to collaborate closely. Here we collectively understand what the problem is and why it is valuable to solve. This is termed as the <strong>domain</strong> for the problem.</p>
</li>
<li>
<p><strong>Break down the problem</strong> into more manageable parts: To keep complexity at manageable levels, break down complex problems into smaller, independently solvable parts. These parts are termed as <strong>subdomains</strong>. It may be necessary to further break down subdomains where the subdomain is still too complex. Assign explicit boundaries to limit the functionality of each subdomain. This boundary is termed as the <strong>bounded context</strong> for that subdomain. It may also be convenient to think of the subdomain as a concept that makes more sense to the domain experts (in the problem space), whereas the bounded context is a concept that makes more sense to the technology experts (in the solution space).</p>
</li>
<li>
<p>For each of these bounded contexts:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Agree on a shared language</strong>: Formalize the understanding by establishing a shared language that is applicable unambiguously within the bounds of the subdomain. This shared language is termed as the ubiquitous language of the domain.</p>
</li>
<li>
<p><strong>Express understanding in shared models</strong>: In order to produce working software, express the ubiquitous language in the form of shared models. This model is termed as the <strong>domain model</strong>. There may exist multiple variations of this model, each meant to clarify a specific aspect of the solution. For example, a process model, a sequence diagram, working code, a deployment topology, etc.</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Embrace incidental complexity</strong> of the problem: It is important to note that it is not possible to shy away from the essential complexity of a given problem. By breaking down the problem into subdomains and bounded contexts, we are attempting to distribute it (more or less) evenly across more manageable parts.</p>
</li>
<li>
<p><strong>Continuously evolve</strong> for greater insight: It is important to understand that the above steps are not a one-time activity. Businesses, technologies, processes and our understanding of these evolve, it is important for our shared understanding to remain in sync with these models through continuous refactoring.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A pictorial representation of the essence of domain-driven design is expressed here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/ddd-essence.png" alt="ddd essence">
</div>
<div class="title">Figure 1- 9. Essence of DDD</div>
</div>
<div class="paragraph">
<p>We appreciate that this is quite a whirlwind introduction to the subject of domain-driven design.</p>
</div>
<div class="sect3">
<h4 id="understanding-the-problem-using-strategic-design"><a class="anchor" href="#understanding-the-problem-using-strategic-design"></a><a class="link" href="#understanding-the-problem-using-strategic-design">1.4.1. Understanding the problem using strategic design</a></h4>
<div class="paragraph">
<p>In this section, let&#8217;s demystify some commonly used concepts and terms when working with domain-driven design. First and foremost, we need to understand what we mean by the first "D"&#8201;&#8212;&#8201;<strong>domain</strong>.</p>
</div>
<div class="sect4">
<h5 id="what-is-a-domain"><a class="anchor" href="#what-is-a-domain"></a><a class="link" href="#what-is-a-domain">What is a domain?</a></h5>
<div class="paragraph">
<p>The foundational concept when working with domain-driven design is the notion of a domain.But what exactly is a domain?The word <a href="https://en.wiktionary.org/wiki/domain">domain</a>, which has its <a href="https://www.etymonline.com/word/domain">origins</a> in the 1600s to the Old French word <em>domaine</em> (power), Latin word <em>dominium</em> (property, right of ownership) is a rather confusing word.Depending on who, when, where and how it is used, it can mean different things:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://en.wiktionary.org/wiki/domain#Noun" target="_blank" rel="noopener"><img src="./images/domain-definition.png" alt="Domain"></a>
</div>
<div class="title">Figure 1- 10. <strong>Domain</strong>: Means many things depending on context</div>
</div>
<div class="paragraph">
<p>In the context of a business however, the word domain covers the overall scope of its primary activity&#8201;&#8212;&#8201;the service it provides to its customers.This is also referred as the <strong><em>problem domain</em></strong>.For example, Tesla operates in the domain of electric vehicles, Netflix provides online movies and shows, while McDonald&#8217;s provides fast food.Some companies like Amazon, provide services in more than one domain&#8201;&#8212;&#8201;online retail, cloud computing, among others.The domain of a business (at least the successful ones) almost always encompasses fairly complex and abstract concepts.To cope with this complexity, it is usual to decompose these domains into more manageable pieces called subdomains.Let us understand subdomains in more detail next.</p>
</div>
</div>
<div class="sect4">
<h5 id="what-is-a-subdomain"><a class="anchor" href="#what-is-a-subdomain"></a><a class="link" href="#what-is-a-subdomain">What is a subdomain?</a></h5>
<div class="paragraph">
<p>At its essence, Domain-driven design provides means to tackle complexity.Engineers do this by breaking down complex problems into more manageable ones called <strong>subdomains</strong>.This facilitates better understanding and makes it easier to arrive at a solution.For example, the online retail domain may be divided into subdomains such as product, inventory, rewards, shopping cart, order management, payments, shipping, etc. as shown below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/domains.png" alt="domains" width="603" height="412">
</div>
<div class="title">Figure 1- 11. Subdomains in the Retail domain</div>
</div>
<div class="paragraph">
<p>In certain businesses, subdomains themselves may turn out to become very complex on their own and may require further decomposition. For instance, in the retail example above, it may be required to break the products subdomain into further constituent subdomains such as catalog, search, recommendations, reviews, etc. as shown below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/subdomains.png" alt="subdomains" width="442" height="280">
</div>
<div class="title">Figure 1- 12. Subdomains in the Products subdomain</div>
</div>
<div class="paragraph">
<p>Further breakdown of subdomains may be needed until we reach a level of manageable complexity.Domain decomposition is an important aspect of DDD.Let&#8217;s look at the types of subdomains to understand this better.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The terms domain and subdomains tend to get used interchangeably quite often.This can be confusing to the casual onlooker.Given that sub(domains) tend to be quite complex and hierarchical, a subdomain can be a domain in its own right.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_types_of_subdomains"><a class="anchor" href="#_types_of_subdomains"></a><a class="link" href="#_types_of_subdomains">Types of subdomains</a></h5>
<div class="paragraph">
<p>Breaking down a complex domain into more manageable subdomains is a great thing to do.However, not all subdomains are created equal.With any business, the following three types of subdomains are going to be encountered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Core</strong>: The main focus area for the business.This is what provides the biggest differentiation and value.It is therefore natural to want to place the most focus on the core subdomain.In the retail example above, shopping cart and orders might be the biggest differentiation&#8201;&#8212;&#8201;and hence may form the core subdomains for that business venture.It is prudent to implement core subdomains in-house given that it is something that businesses will desire to have the most control over.In the online retail example above, the business may want to focus on providing an enriched experience to place online orders.This will make the <em>online orders</em> and <em>shopping cart</em> part of the core subdomain.</p>
</li>
<li>
<p><strong>Supporting</strong>: Like with every great movie, where it is not possible to create a masterpiece without a solid supporting cast, so it is with supporting or auxiliary subdomains.Supporting subdomains are usually very important and very much required, but may not be the primary focus to run the business.These supporting subdomains, while necessary to run the business, do not usually offer a significant competitive advantage.Hence, it might be even fine to completely outsource this work or use an off-the-shelf solution as is or with minor tweaks.For the retail example above, assuming that online ordering is the primary focus of this business, catalog management may be a supporting subdomain.</p>
</li>
<li>
<p><strong>Generic</strong>: When working with business applications, one is required to provide a set of capabilities <strong>not</strong> directly related to the problem being solved.Consequently, it might suffice to just make use of an off-the-shelf solution.For the retail example above, the identity, auditing and activity tracking subdomains might fall in that category.</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
It is important to note that the notion of core vs. supporting vs. generic subdomains is very context specific.What is core for one business may be supporting or generic for another.Identifying and distilling the core domain requires deep understanding and experience of what problem is being attempted to be solved.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Given that the core subdomain establishes most of the business differentiation, it will be prudent to devote the most amount of energy towards maintaining that differentiation. This is illustrated in the core domain chart here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/core-domain-chart.png" alt="core domain chart">
</div>
<div class="title">Figure 1- 13. Importance of subdomains</div>
</div>
<div class="paragraph">
<p>Over a period of time, it is only natural that competitors will attempt to emulate your successes. Newer, more efficient methods will arise, reducing the complexity involved, disrupting your core. This may cause the notion of what is currently core, to shift and become a supporting or generic capability as depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/core-domain-erosion.png" alt="core domain erosion">
</div>
<div class="title">Figure 1- 14. Core domain erosion</div>
</div>
<div class="paragraph">
<p>To continue running a successful operation, it is required to constantly innovate in the core. For example, when AWS started the cloud computing business, it only provided simple infrastructure (IaaS) solutions. However, as competitors like Microsoft, Google and others started to catch up, AWS has had to provide several additional value-added services (for example, PaaS, SaaS, etc).</p>
</div>
<div class="paragraph">
<p>As is evident, this is not just an engineering problem. It requires deep understanding of the underlying business. That&#8217;s where domain experts can play a significant role.</p>
</div>
</div>
<div class="sect4">
<h5 id="domain-and-technical-experts"><a class="anchor" href="#domain-and-technical-experts"></a><a class="link" href="#domain-and-technical-experts">Domain and technical experts</a></h5>
<div class="paragraph">
<p>Any modern software team requires expertise in at least two areas&#8201;&#8212;&#8201;the functionality of the domain and the art of translating it into high quality software. At most organizations, these exist as at least two distinct groups of people.</p>
</div>
<div class="paragraph">
<p><strong>Domain experts</strong>&#8201;&#8212;&#8201;those who have a deep and intimate understanding of the domain. Domain experts are subject-matter experts (SMEs) who have a very strong grasp of the business. Domain experts may have varying degrees of expertise. Some SMEs may choose to specialize in specific subdomains, while others may have a broader understanding of how the overall business works.</p>
</div>
<div class="paragraph">
<p><strong>Technical experts</strong> on the other hand, enjoy solving specific, quantifiable computer science problems. Often, technical experts do not feel it worth their while understanding the context of the business they work in. Rather, they seem overly eager to only enhance their technical skills that are a continuation of their learnings in academia.</p>
</div>
<div class="paragraph">
<p>While the domain experts specify the <strong>why</strong> and the <strong><em>what</em></strong>, technical experts, (software engineers) largely help realize the <strong><em>how</em></strong>. Strong collaboration and synergy between both groups is absolutely essential to ensure sustained high performance and success.</p>
</div>
</div>
<div class="sect4">
<h5 id="a-divide-originating-in-language"><a class="anchor" href="#a-divide-originating-in-language"></a><a class="link" href="#a-divide-originating-in-language">A divide originating in language</a></h5>
<div class="paragraph">
<p>While strong collaboration between these groups is necessary, it is important to appreciate that these groups of people seem to have distinct motivations and differences in thinking. Seemingly, this may appear to be restricted to simple things like differences in their day-to-day language. However, deeper analysis usually reveals a much larger divide in aspects such as goals, motivations etc. This is illustrated in the picture here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/linguistic-divide.png" alt="linguistic divide">
</div>
<div class="title">Figure 1- 15. Divide originating in language</div>
</div>
<div class="paragraph">
<p>But this is a book primarily focused towards technical experts. Our point is that it is not possible to be successful by just working on technically challenging problems without gaining a sound understanding of the underlying business context.</p>
</div>
<div class="paragraph">
<p>Every decision we take regarding the organization, be it requirements, architecture, code, etc. has business and user consequences.
In order to conceive, architect, design, build and evolve software effectively, our decisions need to aid in creating the optimal business impact. As mentioned above, this can only be achieved if we have a clear understanding of the problem we intend to solve.
This leads us to the realization that there exist two distinct <em>domains</em> when arriving at the solution for a problem:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The use of the word domain in this context is made in an abstract sense&#8201;&#8212;&#8201;not to be confused with the concept of the business domain introduced earlier.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="problem-domain"><a class="anchor" href="#problem-domain"></a><a class="link" href="#problem-domain">Problem domain</a></h5>
<div class="paragraph">
<p>A term that is used to capture information that simply defines the problem while consciously avoiding any details of the solution.
It includes details like <strong>why</strong> we are trying to solve the problem, <strong>what</strong> we are trying to achieve and <strong>how</strong> it needs to be solved.
It is important to note that the <em>why</em>, <em>what</em> and <em>how</em> are from the perspective of the customers/stakeholders, not from the perspective of the engineers providing software solutions to the problem.</p>
</div>
<div class="paragraph">
<p>Consider the example of a retail bank which already provides a checking account capability for their customers.
They want access to more liquid funds.
To achieve that, they need to encourage customers to maintain higher account balances.
To do that, they are looking to introduce a new product called the <em>premium checking account</em> with additional features like higher interest rates, overdraft protection, no-charge ATM access, etc.
The problem domain expressed in the form of why, what and how is shown here:</p>
</div>
<table class="tableblock frame-all grid-all fit-content text-center">
<caption class="title">Problem domain: why, what and how</caption>
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Question</th>
<th class="tableblock halign-left valign-top">Answer</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Why</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bank needs access to more liquid funds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>What</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Have customers maintain higher account balances</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>How</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By introducing a new product&#8201;&#8212;&#8201;the premium checking account with enhanced features</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Now that we have defined the problem and the motivations surrounding it, let&#8217;s examine how it can inform the solution.</p>
</div>
</div>
<div class="sect4">
<h5 id="solution-domain"><a class="anchor" href="#solution-domain"></a><a class="link" href="#solution-domain">Solution domain</a></h5>
<div class="paragraph">
<p>A term used to describe the environment in which the solution is developed. In other words, the process of translating requirements into working software (this includes design, development, testing, deployment, etc). Here the emphasis is on the <em>how</em> of the problem being solved from a software implementation perspective. However, it is very difficult to arrive at a solution without having an appreciation of the why and the what.</p>
</div>
<div class="paragraph">
<p>Building on the previous premium checking account example, the code-level solution for this problem may look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PremiumCheckingAccountFactory</span> {

    Account openPremiumCheckingAccount(Applicant applicant,
                                       MonetaryAmount initialAmount) {

        Salary salary = checkEmployed(applicant);

        <span style="color:#080;font-weight:bold">if</span> (salary.isBelowThreshold()) {
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> InsufficientIncomeException(applicant);
        }

        Account account = Account.createFor(applicant);
        account.deposit(initialAmount);
        account.activate();
        <span style="color:#080;font-weight:bold">return</span> account;
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>This likely appears like a significant leap from a problem domain description, and indeed it is. Before a solution like this can be arrived at, there may need to exist multiple levels of refinement of the problem. As mentioned in the <a href="#_inaccurate_requirements">previous chapter</a>, this process of refinement is usually messy and may lead to inaccuracies in the understanding of the problem, resulting in a solution that may be good (for example, one that is sound from an engineering, software architecture standpoint), but not one that solves the problem at hand. Let&#8217;s look at how we can continuously refine our understanding by closing the gap between the problem and the solution domain.</p>
</div>
</div>
<div class="sect4">
<h5 id="promoting-a-shared-understanding-using-a-ubiquitous-language"><a class="anchor" href="#promoting-a-shared-understanding-using-a-ubiquitous-language"></a><a class="link" href="#promoting-a-shared-understanding-using-a-ubiquitous-language">Promoting a shared understanding using a ubiquitous language</a></h5>
<div class="paragraph">
<p>Previously, we saw how <a href="#_silo_mentality">organizational silos</a> can result in valuable information getting diluted. At a credit card company I used to work with, the words plastic, payment instrument, account, PAN (Primary Account Number), BIN (Bank Identification Number), card were all used by different team members to mean the exact same thing - the <strong><em>credit card</em></strong> when working in the same area of the application. On the other hand, a term like <strong><em>user</em></strong> would be used to sometimes mean a customer, a relationship manager, a technical customer support employee. To make matters worse, a lot of these muddled use of terms got implemented in code as well. While this might feel like a trivial thing, it had far-reaching consequences. Product experts, architects, developers, all came and went, each regressively contributing to more confusion, muddled designs, implementation and technical debt with every new enhancement&#8201;&#8212;&#8201;accelerating the journey towards the dreaded, unmaintainable, <a href="http://www.laputan.org/mud/">big ball of mud</a>.</p>
</div>
<div class="paragraph">
<p>DDD advocates breaking down these artificial barriers, and putting the domain experts and the developers on the same level footing by working collaboratively towards creating what DDD calls a <strong><em>ubiquitous language</em></strong>&#8201;&#8212;&#8201;a shared vocabulary of terms, words, phrases to continuously enhance the collective understanding of the entire team. This phraseology is then used actively in every aspect of the solution: the everyday vocabulary, the designs, the code&#8201;&#8212;&#8201;in short by <strong>everyone</strong> and <strong>everywhere</strong>. Consistent use of the common ubiquitous language helps reinforce a shared understanding and  produce solutions that better reflect the mental model of the domain experts.</p>
</div>
</div>
<div class="sect4">
<h5 id="evolving-a-domain-model-and-a-solution"><a class="anchor" href="#evolving-a-domain-model-and-a-solution"></a><a class="link" href="#evolving-a-domain-model-and-a-solution">Evolving a domain model and a solution</a></h5>
<div class="paragraph">
<p>The ubiquitous language helps establish a consistent albeit informal lingo among team members. To enhance understanding, this can be further refined into a formal set of abstractions&#8201;&#8212;&#8201;a <strong><em>domain model</em></strong> to represent the solution in software. When a problem is presented to us, we subconsciously attempt to form mental representations of potential solutions. Further, the type and nature of these representations (models) may differ wildly based on factors like our understanding of the problem, our backgrounds and experiences, etc. This implies that it is natural for these models to be different. For example, the same problem can be thought of differently by various team members as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/multiple-models.png" alt="multiple models">
</div>
<div class="title">Figure 1- 16. Multiple models to represent the solution to the problem using the ubiquitous language</div>
</div>
<div class="paragraph">
<p>As illustrated here, the business expert may think of a process model, whereas the test engineer may think of exceptions and boundary conditions to arrive at a test strategy and so on.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The illustration above is to depict the existence of multiple models. There may be several other perspectives, for example, a customer experience model, an information security model, etc. which are not depicted.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Care should be taken to retain focus on solving the business problem at hand at all times. Teams will be better served if they expend the same amount of effort modeling business logic as the technical aspects of the solution. To keep accidental complexity in check, it will be best to isolate the infrastructure aspects of the solution from this model. These models can take several forms, including conversations, whiteboard sessions, documentation, diagrams, tests and other forms of architecture fitness functions. It is also important to note that this is <strong>not</strong> a one-time activity. As the business evolves, the domain model and the solution will need to keep up. This can only be achieved through close collaboration between the domain experts and the developers at all times.</p>
</div>
</div>
<div class="sect4">
<h5 id="scope-of-domain-models-and-the-bounded-context"><a class="anchor" href="#scope-of-domain-models-and-the-bounded-context"></a><a class="link" href="#scope-of-domain-models-and-the-bounded-context">Scope of domain models and the bounded context</a></h5>
<div class="paragraph">
<p>When creating domain models, one of the dilemmas is in deciding how to restrict the scope of these models. One can attempt to create a single domain model that acts as a solution for the entire problem. On the other hand, we may go the route of creating extremely fine-grained models that cannot exist meaningfully without having a strong dependency on others. There are pros and cons in going each way. Whatever be the case, each solution has a scope&#8201;&#8212;&#8201;bounds to which it is confined to. This boundary is termed as a <strong>bounded context</strong>.</p>
</div>
<div class="paragraph">
<p>There seems to exist a lot of confusion between the terms subdomains and bounded contexts. What is the difference? It turns out that subdomains are problem space concepts whereas bounded contexts are solution space concepts. This is best explained through the use of an example. Let&#8217;s consider the example of a fictitious Acme bank that provides two products: credit cards and retail bank. This may decompose to the following subdomains as depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/banking-subdomains.png" alt="banking subdomains">
</div>
<div class="title">Figure 1- 17. Banking subdomains at Acme bank</div>
</div>
<div class="paragraph">
<p>When creating a solution for the problem, many possible solution options exist. We have depicted a few options here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/banking-bounded-contexts.png" alt="banking bounded contexts">
</div>
<div class="title">Figure 1- 18. Bounded contexts options at Acme bank</div>
</div>
<div class="paragraph">
<p>These are just a few examples of decomposition patterns to create bounded contexts. The exact set of patterns one may choose to use may vary depending on currently prevailing realities like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Current organizational structures</p>
</li>
<li>
<p>Domain experts' responsibilities</p>
</li>
<li>
<p>Key activities and pivotal events</p>
</li>
<li>
<p>Existing applications</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Conway&#8217;s Law asserts that organizations are constrained to produce application designs which are copies of their communication structures. Your current organizational structures may not be optimally aligned to your desired solution approach. The <a href="https://www.thoughtworks.com/en-us/radar/techniques/inverse-conway-maneuver"><strong>inverse Conway maneuver</strong></a><sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> may be applied to achieve isomorphism with the business architecture.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Whatever be the method used to decompose a problem into a set of bounded contexts, care should be taken to make sure that the coupling between them is kept as low as possible.</p>
</div>
<div class="paragraph">
<p>While bounded contexts ideally need to be as independent as possible,  they may still need to communicate with each other. When using domain-driven design, the system as a whole can be represented as a set of bounded contexts which have relationships with each other. These relationships define how these bounded contexts can integrate with each other and are called <strong><em>context maps</em></strong>. A sample context map is shown here.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/sample-context-map.png" alt="sample context map">
</div>
<div class="title">Figure 1- 19. Sample context map for Acme bank</div>
</div>
<div class="paragraph">
<p>The context map shows the bounded contexts the relationship between them. These relationships can be a lot more nuanced than what is depicted here. We will discuss more details on context maps and communication patterns in <a href="#_integrating_with_external_systems">Chapter 9: Integrating with external systems</a>.</p>
</div>
<div class="paragraph">
<p>We have now covered a catalog of concepts that are core to the strategic design tenets of domain-driven design. Let&#8217;s look at some tools that can help expedite this process.</p>
</div>
<div class="paragraph">
<p>In subsequent chapters we will reinforce all the concepts introduced here in a lot more detail.</p>
</div>
<div class="paragraph">
<p>In the next section, we will look at why the ideas of DDD, introduced all those years ago, are still very relevant. If anything, we will look at why they are becoming even more relevant now than ever.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implementing-the-solution-using-tactical-design"><a class="anchor" href="#implementing-the-solution-using-tactical-design"></a><a class="link" href="#implementing-the-solution-using-tactical-design">1.4.2. Implementing the solution using tactical design</a></h4>
<div class="paragraph">
<p>In the previous section, we have seen how we can arrive at a shared understanding of the problem using the strategic design tools. We need to use this understanding to create a solution. DDD&#8217;s tactical design aspects, tools and techniques help translate this understanding into working software. Let&#8217;s look at these aspects in detail. In part 2 of the book, we will apply these to solve a real-world problem.</p>
</div>
<div class="paragraph">
<p>It is convenient to think of the tactical design aspects as depicted in this picture:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/ddd-tactical-design.png" alt="ddd tactical design">
</div>
<div class="title">Figure 1- 20. The elements of DDD&#8217;s tactical design</div>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the definitions of these elements.</p>
</div>
<div class="sect4">
<h5 id="value-objects"><a class="anchor" href="#value-objects"></a><a class="link" href="#value-objects">Value objects</a></h5>
<div class="paragraph">
<p>Value objects are immutable objects that encapsulate the data and behavior of one or more related attributes. It may be convenient to think of value objects as named primitives. For example, consider a <code>MonetaryAmount</code> value object. A simple implementation can contain two attributes&#8201;&#8212;&#8201;an <em>amount</em> and a <em>currency code</em>. This allows encapsulation of behavior such as adding two <code>MonetaryAmount</code> objects safely as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/entity-example.png" alt="entity example" width="158" height="132">
</div>
<div class="title">Figure 1- 21. A simple <code>MonetaryAmount</code> value object</div>
</div>
<div class="paragraph">
<p>The effective use of value objects helps protect from the <a href="https://wiki.c2.com/?PrimitiveObsession">primitive obsession</a><sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> antipattern, while increasing clarity. It also allows composing higher level abstractions using one or more value objects. It is important to note that value objects do not have the notion of identity. That is, two value having the same value are treated equal. So two <code>MonetaryAmount</code> objects having the same <code>amount</code> and <code>currency code</code> will be considered equal. Also, it is important to make value objects immutable. That is, a need to change any of the attributes should result in the creation of a new attribute.</p>
</div>
<div class="paragraph">
<p>It is easy to dismiss the use of value objects as a mere engineering technique, but the consequences of (not) using them can be far-reaching. In the <code>MonetaryAmount</code> example above, it is possible for the <code>amount</code> and <code>currency code</code> to exist as independent attributes. However, the use of the <code>MonetaryAmount</code> enforces the notion of the <em>ubiquitous language</em>. Hence, we recommend the use of value objects as a default instead of using primitives.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Critics may be quick to point out problems such as class explosion and performance issues. But in our experience, the benefits usually outweigh the costs. But it may be necessary to re-examine this approach if problems occur.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_entities"><a class="anchor" href="#_entities"></a><a class="link" href="#_entities">Entities</a></h5>
<div class="paragraph">
<p>An entity is an object with a <strong>unique identity</strong> and <strong>encapsulates</strong> the data and behaviour of its attributes. It may be convenient to view entities as a collection of other entities and value objects that need to be grouped together. A very simple example of an entity is shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/entity-example.png" alt="entity example" width="217" height="165">
</div>
<div class="title">Figure 1- 22. A simple depiction of <code>Transaction</code> entity</div>
</div>
<div class="paragraph">
<p>In contrast to a value object, entities have the notion of a unique identifier. This means that two <code>Transaction</code> entities having the same underlying values, but having a different identifier (<code>id</code>) value, will be considered different. On the other hand, two entity instances having the same value for the identifier are considered equal. Furthermore, unlike value objects, entities are mutable. That is, their attributes can and will change over time.</p>
</div>
<div class="paragraph">
<p>The concept of value objects and entities depends on the context within which they are used. In an order management system, the <code>Address</code> may be implemented as a value object in the <em>E-Commerce</em> bounded context, whereas it may be needed to be implemented as an entity in the <em>Order Fulfillment</em> bounded context.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is common to collectively refer to entities and value objects as <em>domain objects</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_aggregates"><a class="anchor" href="#_aggregates"></a><a class="link" href="#_aggregates">Aggregates</a></h5>
<div class="paragraph">
<p>As seen above, entities are hierarchical, in that they can be composed of one more children. Fundamentally, an aggregate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Is an entity usually composed of other child entities and value objects.</p>
</li>
<li>
<p>Encapsulates access to child entities by exposing behavior (usually referred to as <em>commands</em>).</p>
</li>
<li>
<p>Is a boundary that is used to enforce business invariants (rules) in a consistent manner.</p>
</li>
<li>
<p>Is an entry point to get things done within a bounded context.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider the example of a <code>CheckingAccount</code> aggregate:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/aggregate-example.png" alt="aggregate example" width="338" height="216">
</div>
<div class="title">Figure 1- 23. A simple depiction of a <code>CheckingAccount</code> aggregate</div>
</div>
<div class="paragraph">
<p>Note how the <code>CheckingAccount</code> is composed using the <code>AccountHolder</code> and Transaction` entities among other things. In this example, let&#8217;s assume that the overdraft feature (ability to hold a negative account balance) is only available for high net-worth individuals (HNI). Any attempt to change the <code>currentBalance</code> needs to occur in the form of a unique <code>Transaction</code> for audit purposes&#8201;&#8212;&#8201;irrespective of its outcome. For this reason, the <code>CheckingAccount</code> aggregate makes use of the <code>Transaction</code> entity. Although the <code>Transaction</code> has <code>approve</code> and <code>reject</code> methods as part of its interface, only the aggregate has access to these methods. In this way, the aggregate enforces the business invariant while maintaining high levels of encapsulation. A potential implementation of the <code>tryWithdraw</code> method is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CheckingAccount</span> {
    <span style="color:#088;font-weight:bold">private</span> AccountHolder primaryHolder;                            <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Collection</span>&lt;Transaction&gt; transactions;                       <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount currentBalance;                          <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#777">// Other code omitted for brevity</span>

    <span style="color:#339;font-weight:bold">void</span> tryWithdraw(MonetaryAmount amount) {                       <i class="conum" data-value="2"></i><b>(2)</b>
        MonetaryAmount newBalance = <span style="color:#950">this</span>.currentBalance.subtract(amount);
        Transaction transaction = add(Transaction.withdrawal(<span style="color:#950">this</span>.id, amount));
        <span style="color:#080;font-weight:bold">if</span> (primaryHolder.isNotHNI() &amp;&amp; newBalance.isOverdrawn()) { <i class="conum" data-value="3"></i><b>(3)</b>
        transaction.rejected();
        } <span style="color:#080;font-weight:bold">else</span> {
            transaction.approved();
            currentBalance = newBalance;
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>CheckingAccount</code> aggregate is composed of child entities and value objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>tryWithdraw</code> method acts as a consistency boundary for the operation. Irrespective of the outcome (approved or rejected), the system will remain in a consistent state. In other words, the <code>currentBalance</code> can change only within the confines of the <code>CheckingAccount</code> aggregate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The aggregate enforces the appropriate business invariant (rule) to allow overdrafts only for HNIs.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Aggregates are also referred to as <strong>aggregate roots</strong>. That is, the object that is at the root of the entity hierarchy. We use these terms synonymously in this book.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="domain-events"><a class="anchor" href="#domain-events"></a><a class="link" href="#domain-events">Domain events</a></h5>
<div class="paragraph">
<p>As mentioned above, aggregates dictate how and when state changes occur. Other parts of the system may be interested in knowing about the occurrence of changes that are significant to the business. For example, an order being placed or a payment being received, etc. <em>Domain events</em> are the means to convey that something business significant has occurred. It is important to differentiate between system events and domain events. For example, in the context of a retail bank, a <em>row was saved</em> in the database, or a <em>server ran out of disk space</em>, etc. may classify as system events, whereas a <em>deposit was made</em> to a checking account, <em>fraudulent activity was detected</em> on a transaction, etc. could be classified as domain events. In other words, domain events are things that <strong>domain experts care about</strong>.</p>
</div>
<div class="paragraph">
<p>It may be prudent to make use of domain events to reduce the amount of coupling between bounded contexts, making it a critical building block of domain-driven design.</p>
</div>
</div>
<div class="sect4">
<h5 id="repositories"><a class="anchor" href="#repositories"></a><a class="link" href="#repositories">Repositories</a></h5>
<div class="paragraph">
<p>Most businesses require durability of data. For this reason, aggregate state needs to be persisted and retrieved when needed. Repositories are objects that enable persisting and  loading <em>aggregate</em> instances. This is well documented in Martin Fowler&#8217;s <em>Patterns of Enterprise Application Architecture</em> book as part of the <a href="https://martinfowler.com/eaaCatalog/repository.html">repository</a><sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> pattern. It is pertinent to note that we are referring to aggregate repositories here, not just any entity repository. The singular purpose of this repository is to load a <strong>single instance</strong> of an aggregate using its identifier. It is important to note that this repository does not support finding aggregate instances using any other means. This is because, business operations happen as part of manipulating a single instance of the aggregate within its bounded context.</p>
</div>
</div>
<div class="sect4">
<h5 id="factories"><a class="anchor" href="#factories"></a><a class="link" href="#factories">Factories</a></h5>
<div class="paragraph">
<p>In order to work with aggregates and value objects, instances of these need to be constructed. In simple cases, it might suffice to use a constructor to do so. However, aggregate and value object instances can become quite complex depending on amount the state they encapsulate. In such cases, it may be prudent to consider delegating object construction responsibilities to a <em>factory</em> external to the aggregate/value object. We make use of the static factory method, builder, and dependency injection quite commonly in our day-to-day. Joshua Bloch discusses several variations of this pattern in <em>Chapter 2: Creating and destroying objects</em> in his <em>Effective Java</em> book.</p>
</div>
</div>
<div class="sect4">
<h5 id="services"><a class="anchor" href="#services"></a><a class="link" href="#services">Services</a></h5>
<div class="paragraph">
<p>When working within the confines of a single bounded context, the public interface (commands) of the aggregate provides a natural API. However, more complex business operations may require interacting with multiple bounded contexts and aggregates. In other words, we may find ourselves in situations where certain business operations do not fit naturally with any single aggregate. Even if interactions are limited to a single bounded context, there may be a need to expose that functionality in an implementation-neutral manner. In such cases, one may consider the use of objects termed as <em>services</em>. Services come in at least 3 flavors:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Domain services</strong>: To enable coordinating operations among more than one aggregate. For example, transferring money between two checking accounts at a retail bank.</p>
</li>
<li>
<p><strong>Infrastructure services</strong>: To enable interactions with a utility that is not core to the business. For example, logging, sending emails, etc. at the retail bank.</p>
</li>
<li>
<p><strong>Application services</strong>: Enable coordination between domain services, infrastructure services and other application services. For example, sending email notifications after a successful inter-account money transfer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Services can also be stateful or stateless. It is best to allow aggregates to manage state making use of repositories, while allowing services to coordinate and/or orchestrate business flows. In complex cases, there may be a need to manage the state of the flow itself. We will look at more concrete examples in part 2 of this book.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
It may become tempting to implement business logic almost exclusively using services&#8201;&#8212;&#8201;inadvertently leading to the <a href="https://martinfowler.com/bliki/AnemicDomainModel.html">anemic domain model</a><sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup> anti-pattern. It is worthwhile striving to encapsulate business logic within the confines of aggregates as a default.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="why-is-ddd-relevant-why-now"><a class="anchor" href="#why-is-ddd-relevant-why-now"></a><a class="link" href="#why-is-ddd-relevant-why-now">1.5. Why is DDD Relevant? Why Now?</a></h3>
<div class="quoteblock">
<blockquote>
He who has a why to live for can bear almost anyhow.
</blockquote>
<div class="attribution">
&#8212; Friedrich Nietzsche
</div>
</div>
<div class="paragraph">
<p>In a lot of ways, domain-driven design was way ahead of its time when Eric Evans introduced the concepts and principles back in 2003. DDD seems to have gone from strength to strength. In this section, we will examine why DDD is even more relevant today, than it was when Eric Evans wrote his book on the subject way back in 2003.</p>
</div>
<div class="sect3">
<h4 id="rise-of-open-source"><a class="anchor" href="#rise-of-open-source"></a><a class="link" href="#rise-of-open-source">1.5.1. Rise of Open Source</a></h4>
<div class="paragraph">
<p>Eric Evans, during his keynote address at the Explore DDD conference in 2017, lamented about how difficult it was to implement even the simplest concepts like immutability in value objects when his book had released. In contrast though, nowadays, it&#8217;s simply a matter of importing a mature, well documented, tested library like <a href="https://projectlombok.org/">Project Lombok</a> or <a href="https://immutables.github.io/">Immutables</a> to be productive, literally in a matter of minutes. To say that open source software has revolutionized the software industry would be an understatement! At the time of this writing, the public maven repository (<a href="https://mvnrepository.com" class="bare">https://mvnrepository.com</a>) indexes no less than a staggering <strong>18.3 million artifacts</strong> in a large assortment of popular categories ranging from databases, language runtimes to test frameworks and many many more as shown in the chart below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<a class="image" href="https://mvnrepository.com/" target="_blank" rel="noopener"><img src="./images/oss-stats.png" alt="oss stats"></a>
</div>
<div class="title">Figure 1- 24. Open source Java over the years. Source: <a href="https://mvnrepository.com/" class="bare">https://mvnrepository.com/</a></div>
</div>
<div class="paragraph">
<p>Java stalwarts like the <a href="https://spring.io/">spring framework</a> and more recent innovations like <a href="https://start.spring.io/">spring boot</a>, <a href="https://quarkus.io/">quarkus</a>, etc. make it a no-brainer to create production grade applications, literally in a matter of minutes. Furtheremore, frameworks like <a href="https://axoniq.io/product-overview/axon-framework">Axon</a>, <a href="https://www.lagomframework.com">Lagom</a>, etc. make it relatively simple to implement advanced architecture patterns such are CQRS, event sourcing, that are very complementary to implementing DDD-based solutions.</p>
</div>
</div>
<div class="sect3">
<h4 id="advances-in-technology"><a class="anchor" href="#advances-in-technology"></a><a class="link" href="#advances-in-technology">1.5.2. Advances in Technology</a></h4>
<div class="paragraph">
<p>DDD by no means is just about technology, it could not be completely agnostic to the choices available at the time. 2003 was the heyday of heavyweight and ceremony-heavy frameworks like J2EE (Java 2 Enterprise Edition), EJBs (Enterprise JavaBeans), SQL databases, ORMs (Object Relational Mappers) and the like&#8201;&#8212;&#8201;with not much choice beyond that when it came to enterprise tools and patterns to build complex software&#8201;&#8212;&#8201;at least out in the public domain. The software world has evolved and come a very long way from there. In fact, modern game changers like Ruby on Rails and the public cloud were just getting released. In contrast though, we now have no shortage of application frameworks, NoSQL databases, programmatic APIs to create infrastructure components with a lot more releasing with monotonous regularity.</p>
</div>
<div class="paragraph">
<p>All these innovations allow for rapid experimentation, continuous learning and iteration at pace. These game changing advances in technology have also coincided with the exponential rise of the internet and ecommerce as viable means to carry out successful businesses. In fact the impact of the internet is so pervasive that it is almost inconceivable to launch businesses without a digital component being an integral component. Finally, the consumerization and wide scale penetration of smartphones, IoT devices and social media has meant that data is being produced at rates inconceivable as recent as a decade ago. This means that we are building for and solving the most complicated problems by several orders of magnitude.</p>
</div>
</div>
<div class="sect3">
<h4 id="rise-of-distributed-computing"><a class="anchor" href="#rise-of-distributed-computing"></a><a class="link" href="#rise-of-distributed-computing">1.5.3. Rise of Distributed Computing</a></h4>
<div class="paragraph">
<p>There was a time when building large monoliths was very much the default. But an exponential rise in computing technology, public cloud, (IaaS, PaaS, SaaS, FaaS), big data storage and processing volumes, which has coincided with an arguable slowdown in the ability to continue creating faster CPUs, have all meant a turn towards more decentralized methods of solving problems.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="https://upload.wikimedia.org/wikipedia/commons/7/7c/Hilbert_InfoGrowth.png" alt="Hilbert InfoGrowth">
</div>
<div class="title">Figure 1- 25. Global Information Storage Capacity</div>
</div>
<div class="paragraph">
<p>Domain-driven design with its emphasis on dealing with complexity by breaking unwieldy monoliths into more manageable units in the form of subdomains and bounded contexts, fits naturally to this style of programming. Hence, it is no surprise to see a renewed interest in adopting DDD principles and techniques when crafting modern solutions. To quote Eric Evans, it is no surprise that Domain-Driven Design is even more relevant now than when it was originally conceived!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary"><a class="anchor" href="#summary"></a><a class="link" href="#summary">1.6. Summary</a></h3>
<div class="paragraph">
<p>In this chapter we examined some common reasons for why software projects fail. We saw how inaccurate or misinterpreted requirements, architecture (or the lack thereof), excessive technical debt, etc. can get in the way of meeting business goals and success.</p>
</div>
<div class="paragraph">
<p>We looked at the basic building blocks of domain-driven design such as domains, subdomains, ubiquitous language, domain models, bounded contexts and context maps. We also examined why the principles and techniques of domain-driven design are still very much relevant in the modern age of microservices and serverless. You should now be able to appreciate the basic terms of DDD and understand why it is important in todays context.</p>
</div>
<div class="paragraph">
<p>In the next chapter we will take a closer look at the real-world mechanics of domain-driven design. We will delve deeper into the strategic and tactical design elements of DDD and look at how using these can help form the basis for better communication and create more robust designs.</p>
</div>
</div>
<div class="sect2">
<h3 id="questions"><a class="anchor" href="#questions"></a><a class="link" href="#questions">1.7. Questions</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>What are the most common reasons for software projects to fail?</p>
</li>
<li>
<p>Why is DDD relevant in todays context?</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="further-reading"><a class="anchor" href="#further-reading"></a><a class="link" href="#further-reading">1.8. Further Reading</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 36.3636%;">
<col style="width: 9.0909%;">
<col style="width: 54.5455%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pulse of the Profession - 2017</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PMI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.pmi.org/-/media/pmi/documents/public/pdf/learning/thought-leadership/pulse/pulse-of-the-profession-2017.pdf" class="bare">https://www.pmi.org/-/media/pmi/documents/public/pdf/learning/thought-leadership/pulse/pulse-of-the-profession-2017.pdf</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pulse of the Profession - 2020</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PMI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.pmi.org/learning/library/forging-future-focused-culture-11908" class="bare">https://www.pmi.org/learning/library/forging-future-focused-culture-11908</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Project success: Definitions and Measurement Techniques</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PMI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.pmi.org/learning/library/project-success-definitions-measurement-techniques-5460" class="bare">https://www.pmi.org/learning/library/project-success-definitions-measurement-techniques-5460</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Project success: definitions and measurement techniques</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JK Pinto, DP Slevin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.pmi.org/learning/library/project-success-definitions-measurement-techniques-5460" class="bare">https://www.pmi.org/learning/library/project-success-definitions-measurement-techniques-5460</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Analysis Paralysis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ward Cunningham</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://proxy.c2.com/cgi/wiki?AnalysisParalysis" class="bare">https://proxy.c2.com/cgi/wiki?AnalysisParalysis</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Big Design Upfront</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ward Cunningham</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://wiki.c2.com/?BigDesignUpFront" class="bare">https://wiki.c2.com/?BigDesignUpFront</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enterprise Modeling Anti-Patterns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scott W. Ambler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://agilemodeling.com/essays/enterpriseModelingAntiPatterns.htm" class="bare">http://agilemodeling.com/essays/enterpriseModelingAntiPatterns.htm</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Project Managers Guide To 42 Agile Methodologies</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Henny Portman</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://thedigitalprojectmanager.com/agile-methodologies" class="bare">https://thedigitalprojectmanager.com/agile-methodologies</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain-Driven Design Even More Relevant Now</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eric Evans</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.youtube.com/watch?v=kIKwPNKXaLU" class="bare">https://www.youtube.com/watch?v=kIKwPNKXaLU</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Introducing Deliberate Discovery</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dan North</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://dannorth.net/2010/08/30/introducing-deliberate-discovery/" class="bare">https://dannorth.net/2010/08/30/introducing-deliberate-discovery/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Silver Bullet&#8201;&#8212;&#8201;Essence and Accident in Software Engineering</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fred Brooks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://faculty.salisbury.edu/~xswang/Research/Papers/SERelated/no-silver-bullet.pdf" class="bare">http://faculty.salisbury.edu/~xswang/Research/Papers/SERelated/no-silver-bullet.pdf</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mastering Non-Functional Requirements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sameer Paradkar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.packtpub.com/product/mastering-non-functional-requirements/9781788299237" class="bare">https://www.packtpub.com/product/mastering-non-functional-requirements/9781788299237</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Big Ball Of Mud</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Brian Foote &amp; Joseph Yoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.laputan.org/mud/" class="bare">http://www.laputan.org/mud/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Forgotten Layer of the Test Automation Pyramid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mike Cohn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.mountaingoatsoftware.com/blog/the-forgotten-layer-of-the-test-automation-pyramid" class="bare">https://www.mountaingoatsoftware.com/blog/the-forgotten-layer-of-the-test-automation-pyramid</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tech debt: Reclaiming tech equity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vishal Dalal et al</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.mckinsey.com/business-functions/mckinsey-digital/our-insights/tech-debt-reclaiming-tech-equity" class="bare">https://www.mckinsey.com/business-functions/mckinsey-digital/our-insights/tech-debt-reclaiming-tech-equity</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is High Quality Software Worth the Cost</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/articles/is-quality-worth-cost.html#WeAreUsedToATrade-offBetweenQualityAndCost" class="bare">https://martinfowler.com/articles/is-quality-worth-cost.html#WeAreUsedToATrade-offBetweenQualityAndCost</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1 text-justify">
<h2 id="_where_does_ddd_fit"><a class="anchor" href="#_where_does_ddd_fit"></a><a class="link" href="#_where_does_ddd_fit">2. Where and How Does DDD Fit?</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
We wont be distracted by comparison if we are captivated with purpose.
</blockquote>
<div class="attribution">
&#8212; Bob Goff
</div>
</div>
<div class="paragraph">
<p>Software architecture refers to the fundamental structures of a software system and the discipline of creating such structures and systems. Over the years, we have accumulated a series of architecture styles and programming paradigms to help us deal with system complexity. In this chapter we will examine how DDD can be applied in a manner that is complementary to these architecture styles and programming paradigms. We will also look at how/where it fits in the overall scheme of things when crafting a software solution.</p>
</div>
<div class="paragraph">
<p>At the end of this chapter, you will gain an appreciation of a variety of architecture style and programming paradigms, along with some pitfalls to watch out for, when applying them. You will also understand the role that DDD plays in augmenting each of these.</p>
</div>
<div class="sect2">
<h3 id="architecture-styles"><a class="anchor" href="#architecture-styles"></a><a class="link" href="#architecture-styles">2.1. Architecture Styles</a></h3>
<div class="paragraph">
<p>Domain-driven design presents a set of architecture tenets in the form of the strategic and tactical design elements. This enables decomposing large, potentially unwieldy business subdomains into well-factored, independent bounded contexts. One of the great advantages of DDD is that it does not require the use of any specific architecture. However, the software industry has been using a plethora of architecture styles over a period of the last several years. Let&#8217;s look at how DDD can be used in conjunction with a set of popular architecture styles to arrive at better solutions.</p>
</div>
<div class="sect3">
<h4 id="layered-architecture"><a class="anchor" href="#layered-architecture"></a><a class="link" href="#layered-architecture">2.1.1. Layered Architecture</a></h4>
<div class="paragraph">
<p>The layered architecture is one of the most common architecture styles where the solution is typically organized into four broad categories: <strong>presentation</strong>, <strong>application</strong>, <strong>domain</strong> and <strong>persistence</strong>. Each of the layers provides a solution to a particular concern it represents as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/layered.png" alt="layered" width="50%">
</div>
<div class="title">Figure 1- 26. Essence of a layered architecture.</div>
</div>
<div class="paragraph">
<p>The main idea behind the layered architecture is a separation of concerns&#8201;&#8212;&#8201;where the dependencies between layers are unidirectional (from the top to the bottom). For example, the domain layer can depend on the persistence layer, not the other way round. In addition, any given layer typically accesses the layer immediately beneath it without bypassing layers in between. For example, the presentation layer may access the domain layer only through the application layer.</p>
</div>
<div class="paragraph">
<p>This structure enables looser coupling between layers and allows them to evolve independently of each other. The idea of the layered architecture fits very well with domain-driven design&#8217;s tactical design elements as depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/layered-vs-ddd.png" alt="layered vs ddd" width="75%">
</div>
<div class="title">Figure 1- 27. Layered architecture mapped to DDD&#8217;s tactical design elements.</div>
</div>
<div class="paragraph">
<p>DDD actively promotes the use of a layered architecture, primarily because it makes it possible to focus on the domain layer in isolation of other concerns like how to information gets displayed, how end-to-end flows are managed, how data is stored and retrieved, etc. From that perspective, solutions that apply DDD tend to naturally be layered as well.</p>
</div>
<div class="sect4">
<h5 id="notable-variations"><a class="anchor" href="#notable-variations"></a><a class="link" href="#notable-variations">Notable variations</a></h5>
<div class="paragraph">
<p>A variation of the layered architecture was invented by Alistair Cockburn, which he originally called the <a href="https://alistair.cockburn.us/hexagonal-architecture/"><em>hexagonal architecture</em></a><sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup> (alternatively called the ports and adapters architecture). The idea behind this style was to avoid inadvertent dependencies between layers (as could occur in the layered architecture), specifically between the core of the system and the peripheral layers. The main idea here is to make use of interfaces (<em>ports</em>) exclusively within the core to enable modern drivers such as testing and looser coupling. This allows the core to  be developed and evolved independently of the non-core parts and the external dependencies. Integration with real-world components such as a database, file systems, web services, etc. is achieved through concrete implementations of the <em>ports</em> termed as <em>adapters</em>. The use of interfaces within the core enables much easier testing of the core in isolation of the rest of the system using mocks and stubs. It is also common to use dependency injection frameworks to dynamically swap out implementations of these interfaces when working with the real system in an end-to-end environment. A visual representation of the hexagonal architecture is shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/hexagonal.png" alt="hexagonal" width="75%">
</div>
<div class="title">Figure 1- 28. Hexagonal architecture</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It turns out that the use of the term hexagon in this context was purely for visual purposes&#8201;&#8212;&#8201;not to limit the system to exactly six types of ports.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similar to the hexagonal architecture, the <a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/">onion architecture</a><sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup>, conceived by Jeffrey Palermo is based on creating an application based on an independent object model within the core that can be compiled and run separately from the outer layers. This is done by defining interfaces (called ports in the hexagonal architecture) in the core and implementing (called adapters in the hexagonal architecture) them in the outer layers. From our perspective, the hexagonal and onion architecture styles have no perceptible differences that we could identify.</p>
</div>
<div class="paragraph">
<p>A visual representation of the onion architecture is shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/onion.png" alt="onion" width="75%">
</div>
<div class="title">Figure 1- 29. Onion architecture</div>
</div>
<div class="paragraph">
<p>Yet another variation of the layered architecture, popularized by Robert C. Martin (known endearingly as Uncle Bob) is the clean architecture. This is based on adhering to the <a href="https://blog.cleancoder.com/uncle-bob/2020/10/18/Solid-Relevance.html">SOLID principles</a><sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup> also perpetrated by him. The fundamental message here (just like in the case of hexagonal and onion architecture) is to avoid dependencies between the core&#8201;&#8212;&#8201;the one that houses business logic and other layers that tend to be volatile (like frameworks, third-party libraries, UIs, databases, etc).</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/clean.png" alt="clean" width="75%">
</div>
<div class="title">Figure 1- 30. Clean architecture</div>
</div>
<div class="paragraph">
<p>All these architecture styles are synergistic with DDD&#8217;s idea of developing the domain model for the core subdomain (and by extension its bounded context) independently of the rest of the system.</p>
</div>
<div class="paragraph">
<p>While each of these architecture styles provide additional guidance in terms of how to structure a layered architecture, any architecture approach we choose,  comes with its set of tradeoffs and limitations you will need to be cognizant of. We discuss some of these considerations here.</p>
</div>
</div>
<div class="sect4">
<h5 id="considerations"><a class="anchor" href="#considerations"></a><a class="link" href="#considerations">Considerations</a></h5>
<div class="sect5">
<h6 id="layer-cake-anti-pattern"><a class="anchor" href="#layer-cake-anti-pattern"></a><a class="link" href="#layer-cake-anti-pattern">Layer cake anti-pattern</a></h6>
<div class="paragraph">
<p>Sticking to a fixed set of layers provides a level of isolation, but in simpler cases, it may prove overkill without adding any perceptible benefit other than adherence to an agreed on architectural guidelines. In the layer cake anti-pattern, each layer merely proxies the call to the layer beneath it without adding any value. The example below illustrates this scenario that is fairly common:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/layer-cake-anti-pattern.png" alt="layer cake anti pattern" width="50%" height="665">
</div>
<div class="title">Figure 1- 31. Example of the <strong>layer cake</strong> anti-pattern to find an entity representation by ID</div>
</div>
<div class="paragraph">
<p>Here the <code>findById</code> method is replicated in every layer and simply calls the method with the same name in the layer below with no additional logic. This introduces a level of accidental complexity to the solution. Some amount of redundancy in the layering may be unavoidable for the purposes of standardization. It may be best to re-examine the layering guidelines if the <em>layer cake</em> occurs prominently in the codebase.</p>
</div>
</div>
<div class="sect5">
<h6 id="anemic-translation"><a class="anchor" href="#anemic-translation"></a><a class="link" href="#anemic-translation">Anemic translation</a></h6>
<div class="paragraph">
<p>Another variation of the layer cake we see commonly is one where layers refuse to share input and output types in the name of higher isolation and looser coupling. This makes it necessary to perform translations at the boundary of each layer. If the objects being translated are more or less structurally identical, we have an <em>anemic translation</em>. Let&#8217;s look at a variation of the <code>findById</code> example we discussed above.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/layer-cake-anti-pattern.png" alt="layer cake anti pattern" width="50%" height="675">
</div>
<div class="title">Figure 1- 32. Example of the <strong>anemic translation</strong> anti-pattern to find an entity representation by ID</div>
</div>
<div class="paragraph">
<p>In this case, each layer defines a <code>Entity</code> type of its own, requiring a translation between types at each layer. To make matters worse, the structure of the <code>Entity</code> type may have seemingly minor variations (for example, <code>lastName</code> being referred to as <code>surname</code>). While such translations may be necessary across bounded contexts, teams should strive to avoid the need for variations in names and structures of the same concept within a single bounded context. The intentional use of the <strong>ubiquitous language</strong> helps avoid such scenarios.</p>
</div>
</div>
<div class="sect5">
<h6 id="layer-bypass"><a class="anchor" href="#layer-bypass"></a><a class="link" href="#layer-bypass">Layer bypass</a></h6>
<div class="paragraph">
<p>When working with a layered architecture, it is reasonable to start by being strict about layers only interacting with the layer immediately beneath it. As we have seen above, such rigid enforcements may lead to an intolerable degree of accidental complexity, especially when applied generically to a large number of use-cases. In such scenarios, it may be worth considering consciously allowing one or more layers to be bypassed. For example, the <code>controller</code> layer may be allowed to work directly with the <code>repository</code> without using the <code>service</code> layer. In many cases, we have found it useful to use a separate set of rules for <a href="#_cqrs_pattern"><em>commands</em> versus <em>queries</em></a> as a starting point.</p>
</div>
<div class="paragraph">
<p>This can be a slippery slope. To continue maintaining a level of sanity, teams should consider the use of a lightweight architecture governance tool like <a href="https://www.archunit.org/"><strong>ArchUnit</strong></a><sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup> to make agreements explicit and afford quick feedback. A simple example of how to use ArchUnit for this purpose is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LayeredArchitectureTests</span> {
    <span style="color:#007">@ArchTest</span>
    <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> ArchRule layer_dependencies_are_respected_with_exception = layeredArchitecture()

            .layer(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Controllers</span><span style="color:#710">&quot;</span></span>).definedBy(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">..controller..</span><span style="color:#710">&quot;</span></span>)
            .layer(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Services</span><span style="color:#710">&quot;</span></span>).definedBy(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">..service..</span><span style="color:#710">&quot;</span></span>)
            .layer(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Domain</span><span style="color:#710">&quot;</span></span>).definedBy(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">..domain..</span><span style="color:#710">&quot;</span></span>)
            .layer(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Repository</span><span style="color:#710">&quot;</span></span>).definedBy(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">..repository..</span><span style="color:#710">&quot;</span></span>)

            .whereLayer(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Controllers</span><span style="color:#710">&quot;</span></span>).mayNotBeAccessedByAnyLayer()
            .whereLayer(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Services</span><span style="color:#710">&quot;</span></span>).mayOnlyBeAccessedByLayers(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Controllers</span><span style="color:#710">&quot;</span></span>)
            .whereLayer(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Domain</span><span style="color:#710">&quot;</span></span>).mayOnlyBeAccessedByLayers(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Services</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Repository</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Controllers</span><span style="color:#710">&quot;</span></span>)
            .whereLayer(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Repository</span><span style="color:#710">&quot;</span></span>)
                .mayOnlyBeAccessedByLayers(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Services</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Controllers</span><span style="color:#710">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Repository layer can be accessed by both the Services and Controllers layers&#8201;&#8212;&#8201;effectively allowing Controllers to bypass the use of the Services layer.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_vertical_slice_architecture"><a class="anchor" href="#_vertical_slice_architecture"></a><a class="link" href="#_vertical_slice_architecture">2.1.2. Vertical slice architecture</a></h4>
<div class="paragraph">
<p>The layered architecture and its variants described above, provide reasonably good guidance on how to structure complex applications.The vertical slice architecture championed by Jimmy Boggard recognizes that it may be too rigid to adopt a standard layering strategy for all use cases across the entire application.Furthermore, it is important to note that business value cannot be derived by implementing any of these horizontal layers in isolation.Doing so will only result in unusable inventory and lots of unnecessary context switching until all these layers are connected.Therefore, the vertical slice architecture proposes <a href="https://jimmybogard.com/vertical-slice-architecture/"><em>minimizing coupling between slices, and maximizing coupling in a slice</em></a><sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup> as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/vertical-slice.png" alt="vertical slice" width="75%">
</div>
<div class="title">Figure 1- 33. Vertical slice architecture</div>
</div>
<div class="paragraph">
<p>In the example above, <em>place order</em> might require us to coordinate with other components through the application layer, apply complex business invariants while operating within the purview of an ACID transaction.Similarly, <em>cancel order</em> might require applying business invariants within an ACID transaction without any additional coordination&#8201;&#8212;&#8201;obviating the need for the application layer in this case.However, <em>search orders</em> might require us to simply fetch existing data from a query optimized view.This style makes use of a horses for courses approach to layering that may help alleviate some anti-patterns listed above when implementing a plain vanilla layered architecture.</p>
</div>
<div class="sect4">
<h5 id="considerations-2"><a class="anchor" href="#considerations-2"></a><a class="link" href="#considerations-2">Considerations</a></h5>
<div class="paragraph">
<p>The vertical slice architecture affords a lot of flexibility when implementing a solution&#8201;&#8212;&#8201;taking into consideration the specific needs of the use-case being implemented. However, without some level of governance, this may quickly devolve to the big ball of mud with layering decisions being made seemingly arbitrarily based on personal preferences and experiences (or lack thereof). As a sensible default, you may want to consider using a distinct layering strategy for <a href="#_cqrs_pattern">commands and queries</a>. Beyond that, non-functional requirements may dictate how you may need to deviate from here. For example, you may need to bypass layers to meet performance SLAs for certain use cases.</p>
</div>
<div class="paragraph">
<p>When used pragmatically, the vertical slice architecture does enable applying DDD very effectively within each or a group of related vertical slices&#8201;&#8212;&#8201;allowing them to be treated as  bounded contexts. We show two possibilities using the <em>place order</em> and <em>cancel order</em> examples here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/vertical-slice-example.png" alt="vertical slice example" width="75%">
</div>
<div class="title">Figure 1- 34. Vertical slices used to evolve bounded contexts</div>
</div>
<div class="paragraph">
<p>In example (i) above, <em>place order</em> and <em>cancel order</em>, each use a distinct domain model, whereas in example (ii), both use cases share a common domain model and by extension become part of the same bounded context. This does pave the way to slice functionality when looking to adopt the <a href="#_serverless_architecture">serverless architecture</a> along use case boundaries.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="service-oriented-architecture-soa"><a class="anchor" href="#service-oriented-architecture-soa"></a><a class="link" href="#service-oriented-architecture-soa">2.1.3. Service Oriented Architecture (SOA)</a></h4>
<div class="paragraph">
<p>Service Oriented Architecture (SOA) is an architectural style where software components expose (potentially) reusable functionality over standardized interfaces. The use of standardized interfaces (such as SOAP, REST, gRPC, etc. to name a few) enables easier interoperability when integrating heterogeneous solutions as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/soa.png" alt="soa">
</div>
<div class="title">Figure 1- 35. SOA: Expose reusable functionality over standard interfaces.</div>
</div>
<div class="paragraph">
<p>Previously, the use of non-standard, proprietary interfaces made this kind of integration a lot more challenging. For example, a retail bank may expose inter-account transfer functionality in the form of SOAP web services. While SOA prescribes exposing functionality over standardized interfaces, the focus is more on integrating heterogeneous applications than on implementing them.</p>
</div>
<div class="sect4">
<h5 id="considerations-3"><a class="anchor" href="#considerations-3"></a><a class="link" href="#considerations-3">Considerations</a></h5>
<div class="paragraph">
<p>At one of the banks we worked at, we exposed a set of over 500 service interfaces over SOAP. Under the covers, we implemented these services using EJB 2.x (a combination of stateless session beans and message-driven beans) hosted on a commercial J2EE application server which also did double duty as an enterprise service bus (ESB). These services largely delegated most if not all the logic to a set of underlying stored procedures within a single monolithic Oracle database using a canonical data model for the entire enterprise! To the outside world, these services were <em>location transparent</em>, stateless, <em>composable</em> and <em>discoverable</em>. Indeed, we advertised this implementation as an example of SOA, and it would be hard to argue that it was not.</p>
</div>
<div class="paragraph">
<p>This suite of services had evolved organically over the years with no explicit boundaries, concepts from various parts of the organization and generations of people mixed in, each adding their own interpretation of how business functionality needed to be implemented. In essence, the implementation resembled the dreaded big ball of mud which was extremely hard to enhance and maintain.</p>
</div>
<div class="paragraph">
<p>The intentions behind SOA are noble. However, the promises of reuse, loose coupling are hard to achieve in practice given the lack of concrete implementation guidance on component granularity. It is also true that SOA <a href="https://martinfowler.com/bliki/ServiceOrientedAmbiguity.html">means many things</a><sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup> to different people. This ambiguity leads to most SOA implementations becoming complex, unmaintainable monoliths, centered around technology components like a service bus or the persistence store or both. This is where using DDD to solve a complex problem by breaking it down into subdomains and bounded contexts can be invaluable.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="microservices-architecture"><a class="anchor" href="#microservices-architecture"></a><a class="link" href="#microservices-architecture">2.1.4. Microservices architecture</a></h4>
<div class="paragraph">
<p>In the last decade or so, microservices have gained quite a lot of popularity with lots of organizations wanting to adopt this style of architecture. In a lot of ways, microservices are an extension of service-oriented architectures&#8201;&#8212;&#8201;one where a lot of emphasis is placed on creating focused components that deal with doing a limited number of things and doing them right. Sam Newman, the author of the <em>Building Microservices</em> book defines microservices as <em>small</em>-sized, independently deployable components that maintain their own state and are <strong>modeled around a business domain</strong>. This affords benefits such as adopting a horses for courses approach when modeling solutions, limiting the blast radius, improved productivity and speed, autonomous cross-functional teams, etc. Microservices usually exist as a collective, working collaboratively to achieve the desired business outcomes, as depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/architecture-styles/microservices.png" alt="microservices" width="50%">
</div>
<div class="title">Figure 1- 36. A microservices ecosystem</div>
</div>
<div class="paragraph">
<p>As we can see, SOA and microservices are very similar from the perspective of the consumers in that they access functionality through a set of standardized interfaces. The microservices approach is an evolution of SOA in that the focus now is on building smaller, self-sufficient, independently deployable components with the intent of avoiding single points of failure (like an enterprise database or service bus), which was fairly common with a number of SOA-based implementations.</p>
</div>
<div class="sect4">
<h5 id="considerations-4"><a class="anchor" href="#considerations-4"></a><a class="link" href="#considerations-4">Considerations</a></h5>
<div class="paragraph">
<p>While microservices have definitely helped, there still exists quite a lot of ambiguity when it comes to answering how <a href="https://martinfowler.com/articles/microservices.html#HowBigIsAMicroservice">big or small</a><sup class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnotedef_11" title="View footnote.">11</a>]</sup> a microservice should be. Indeed, a lot of teams seem to struggle to get this balance right, resulting in a <a href="https://www.infoq.com/news/2016/02/services-distributed-monolith/">distributed monolith</a><sup class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnotedef_12" title="View footnote.">12</a>]</sup>&#8201;&#8212;&#8201;which in a lot of ways can be much worse than even the single process monolith from the SOA days. Again, applying the strategic design concepts of DDD can help create independent, loosely coupled components, making it an ideal companion for the microservices style of architecture.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="event-driven-architecture-eda"><a class="anchor" href="#event-driven-architecture-eda"></a><a class="link" href="#event-driven-architecture-eda">2.1.5. Event-Driven Architecture (EDA)</a></h4>
<div class="paragraph">
<p>Irrespective of the granularity of components (monolith or microservices or something in between), most non-trivial solutions have a boundary, beyond which there may be a need to communicate with external system(s). This communication usually happens through the exchange of messages between systems, causing them to become coupled with each other. Coupling comes in two broad flavors: <em>afferent</em>&#8201;&#8212;&#8201;who depends on you and <em>efferent</em>&#8201;&#8212;&#8201;who you depend on. Excessive amounts of efferent coupling can make systems very brittle and hard to work with.</p>
</div>
<div class="paragraph">
<p>Event-driven systems enable authoring solutions that have a relatively low amount of efferent coupling by emitting events when they attain a certain state without caring about who consumes those events. In this regard, it is important to differentiate between message-driven and event-driven systems as mentioned in the <em>Reactive Manifesto</em>:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Message-driven versus Event-driven</div>
<div class="quoteblock">
<blockquote>
A message is an item of data that is sent to a specific destination. An event is a signal emitted by a component upon reaching a given state. In a message-driven system addressable recipients await the arrival of messages and react to them, otherwise lying dormant. In an event-driven system notification listeners are attached to the sources of events such that they are invoked when the event is emitted. This means that an event-driven system focuses on addressable event sources while a message-driven system concentrates on addressable recipients.
</blockquote>
<div class="attribution">
&#8212; Reactive Manifesto
</div>
</div>
<div class="paragraph">
<p>In simpler terms, event-driven systems do not care who the downstream consumers are, whereas in a message-driven system that may not necessarily be true. When we say event-driven in the context of this book, we mean the former.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Typically, event-driven systems eliminate the need for point-to-point messaging with the ultimate consumers by making use of an intermediary infrastructure component usually known as a message broker, event bus, etc. This effectively reduces the efferent coupling from <em>n</em> consumers to 1. There are a few variations on how event-driven systems can be implemented. In the context of publishing events, Martin Fowler talks about two broad styles (among other things)&#8201;&#8212;&#8201;event notifications and event-carried state transfer in his <a href="https://martinfowler.com/articles/201701-event-driven.html">What do you mean by "event-driven"?</a><sup class="footnote">[<a id="_footnoteref_13" class="footnote" href="#_footnotedef_13" title="View footnote.">13</a>]</sup> article.</p>
</div>
<div class="sect4">
<h5 id="considerations-5"><a class="anchor" href="#considerations-5"></a><a class="link" href="#considerations-5">Considerations</a></h5>
<div class="paragraph">
<p>One of the main trade-offs when building an event-driven system is to decide the amount of state (payload) that should be embedded in each event. It may be prudent to consider embedding just enough state indicating changes that occurred as a result of the emitted event to keep the various opposing forces such as producer scaling, encapsulation, consumer complexity, resiliency, etc. We will discuss the related implications in more detail when we cover <a href="#_implementing_the_event">implementing events</a> in Chapter 5.</p>
</div>
<div class="paragraph">
<p>Domain-driven design is all about keeping complexity in check by creating these independent bounded contexts. However, independent does not mean isolated. Bounded contexts may still need to communicate with each other. One way to do that is through the use of a fundamental DDD building block&#8201;&#8212;&#8201;domain events. Event-driven architecture and DDD are thus complementary. It is typical to make use of an event-driven architecture to allow bounded contexts to communicate while continuing to loosely coupled with each other.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cqrs_pattern"><a class="anchor" href="#_cqrs_pattern"></a><a class="link" href="#_cqrs_pattern">2.1.6. Command Query Responsibility Segregation (CQRS)</a></h4>
<div class="paragraph">
<p>In traditional applications, a single domain, data/persistence model is used to handle all kinds of operations. With CQRS, we create distinct models to handle updates (commands) and enquiries. This is depicted in the following diagram:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/cqrs/traditional-vs-cqrs-architecture.png" alt="traditional vs cqrs architecture" width="75%">
</div>
<div class="title">Figure 1- 37. Traditional versus CQRS Architecture</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We depict multiple query models above because it is possible (but not necessary) to create more than one query model, depending on the kinds of query use cases that need to be supported.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For this to work predictably, the query model(s) need to be kept in sync with the write models (we will examine some of the techniques to do that in detail later.</p>
</div>
<div class="sect4">
<h5 id="_when_to_use_cqrs"><a class="anchor" href="#_when_to_use_cqrs"></a><a class="link" href="#_when_to_use_cqrs">Considerations</a></h5>
<div class="paragraph">
<p>The traditional, single-model approach works well for simple, CRUD-style applications, but starts to become unwieldy for more complex scenarios. We discuss some of these scenarios below:</p>
</div>
<div class="sect5">
<h6 id="volume-imbalance-between-read-and-writes"><a class="anchor" href="#volume-imbalance-between-read-and-writes"></a><a class="link" href="#volume-imbalance-between-read-and-writes">Volume imbalance between read and writes</a></h6>
<div class="paragraph">
<p>In most systems, read operations often outnumber write operations by significant orders of magnitude. For example, consider the number of times a trader checks stock prices vs. the number of times they actually transact (buy or sell stock trades). It is also usually true that write operations are the ones that make businesses money. Having a single model for both reads and writes in a system with a majority of read operations can overwhelm a system to an extent where write performance can start getting affected.</p>
</div>
</div>
<div class="sect5">
<h6 id="need-for-multiple-read-representations"><a class="anchor" href="#need-for-multiple-read-representations"></a><a class="link" href="#need-for-multiple-read-representations">Need for multiple read representations</a></h6>
<div class="paragraph">
<p>When working with relatively complex systems, it is not uncommon to require more than one representation of the same data.For example, when looking at personal health data, one may want to look at a daily, weekly, monthly view.While these views can be computed on the fly from the <em>raw</em> data, each transformation (aggregation, summarization, etc.) adds to the cognitive load on the system.Several times, it is not possible to predict ahead of time, the nature of these requirements.By extension, it is not feasible to design a single canonical model that can provide answers to all these requirements.Creating domain models specifically designed to meet a focused set of requirements can be much easier.</p>
</div>
</div>
<div class="sect5">
<h6 id="different-security-requirements"><a class="anchor" href="#different-security-requirements"></a><a class="link" href="#different-security-requirements">Different security requirements</a></h6>
<div class="paragraph">
<p>Managing authorization and access requirements to data/APIs when working a single model can start to become cumbersome. For example, higher levels of security may be desirable for debit operations in comparison to balance enquiries.Having distinct models can considerably ease the complexity in designing fine-grained authorization controls.</p>
</div>
</div>
<div class="sect5">
<h6 id="more-uniform-distribution-of-complexity"><a class="anchor" href="#more-uniform-distribution-of-complexity"></a><a class="link" href="#more-uniform-distribution-of-complexity">More uniform distribution of complexity</a></h6>
<div class="paragraph">
<p>Having a model dedicated to serve only command-side use cases means that they can now be focused towards solving a single concern.For query-side use cases, we create models as needed that are distinct from the command-side model. This helps spread complexity more uniformly over a larger surface area&#8201;&#8212;&#8201;as opposed to increasing the complexity on the single model that is used to serve all use cases.It is worth noting that the essence of domain-driven design is mainly to work effectively with complex software systems and CQRS fits well with this line of thinking.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When working with a CQRS based architecture, choosing the persistence mechanism for the command side is a key decision. When working in conjunction with an event-driven architecture, one could choose to persist aggregates as a series of events (ordered in the sequence of their occurrence). This style of persistence is known as event sourcing. We will cover this in more detail in Chapter 5 in the section on <a href="#_event_sourced_aggregates">event-sourced aggregates</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_serverless_architecture"><a class="anchor" href="#_serverless_architecture"></a><a class="link" href="#_serverless_architecture">2.1.7. Serverless Architecture</a></h4>
<div class="paragraph">
<p>Serverless architecture is an approach to software design that allows developers to build and run services without having to manage the underlying infrastructure. The advent of AWS Lambda service has popularized this style of architecture, although several other services (like S3 and DynamoDB for persistence, SNS for notifications, SQS for message queuing etc.) have existed long before Lambda was launched.While AWS Lambda provided a compute solution in the form of Functions-as-a-Service (FaaS), these other services are just as essential, if not more, in order to benefit from the serverless paradigm.</p>
</div>
<div class="paragraph">
<p>In conventional DDD, bounded contexts are formed by grouping related operations around an aggregate, which then informs how the solution is deployed as a unit&#8201;&#8212;&#8201;usually within the confines of a single process. With the serverless paradigm, each operation (task) is expected to be deployed as an independent unit of its own. This requires that we look at how we model aggregates and bounded contexts differently&#8201;&#8212;&#8201;now centered around individual tasks or functions as opposed to a group of related tasks.</p>
</div>
<div class="paragraph">
<p>Does that mean that the principles of DDD to arrive at a solution do not apply anymore?While serverless introduces an additional dimension of having to treat finely-grained deployable units as first-class citizens in the modeling process, the overall process of applying DDD&#8217;s strategic and tactical design continue to apply. We will examine this in more detail in Chapter 11 when we refactor the solution we build throughout this book to employ a serverless approach.</p>
</div>
</div>
<div class="sect3">
<h4 id="_big_ball_of_mud"><a class="anchor" href="#_big_ball_of_mud"></a><a class="link" href="#_big_ball_of_mud">2.1.8. Big ball of mud</a></h4>
<div class="paragraph">
<p>Thus far, we have examined a catalog of named architecture styles along with their pitfalls and how applying DDD can help alleviate them.On the other extreme, we may encounter solutions that lack a perceivable architecture, infamously termed as the <em>big ball of mud</em>.</p>
</div>
<div class="quoteblock">
<blockquote>
A BIG BALL OF MUD is haphazardly structured, sprawling, sloppy, duct-tape and bailing wire, spaghetti code jungle. Weve all seen them. These systems show unmistakable signs of unregulated growth, and repeated, expedient repair. Information is shared promiscuously among distant elements of the system, often to the point where nearly all the important information becomes global or duplicated. The overall structure of the system may never have been well-defined. If it was, it may have eroded beyond recognition. Programmers with a shred of architectural sensibility shun these quagmires. Only those who are unconcerned about architecture, and, perhaps, are comfortable with the inertia of the day-to-day chore of patching the holes in these failing dikes, are content to work on such systems.
</blockquote>
<div class="attribution">
&#8212; Brian Foote and Joseph Yoder
</div>
</div>
<div class="paragraph">
<p>Although Foote and Yoder advise avoiding this style of architecture at all costs, software systems that resemble the big ball of mud continue to be a day-to-day inevitability for a lot of us. The strategic and tactical design elements of DDD provide a set of techniques to help deal with and recover from these near-hopeless situations in a pragmatic manner without potentially having to adopt a big bang approach. Indeed, the focus of this book is to apply these principles to prevent or at least delay further devolution towards the big ball of mud.</p>
</div>
</div>
<div class="sect3">
<h4 id="which-architecture-style-should-you-use"><a class="anchor" href="#which-architecture-style-should-you-use"></a><a class="link" href="#which-architecture-style-should-you-use">2.1.9. Which architecture style should you use?</a></h4>
<div class="paragraph">
<p>As we have seen, there are a variety of architecture styles one can lean on to when crafting a software solution. A lot of these architecture styles share quite a few common tenets. It can become difficult to claim conformance to any single architecture style. DDD, with its emphasis on breaking down complex business problems into subdomains and bounded contexts, enables the use of more than one approach across bounded contexts. We would like to make a special mention of the vertical slice architecture because it places an emphasis on dividing functionality along specific business outcomes and thus more naturally to DDD&#8217;s ideas of subdomains and bounded contexts. In reality, one may find the need to extend and even deviate from pedantic definitions of architecture styles in order to meet real-world needs. But when we do make such compromises, it is important to do so <strong>intentionally</strong> and make it unambiguously clear why we are making such a decision (preferably using some lightweight mechanism such as <a href="https://www.thoughtworks.com/de-de/radar/techniques/lightweight-architecture-decision-records">ADR</a>s<sup class="footnote">[<a id="_footnoteref_14" class="footnote" href="#_footnotedef_14" title="View footnote.">14</a>]</sup>). This is important because it may become hard to justify this to others and even ourselves when we look at it in the future.</p>
</div>
<div class="paragraph">
<p>In this section, we have examined popular architecture styles and how we can amplify their effectiveness when used in conjunction with DDD. Now let&#8217;s look at how DDD can complement the use of existing programming paradigms.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="programming-paradigms"><a class="anchor" href="#programming-paradigms"></a><a class="link" href="#programming-paradigms">2.2. Programming paradigms</a></h3>
<div class="paragraph">
<p>The tactical elements of DDD introduce a specific vocabulary (aggregates, entities, value objects, repositories, services, factories, domain events, etc.) when arriving at a solution. At the end of the day, we need to translate these concepts into running software. Over the years, we have employed a variety of programming paradigms including procedural, object-oriented, functional, aspect-oriented, etc. Is it possible to apply DDD in conjunction with one or more of these paradigms? In this section, we will explore how some common programming paradigms and techniques help us express the tactical design elements in code.</p>
</div>
<div class="sect3">
<h4 id="object-oriented-programming"><a class="anchor" href="#object-oriented-programming"></a><a class="link" href="#object-oriented-programming">2.2.1. Object-oriented programming</a></h4>
<div class="paragraph">
<p>On the surface of it, DDD seems to simply replicate a set of OO terms and call them using different names. For example, the central concepts of tactical DDD such as <code>aggregates</code>, <code>entities</code> and <code>value objects</code> could simply be referred to as objects in OO terms. Others like <code>services</code> may not have a direct OO analog. So how does one apply DDD in an object-oriented world? Let&#8217;s look at a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre>
<span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">PasswordService</span> {
    <span style="color:#0a8;font-weight:bold">String</span> generateStrongPassword();
    <span style="color:#339;font-weight:bold">boolean</span> isStrong(<span style="color:#0a8;font-weight:bold">String</span> password);
    <span style="color:#339;font-weight:bold">boolean</span> isWeak(<span style="color:#0a8;font-weight:bold">String</span> password);
}

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PasswordClient</span> {
    <span style="color:#088;font-weight:bold">private</span> PasswordService service;

    <span style="color:#339;font-weight:bold">void</span> register(<span style="color:#0a8;font-weight:bold">String</span> userEnteredPassword) {
        <span style="color:#080;font-weight:bold">if</span> (service.isStrong(userEnteredPassword)) {
            <span style="color:#777">//...</span>
        }
    }
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>OO purists will be quick to point out that the <code>PasswordService</code> is procedural and that a <code>Password</code> class might be needed to encapsulate related behaviours. Similarly, DDD enthusiasts might point out that this is an anemic domain model implementation. An arguably better object-oriented version might look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Password</span> {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> password;

    <span style="color:#088;font-weight:bold">private</span> Password(<span style="color:#0a8;font-weight:bold">String</span> password) {
        <span style="color:#950">this</span>.password = password;
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> isStrong() { ... }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">boolean</span> isWeak() { ... }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> Password generateStrongPassword() { ... }
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> Password passwordFrom(<span style="color:#0a8;font-weight:bold">String</span> password) { ... }

}

<span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">PasswordService</span> {
    Password generateStrongPassword();
    Password createPasswordFrom(<span style="color:#0a8;font-weight:bold">String</span> userEntered);
}

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PasswordClient</span> {
    <span style="color:#088;font-weight:bold">private</span> PasswordService service;

    <span style="color:#339;font-weight:bold">void</span> register(<span style="color:#0a8;font-weight:bold">String</span> userEnteredPassword) {
        Password password = service.createPasswordFrom(userEnteredPassword);
        <span style="color:#080;font-weight:bold">if</span> (password.isStrong()) {
            <span style="color:#777">// ...</span>
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the <code>Password</code> class stops exposing its internals and exposes the idea of a strong or weak password in the form of behavior (the <code>isStrong</code> and <code>isWeak</code> methods). From an OO perspective, the second implementation is arguably superior. If so, shouldn&#8217;t we be using the object-oriented version at all times? As it turns out, the answer is nuanced and depends on what the consumers desire and the ubiquitous language used in that context. If the concept of the <code>Password</code> is in common usage within the domain, it perhaps warrants introducing such a concept in the implementation as well. If not, the first solution might suffice even though it seems to violate OO principles of encapsulation.</p>
</div>
<div class="paragraph">
<p>Our default position is to apply good OO practices as a starting point. However, it is more important to mirror the language of the domain as opposed to applying OO in a dogmatic manner. So we will be willing to compromise on OO purity if it appears unnatural to do so in that context. As mentioned earlier, clearly communicating the rationale for such decisions can go a long way.</p>
</div>
</div>
<div class="sect3">
<h4 id="functional-programming"><a class="anchor" href="#functional-programming"></a><a class="link" href="#functional-programming">2.2.2. Functional programming</a></h4>
<div class="paragraph">
<p>Functions are a fundamental building block to code organization that exist in all higher order programming languages. Functional programming is a programming paradigm where programs are constructed by applying and composing functions. This is in contrast to imperative programming that uses statements to change a program&#8217;s state. The most significant differences stem from the fact that functional programming avoids side effects, which are used in imperative programming. Pure functional programming completely prevents side effects and forces immutability. Embracing a functional style when designing a domain model to be more declarative and express intent a lot more clearly while remaining terse. It also allows us to keep complexity in check by enabling us to compose more complex concepts by using simpler ones.The functional implementation allows us to use a language closer to the problem domain, while having the added benefit of also being terse. Consider a simple example where we need to find the item with the least inventory across all our warehouses using a functional style as shown here:</p>
</div>
<div class="listingblock">
<div class="title">Functional example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Functional</span> {
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> Optional&lt;Item&gt; scarcestItem(Warehouse... warehouses) {
        <span style="color:#080;font-weight:bold">return</span> Stream.of(warehouses)
                .flatMap(Warehouse::items)
                .collect(groupingBy(Item::name, summingInt(Item::quantity)))
                .entrySet().stream()
                .map(Item::<span style="color:#080;font-weight:bold">new</span>)
                .min(comparing(Item::quantity));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The imperative style shown here does get the job done, but is arguably a lot more verbose and harder to follow, sometimes even for technical team members!</p>
</div>
<div class="listingblock">
<div class="title">Imperative example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Imperative</span> {
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> Optional&lt;Item&gt; scarcestItem(Warehouse... warehouses) {
        <span style="color:#0a8;font-weight:bold">Collection</span>&lt;Item&gt; allItems = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;&gt;();
        <span style="color:#080;font-weight:bold">for</span> (Warehouse warehouse : warehouses) {
            allItems.addAll(warehouse.getItems());
        }
        <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">Integer</span>&gt; itemNamesByQuantity = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;&gt;();
        <span style="color:#080;font-weight:bold">for</span> (Item item : allItems) {
            <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> name = item.name();
            <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">int</span> quantity = item.quantity();
            <span style="color:#080;font-weight:bold">if</span> (itemNamesByQuantity.containsKey(name)) {
                itemNamesByQuantity.put(name, itemNamesByQuantity.get(name) + quantity);
            } <span style="color:#080;font-weight:bold">else</span> {
                itemNamesByQuantity.put(name, quantity);
            }
        }
        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Map</span>.Entry&lt;<span style="color:#0a8;font-weight:bold">String</span>, <span style="color:#0a8;font-weight:bold">Integer</span>&gt; min =
            <span style="color:#0a8;font-weight:bold">Collections</span>.min(itemNamesByQuantity.entrySet(), <span style="color:#0a8;font-weight:bold">Map</span>.Entry.comparingByValue());
        <span style="color:#080;font-weight:bold">return</span> min != <span style="color:#069">null</span> ? Optional.of(<span style="color:#080;font-weight:bold">new</span> Item(min)) : Optional.empty();

    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>From a DDD perspective, this yields a few benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Increase collaboration with domain experts</strong> because the declarative style allows placing a bigger focus on the what, rather than the how. This makes it a lot less intimidating to technical and non-technical stakeholders alike to work with on an ongoing basis.</p>
</li>
<li>
<p><strong>Better testability</strong>: because the use of pure functions (those that are side effect free) makes it easier to create data-driven tests. This has also afforded us an additional benefit of less mocking/stubbing. These characteristics make tests that are a lot easier to maintain and reason about. This has the benefit of allowing even technical team members to visualize corner cases a lot earlier in the process.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="which-paradigm-should-you-choose"><a class="anchor" href="#which-paradigm-should-you-choose"></a><a class="link" href="#which-paradigm-should-you-choose">2.2.3. Which paradigm should you choose?</a></h4>
<div class="paragraph">
<p>DDD simply states that you should build your software around a domain model that represents the actual problem that the software is trying to solve. When encountered with complex real-life problems, often we will find it hard to conform to any single paradigm across the board. Looking to use a one-size-fits-all approach may work to one&#8217;s detriment. Our experience indicates that we will need to make use of a variety of techniques in order to solve the problem at hand elegantly. Java is inherently an object-oriented language. But with the advent of Java 8, it has started to embrace a variety of functional constructs as well. This allows us to make use of a multitude of techniques to create elegant solutions. The most important thing is to agree on the ubiquitous language and allow it to guide the approach taken. It also largely depends on the talent and experience one has at their disposal. Making use of a style that is foreign to a majority of the team will likely prove counter-productive. Although we haven&#8217;t covered the procedural paradigm here in this text, there may be occasions where it might be the best solution given the current situation. As long as we are intentional about areas where we deviate from the accepted norm for a particular programming paradigm, we should be in a reasonably good place.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary-2"><a class="anchor" href="#summary-2"></a><a class="link" href="#summary-2">2.3. Summary</a></h3>
<div class="paragraph">
<p>In this chapter, we covered a series of commonly used architecture patterns and how we can practice DDD when working with them. We also looked at common pitfalls and gotchas that one may need to be cognizant of when using these architectures. We also looked at popular programming paradigms and their influence on the tactical elements of DDD.</p>
</div>
<div class="paragraph">
<p>Additionally, you should have an appreciation of the various architecture styles that we need to employ when coming up with a solution. In addition, you should have an understanding of how DDD can play a role no matter which style of architecture you choose to adopt.</p>
</div>
<div class="paragraph">
<p>In the next section, we will look to apply all the learnings in this and previous chapters against a real-world business use case. We will apply both the strategic and tactical patterns of DDD to break a complex domain into subdomains, bounded contexts and iteratively build a solution using technologies that are based on the Java programming language.</p>
</div>
</div>
<div class="sect2">
<h3 id="questions-2"><a class="anchor" href="#questions-2"></a><a class="link" href="#questions-2">2.4. Questions</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>What architecture style(s) are you using in your current ecosystem? Are you seeing any of the common pitfalls that we have covered in this chapter?</p>
</li>
<li>
<p>Do you see merit in employing a hybrid of the architecture approaches covered here?</p>
</li>
<li>
<p>What programming paradigms are you employing in your current ecosystem?</p>
</li>
<li>
<p>Are there areas where you have had to violate principles that are strictly aligned with any given paradigm or approach? Are these deviations well understood and documented?</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<h1 id="part-2-implementing-ddd-in-the-real-world" class="sect0"><a class="anchor" href="#part-2-implementing-ddd-in-the-real-world"></a><a class="link" href="#part-2-implementing-ddd-in-the-real-world">Part 2: Implementing DDD in the real world</a></h1>
<div class="openblock partintro">
<div class="content">
In the first section of this book, we looked at the mechanics of domain driven design and how it fits in the context of commonly used architecture styles and programming paradigms. In this section, we will implement a real-world application employing a bunch of techniques and practices that enable us to apply the tenets of DDD&#8217;s strategic and tactical design.
</div>
</div>
<div class="sect1 text-justify">
<h2 id="understanding-the-domain"><a class="anchor" href="#understanding-the-domain"></a><a class="link" href="#understanding-the-domain">3. Understanding the Domain</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
A spoon does not know the taste of soup, nor a learned fool the taste of wisdom.
</blockquote>
<div class="attribution">
&#8212; Welsh Proverb
</div>
</div>
<div class="sect2">
<h3 id="introduction-2"><a class="anchor" href="#introduction-2"></a><a class="link" href="#introduction-2">3.1. Introduction</a></h3>
<div class="paragraph">
<p>In this chapter, we will introduce a fictitious organization named <em>KP Bank</em> that is looking to modernize its product offerings in the international trade business. In order to establish a business strategy that sets them up for sustained success in the medium to long term, we will employ a series of techniques and practices to help expedite their path from strategy to execution.</p>
</div>
<div class="paragraph">
<p>At the end of this chapter, you will gain an appreciation of how to employ techniques like the business value canvas and the lean canvas to establish a sound understanding of the business strategy. Furthermore, we will examine how plotting an impact map will allow us to correlate business deliverables to goals. Finally, the Wardley mapping exercise will allow to establish the importance of our business decisions in relation to our competitive landscape.</p>
</div>
<div class="paragraph">
<p>At the outset, let&#8217;s gain a high level understanding of KB Bank&#8217;s business domain before we start diving deeper.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-domain-of-international-trade"><a class="anchor" href="#the-domain-of-international-trade"></a><a class="link" href="#the-domain-of-international-trade">3.2. The domain of international trade</a></h3>
<div class="paragraph">
<p>In many countries, international trade represents a significant portion of the gross domestic product (GDP)&#8201;&#8212;&#8201;making an exchange of capital, goods, and services between untrusted parties spread across the globe a necessity.
While economic organizations such as the World Trade Organization (WTO) were formed specifically to ease and facilitate this process, differences in factors such as economic policy, trade laws, currency, etc. ensure that carrying out trade internationally can be a complex process with several entities involved across countries. A binding contract between all parties involved, called a <em>Letter of Credit</em> exists to simplify this process. Let&#8217;s take a look at how they work.</p>
</div>
</div>
<div class="sect2">
<h3 id="international-trade-at-kp-bank"><a class="anchor" href="#international-trade-at-kp-bank"></a><a class="link" href="#international-trade-at-kp-bank">3.3. International trade at KP Bank</a></h3>
<div class="paragraph">
<p>Kosmo Primo (KP) Bank has been in business for the last several years and has been focusing on providing a variety of banking solutions such as retail, corporate, securities and other products. They have been steadily expanding operations to other countries and continents. This has allowed them to expand their international trade business significantly in the last decade or so. While they have been among the leaders in this space, the recent onset of new digital-native competitors has started to eat into their business and impacting their top-line adversely. Customers are complaining that the process is too cumbersome, time-consuming and lately unreliable. In addition, due to a very inefficient, manual process that is currently in place, KP Bank has been finding it very hard to keep a check on costs. Just in the last three years, they have had to increase transaction processing costs by around fifty percent! Not surprisingly, this has coincided with plummeting customer satisfaction&#8201;&#8212;&#8201;which is evidenced by the fact that the number of customers serviced has remained flat over the intervening time.</p>
</div>
<div class="paragraph">
<p>The CIO has recognized that there is a need to look at this problem afresh and come up with a strategy that sets KP Bank up for sustained success for the next several years and re-establish them as one of the leaders in the international trade business.</p>
</div>
</div>
<div class="sect2">
<h3 id="understanding-international-trade-strategy-at-kp-bank"><a class="anchor" href="#understanding-international-trade-strategy-at-kp-bank"></a><a class="link" href="#understanding-international-trade-strategy-at-kp-bank">3.4. Understanding international trade strategy at KP Bank</a></h3>
<div class="paragraph">
<p>To arrive at an optimal solution, it is important to have a strong appreciation of the business goals and their alignment to support the needs of the users of the solution. We introduce a set of tools and techniques we have found to be useful.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is pertinent to note that these tools were conceived independently, but when practiced in conjunction with other DDD techniques can accentuate the effectiveness of the overall process and solution. The use of these should be considered to be complementary in your DDD journey.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at some of the most populars techniques we have employed to quickly gain understanding of the business problem and propose solutions.</p>
</div>
<div class="sect3">
<h4 id="business-model-canvas"><a class="anchor" href="#business-model-canvas"></a><a class="link" href="#business-model-canvas">3.4.1. Business model canvas</a></h4>
<div class="paragraph">
<p>As we have mentioned several times, it is important to make sure that we are solving the right problem before attempting to solving it right. The business model canvas, originally conceived by Swiss consultant Alexander Osterwalder as part of his Ph.D. thesis, is a quick and easy way to establish that we are solving a valuable problem in a single visual that captures nine elements of your business namely:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Value propositions</em>: what do you do?</p>
</li>
<li>
<p><em>Key activities</em>: how do you do it?</p>
</li>
<li>
<p><em>Key resources</em>: what do you need?</p>
</li>
<li>
<p><em>Key partners</em>: who will help you?</p>
</li>
<li>
<p><em>Cost structure</em>: what will it cost?</p>
</li>
<li>
<p><em>Revenue streams</em>: how much will you make?</p>
</li>
<li>
<p><em>Customer segments</em>: who are you creating value for?</p>
</li>
<li>
<p><em>Customer relationships</em>: who do you interact with?</p>
</li>
<li>
<p><em>Channels</em>: How do you reach your customers?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The business model canvas helps establish a shared understanding of the big picture among a varied set of groups including business stakeholders, domain experts, product owners, architects and developers. We have found it very useful when embarking on both greenfield and brownfield engagements alike. Here is an attempt we made to create the business model canvas for the international trade business at KP Bank:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/business-model-canvas-kp-bank.png" alt="business model canvas kp bank">
</div>
<div class="title">Figure 1- 38. Business model canvas for the international trade business at KP Bank</div>
</div>
<div class="paragraph">
<p>Using this canvas leads to insights about the customers we intend to serve at the bank, what value propositions are offered through what channels, and how we make money. When developing a business model canvas, it is recommended that we follow the numbered sequence depicted above in order to gain a better understanding of the:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Desirability of the business (who our customers are what they want).</p>
</li>
<li>
<p>Feasibility of the business (how we can operationalize and deliver it).</p>
</li>
<li>
<p>Economic viability of the business (how we can identify costs and capture profits).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Creating the business model canvas can prove challenging if you do not have an existing product already&#8201;&#8212;&#8201;which is usually true in case of startups or existing enterprises expanding into new business areas. In such cases, a variation in the form of the lean canvas is worth exploring.</p>
</div>
</div>
<div class="sect3">
<h4 id="lean-canvas"><a class="anchor" href="#lean-canvas"></a><a class="link" href="#lean-canvas">3.4.2. Lean canvas</a></h4>
<div class="paragraph">
<p>A variation of the business model canvas, called the <em>lean canvas</em> was conceived by Ash Maurya for lean startups. In contrast to the business model canvas, the main emphasis here is to first and foremost elaborate on the problem that needs to be solved and explore potential solutions. In order to make the canvas actionable, idea was to capture items which were most uncertain and/or risky. This is pertinent for businesses operating under high uncertainty (which is usually true for startups). Similar to DDD, it encourages focusing on the issue as the starting point for building a business.</p>
</div>
<div class="paragraph">
<p>Structurally, it is similar to the business model canvas, with the following differences:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong><em>Problem</em></strong> instead of <em>Key Partners</em>: because it is common for businesses to fail due to misunderstanding the problem they are solving. The rationale for replacing the <em>Key Partners</em> block is that when you are an unknown entity looking to establish an unproven product, pursuing key partnerships may be too premature.</p>
</li>
<li>
<p><strong><em>Solutions</em></strong> instead of <em>Key Activities</em>: because  it is important to try more than one solution iteratively and respond to feedback. <em>Key Activities</em> is removed because they are usually a by-product of the solution.</p>
</li>
<li>
<p><strong><em>Key Metrics</em></strong> instead of <em>Key Resources</em>: because it is very important to know that we are progressing in the right direction. It is advisable to focus on a small number of <strong>key metrics</strong> to enable pivoting quickly if needed. <em>Key Resources</em> is removed because developing new products may not be as resource-intensive in the current climate. Furthermore, they may appear in the <em>Unfair Advantage</em> box, which we discuss next.</p>
</li>
<li>
<p><strong><em>Unfair Advantage</em></strong> instead of <em>Customer Relationships</em>: because it clearly establishes our differentiators that are hard to replicate. This is closely aligned to the idea of the <a href="#_types_of_subdomains">core subdomain</a> we discussed in chapter 1 and gives us a clear picture of what we need to focus our energies on at the outset.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We have shown the result of a lean canvas workshop we ran for KP Bank here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lean-value-canvas-kp-bank.png" alt="lean value canvas kp bank">
</div>
<div class="title">Figure 1- 39. Lean canvas for the international trade business at KP Bank</div>
</div>
<div class="paragraph">
<p>The exact sequence in which to fill out the lean canvas may vary. Ash Maurya himself suggests that there may not be a prescriptive run order to do this exercise on his <a href="https://blog.leanstack.com/what-is-the-right-fill-order-for-a-lean-canvas/">blog</a><sup class="footnote">[<a id="_footnoteref_15" class="footnote" href="#_footnotedef_15" title="View footnote.">15</a>]</sup>. Personally, we like starting from elaborating on the problem before moving on to other aspects of the canvas. Both the business model canvas and the lean canvas provide a high level view into the business model and the high priority problems and the potential solutions. Next, let&#8217;s look at impact mapping, which is another lightweight planning technique to arrive at an outcome driven plan based on mind maps.</p>
</div>
</div>
<div class="sect3">
<h4 id="impact-maps"><a class="anchor" href="#impact-maps"></a><a class="link" href="#impact-maps">3.4.3. Impact maps</a></h4>
<div class="paragraph">
<p>An impact map is a visualisation and a strategic planning tool that enables understanding scope and underlying assumptions. It is created collaboratively by senior technical and business people in the form of a mind-map by considering the following four aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Goals</em>: <strong>Why</strong> are we doing this?</p>
</li>
<li>
<p><em>Actors</em>: <strong>Who</strong> are the consumers or users of our product? In other words, who will be impacted by it.</p>
</li>
<li>
<p><em>Impacts</em>: <strong>How</strong> can the consumers' change in behavior help achieve our goals? In other words, the impacts that were trying to create.</p>
</li>
<li>
<p><em>Deliverables</em>: <strong>What</strong> we can do, as an organisation or a delivery team, to support the required impacts? In other words, the software features or process changes required to be realized as part of the solution.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/impact-mapping-kp-bank.png" alt="impact mapping kp bank" width="75%">
</div>
<div class="title">Figure 1- 40. A simple impact map for KP Bank&#8217;s international trade business</div>
</div>
<div class="paragraph">
<p>Impact mapping provides an easy to understand visual representation of the relationship between the goals, the users and the impacts to the deliverables. Next, let us examine Wardley maps which enables us to dive deeper, understand our purpose and determine which portions of the business provide the most value.</p>
</div>
</div>
<div class="sect3">
<h4 id="wardley-maps"><a class="anchor" href="#wardley-maps"></a><a class="link" href="#wardley-maps">3.4.4. Wardley maps</a></h4>
<div class="paragraph">
<p>The business model canvas and lean canvas can help establish clarity of purpose at a high level. The Wardley map is another tool to help build a business strategy and establish purpose. It provides a sketch of the people that the system is built for, followed by the benefits the system offers them and a chain of needs required to provide those benefits (called the <em>value chain</em>). Next the value chain is plotted along an evolution axis which ranges from something that is uncharted and uncertain to something that is highly standardized. When building a Wardley map, it can be done in six steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Purpose</strong>: What is your purpose? Why does the organization or project exist?</p>
</li>
<li>
<p><strong>Scope</strong>: What is (and not) included within the scope of the map.</p>
</li>
<li>
<p><strong>Users</strong>: Who uses or interacts with the thing you are mapping?</p>
</li>
<li>
<p><strong>User needs</strong>: What do your users need from the thing you are mapping?</p>
</li>
<li>
<p><strong>Value chain</strong>: What do we need to be doing to fulfill those needs captured above? These needs are arranged according to their dependencies&#8201;&#8212;&#8201;resulting in the creation of a value chain that maps user needs to a series of activities in the order of their visibility to the user (going from most visible to the least).</p>
</li>
<li>
<p><strong>Map</strong>: Finally, plot the map using the evolutionary characteristics to decide where to place each component along the horizontal axis.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We conducted a Wardley mapping exercise at KP Bank for their international trade business as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/wardley-map-canvas-kp-bank.jpeg" alt="wardley map canvas kp bank">
</div>
<div class="title">Figure 1- 41. Wardley map for the international trade business at KP Bank</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On this canvas, we have chosen to elaborate the needs of only one class of users (Importers and Exporters) for brevity. In a real-world scenario, we would have to repeat steps 4, 5 and 6 for all types of users.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Wardley map makes it easy to understand the capabilities provided by our solution, their dependencies and how value is derived. It also helps depict how these capabilities play out in comparison to those offered by competitors, allowing you to prioritize attention appropriately and make build versus buy decisions.</p>
</div>
<div class="paragraph">
<p>We have examined a number of lightweight and collaborative techniques to quickly gain an understanding of the problem space and the impacts we can have on our users and to our business. Each of these techniques is fairly lightweight and can be completed within a matter of a few hours. Each enables us to zoom in on the most impactful areas of the business and maximize ROI. In our experience, it is worth experimenting with more than one of these exercises (potentially all of them) as each can highlight a different facet of the business/user needs.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="international-trade-products-and-services"><a class="anchor" href="#international-trade-products-and-services"></a><a class="link" href="#international-trade-products-and-services">3.5. International trade products and services</a></h3>
<div class="paragraph">
<p>International trade is fraught with risk, which then presents a degree of uncertainty over the timing of payments between the seller (exporter) and the buyer (importer), especially due to the lack of trust between the parties involved. For exporters, until payment is received, all sales are gifts. Consequently, exporters prefer receiving payment as soon as the order is placed or at least before the goods are shipped. For importers, until the goods are received, all payments made towards a purchase are donations. Consequently, importers prefer receiving goods as soon as possible and delaying payment until the goods are resold to generate enough money to pay the seller.</p>
</div>
<div class="paragraph">
<p>This situation presents an opportunity for trusted intermediaries (such as KP Bank) to play a significant role in brokering international trade transactions in a secure manner. When it comes to KP bank, it offers a number of products to facilitate international trade payments as listed here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Letter of Credit (LC)</p>
</li>
<li>
<p>Documentary Collections (DC)</p>
</li>
<li>
<p>Open Account</p>
</li>
<li>
<p>Cash-in-advance</p>
</li>
<li>
<p>Consignments</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The diagram below shows the risk profile of each of these payment methods from both an exporter&#8217;s and importer&#8217;s perspective:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/international-trade-payment-methods.png" alt="international trade payment methods">
</div>
<div class="title">Figure 1- 42. Risk profile of international trade payment methods</div>
</div>
<div class="paragraph">
<p>As is evident here, the Documentary Collections and Letter of Credit products offer a good balance in providing solutions that are relatively secure from the perspective of both parties. The involvement of trusted intermediaries like KP Bank are required to play in the fulfillment process makes these payment methods less risky for both parties. From the bank&#8217;s perspective, streamlining the process for these products on a priority also provides a greater business opportunity compared to the other products. Between the two, the Letter of Credit product satisfies most criteria outlined against user needs in the recently concluded business strategy sessions we elaborated above. Hence, the stakeholders at KP Bank have decided to move forward with investing heavily against the Letter of Credit product at the outset.</p>
</div>
<div class="paragraph">
<p>In the next chapter, and indeed the rest of the book, we will elaborate on how we can improve the Letter of Credit application, issuance and related processes making use of tenets that align closely with the tenets of DDD.</p>
</div>
</div>
<div class="sect2">
<h3 id="summary-3"><a class="anchor" href="#summary-3"></a><a class="link" href="#summary-3">3.6. Summary</a></h3>
<div class="paragraph">
<p>In this chapter, we have explored a variety of techniques that help establish whether a problem is the right one to be solving. Specifically, we looked at business value canvas and the lean canvas to clarify the business strategy for both startups and established enterprises alike. We then looked at impact maps that enable you to unambiguously correlate business goals to user impacts and the deliverables needed to create that impact. Finally, we looked at Wardley maps to further drill down areas that are important to focus energies on through establishing build versus buy decisions and the importance of business strategy in relation to the competitors and the relative risk involved when treading on uncharted waters.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will look at techniques and practices to drill down further and gain an understanding of the Letter of Credit business so that we can start crafting domain model(s) to enable us to arrive at an appropriate solution.</p>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-2"><a class="anchor" href="#further-reading-2"></a><a class="link" href="#further-reading-2">3.7. Further reading</a></h3>
<div class="paragraph">
<p>Learn more about lean canvas at <a href="https://blog.leanstack.com/what-is-the-right-fill-order-for-a-lean-canvas/" class="bare">https://blog.leanstack.com/what-is-the-right-fill-order-for-a-lean-canvas/</a></p>
</div>
</div>
</div>
</div>
<div class="sect1 text-justify">
<h2 id="_domain_analysis_and_modeling"><a class="anchor" href="#_domain_analysis_and_modeling"></a><a class="link" href="#_domain_analysis_and_modeling">4. Domain analysis and modeling</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
He who asks a question remains a fool for five minutes. He who does not ask remains a fool forever.
</blockquote>
<div class="attribution">
&#8212; Chinese Proverb
</div>
</div>
<div class="sect2">
<h3 id="introduction-3"><a class="anchor" href="#introduction-3"></a><a class="link" href="#introduction-3">4.1. Introduction</a></h3>
<div class="paragraph">
<p>As we saw in the previous chapter, misinterpreted requirements cause a significant portion of software projects to fail. Arriving at a shared understanding and creating a useful domain model necessitates high degrees of collaboration with domain experts. In this chapter, we will introduce the sample application we will use throughout the book and explore modeling techniques such as domain storytelling and eventstorming to enhance our collective understanding of the problem in a reliable and structured manner.</p>
</div>
<div class="paragraph">
<p>The following topics will be covered in this chapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Introducing the example application (Letter of Credit)</p>
</li>
<li>
<p>Enhancing shared understanding</p>
</li>
<li>
<p>Domain storytelling</p>
</li>
<li>
<p>EventStorming</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This chapter will help developers and architects learn how to apply these techniques in real-life situations to produce elegant software solutions that mirror the problem domain that needs to be solved. Similarly, non-technical domain experts will understand how to communicate their ideas and collaborate effectively with technical team members to accelerate the process of arriving at a shared understanding.</p>
</div>
</div>
<div class="sect2">
<h3 id="technical-requirements"><a class="anchor" href="#technical-requirements"></a><a class="link" href="#technical-requirements">4.2. Technical requirements</a></h3>
<div class="paragraph">
<p>There are no specific technical requirements for this chapter. However, given that it may become necessary to collaborate remotely as opposed to being in the same room with access to a whiteboard, it will be useful to have access to the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Digital whiteboard (like <a href="https://www.mural.co/" class="bare">https://www.mural.co/</a> or <a href="http://miro.com/" class="bare">http://miro.com/</a>)</p>
</li>
<li>
<p>Online domain storytelling modeler (like <a href="https://www.wps.de/modeler/" class="bare">https://www.wps.de/modeler/</a>)</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="understanding-letter-of-credit-lc"><a class="anchor" href="#understanding-letter-of-credit-lc"></a><a class="link" href="#understanding-letter-of-credit-lc">4.2.1. Understanding Letter of Credit (LC)</a></h4>
<div class="paragraph">
<p>Documentary Letter of Credit (LC) is a financial instrument issued by the banks as a contract between the importer (or buyer) and the exporter (or seller).
This contract specifies terms and conditions of the transaction under which importer promises to pay the exporter in exchange for the goods or services provided by the exporter.
Letter of Credit transaction typically involves multiple parties.
A simplified summary of the parties involved is described below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Importer</strong>: The buyer of the goods or services.</p>
</li>
<li>
<p><strong>Exporter</strong>: The seller of the goods or services.</p>
</li>
<li>
<p><strong>Freight Forwarder</strong>: The agency that handles shipment of goods on behalf of the exporter.
This is only applicable in cases there is an exchange of physical goods.</p>
</li>
<li>
<p><strong>Issuing Bank</strong>: The bank that the importer requests to issue the LC application.
Usually the importer has a pre-existing relationship with this bank.</p>
</li>
<li>
<p><strong>Advising Bank</strong>: The bank that informs the exporter about the issuance of the LC. This is usually a bank that is native to the exporter&#8217;s country.</p>
</li>
<li>
<p><strong>Negotiating Bank</strong>: The bank that the exporter submits documents for the shipment of goods, or the services provided.
Usually the exporter has a pre-existing relationship with this bank.</p>
</li>
<li>
<p><strong>Reimbursement Bank</strong>: The bank that reimburses the funds to the negotiating bank, at the request of the issuing bank.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to note that the same bank can play more than one role for a given transaction. In the most complex cases, there can be four distinct banks involved for a transaction (sometimes even more, but we will skip those cases for brevity).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-lc-issuance-application"><a class="anchor" href="#the-lc-issuance-application"></a><a class="link" href="#the-lc-issuance-application">4.3. The LC issuance application</a></h3>
<div class="paragraph">
<p>As discovered in the previous chapter, Kosmo Primo Bank needs us to focus on  streamlining the process used for LC application and issuance functions. In this chapter, and indeed the rest of this book, we will strive to understand, evolve, design and build a software solution to make the process more efficient by replacing the largely manual and error-prone workflows with more simplified processes based on larger amounts of automation.</p>
</div>
<div class="paragraph">
<p>We understand that unless one is an expert dealing with international trade, it is unlikely that one would have an intimate understanding of concepts like Letters of Credit (LCs). In the upcoming section, we will look at demystifying LCs and how to work with them.</p>
</div>
</div>
<div class="sect2">
<h3 id="enhancing-shared-understanding"><a class="anchor" href="#enhancing-shared-understanding"></a><a class="link" href="#enhancing-shared-understanding">4.4. Enhancing shared understanding</a></h3>
<div class="paragraph">
<p>When working with a problem where domain concepts are unclear, there is a need to arrive at a common understanding among key team members (both those that have bright ideas&#8201;&#8212;&#8201;the business/product people, and those that translate those ideas into working software&#8201;&#8212;&#8201;the software developers).
For this process to be effective, we tend to look for approaches that are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quick, informal and effective</p>
</li>
<li>
<p>Collaborative - Easy to learn and adopt for both non-technical and technical team members</p>
</li>
<li>
<p>Pictorial - because a picture can be worth a thousand words</p>
</li>
<li>
<p>Usable for both coarse grained and fine-grained scenarios</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are several means to arrive at this shared understanding.
Some commonly used approaches are listed below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>UML</p>
</li>
<li>
<p>BPMN</p>
</li>
<li>
<p>Use Cases</p>
</li>
<li>
<p>User Story Mapping</p>
</li>
<li>
<p>CRC Models</p>
</li>
<li>
<p>Data Flow Diagrams</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The above-mentioned modeling techniques have tried to formalize knowledge and express them in form of a structure diagram or text to help in delivering the business requirements as a software product. However, this attempt has not narrowed but has widened the gap between the business and the software systems. While these methods tend to work well for technical audiences, they are usually not as appealing to non-technical users.</p>
</div>
<div class="paragraph">
<p>In order to restore the balance and promote the use of techniques that can work for both parties, we will use <strong>domain storytelling</strong> and <strong>eventstorming</strong> as our means to capture business knowledge from domain experts for consumption of developers, business analysts etc.</p>
</div>
</div>
<div class="sect2">
<h3 id="domain-storytelling"><a class="anchor" href="#domain-storytelling"></a><a class="link" href="#domain-storytelling">4.5. Domain storytelling</a></h3>
<div class="quoteblock">
<blockquote>
Youre never going to kill storytelling because its built into the human plan.
We come with it.
</blockquote>
<div class="attribution">
&#8212; Margaret Atwood
</div>
</div>
<div class="sect3">
<h4 id="_introducing_domain_storytelling"><a class="anchor" href="#_introducing_domain_storytelling"></a><a class="link" href="#_introducing_domain_storytelling">4.5.1. Introducing Domain Storytelling</a></h4>
<div class="paragraph">
<p>Scientific research has now proven that learning methods that employ audiovisual aids assist both the teacher and the learners in retaining and internalizing concepts very effectively. In addition, teaching what one has learnt to someone else helps reinforce ideas and also stimulates the formation of new ones.
Domain storytelling is a collaborative modeling technique that combines a pictorial language, real-world examples, and a workshop format to serve as a very simple, quick and effective technique for sharing knowledge among team members.
Domain Storytelling is a technique invented and popularized by Stefan Hofer and Henning Schwentner based on some related work done at the University of Hamburg called <em>cooperation pictures</em>.</p>
</div>
<div class="paragraph">
<p>A pictorial notation of the technique is illustrated in the diagram below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/domain-storytelling/dst-summary.png" alt="dst summary">
</div>
<div class="title">Figure 1- 43. Domain storytelling summarized</div>
</div>
<div class="paragraph">
<p>A domain story is conveyed using the following attributes:</p>
</div>
<div class="paragraph">
<p><strong>Actors</strong> - Stories are communicated from the perspective of an actor (noun), for example, the issuing bank, who plays an active role in the context of that particular story.
It is a good practice to use the ubiquitous language for the particular domain.</p>
</div>
<div class="paragraph">
<p><strong>Work Objects</strong> - Actors act on some object, for example, applying for an LC. Again, this would be a term (noun) commonly used in the domain.</p>
</div>
<div class="paragraph">
<p><strong>Activities</strong> - Actions (verb) performed by the actor on a work object.
Represented by a labelled arrow connecting the actor and the work object.</p>
</div>
<div class="paragraph">
<p><strong>Annotations</strong> - Used to capture additional information as part of the story, usually represented in few sentences.</p>
</div>
<div class="paragraph">
<p><strong>Sequence Numbers</strong> - Usually, stories are told one sentence after the other.
Sequence numbers helps capture the sequence of the activities in a story.</p>
</div>
<div class="paragraph">
<p><strong>Groups</strong> - An outline to represent a collection of related concepts ranging from repeated/optional activities to subdomains/organizational boundaries.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-dst-for-the-lc-application"><a class="anchor" href="#using-dst-for-the-lc-application"></a><a class="link" href="#using-dst-for-the-lc-application">4.5.2. Using DST for the LC application</a></h4>
<div class="paragraph">
<p>KP Bank has a process that allows processing of LCs.
However, this process is very archaic, paper-based and manually intensive.
Very few at the bank fully understand the process end-to-end and natural attrition has meant that the process is overly complex without good reason.
So they are looking to digitize and simplify this process. DST itself is just a graphical notation which can be done in isolation. However, it is typical to not do this on your own and employ a workshop style with domain experts and software experts working collaboratively.</p>
</div>
<div class="paragraph">
<p>In this section, we will employ a DST workshop to capture the current business flow.
The following is an excerpt of such a conversation between <strong>Katie</strong>, <em>the domain expert</em> and <strong>Patrick</strong>, <em>the software developer</em>.</p>
</div>
<div class="paragraph">
<p><strong>Patrick</strong> : <em>"Can you give me a high level overview of a typical LC Flow?"</em><br>
<strong>Katie</strong> : <em>"Sure, it all begins with the importer and the exporter entering into a contract for purchase of goods or services."</em><br>
<strong>Patrick</strong> : <em>"What form does this contract take?
Is it a formal documentClause?
Or is this just a conversation?"</em><br>
<strong>Katie</strong> : <em>"This is just a conversation."</em><br>
<strong>Patrick</strong> : <em>"Oh okay.
What does the conversation cover?"</em><br>
<strong>Katie</strong> : <em>Several things&#8201;&#8212;&#8201;nature and quantity of goods, pricing details, payment terms, shipment costs and timelines, insurance, warranty, etc.
These details may be captured in a purchase order&#8201;&#8212;&#8201;which is a simple documentClause elaborating the above.</em><br></p>
</div>
<div class="paragraph">
<p>At this time, Patrick draws this part of the interaction between the importer and the exporter. This graphic is depicted in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/domain-storytelling/lc-issue-step01.png" alt="lc issue step01">
</div>
<div class="title">Figure 1- 44. Interaction between importer and exporter</div>
</div>
<div class="paragraph">
<p><strong>Patrick</strong> : <em>"Seems straight forward, so where does the bank come into the picture?"</em><br>
<strong>Katie</strong> : <em>"This is international trade and both the importer and the exporter need to mitigate the financial risk involved in such business transactions.
So they involve a bank as a trusted mediator."</em><br>
<strong>Patrick</strong> : <em>"What kind of bank is this?"</em><br>
<strong>Katie</strong> : "<em>Usually, there are multiple banks involved.
But it all starts with an <strong>issuing bank</strong>.</em>"<br>
<strong>Patrick</strong> : <em>"What is an issuing bank?"</em><br>
<strong>Katie</strong> : <em>"Any bank that is authorized to mediate international trade deals.
This has to be a bank in the importer&#8217;s country."</em><br>
<strong>Patrick</strong> : <em>"Does the importer need to have an existing relationship with this bank?"</em><br>
<strong>Katie</strong> : <em>"Not necessarily.
There may be other banks with whom the importer may have a relationship with&#8201;&#8212;&#8201;which in turn liaises with the issuing bank on the importer&#8217;s behalf.
But to keep it simple, let&#8217;s assume that the importer has an existing relationship with the issuing bank&#8201;&#8212;&#8201;which is our bank in this case."</em><br>
<strong>Patrick</strong> : <em>"Does the importer provide details of the purchase order to the issuing bank to get started?"</em><br>
<strong>Katie</strong> : <em>"Yes.
The importer provides the details of the transaction by making an <strong>LC application</strong>."</em><br></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/domain-storytelling/lc-issue-step02.png" alt="lc issue step02">
</div>
<div class="title">Figure 1- 45. Introducing the LC and the issuing bank</div>
</div>
<div class="paragraph">
<p><strong>Patrick</strong> : <em>"What does the issuing bank do when they receive this LC application?"</em><br>
<strong>Katie</strong> : <em>"Mainly two things&#8201;&#8212;&#8201;whet the financial standing of the importer and the legality of the goods being imported."</em><br>
<strong>Patrick</strong> : "Okay.
What happens if everything checks out?"<br>
<strong>Katie</strong> : <em>"The issuing bank approves the LC and notifies the importer."</em><br></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/domain-storytelling/lc-issue-step03.png" alt="lc issue step03">
</div>
<div class="title">Figure 1- 46. Notifying LC approval to the importer</div>
</div>
<div class="paragraph">
<p><strong>Patrick</strong> : <em>"What happens next?
Does the issuing bank contact the exporter now?"</em><br>
<strong>Katie</strong> : <em>"Not yet.
It is not that simple.
The issuing bank can only deal with a counterpart bank in the exporter&#8217;s country.
This bank is called the <strong>advising bank</strong>."</em><br></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/domain-storytelling/lc-issue-step04.png" alt="lc issue step04">
</div>
<div class="title">Figure 1- 47. Introducing the advising bank</div>
</div>
<div class="paragraph">
<p><strong>Patrick</strong> : <em>"What does the advising bank do?"</em><br>
<strong>Katie</strong> : <em>"The advising bank notifies the exporter about the LC."</em><br>
<strong>Patrick</strong> : <em>"Doesn&#8217;t the importer need to know that the LC has been advised?"</em><br>
<strong>Katie</strong> : <em>"Yes.
The issuing bank notifies the importer that the LC has been advised to the exporter."</em><br></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/domain-storytelling/lc-issue-step05.png" alt="lc issue step05">
</div>
<div class="title">Figure 1- 48. Advice notification to the importer</div>
</div>
<div class="paragraph">
<p><strong>Patrick</strong> : <em>"How does the exporter know how to proceed?"</em><br>
<strong>Katie</strong> : <em>"Through the advising bank&#8201;&#8212;&#8201;they notify the exporter that the LC was issued."</em><br></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/domain-storytelling/lc-issue-step06.png" alt="lc issue step06">
</div>
<div class="title">Figure 1- 49. Dispatching the advice to the exporter</div>
</div>
<div class="paragraph">
<p><strong>Patrick</strong> : <em>"Does the exporter initiate shipping at this time and how do they get paid?"</em><br>
 <strong>Katie</strong> : <em>"Through the advising bank&#8201;&#8212;&#8201;they notify the exporter that the LC was issued and this triggers the next steps in the process&#8201;&#8212;&#8201;this process of settling the payment is called <strong>settlement</strong>.
But let&#8217;s focus on issuance right now.
We will discuss settlement at a later time."</em><br></p>
</div>
<div class="paragraph">
<p>We have now looked at an excerpt of a typical DST workshop. The DST workshop has served to provide a reasonably good understanding of the high level business flow. Note that we have not referenced any technical artifacts during the process.</p>
</div>
<div class="paragraph">
<p>To be able to refine this flow and convert it into a form that can be used to design the software solution, we will need to further enhance this view. In the upcoming section, we will use EventStorming as a structured approach to achieve that.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="eventstorming"><a class="anchor" href="#eventstorming"></a><a class="link" href="#eventstorming">4.6. EventStorming</a></h3>
<div class="quoteblock">
<blockquote>
The amount of energy necessary to refute bullshit is an order of magnitude bigger than to produce it.
</blockquote>
<div class="attribution">
&#8212; Alberto Brandolini
</div>
</div>
<div class="sect3">
<h4 id="_introducing_eventstorming"><a class="anchor" href="#_introducing_eventstorming"></a><a class="link" href="#_introducing_eventstorming">4.6.1. Introducing EventStorming</a></h4>
<div class="paragraph">
<p>In the previous section, we gained a high level understanding of the LC Issuance process.
To be able to build a real-world application, it will help to use a method that delves into the next level of detail.
EventStorming, originally conceived by Alberto Brandolini, is one such method for the collaborative exploration of complex domains.</p>
</div>
<div class="paragraph">
<p>In this method, one simply starts by listing out all the events that are significant to the business domain in roughly chronological order on a wall or whiteboard using a bunch of colored sticky notes.
Each of the note types (denoted by a color) serve a specific purpose as outlined below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Domain Event</strong>: An event that is significant to the business process&#8201;&#8212;&#8201;expressed in past tense.</p>
</li>
<li>
<p><strong>Command</strong>: An action or an activity that may result in one or more domain events occurring.
This is either user initiated or system initiated, in response to a domain event.</p>
</li>
<li>
<p><strong>User</strong>: A person who performs a business action/activity.</p>
</li>
<li>
<p><strong>Policy</strong>: A set of business invariants (rules) that need to be adhered to, for an action/activity to be successfully performed.</p>
</li>
<li>
<p><strong>Query/Read Model</strong>: A piece of information required to perform an action/activity.</p>
</li>
<li>
<p><strong>External System</strong>: A system significant to the business process, but out of scope in the current context.</p>
</li>
<li>
<p><strong>Hotspot</strong>: Point of contention within the system that is likely confusing and/or puzzling beyond a small subsection of the team.</p>
</li>
<li>
<p><strong>Aggregate</strong>: An object graph whose state changes consistently and atomically. This is consistent with the definition of <a href="#_aggregates">aggregates</a> we saw in Chapter 2.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The depiction of the stickies for our EventStorming workshop is shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/event-storming/00-event-storming-summary.png" alt="00 event storming summary">
</div>
<div class="title">Figure 1- 50. EventStorming legend</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>Why domain events</strong>?
When trying to understand a business process, it is convenient to express significant facts or things that happen in that context.
It can also be informal and easy for audiences that are uninitiated with this practice.
This provides an easy to digest visual representation of the domain complexity.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="using-eventstorming-for-the-lc-issuance-application"><a class="anchor" href="#using-eventstorming-for-the-lc-issuance-application"></a><a class="link" href="#using-eventstorming-for-the-lc-issuance-application">4.6.2. Using eventStorming for the LC issuance application</a></h4>
<div class="paragraph">
<p>Now that we have a high level understanding of the current business process, thanks to the domain storytelling workshop, let&#8217;s look at how we can delve deeper using eventstorming.
The following is an excerpt of the stages from an eventstorming workshop for the same application.</p>
</div>
<div class="sect4">
<h5 id="1-outline-the-event-chronology"><a class="anchor" href="#1-outline-the-event-chronology"></a><a class="link" href="#1-outline-the-event-chronology">1. Outline the event chronology</a></h5>
<div class="paragraph">
<p>During this exercise, we recall significant <strong>domain events</strong> (using orange stickies) that happen in the system and paste them on the whiteboard, as depicted below.
We ensure that the event stickies are pasted roughly in the chronological order of occurrence.
As the timeline is enforced, the business flow will begin to emerge.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/event-storming/01-events.png" alt="01 events">
</div>
<div class="title">Figure 1- 51. Event chronology</div>
</div>
<div class="paragraph">
<p>This acts as an aid to understand the big picture.
This also enables people in the room to identify hotspots in the existing business process.
In the above illustration, we realized that, the process to handle "declined LC applications" is sub-optimal, i.e. applicants do not receive any information when their application is declined.</p>
</div>
<div class="paragraph">
<p>To address this, we added a new domain event which explicitly indicates that an application is declined, as depicted below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/event-storming/02-events.png" alt="02 events">
</div>
<div class="title">Figure 1- 52. New event to handle declined applications</div>
</div>
</div>
<div class="sect4">
<h5 id="2-identify-triggering-activities-and-external-systems"><a class="anchor" href="#2-identify-triggering-activities-and-external-systems"></a><a class="link" href="#2-identify-triggering-activities-and-external-systems">2. Identify triggering activities and external systems</a></h5>
<div class="paragraph">
<p>Having arrived at a high level understanding of event chronology, the next step is to embellish the visual with <strong>activities/actions</strong> that cause these events to occur (using blue stickies) and interactions with <strong>external systems</strong> (using pink stickies).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/event-storming/03-activities-and-external-systems.png" alt="03 activities and external systems">
</div>
<div class="title">Figure 1- 53. Activities and external systems</div>
</div>
</div>
<div class="sect4">
<h5 id="3-capture-users-context-and-policies"><a class="anchor" href="#3-capture-users-context-and-policies"></a><a class="link" href="#3-capture-users-context-and-policies">3. Capture users, context and policies</a></h5>
<div class="paragraph">
<p>The next step is to capture <strong>users</strong> who perform these activities along with their functional <strong>context</strong> (using yellow stickies) and policies (using purple stickies).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/event-storming/04-users-and-policies-full.png" alt="04 users and policies full">
</div>
<div class="title">Figure 1- 54. Users and policies</div>
</div>
</div>
<div class="sect4">
<h5 id="4-outline-query-models"><a class="anchor" href="#4-outline-query-models"></a><a class="link" href="#4-outline-query-models">4. Outline query models</a></h5>
<div class="paragraph">
<p>Every activity requires a certain set of data to be able to be performed.
Users will need to view out-of-band data that they need to act upon and also see the result of their actions.
These sets of data are represented as <strong>query models</strong> (using green stickies).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/event-storming/05-query-models.png" alt="05 query models">
</div>
<div class="title">Figure 1- 55. Big picture eventstorming workshop board</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For both the domain storytelling and eventstorming workshops, it works best when we have approximately 6-8 people participating with a right mix of domain and technology experts.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This concludes the eventstorming workshop to gain a reasonably detailed understanding of the LC application and issuance process.
Does this mean that we have concluded the domain requirements gathering process?
Not at all&#8201;&#8212;&#8201;while we have made significant strides in understanding the domain, there is still a long way to go.
The process of elaborating domain requirements is perpetual.
Where are we in this continuum?
The picture below is an attempt to clarify:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/domain-requirements-elaboration.png" alt="domain requirements elaboration">
</div>
<div class="title">Figure 1- 56. Domain requirements elaboration continuum</div>
</div>
<div class="paragraph">
<p>In subsequent chapters we will examine the other techniques in more detail.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary-4"><a class="anchor" href="#summary-4"></a><a class="link" href="#summary-4">4.7. Summary</a></h3>
<div class="paragraph">
<p>In this chapter we examined two ways to enhance our collective understanding of the problem domain using two lightweight modeling techniques&#8201;&#8212;&#8201;domain storytelling and eventstorming.</p>
</div>
<div class="paragraph">
<p>Domain storytelling uses a simple pictorial notation to share business knowledge among domain experts and technical team members.
Eventstorming, on the other hand, uses a chronological ordering of domain events that occur as part of the business process to gain that same shared understanding.</p>
</div>
<div class="paragraph">
<p>Domain storytelling can be used as an introductory technique to establish high level understanding of the problem space, while eventstorming can be used to inform detailed design decisions of the solution space.</p>
</div>
<div class="paragraph">
<p>With this knowledge, we should be able to dive deeper into the technical aspects of solution implementation. In the next chapter, we will start implementation of the business logic, model our aggregate along with commands and domain events.</p>
</div>
</div>
<div class="sect2">
<h3 id="questions-3"><a class="anchor" href="#questions-3"></a><a class="link" href="#questions-3">4.8. Questions</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When should you use domain storytelling?</p>
</li>
<li>
<p>Pick an application in your current context. Can you use domain storytelling to capture actors, work objects and activities for the scenario you picked?</p>
</li>
<li>
<p>When should you use eventstorming?</p>
</li>
<li>
<p>Pick an application in your current context. Can you use eventstorming to capture domain events, actors, actions, hotspots, query models, external systems, etc. for the scenario you picked?</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-3"><a class="anchor" href="#further-reading-3"></a><a class="link" href="#further-reading-3">4.9. Further reading</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain Storytelling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stefan Hofer and Henning Schwentner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://leanpub.com/domainstorytelling" class="bare">https://leanpub.com/domainstorytelling</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An Introduction to Domain Storytelling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Virtual Domain-Driven Design</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.youtube.com/watch?v=d9k9Szkdprk" class="bare">https://www.youtube.com/watch?v=d9k9Szkdprk</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Domain Storytelling Resources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stefan Hofer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/hofstef/awesome-domain-storytelling" class="bare">https://github.com/hofstef/awesome-domain-storytelling</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Introducing EventStorming</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alberto Brandolini</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://leanpub.com/introducing_eventstorming" class="bare">https://leanpub.com/introducing_eventstorming</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Introducing Event Storming</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alberto Brandolini</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ziobrando.blogspot.com/2013/11/introducing-event-storming.html" class="bare">https://ziobrando.blogspot.com/2013/11/introducing-event-storming.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event storming for fun and profit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dan Terhorst-North</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://speakerdeck.com/tastapod/event-storming-for-fun-and-profit" class="bare">https://speakerdeck.com/tastapod/event-storming-for-fun-and-profit</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EventStorming</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allen Holub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://holub.com/event-storming/" class="bare">https://holub.com/event-storming/</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="answers"><a class="anchor" href="#answers"></a><a class="link" href="#answers">4.10. Answers</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Refer to section <a href="#_introducing_domain_storytelling">Section 4.5.1</a></p>
</li>
<li>
<p>Share and validate the domain storytelling artifact you created with your teammates.</p>
</li>
<li>
<p>Refer to section <a href="#_introducing_eventstorming">Section 4.6.1</a></p>
</li>
<li>
<p>Share and validate the eventstorming artifact you created with your teammates.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1 text-justify">
<h2 id="_implementing_domain_logic"><a class="anchor" href="#_implementing_domain_logic"></a><a class="link" href="#_implementing_domain_logic">5. Implementing Domain Logic</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
To communicate effectively, the code must be based on the same language used to write the requirementsthe same language that the developers speak with each other and with domain experts.
</blockquote>
<div class="attribution">
&#8212; Eric Evans
</div>
</div>
<div class="paragraph">
<p>In the Command Query Responsibility Segregation (CQRS) section, we describe how DDD and CQRS complement each other and how the command side (write requests) is the home of business logic. In this chapter, we will implement the command side API for the LC application using Spring Boot and Axon Framework, JSR-303 Bean Validations and persistence options by contrasting between state-stored vs event-sourced aggregates. The list of topics to be covered is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identifying aggregates</p>
</li>
<li>
<p>Handling commands and emitting events</p>
</li>
<li>
<p>Test-driving the application</p>
</li>
<li>
<p>Persisting aggregates</p>
</li>
<li>
<p>Performing validations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By the end of this chapter, you would have learned how to implement the core of your system (the domain logic) in a robust, well encapsulated manner. You will also learn how to decouple your domain model from persistence concerns. Finally, you will be able to appreciate how to perform DDD&#8217;s tactical design using services, repositories, aggregates, entities and value objects.</p>
</div>
<div class="sect2">
<h3 id="technical-requirements-2"><a class="anchor" href="#technical-requirements-2"></a><a class="link" href="#technical-requirements-2">5.1. Technical requirements</a></h3>
<div class="paragraph">
<p>To follow the examples in this chapter, you will need access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 1.8+ (We have used Java 16 to compile sample sources)</p>
</li>
<li>
<p>Maven 3.x</p>
</li>
<li>
<p>Spring Boot 2.4.x</p>
</li>
<li>
<p>JUnit 5.7.x (Included with spring boot)</p>
</li>
<li>
<p>Axon Framework 4.4.7 (DDD and CQRS Framework)</p>
</li>
<li>
<p>Project Lombok (To reduce verbosity)</p>
</li>
<li>
<p>Moneta 1.4.x (Money and currency reference implementation - JSR 354)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="continuing-our-design-journey"><a class="anchor" href="#continuing-our-design-journey"></a><a class="link" href="#continuing-our-design-journey">5.2. Continuing our design journey</a></h3>
<div class="paragraph">
<p>In the previous chapter, we discussed eventstorming as  a lightweight method to clarify business flows. As a reminder, this is the output produced from our eventstorming session:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/event-storming/05-query-models.png" alt="05 query models">
</div>
<div class="title">Figure 1- 57. Recap of eventstorming session</div>
</div>
<div class="paragraph">
<p>As mentioned previously, the <strong>blue</strong> stickies in this diagram represent <strong>commands</strong>. We will be using the  <a href="#_cqrs_pattern">Command Query Responsibility Segregation (CQRS)</a> pattern as a high level architecture approach to implement the domain logic for our LC issuance application. Let&#8217;s examine the mechanics of using CQRS and how it can result in an elegant solution. For a recap of what CQRS is and when it is appropriate to apply this pattern, please refer to the "<a href="#_when_to_use_cqrs">When to use CQRS</a>" section in <a href="#_where_does_ddd_fit">Chapter 2</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
CQRS is by no means a silver bullet. Although it is general-purpose enough to be used in a variety of scenarios, it is a paradigm shift as applied to mainstream software problems. Like any other architecture decision, you should apply due diligence when choosing to adopt CQRS to your situation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lets look at how this works in practice by implementing a representative sliver of the <strong>command</strong> side of the Letter of Credit application using the Spring and Axon frameworks.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_the_command_side"><a class="anchor" href="#_implementing_the_command_side"></a><a class="link" href="#_implementing_the_command_side">5.3. Implementing the command side</a></h3>
<div class="paragraph">
<p>In this section, we will focus on implementing the command side of the application. This is where we expect all the business logic of the application to be implemented. Logically, it looks as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/cqrs/cqrs-command-side.png" alt="cqrs command side">
</div>
<div class="title">Figure 1- 58. CQRS application&#8201;&#8212;&#8201;command side</div>
</div>
<div class="paragraph">
<p>The high level sequence on the command side is described here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A request to mutate state (command) is received.</p>
</li>
<li>
<p>In an event-sourced system, the command model is constructed by replaying existing events that have occurred for that instance. In a state-stored system, we would simply restore state by reading state from the persistence store.</p>
</li>
<li>
<p>If business invariants (validations) are satisfied, one or more domain events are readied with the intention to be published.</p>
</li>
<li>
<p>In an event-sourced system, the domain event is persisted on the command side. In a state-stored system, we would update the state of the instance in the persistence store.</p>
</li>
<li>
<p>The external world is notified by publishing these domain events onto an event bus. The event bus is an infrastructure component onto which events are published.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how we can implement this in the context of our Letter of Credit (LC) issuance application.</p>
</div>
<div class="sect3">
<h4 id="tooling-choices"><a class="anchor" href="#tooling-choices"></a><a class="link" href="#tooling-choices">5.3.1. Tooling choices</a></h4>
<div class="paragraph">
<p>Implementing CQRS does not require the use of any framework. Greg Young, who is considered the father of the CQRS pattern, advises against rolling our own CQRS framework in this <a href="https://ordina-jworks.github.io/domain-driven%20design/2016/02/02/A-Decade-Of-DDD-CQRS-And-Event-Sourcing.html">essay</a><sup class="footnote">[<a id="_footnoteref_16" class="footnote" href="#_footnotedef_16" title="View footnote.">16</a>]</sup>, which is worth taking a look at. Using a <em>good</em> framework can help enhance developer effectiveness and accelerate the delivery of business functionality, while abstracting the low-level plumbing and non-functional requirements without limiting flexibility. In this book we will make use of the <a href="http://axonframework.org/">Axon Framework</a><sup class="footnote">[<a id="_footnoteref_17" class="footnote" href="#_footnotedef_17" title="View footnote.">17</a>]</sup> to implement application functionality as we have real-world experience of having used it in large scale enterprise development with success. There are other frameworks that work comparably, like <a href="https://www.lagomframework.com/">Lagom Framework</a><sup class="footnote">[<a id="_footnoteref_18" class="footnote" href="#_footnotedef_18" title="View footnote.">18</a>]</sup> and <a href="https://eventuate.io/">Eventuate</a><sup class="footnote">[<a id="_footnoteref_19" class="footnote" href="#_footnotedef_19" title="View footnote.">19</a>]</sup> that are worth exploring as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bootstapping_the_application"><a class="anchor" href="#_bootstapping_the_application"></a><a class="link" href="#_bootstapping_the_application">5.3.2. Bootstrapping the application</a></h4>
<div class="paragraph">
<p>To get started, let&#8217;s create a simple spring boot application. There are several ways to do this. You can always use the Spring starter application at <a href="https://start.spring.io" class="bare">https://start.spring.io</a> to create this application. Here, we will make use of the <code>spring</code> CLI to bootstrap the application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To install the <code>spring</code> CLI for your platform, please refer to the detailed instructions at <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.installing" class="bare">https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.installing</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To bootstrap the application, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>spring init \
      --dependencies 'web,data-jpa,lombok,validation,h2,actuator' \
      --name lc-issuance-api \
      --artifactId lc-issuance-api \
      --groupId com.example.api \
      --packaging jar \
      --description 'LC Issuance API' \
      --package-name com.example.api \
      --force</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The entire command is split into multiple lines for better readability. Unix based operating systems requires us to use backslash [ \ ] character to split the command into multiple lines. If you are using Windows OS, then please make sure to replace the backslash character with back-tick [ ` &nbsp; ] character before running the command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This should create a file named <code>lc-issuance-api.zip</code> in the current directory. Unzip this file to a location of your choice and add a dependency on the Axon framework in the <code>dependencies</code> section of the <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.axonframework<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>axon-spring-boot-starter<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${axon-framework.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You may need to change the version. We are at version <code>4.5.3</code> at the time of writing this book.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also, add the following dependency on the <code>axon-test</code> library to enable unit testing of aggregates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.axonframework<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>axon-test<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#070;font-weight:bold">&lt;/scope&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${axon-framework.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the above set up, you should be able to run the application and start implementing the LC issuance functionality.</p>
</div>
</div>
<div class="sect3">
<h4 id="identifying-commands"><a class="anchor" href="#identifying-commands"></a><a class="link" href="#identifying-commands">5.3.3. Identifying commands</a></h4>
<div class="paragraph">
<p>From the eventstorming session in the previous chapter, we have the following commands to start with:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/potential-commands.png" alt="potential commands" width="680" height="408">
</div>
<div class="title">Figure 1- 59. Identified commands</div>
</div>
<div class="paragraph">
<p>Commands are always directed to an aggregate (the root entity) for processing (handling). This means that we need to resolve each of these commands to be handled by an aggregate. While the sender of the command does not care which component within the system handles it, we need to decide which aggregate will handle each command. It is also important to note that any given command can only be handled by a single aggregate within the system. Let&#8217;s look at how to group these commands and assign them to aggregates. To be able to do that, we need to identify the aggregates in the system first.</p>
</div>
</div>
<div class="sect3">
<h4 id="_identifying_aggregates"><a class="anchor" href="#_identifying_aggregates"></a><a class="link" href="#_identifying_aggregates">5.3.4. Identifying aggregates</a></h4>
<div class="paragraph">
<p>Looking at the output of the eventstorming session of our LC (Letter of Credit) application, one potential grouping of commands can be as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/aggregate-design/aggregate-design-01.png" alt="aggregate design 01">
</div>
<div class="title">Figure 1- 60. First cut attempt at aggregate design</div>
</div>
<div class="paragraph">
<p>Before we arrive at aggregates, the grouping above allows us to identify entities. Some or all of these entities may be aggregates (For a more detailed explanation on the difference between <a href="#_aggregates">aggregates</a> and <a href="#_entities">entities</a>, please refer to <a href="#_the_rationale_for_domain_driven_design">Chapter 1</a>
).</p>
</div>
<div class="paragraph">
<p>At first glance, it appears that we have four potential aggregates to handle these commands:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/potential-aggregates.png" alt="potential aggregates" width="304" height="237">
</div>
<div class="title">Figure 1- 61. Potential aggregates at first glance</div>
</div>
<div class="paragraph">
<p>However, it is a bit more nuanced than that. Before we conclude this conversation on aggregates, let&#8217;s also examine our current organizational structures because they can and will play a very influential role in how we choose aggregates. When implementing the solution, these organizational structures decompose into bounded contexts, so let&#8217;s also examine how that works.</p>
</div>
</div>
<div class="sect3">
<h4 id="discovering-bounded-contexts"><a class="anchor" href="#discovering-bounded-contexts"></a><a class="link" href="#discovering-bounded-contexts">5.3.5. Discovering bounded contexts</a></h4>
<div class="paragraph">
<p>Our current organization is segregated to handle the business functions outlined here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application.png" alt="lc application" width="410" height="251">
</div>
</div>
<div class="paragraph">
<p>As a starting point, we can use these business functions as natural boundaries to act as <a href="#_bounded_contexts">bounded contexts</a> for our solution. We may evolve this design in the future as we gain more understanding of the problem and the solution, but for now, this will suffice. Aggregates live within the confines of a single bounded context, so we need to correlate the two concepts. Let&#8217;s look at how this works.</p>
</div>
</div>
<div class="sect3">
<h4 id="correlating-aggregates-to-bounded-contexts"><a class="anchor" href="#correlating-aggregates-to-bounded-contexts"></a><a class="link" href="#correlating-aggregates-to-bounded-contexts">5.3.6. Correlating aggregates to bounded contexts</a></h4>
<div class="paragraph">
<p>If we examine the lifecycle of the letter of credit (LC) as a whole, we notice the structure outlined here. Each of these bounded contexts work with the same entities, but call them by different names making use of their own ubiquitous language. The context map for the system looks like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application.png" alt="lc application" width="529" height="533">
</div>
<div class="title">Figure 1- 62. Relationship between bounded contexts</div>
</div>
<div class="paragraph">
<p>Notice how the <code>Customer</code> in the Customer Onboarding bounded context is called an <code>Applicant</code> in the LC Application Processing context. Similarly, Compliance works with a <code>Product</code> entity, whereas LC Application Processing calls it <code>Merchandise</code>. Within the LC Application Processing bounded context, we always work within the purview of an <code>LC Application</code>, not directly with either the <code>Applicant</code> or the <code>Merchandise</code>. This leads us to the conclusion (at least for now), that the <code>Applicant</code> and <code>Merchandise</code> entities are not aggregates within the LC Application Processing context. The <code>LC Application</code> entity acts as the <strong>aggregate</strong> for this bounded context. Furthermore, it is at the root of the aggregate hierarchy, hence it is termed as the <strong>aggregate root</strong>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The terms aggregate and aggregate root are sometimes used interchangeably to mean the same thing. While both aggregates and aggregate roots handle commands, only one aggregate can exist as the root in a given context, and it encapsulates access to its child aggregates, entities and value objects.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is important to note that entities may be required to be treated as aggregates in a different bounded context and this kind of treatment is entirely context dependent.</p>
</div>
<div class="paragraph">
<p>When we look at the output of our eventstorming session, the <code>LC Application</code> transitions to become an <code>LC</code> much later in the lifecycle in the Issuance context. Our focus right now is to optimize and automate the LC application flow of the overall issuance process. Now that we have settled on working with the <code>LC Application</code> aggregate (root), let&#8217;s start writing our first command to see how this manifests itself in code.</p>
</div>
</div>
<div class="sect3">
<h4 id="test-driving-the-system"><a class="anchor" href="#test-driving-the-system"></a><a class="link" href="#test-driving-the-system">5.3.7. Test-driving the system</a></h4>
<div class="paragraph">
<p>While we have a reasonably good conceptual understanding of the system, we are still in the process of refining this understanding. Test-driving the system allows us to exercise our understanding by acting as the first client of the solution that we are producing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The practice of test-driving the system is very well illustrated in the best-selling book&#8201;&#8212;&#8201;<em>Growing Object-Oriented Software, Guided by Tests</em> by authors Nat Price and Steve Freeman. This is worth looking at, to gain a deeper understanding of this practice.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So let&#8217;s start with the first test. To the external world, an event-driven system typically works in a manner depicted below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/event-driven-system.png" alt="event driven system">
</div>
<div class="title">Figure 1- 63. An event-driven system</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An optional set of domain events may have occurred in the past.</p>
</li>
<li>
<p>A command is received by the system (initiated manually by a user or automatically by a part of the system), which acts as a stimulus.</p>
</li>
<li>
<p>The command is handled by an aggregate which then proceeds to validate the received command to enforce invariants (structural and domain validations).</p>
</li>
<li>
<p>The system then reacts in one of two ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Emit one or more events</p>
</li>
<li>
<p>Throw an exception</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Axon framework allows us to express tests in the following form.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code snippets shown in this chapter are excerpts to highlight significant concepts and techniques. For the full working example, please refer to the accompanying source code for this chapter (included in the ch05 directory).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {

    <span style="color:#088;font-weight:bold">private</span> FixtureConfiguration&lt;LCApplication&gt; fixture;                          <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> setUp() {
        fixture = <span style="color:#080;font-weight:bold">new</span> AggregateTestFixture&lt;&gt;(LCApplication.class);                <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldPublishLCApplicationCreated() {
        fixture.given()                                                           <i class="conum" data-value="3"></i><b>(3)</b>

                .when(<span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommand())                           <i class="conum" data-value="4"></i><b>(4)</b>

                .expectEventsMatching(exactSequenceOf(                            <i class="conum" data-value="5"></i><b>(5)</b>
                        messageWithPayload(any(LCApplicationCreatedEvent.class)), <i class="conum" data-value="6"></i><b>(6)</b>
                        andNoMore()                                               <i class="conum" data-value="7"></i><b>(7)</b>
                ));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>FixtureConfiguration</code> is an Axon framework utility to aid testing of aggregate behaviour using a BDD style given-when-then syntax.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>AggregateTestFixture</code> is a concrete implementation of <code>FixtureConfiguration</code> where you need to register your aggregate class&#8201;&#8212;&#8201;<code>LCApplication</code> in our case as the candidate to handle commands directed to our solution.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Since this is the start of the business process, there are no events that have occurred thus far. This is signified by the fact that we do not pass any arguments to the <code>given</code> method. In other examples we will discuss later, there will likely be events that have already occurred prior to receiving this command.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is where we instantiate a new instance of the command object. Command objects are usually similar to data transfer objects, carrying a set of information. This command will be routed to our aggregate for handling. We will take a look at how this works in detail shortly.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here we are declaring that we expect events matching an exact sequence.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here we are expecting an event of type <code>LCApplicationCreated</code> to be emitted as a result of successfully handling the command.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>We are finally saying that we do not expect any more events&#8201;&#8212;&#8201;which means that we expect exactly one event to be emitted.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="implementing-the-command"><a class="anchor" href="#implementing-the-command"></a><a class="link" href="#implementing-the-command">5.3.8. Implementing the command</a></h4>
<div class="paragraph">
<p>The <code>CreateLCApplicationCommand</code> in the previous simplistic example does not carry any state. Realistically, the command will likely look something like what is depicted as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Data</span>;

<span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommand</span> {  <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;            <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#088;font-weight:bold">private</span> ClientId clientId;
    <span style="color:#088;font-weight:bold">private</span> Party applicant;               <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> Party beneficiary;
    <span style="color:#088;font-weight:bold">private</span> AdvisingBank advisingBank;     <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> LocalDate issueDate;
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount amount;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> merchandiseDescription;

}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The command class. When naming commands, we typically use an imperative style i.e. they usually begin with a verb denoting the action required. Note that this is a data transfer object. In other words, it is simply a bag of data attributes. Also note how it is devoid of any logic (at least at the moment).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The identifier for the LC Application. We are assuming client generated identifiers in this case. The topic of using server-generated versus client-generated identifiers is out of scope for the subject of this book. You may use either depending on what is advantageous in your context. Also note that we are using a strong type for the identifier <code>LCApplicationId</code> as opposed to a primitive such as a numeric or a string value. It is also common in some cases to use UUIDs as the identifier. However, we prefer using strong types to be able to differentiate between identifier types. Notice how we are using a type <code>ClientId</code> to represent the creator of the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>Party</code> and <code>AdvisingBank</code> types are complex types to represent those concepts in our solution. Care should be taken to consistently use names that are relevant in the problem (business) domain as opposed to using names that only make sense in the solution (technology) domain. Note the attempt to make use of the <em>ubiquitous language</em> of the domain experts in both cases. This is a practice that we should always be conscious of when naming things in the system.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is worth noting that the <code>merchandiseDescription</code> is left as a primitive <code>String</code> type. This may feel contradictory to the commentary we present above. We will address this in the upcoming section on Structural validations.</p>
</div>
<div class="paragraph">
<p>Now lets look at what the event we will emit as a result of successfully processing the command will look like.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_the_event"><a class="anchor" href="#_implementing_the_event"></a><a class="link" href="#_implementing_the_event">5.3.9. Implementing the event</a></h4>
<div class="paragraph">
<p>In an event-driven system, mutating system state by successfully processing a command usually results in a domain event being emitted to signal the state mutation to the rest of the system. A simplified representation of a real-world <code>LCApplicationCreatedEvent</code> is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Data</span>;

<span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationCreatedEvent</span> {   <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;
    <span style="color:#088;font-weight:bold">private</span> ClientId clientId;
    <span style="color:#088;font-weight:bold">private</span> Party applicant;
    <span style="color:#088;font-weight:bold">private</span> Party beneficiary;
    <span style="color:#088;font-weight:bold">private</span> AdvisingBank advisingBank;
    <span style="color:#088;font-weight:bold">private</span> LocalDate issueDate;
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount amount;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> merchandiseDescription;

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The event type. When naming events, we typically use names in the past tense to denote things that have already occurred and are to be accepted unconditionally as empirical facts that cannot be changed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will likely notice that the structure of the event is currently identical to that of the command. While this is true in this case, it may not always be that way. The amount of information that we choose to disclose in an event is context-dependent. It is important to consult with domain experts when publishing information as part of events. One may choose to withhold certain information in the event payload. For example, consider a <code>ChangePasswordCommand</code> which contains the newly changed password. It might be prudent to not include the changed password in the resulting <code>PasswordChangedEvent</code>.</p>
</div>
<div class="paragraph">
<p>We have looked at the command and the resulting event in the previous test. Let&#8217;s look at how this is implemented under the hood by looking at the aggregate implementation.</p>
</div>
</div>
<div class="sect3">
<h4 id="designing-the-aggregate"><a class="anchor" href="#designing-the-aggregate"></a><a class="link" href="#designing-the-aggregate">5.3.10. Designing the aggregate</a></h4>
<div class="paragraph">
<p>The aggregate is the place where commands are handled and events are emitted. The good thing about the test that we have written is that it is expressed in a manner that hides the implementation details. But let&#8217;s look at the implementation to be able to appreciate how we can get our tests to pass and meet the business requirement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {

    <span style="color:#007">@AggregateIdentifier</span>                                                            <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;

    <span style="color:#007">@SuppressWarnings</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">unused</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> LCApplication() {
        <span style="color:#777">// Required by the framework</span>
    }

    <span style="color:#007">@CommandHandler</span>                                                                 <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#088;font-weight:bold">public</span> LCApplication(CreateLCApplicationCommand command) {                      <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="color:#777">// TODO: perform validations here</span>
        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(command.getId()));   <i class="conum" data-value="4"></i><b>(4)</b>
    }

    <span style="color:#007">@EventSourcingHandler</span>                                                           <i class="conum" data-value="5"></i><b>(5)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationCreatedEvent event) {
        <span style="color:#950">this</span>.id = event.getId();
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The aggregate identifier for the <code>LCApplication</code> aggregate. For an aggregate, the identifier uniquely identifies one instance from another. For this reason, all aggregates are required to declare an identifier and mark it so using the <code>@AggregateIdentifier</code> annotation provided by the framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The method that is handling the command needs to be annotated with the <code>@CommandHandler</code> annotation. In this case, the command handler happens to be the constructor of the class given that this the first command that can be received by this aggregate. We will see examples of subsequent commands being handled by other methods later in the chapter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>@CommandHandler</code> annotation marks a method as being a command handler. The exact command that this method can handle needs to be passed as a parameter to the method. Do note that there can only be one command handler in the <strong>entire</strong> system for any given command.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here, we are emitting the <code>LCApplicationCreatedEvent</code> using the <code>AggregateLifecycle</code> utility provided by the framework. In this very simple case, we are emitting an event unconditionally on receipt of the command. In a real-world scenario, it is conceivable that a set of validations will be performed before deciding to either emit one or more events or failing the command with an exception. We will look at more realistic examples later in the chapter.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The need for the <code>@EventSourcingHandler</code> and its role are likely very unclear at this time. We will explain the need for this in detail in an upcoming section of this chapter.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This was a whirlwind introduction to a simple event-driven system. We still need to understand the role of the
<code>@EventSourcingHandler</code>. To understand that, we will need to appreciate how aggregate persistence works and the implications it has on our overall design.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_persisting_aggregates"><a class="anchor" href="#_persisting_aggregates"></a><a class="link" href="#_persisting_aggregates">5.4. Persisting aggregates</a></h3>
<div class="paragraph">
<p>When working with any system of even moderate complexity, we are required to make interactions durable. That is, interactions need to outlast system restarts, crashes, etc. So the need for persistence is a given. While we should always endeavour to abstract persistence concerns from the rest of the system, our persistence technology choices can have a significant impact on the way we architect our overall solution. We have a couple of choices in terms of how we choose to persist aggregate state that are worth mentioning:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>State stored</p>
</li>
<li>
<p>Event sourced</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s examine each of these techniques in more detail below:</p>
</div>
<div class="sect3">
<h4 id="_state_stored_aggregates"><a class="anchor" href="#_state_stored_aggregates"></a><a class="link" href="#_state_stored_aggregates">5.4.1. State stored aggregates</a></h4>
<div class="paragraph">
<p>Saving current values of entities is by far the most popular way to persist state&#8201;&#8212;&#8201;thanks to the immense popularity of relational databases and object-relational mapping (ORM) tools like Hibernate. And there is good reason for this ubiquity. Until recently, a majority of enterprise systems used relational databases almost as a default to create business solutions, with ORMs arguably providing a very convenient mechanism to interact with relational databases and their object representations. For example, for our <code>LCApplication</code>, it is conceivable that we could use a relational database with a structure that would look something like below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/relational-structure.png" alt="relational structure" width="818" height="475">
</div>
<div class="title">Figure 1- 64. Typical entity relationship model</div>
</div>
<div class="paragraph">
<p>Irrespective of whether we choose to use a relational database or a more modern NoSql store&#8201;&#8212;&#8201;for instance, a document store, key-value store, column family store, etc., the style we use to persist information remains more or less the same&#8201;&#8212;&#8201;which is to store the current values of the attributes of the said aggregate/entity. When the values of attributes change, we simply overwrite old values with newer ones i.e. we store the current state of aggregates and entities&#8201;&#8212;&#8201;hence the name <em>state stored</em>. This technique has served us very well over the years, but there is at least one more mechanism that we can use to persist information. We will look at this in more detail below.</p>
</div>
</div>
<div class="sect3">
<h4 id="_event_sourced_aggregates"><a class="anchor" href="#_event_sourced_aggregates"></a><a class="link" href="#_event_sourced_aggregates">5.4.2. Event sourced aggregates</a></h4>
<div class="paragraph">
<p>Developers have also been relying on logs for a variety of diagnostic purposes for a very long time. Similarly, relational databases have been employing commit logs to store information durably almost since their inception. However, developers' use of logs as a first class persistence solution for structured information in mainstream systems remains extremely rare.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A log is an extremely simple, append-only sequence of immutable records ordered by time. The diagram here illustrates the structure of a log where records are written sequentially. In essence, a log is an append-only data structure as depicted here:.
</td>
</tr>
</table>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/log-records.png" alt="log records" width="600" height="154">
</div>
<div class="title">Figure 1- 65. The log data structure</div>
</div>
<div class="paragraph">
<p>Writing to a log as compared to a more complex data structure like a table is a relatively simple and fast operation and can handle extremely high volumes of data while providing predictable performance. Indeed, a modern event streaming platform like Kafka makes use of this pattern to scale to support extremely high volumes. We do feel that this can be applied to act as a persistence store when processing commands in mainstream systems because this has benefits beyond the technical advantages listed above. Consider the example of an online order flow below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 37.5%;">
<col style="width: 37.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">User Action</th>
<th class="tableblock halign-left valign-top">Traditional Store</th>
<th class="tableblock halign-left valign-top">Event Store</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add milk to cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Milk in cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add white bread to cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Milk, White bread in cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart<br>
E3: White bread added to cart</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove White bread from cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Milk in cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart<br>
E3: White bread added to cart<br>
E4: White bread removed from cart</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add Wheat bread to cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Milk, Wheat bread in cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart<br>
E3: White bread added to cart<br>
E4: White bread removed from cart<br>
E5: Wheat bread added to cart</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Confirm cart checkout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Ordered Milk, Wheat bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart<br>
E3: White bread added to cart<br>
E4: White bread removed from cart<br>
E5: Wheat bread added to cart<br>
E6: Order 123 confirmed</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As you can see, in the event store, we continue to have full visibility of all user actions performed. This allows us to reason about these behaviors more holistically. In the traditional store, we lost the information that the user replaced white with wheat bread. While this does not impact the order itself, we lose the opportunity to gather insights from this user behavior. We recognize that this information can be captured in other ways using specialized analytical solutions, however, the event log mechanism provides a natural way to do this without requiring any additional effort. It also acts as an audit log providing full history of all events that have occurred thus far. This fits well with the essence of domain-driven design where we are constantly exploring ways in which to reduce complexity.</p>
</div>
<div class="paragraph">
<p>However, there are implications to persisting data in the form of a simple event log. Before processing any command, we will need to hydrate past events in exact order of occurrence and reconstruct aggregate state to allow us to perform validations. For example, when confirming checkout, just having the ordered set of elapsed events will not suffice. We still need to compute the exact items that are in the cart before allowing the order to be placed. This <em>event replay</em> to restore aggregate state (at least those attributes that are required to validate said command) is necessary before processing that command. For example, we need to know which items are in the cart currently before processing the <code>RemoveItemFromCartCommand</code>.This is illustrated in the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 29.4117%;">
<col style="width: 17.647%;">
<col style="width: 23.5294%;">
<col style="width: 29.4119%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Elapsed Events</th>
<th class="tableblock halign-left valign-top">Aggregate State</th>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Event(s) Emitted</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add item: milk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#<em>123</em> created<br>
E2: Milk added</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cart Items</strong>:<br>
Milk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add item: white bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E2: White bread added</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added<br>
E3: White bread added</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cart Items</strong>:<br>
Milk,<br>
White Bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove item: white bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E3: White bread removed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added<br>
E3: White bread added<br>
E4: White bread removed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cart Items</strong>:<br>
Milk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add item: wheat bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E4: Wheat bread added</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added<br>
E3: White bread added<br>
E4: White bread removed<br>
E5: Wheat bread added</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cart Items</strong>:<br>
Milk<br>
Wheat bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Confirm checkout for Cart#123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E5: Order created!</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The corresponding source code for the whole scenario is illustrated in the following code snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Cart</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> isNew;
    <span style="color:#088;font-weight:bold">private</span> CartItems items;
    <span style="color:#777">//..</span>

    <span style="color:#088;font-weight:bold">private</span> Cart() {                                             <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#777">// Required by the framework</span>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> addItem(AddItemToCartCommand command) {
        <span style="color:#777">// Business validations here</span>
        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">this</span>.isNew) {
            apply(<span style="color:#080;font-weight:bold">new</span> CartCreatedEvent(command.getId()));        <i class="conum" data-value="2"></i><b>(2)</b>
        }
        apply(<span style="color:#080;font-weight:bold">new</span> ItemAddedEvent(id, command.getItem()));        <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> removeItem(RemoveItemFromCartCommand command) {
        <span style="color:#777">// Business validations here</span>
        apply(<span style="color:#080;font-weight:bold">new</span> ItemRemovedEvent(id, commmand.getItem()));
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> checkout(ConfirmCheckoutCommand command) {
        <span style="color:#777">// Business validations here</span>
        apply(<span style="color:#080;font-weight:bold">new</span> OrderCreatedEvent(<span style="color:#950">this</span>.items));
    }

    <span style="color:#007">@EventSourcingHandler</span>                                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(CartCreatedEvent event) {
        <span style="color:#950">this</span>.id = event.getCartId();
        <span style="color:#950">this</span>.items = <span style="color:#080;font-weight:bold">new</span> CartItems();
        <span style="color:#950">this</span>.isNew = <span style="color:#069">true</span>;
    }

    <span style="color:#007">@EventSourcingHandler</span>                                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(ItemAddedEvent event) {
        <span style="color:#950">this</span>.items.add(event.getItem());
        <span style="color:#950">this</span>.isNew = <span style="color:#069">false</span>;
    }

    <span style="color:#007">@EventSourcingHandler</span>                                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(ItemRemovedEvent event) {
        <span style="color:#950">this</span>.items.remove(event.getItem());
    }

    <span style="color:#007">@EventSourcingHandler</span>                                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(CheckoutConfirmedEvent event) {
        <span style="color:#777">// ..</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Before processing any command, the aggregate loading process commences by first invoking the no-args constructor. For this reason, we need the no-args constructor to be <strong>empty</strong> i.e. it should <strong>not</strong> have any code that restores state. State restoration <strong>must</strong> happen only in those methods that trigger an event replay. In the case of the Axon framework, this translates to methods embellished with the <code>@EventSourcingHandler</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is important to note that it is possible (but not necessary) to emit <strong>more than one event</strong> after processing a command. This is illustrated in the first instance of the <code>AddItemCommand</code> in the previous code where we emit <code>CartCreatedEvent</code> and <code>ItemAddedEvent</code>.Command handlers do not mutate state of the aggregate. They only make use of existing aggregate state to enforce invariants (validations) and emit events if those invariants hold true.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The loading process continues through the invocation of event sourcing handler methods in exactly the order of occurrence for that aggregate instance. Event sourcing handlers are only needed to hydrate aggregate state on the basis of past events. This means that they usually are devoid of any business (conditional) logic. It goes without saying that these methods do not emit any events. Event emission is restricted to happen within command handlers when invariants are successfully enforced.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When working with event sourced aggregates, it is very important to be disciplined about the kind of code that one can write:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type of Method</th>
<th class="tableblock halign-left valign-top">State Restoration</th>
<th class="tableblock halign-left valign-top">Business Logic</th>
<th class="tableblock halign-left valign-top">Event Emission</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@CommandHandler</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@EventSourcingHandler</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If there are a large number of historic events to restore state, the aggregate loading process can become a time-consuming operation&#8201;&#8212;&#8201;directly proportional to the number of elapsed events for that aggregate. There are techniques (like snapshotting) we can employ to overcome this. We will cover this in more detail in Chapter 11  Non-Functional Requirements.</p>
</div>
</div>
<div class="sect3">
<h4 id="persistence-technology-choices"><a class="anchor" href="#persistence-technology-choices"></a><a class="link" href="#persistence-technology-choices">5.4.3. Persistence technology choices</a></h4>
<div class="paragraph">
<p>If you are using a state store to persist your aggregates, using your usual evaluation process for choosing your persistence technology should suffice. However, if you are looking at event-sourced aggregates, the decision can be a bit more nuanced. In our experience, even a simple relational database can do the trick. Indeed, we had made use of a relational database to act as an event store for a high volume transactional application with billions of events. This setup worked just fine for us. It is worth noting that we were only using the event store to insert new events and loading events for a given aggregate in sequential order. However, there are a multitude of specialized technologies that have been purpose built to act as an event store that support several other value-added features such as time travel, full event replay, event payload introspection, etc. If you have such requirements, it might be worth considering other options such as NoSql databases (document stores like MongoDB or column family stores like Cassandra) or purpose-built commercial offerings such as EventStoreDB<sup class="footnote">[<a id="_footnoteref_20" class="footnote" href="#_footnotedef_20" title="View footnote.">20</a>]</sup> and Axon Server<sup class="footnote">[<a id="_footnoteref_21" class="footnote" href="#_footnotedef_21" title="View footnote.">21</a>]</sup> to evaluate feasibility in your context.</p>
</div>
</div>
<div class="sect3">
<h4 id="which-persistence-mechanism-should-we-choose"><a class="anchor" href="#which-persistence-mechanism-should-we-choose"></a><a class="link" href="#which-persistence-mechanism-should-we-choose">5.4.4. Which persistence mechanism should we choose?</a></h4>
<div class="paragraph">
<p>Now that we have a reasonably good understanding of the two types of aggregate persistence mechanisms (<a href="#_state_stored_aggregates">state-stored</a> and <a href="#_event_sourced_aggregates">event-sourced</a>), it begs the question of which one we should choose. We list a few benefits of using event sourcing below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We get to use the events as a <strong>natural audit log</strong> in high compliance scenarios.</p>
</li>
<li>
<p>It provides the ability to perform <strong>more insightful analytics</strong> on the basis of the fine-grained events data.</p>
</li>
<li>
<p>It arguably produces more flexible designs when we work with an system based on <strong>immutable events</strong>&#8201;&#8212;&#8201;because the complexity of the persistence model is capped. Also, there is no need to deal with complex ORM impedance mismatch problems.</p>
</li>
<li>
<p>The domain model is much more <strong>loosely coupled</strong> with the persistence model&#8201;&#8212;&#8201;enabling it to evolve mostly independently from the persistence model.</p>
</li>
<li>
<p>Enables going back in time to be able to create <strong>adhoc views and reports</strong> without having to deal with upfront complexity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On the flip side, these are some challenges that you might have to consider when implementing an event sourced solution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Event sourcing requires a <strong>paradigm shift</strong>. Which means that development and business teams will have to spend time and effort understanding how it works.</p>
</li>
<li>
<p>The persistence model does not store state directly. This means that <strong>adhoc querying</strong> directly on the persistence model can be a lot more <strong>challenging</strong>. This can be alleviated by materializing new views, however there is added complexity in doing that.</p>
</li>
<li>
<p>Event sourcing usually tends to work very well when implemented in conjunction with <strong>CQRS</strong> which arguably may add more complexity to the application. It also requires applications to pay closer attention to strong vs <strong>eventual consistency</strong> concerns.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our experiences indicate that event sourced systems bring a lot of benefits in modern event-driven systems. However, you will need to be cognizant of the considerations presented above in the context of your own ecosystems when making persistence choices.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enforcing-policies"><a class="anchor" href="#enforcing-policies"></a><a class="link" href="#enforcing-policies">5.5. Enforcing policies</a></h3>
<div class="paragraph">
<p>When processing commands, we need to enforce policies or rules. Policies come in two broad categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Structural rules&#8201;&#8212;&#8201;those that enforce that the syntax of the dispatched command is valid.</p>
</li>
<li>
<p>Domain rules&#8201;&#8212;&#8201;those that enforce that business rules are adhered to.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It may also be prudent to perform these validations in different layers of the system. And it is also common for some or all of these policy enforcements to be repeated in more than one layer of the system. However, the important thing to note is that before a command is successfully handled, all these policy enforcements are uniformly applied. Let&#8217;s look at some examples of these in the upcoming section.</p>
</div>
<div class="sect3">
<h4 id="structural-validations"><a class="anchor" href="#structural-validations"></a><a class="link" href="#structural-validations">5.5.1. Structural validations</a></h4>
<div class="paragraph">
<p>Currently, to create an LC application, one is required to dispatch a <code>CreateLCApplicationCommand</code>. While the command dictates a structure, none of it is enforced at the moment. Let&#8217;s correct that.</p>
</div>
<div class="paragraph">
<p>To be able to enable validations declaratively, we will make use of the JSR-303 bean validation libraries. We can add that easily using the <code>spring-boot-starter-validation</code> dependency to our <code>pom.xml</code> file as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-validation<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can add validations to the command object using the JSR-303 annotations as depicted below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Data</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">javax.validation</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">javax.validation.constraints</span>.*;

<span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommand</span> {

    <span style="color:#007">@NotNull</span>
    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;

    <span style="color:#007">@NotNull</span>
    <span style="color:#088;font-weight:bold">private</span> ClientId clientId;

    <span style="color:#007">@NotNull</span>
    <span style="color:#007">@Valid</span>
    <span style="color:#088;font-weight:bold">private</span> Party applicant;

    <span style="color:#007">@NotNull</span>
    <span style="color:#007">@Valid</span>
    <span style="color:#088;font-weight:bold">private</span> Party beneficiary;

    <span style="color:#007">@NotNull</span>
    <span style="color:#007">@Valid</span>
    <span style="color:#088;font-weight:bold">private</span> AdvisingBank advisingBank;

    <span style="color:#007">@Future</span>
    <span style="color:#088;font-weight:bold">private</span> LocalDate issueDate;

    <span style="color:#007">@Positive</span>
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount amount;

    <span style="color:#007">@NotBlank</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> merchandiseDescription;
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Most structural validations can be accomplished using the built-in validator annotations. It is also possible to create custom validators for individual fields or to validate the entire object (for example, to validate inter-dependent attributes). For more details on how to do this, please refer to the bean validation specification at <a href="https://beanvalidation.org/2.0/" class="bare">https://beanvalidation.org/2.0/</a> and the reference implementation at <a href="http://hibernate.org/validator/" class="bare">http://hibernate.org/validator/</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="business-rule-enforcements"><a class="anchor" href="#business-rule-enforcements"></a><a class="link" href="#business-rule-enforcements">5.5.2. Business rule enforcements</a></h4>
<div class="paragraph">
<p>Structural validations can be accomplished using information that is already available in the command. However, there is another class of validations that requires information that is not present in the incoming command itself. This kind of information can be present in one of two places: within the aggregate that we are operating on or outside of the aggregate itself, but made available within the bounded context.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at an example of a validation that requires state present within the aggregate. Consider the example of submitting an LC. While we can make several edits to the LC when it is in draft state, no changes can be made after it is submitted. This means that we can only submit an LC once. This act of submitting the LC is achieved by issuing the <code>SubmitLCApplicationCommand</code> as shown in the artifact from the eventstorming session:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/aggregate-state-validation.png" alt="aggregate state validation">
</div>
<div class="title">Figure 1- 66. Validations during the submit LC process</div>
</div>
<div class="paragraph">
<p>Let&#8217;s begin with a test to express our intent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {
    <span style="color:#777">//..</span>
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldAllowSubmitOnlyInDraftState() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId applicationId = LCApplicationId.randomId();

        fixture.given(<span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(applicationId))            <i class="conum" data-value="1"></i><b>(1)</b>
                .when(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(applicationId))           <i class="conum" data-value="2"></i><b>(2)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(applicationId)); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the <code>LCApplicationCreatedEvent</code> has already occurred&#8201;&#8212;&#8201;in other words, the LC application is already created.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When we try to submit the application by issuing the <code>SubmitLCApplicationCommand</code> for the same application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect the <code>LCApplicationSubmittedEvent</code> to be emitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The corresponding implementation will look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">// ..</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> submit(SubmitLCApplicationCommand command) {
        apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(id));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation above allows us to submit an LC application unconditionally&#8201;&#8212;&#8201;more than once. However, we want to restrict users to be able to submit only once. To be able to do that, we need to remember that the LC application has already been submitted. We can do that in the <code>@EventSourcingHandler</code> of the corresponding events as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">// ..</span>
    <span style="color:#007">@EventSourcingHandler</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationSubmittedEvent event) {
        <span style="color:#950">this</span>.state = State.SUBMITTED; <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When the <code>LCApplicationSubmittedEvent</code> is replayed, we set the state of the <code>LCApplication</code> to <code>SUBMITTED</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While we have remembered that the application has changed to be in <code>SUBMITTED</code> state, we are still not preventing more than one submit attempt. We can fix that by writing a test as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotAllowSubmitOnAnAlreadySubmittedLC() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId applicationId = LCApplicationId.randomId();

        fixture.given(
                <span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(applicationId),           <i class="conum" data-value="1"></i><b>(1)</b>
                <span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(applicationId))         <i class="conum" data-value="1"></i><b>(1)</b>

                .when(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(applicationId))    <i class="conum" data-value="2"></i><b>(2)</b>

                .expectException(AlreadySubmittedException.class)       <i class="conum" data-value="3"></i><b>(3)</b>
                .expectNoEvents();                                      <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>LCApplicationCreatedEvent</code> and <code>LCApplicationSubmittedEvent</code> have already happened&#8201;&#8212;&#8201;which means that the <code>LCApplication</code> has been submitted once.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We now dispatch another <code>SubmitLCApplicationCommand</code> to the system.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect an <code>AlreadySubmittedException</code> to be thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We also expect no events to be emitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation of the command handler to make this work is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">// ..</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> submit(SubmitLCApplicationCommand command) {
        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">this</span>.state != State.DRAFT) {                                     <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> AlreadySubmittedException(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC is already submitted!</span><span style="color:#710">&quot;</span></span>);
        }
        apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(id));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note how we are using the state attribute from the <code>LCApplication</code> aggregate to perform the validation. If the application is not in <code>DRAFT</code> state, we fail with the <code>AlreadySubmittedException</code> domain exception.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s also look at an example where information needed to perform the validation is not part of either the command or the aggregate. Let&#8217;s consider the scenario where country regulations prohibit transacting with a set of so called <em>sanctioned</em> countries. Changes to this list of countries may be affected by external factors. Hence it does not make sense to pass this list of sanctioned countries as part of the command payload. Neither does it make sense to maintain it as part of every single aggregate&#8217;s state&#8201;&#8212;&#8201;given that it can change (albeit very infrequently). In such a case, we may want to consider making use of a command handler that is outside the confines of the aggregate class. Thus far, we have only seen examples of <code>@CommandHandler</code> methods within the aggregate. But the <code>@CommandHandler</code> annotation can appear on any other class external to the aggregate. However, in such a case, we need to load the aggregate ourselves. The Axon framework provides a <code>org.axonframework.modelling.command. Repository</code> interface to allow us to do that. It is important to note that this <code>Repository</code> is distinct from spring framework&#8217;s interface that is part of the spring data libraries. An example of how this works is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.modelling.command.Repository</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyCustomCommandHandler</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Repository&lt;LCApplication&gt; repository;                 <i class="conum" data-value="1"></i><b>(1)</b>

    MyCustomCommandHandler(Repository&lt;LCApplication&gt; repository) {
        <span style="color:#950">this</span>.repository = repository;                                   <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> handle(SomeCommand command) {
        Aggregate&lt;LCApplication&gt; application
            = repository.load(command.getAggregateId());                <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#777">// Command handling code</span>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> handle(AnotherCommand command) {
        Aggregate&lt;LCApplication&gt; application
            = repository.load(command.getAggregateId());
        <span style="color:#777">// Command handling code</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We are injecting the Axon <code>Repository</code> to allow us to load aggregates. This was not required previously because the <code>@CommandHandler</code> annotation appeared on aggregate methods directly.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We are using the <code>Repository</code> to load aggregates and work with them. The <code>Repository</code> interface supports other convenience methods to work with aggregates. Please refer to the Axon framework documentation for more usage examples.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Coming back to the sanctioned countries example, let&#8217;s look at how we need to set up the test slightly differently:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommandHandlerTests</span> {
    <span style="color:#088;font-weight:bold">private</span> FixtureConfiguration&lt;LCApplication&gt; fixture;

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> setUp() {
        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctioned = <span style="color:#0a8;font-weight:bold">Set</span>.of(SOKOVIA);
        fixture = <span style="color:#080;font-weight:bold">new</span> AggregateTestFixture&lt;&gt;(LCApplication.class);              <i class="conum" data-value="1"></i><b>(1)</b>

        <span style="color:#088;font-weight:bold">final</span> Repository&lt;LCApplication&gt; repository = fixture.getRepository();   <i class="conum" data-value="2"></i><b>(2)</b>

        CreateLCApplicationCommandHandler handler =
                <span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommandHandler(repository, sanctioned);  <i class="conum" data-value="3"></i><b>(3)</b>
        fixture.registerAnnotatedCommandHandler(handler);                       <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We are creating a new aggregate fixture as usual</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We are using the fixture to obtain an instance of the Axon <code>Repository</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We instantiate the custom command handler passing in the <code>Repository</code> instance. Also note how we inject the collection of sanctioned countries into the handler using simple dependency injection. In real life, this set of sanctioned countries will likely be obtained from external configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We finally need to register the command handler with the fixture, so that it can route commands to this handler as well.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The tests for this look fairly straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommandHandlerTests</span> {
    <span style="color:#777">// ..</span>

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> setUp() {
    <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctioned = <span style="color:#0a8;font-weight:bold">Set</span>.of(SOKOVIA);                            <i class="conum" data-value="1"></i><b>(1)</b>
        fixture = <span style="color:#080;font-weight:bold">new</span> AggregateTestFixture&lt;&gt;(LCApplication.class);

        <span style="color:#088;font-weight:bold">final</span> Repository&lt;LCApplication&gt; repository = fixture.getRepository();

        CreateLCApplicationCommandHandler handler =
                <span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommandHandler(repository, sanctioned);  <i class="conum" data-value="2"></i><b>(2)</b>
        fixture.registerAnnotatedCommandHandler(handler);
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldFailIfBeneficiaryCountryIsSanctioned() {
        fixture.given()
                .when(<span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommand(randomId(), SOKOVIA))      <i class="conum" data-value="3"></i><b>(3)</b>
                .expectNoEvents()
                .expectException(CannotTradeWithSanctionedCountryException.class);
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldCreateIfCountryIsNotSanctioned() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId applicationId = randomId();
        fixture.given()
                .when(<span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommand(applicationId, WAKANDA))   <i class="conum" data-value="4"></i><b>(4)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(applicationId));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For the purposes of the test, we mark the country <code>SOKOVIA</code> as a <em>sanctioned</em> country. In a more realistic scenario, this will likely come from some form external configuration (e.g. a lookup table or form of external configuration). However, this is appropriate for our unit test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then inject this set of <em>sanctioned countries</em> into the command handler.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the <code>LCApplication</code> is created for the sanctioned country, we expect no events to be emitted and furthermore, the <code>CannotTradeWithSanctionedCountryException</code> exception to be thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally, when the beneficiary belongs to a non-sanctioned country, we emit the <code>LCApplicationCreatedEvent</code> to be emitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation of the command handler is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.stereotype.Service</span>;

<span style="color:#007">@Service</span>                                                         <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommandHandler</span> {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Repository&lt;LCApplication&gt; repository;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctionedCountries;

    <span style="color:#088;font-weight:bold">public</span> CreateLCApplicationCommandHandler(Repository&lt;LCApplication&gt; repository,
                                             <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctionedCountries) {
        <span style="color:#950">this</span>.repository = repository;
        <span style="color:#950">this</span>.sanctionedCountries = sanctionedCountries;
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> handle(CreateLCApplicationCommand command) {
        <span style="color:#777">// Validations can be performed here as well                </span><i class="conum" data-value="2"></i><b>(2)</b>
        repository.newInstance(()
            -&gt; <span style="color:#080;font-weight:bold">new</span> LCApplication(command, sanctionedCountries)); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mark the class as a <code>@Service</code> to mark it as a component devoid of encapsulated state and enable auto-discovery when using annotation-based configuration or classpath scanning. As such, it can be used to perform any "plumbing" activities.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Do note that the validation for the beneficiary&#8217;s country being sanctioned could have been performed on line 18 as well. Some would argue that this would be ideal because we could avoid a potentially unnecessary invocation of the Axon <code>Repository</code> method if we did that. However, we prefer encapsulating business validations within the confines of the aggregate as much as possible&#8201;&#8212;&#8201;so that we don&#8217;t suffer from the problem of creating an <a href="https://www.martinfowler.com/bliki/AnemicDomainModel.html">anemic domain model</a><sup class="footnote">[<a id="_footnoteref_22" class="footnote" href="#_footnotedef_22" title="View footnote.">22</a>]</sup>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, the aggregate implementation along with the validation is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
<span style="color:#777">// ...</span>
    <span style="color:#088;font-weight:bold">public</span> LCApplication(CreateLCApplicationCommand command, <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctioned) {
        <span style="color:#080;font-weight:bold">if</span> (sanctioned.contains(command.getBeneficiaryCountry())) { <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> CannotTradeWithSanctionedCountryException();
        }
        apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(command.getId()));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The validation itself is fairly straightforward. We throw a <code>CannotTradeWithSanctionedCountryException</code> when the validation fails.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the above examples, we looked at different ways to implement the policy enforcements encapsulated within the boundaries the aggregate.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary-5"><a class="anchor" href="#summary-5"></a><a class="link" href="#summary-5">5.6. Summary</a></h3>
<div class="paragraph">
<p>In this chapter, we used the outputs of the eventstorming session and used it as a primary aid to create a domain model for our bounded context. We looked at how to implement this using the command query responsibility segregation (CQRS) architecture pattern. We looked at persistence options and the implications of using event sourced vs state stored aggregates. Finally, we rounded off by looking at a variety of ways in which to perform business validations. We looked at all this through a set of code examples using Spring boot and the Axon framework.</p>
</div>
<div class="paragraph">
<p>With this knowledge, we should be able to implement robust, well encapsulated, event-driven domain models. In the next chapter, we will look at implementing a user interface for these domain capabilities and examine a few options such as CRUD-based vs task-based UIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="questions-4"><a class="anchor" href="#questions-4"></a><a class="link" href="#questions-4">5.7. Questions</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Can you examine the eventstorming session artifact from the last chapter, and identify the possible aggregates that would be required?</p>
</li>
<li>
<p>In your problem domain, can you determine the right approach for persisting aggregates? What are the reasons for choosing one approach over the other?</p>
</li>
<li>
<p>Based on your current understanding, would you apply CQRS architecture pattern in your solution? And how would you justify the choice to your team ?</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-4"><a class="anchor" href="#further-reading-4"></a><a class="link" href="#further-reading-4">5.8. Further reading</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CQRS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/bliki/CQRS.html" class="bare">https://martinfowler.com/bliki/CQRS.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bootiful CQRS and Event Sourcing with Axon Framework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SpringDeveloper and Allard Buijze</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.youtube.com/watch?v=7e5euKxHhTE" class="bare">https://www.youtube.com/watch?v=7e5euKxHhTE</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Log: What every software engineer should know about real-time data&#8217;s unifying abstraction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jay Kreps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying" class="bare">https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Sourcing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/eaaDev/EventSourcing.html" class="bare">https://martinfowler.com/eaaDev/EventSourcing.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using a DDD Approach for Validating Business Rules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fabian Lopez</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.infoq.com/articles/ddd-business-rules/" class="bare">https://www.infoq.com/articles/ddd-business-rules/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anemic Domain Model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.martinfowler.com/bliki/AnemicDomainModel.html" class="bare">https://www.martinfowler.com/bliki/AnemicDomainModel.html</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="answers-2"><a class="anchor" href="#answers-2"></a><a class="link" href="#answers-2">5.9. Answers</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Refer to section <a href="#_identifying_aggregates">Section 5.3.4</a></p>
</li>
<li>
<p>Refer to section <a href="#_persisting_aggregates">Section 5.4</a>, note down the pros and cons of state stored and event sourced approach, and discuss the reasons for your choice with your teammates.</p>
</li>
<li>
<p>Refer to section <a href="#_when_to_use_cqrs">Section 2.1.6.1</a> to list down the advantages of the approach versus the traditional approach.  Share the reasoning with your teammates.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1 text-justify">
<h2 id="implementing-the-user-interfacetask-based"><a class="anchor" href="#implementing-the-user-interfacetask-based"></a><a class="link" href="#implementing-the-user-interfacetask-based">6. Implementing the User Interface&#8201;&#8212;&#8201;Task-based</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
To accomplish a difficult task, one must first make it easy.
</blockquote>
<div class="attribution">
&#8212; Marty Rubin
</div>
</div>
<div class="paragraph">
<p>The essence of Domain Driven Design(DDD) is a lot about capturing the business process and user intent a lot more closely. In the previous chapter, we designed a set of APIs without paying a lot of attention to how those APIs would get consumed by its eventual users. In this chapter, we will design the GUI for the LC application using the <a href="https://openjfx.com/">JavaFX</a><sup class="footnote">[<a id="_footnoteref_23" class="footnote" href="#_footnotedef_23" title="View footnote.">23</a>]</sup> framework. As part of that, we will examine how this approach of designing APIs in isolation can cause an impedance mismatch between the producers and the consumers. We will examine the consequences of this <em>impedance mismatch</em> and how task-based UIs can help cope with this mismatch a lot better.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will implement the UI for LC Application and wire up the integration to the backend APIs.  The list of topics to be covered is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API styles</p>
</li>
<li>
<p>Implementing the UI</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the end of the chapter, you will learn how to employ DDD principles to help you build robust user experiences that are simple and intuitive. You will also learn why it may be prudent to design your backend interfaces (APIs) from the perspective of the consumer.</p>
</div>
<div class="sect2">
<h3 id="technical-requirements-3"><a class="anchor" href="#technical-requirements-3"></a><a class="link" href="#technical-requirements-3">6.1. Technical requirements</a></h3>
<div class="paragraph">
<p>To follow the examples in this chapter, you will need access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 1.8+ (We have used Java 16 to compile sample sources)</p>
</li>
<li>
<p>JavaFX SDK 16 and SceneBuilder</p>
</li>
<li>
<p>Spring Boot 2.4.x</p>
</li>
<li>
<p>mvvmFX 1.8 (<a href="https://sialcasa.github.io/mvvmFX/" class="bare">https://sialcasa.github.io/mvvmFX/</a>)</p>
</li>
<li>
<p>JUnit 5.7.x (Included with spring boot)</p>
</li>
<li>
<p>TestFX (for UI testing)</p>
</li>
<li>
<p>OpenJFX Monocle (for headless UI testing)</p>
</li>
<li>
<p>Project Lombok (To reduce verbosity)</p>
</li>
<li>
<p>Maven 3.x</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before we dive deep into building the GUI solution, let&#8217;s do a quick recap of where we left the APIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="api-styles"><a class="anchor" href="#api-styles"></a><a class="link" href="#api-styles">6.2. API Styles</a></h3>
<div class="paragraph">
<p>If you recall from chapter 5, we created the following commands:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/command-flow.png" alt="command flow" width="488" height="742">
</div>
<div class="title">Figure 1- 67. Commands from the event storming session</div>
</div>
<div class="paragraph">
<p>If you observe carefully, there seem to be commands at two levels of granularity. The "Create LC Application" and "Update LC application" are coarse grained, whereas the others are a lot more focused in terms of their intent. One possible decomposition of the coarse grained commands can be as depicted here:</p>
</div>
<div id="decomposed-commands" class="imageblock text-center">
<div class="content">
<img src="./images/ui-patterns/decomposed-commands.png" alt="decomposed commands">
</div>
<div class="title">Figure 1- 68. Decomposed commands</div>
</div>
<div class="paragraph">
<p>In addition to just being more fine-grained than the commands in the previous iteration, the revised commands seem to better capture the user&#8217;s intent. This may feel like a minor change in semantics, but can have a huge impact on the way our solution is used by its ultimate end-users. The question then is whether we should <em>always</em> prefer fine-grained APIs over coarse grained ones. The answer can be a lot more nuanced. When designing APIs and experiences, we see two main styles being employed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CRUD-based</p>
</li>
<li>
<p>Task-based</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s look at each of these in a bit more detail:</p>
</div>
<div class="sect3">
<h4 id="crud-based-apis"><a class="anchor" href="#crud-based-apis"></a><a class="link" href="#crud-based-apis">6.2.1. CRUD-based APIs</a></h4>
<div class="paragraph">
<p>CRUD is an acronym used to refer to the four basic operations that can be performed on database applications: Create, Read, Update, and Delete. Many programming languages and protocols have their own equivalent of CRUD, often with slight variations in naming and intent. For example, SQL  a popular language for interacting with databases  calls the four functions Insert, Select, Update, and Delete. Similarly, the HTTP protocol has <code>POST</code>, <code>GET</code>, <code>PUT</code> and <code>DELETE</code> as verbs to represent these CRUD operations. This approach has got extended to our design of APIs as well. This has resulted in the proliferation of both CRUD-based APIs and user experiences. Take a look at the <code>CreateLCApplicationCommand</code> from Chapter 5:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Data</span>;

<span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommand</span> {

    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;

    <span style="color:#088;font-weight:bold">private</span> ClientId clientId;
    <span style="color:#088;font-weight:bold">private</span> Party applicant;
    <span style="color:#088;font-weight:bold">private</span> Party beneficiary;
    <span style="color:#088;font-weight:bold">private</span> AdvisingBank advisingBank;
    <span style="color:#088;font-weight:bold">private</span> LocalDate issueDate;
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount amount;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> merchandiseDescription;
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Along similar lines, it would not be uncommon to create a corresponding  <code>UpdateLCApplicationCommand</code> as depicted here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Data</span>;

<span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">UpdateLCApplicationCommand</span> {

    <span style="color:#007">@TargetAggregateIdentifier</span>
    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;

    <span style="color:#088;font-weight:bold">private</span> ClientId clientId;
    <span style="color:#088;font-weight:bold">private</span> Party applicant;
    <span style="color:#088;font-weight:bold">private</span> Party beneficiary;
    <span style="color:#088;font-weight:bold">private</span> AdvisingBank advisingBank;
    <span style="color:#088;font-weight:bold">private</span> LocalDate issueDate;
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount amount;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> merchandiseDescription;
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>While this is very common and also very easy to grasp, it is not without problems. Here are some questions that taking this approach raises:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Are we allowed to change everything listed in the <code>update</code> command?</p>
</li>
<li>
<p>Assuming that everything can change, do they all change at the same time?</p>
</li>
<li>
<p>How do we know what exactly changed? Should we be doing a diff?</p>
</li>
<li>
<p>What if all the attributes mentioned above are not included in the <code>update</code> command?</p>
</li>
<li>
<p>What if we need to add attributes in future?</p>
</li>
<li>
<p>Is the business intent of what the user wanted to accomplish captured?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In a simple system, the answer to these questions may not matter that much. However, as system complexity increases, will this approach remain resilient to change? We feel that it merits taking a look at another approach called task-based APIs to be able to answer these questions.</p>
</div>
</div>
<div class="sect3">
<h4 id="task-based-apis"><a class="anchor" href="#task-based-apis"></a><a class="link" href="#task-based-apis">6.2.2. Task-based APIs</a></h4>
<div class="paragraph">
<p>In a typical organization, individuals perform tasks relevant to their specialization. The bigger the organization, the higher the degree of specialization. This approach of segregating tasks according to one&#8217;s specialization makes sense, because it mitigates the possibility of stepping on each others' shoes, especially when getting complex pieces of work done. For example, in the LC application process, there is a need to establish the value/legality of the product while also determining the credit worthiness of the applicant. It makes sense that each of these tasks are usually performed by individuals in unrelated departments. It also follows that these tasks can be performed independently from the other.</p>
</div>
<div class="paragraph">
<p>In terms of a business process, if we have a single <code>CreateLCApplicationCommand</code> that precedes these operations, individuals in both departments firstly have to wait for the entire application to be filled out before either can commence their work. Secondly, if either piece of information is updated through a single <code>UpdateLCApplicationCommand</code>, it is unclear what changed. This can result in a spurious notification being sent to at least one department because of this lack of clarity in the process.</p>
</div>
<div class="paragraph">
<p>Since most work happens in the form of specific tasks, it can work to our advantage if our processes and by extension, our APIs mirror these behaviors.</p>
</div>
<div class="paragraph">
<p>Keeping this in mind, let&#8217;s re-examine our revised APIs for the LC application process:</p>
</div>
<div id="revised-commands" class="imageblock text-center">
<div class="content">
<img src="./images/ui-patterns/revised-commands-recap.png" alt="revised commands recap">
</div>
<div class="title">Figure 1- 69. Revised commands</div>
</div>
<div class="paragraph">
<p>While it may have appeared previously that we have simply converted our coarse-grained APIs to become more fine-grained, this in reality is a better representation of the tasks that the user intended to perform. So, in essence, task-based APIs are the decomposition of work in a manner that aligns more closely to the users' intents. With our new APIs, product validation can commence as soon as <code>ChangeMerchandise</code> happens. Also, it is unambiguously clear what the user did and what needs to happen in reaction to the user&#8217;s action. It then begs the question on whether we should employ task-based APIs all the time? Let&#8217;s look at the implications in more detail.</p>
</div>
</div>
<div class="sect3">
<h4 id="task-based-or-crud-based"><a class="anchor" href="#task-based-or-crud-based"></a><a class="link" href="#task-based-or-crud-based">6.2.3. Task-based or CRUD-based?</a></h4>
<div class="paragraph">
<p>CRUD-based APIs seem to operate at the level of the aggregate. In our example, we have the LC aggregate. In the simplest case, this essentially translates to four operations aligned with each of the CRUD verbs. However, as we are seeing, even in our simplified version, the LC is becoming a fairly complex concept. Having to work with just four operations at the level of the LC is cognitively complex. With more requirements, this complexity will only continue to increase. For example, consider a situation where  the business expresses a need to capture a lot more information about the <code>merchandise</code>, where today, this is simply captured in the form of free-form text. A more elaborate version of merchandise information is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Merchandise</span> {
    <span style="color:#088;font-weight:bold">private</span> MerchandiseId id;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Item&gt; items;
    <span style="color:#088;font-weight:bold">private</span> Packaging packaging;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> hazardous;
}

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Item</span> {
    <span style="color:#088;font-weight:bold">private</span> ProductId productId;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> quantity;
    <span style="color:#777">// ...</span>
}

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Packaging</span> {
    <span style="color:#777">// ...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In our current design, the implications of this change are far reaching for both the provider and the consumer(s). Let&#8217;s look at some of the consequences in more detail:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 11.1111%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Characteristic</th>
<th class="tableblock halign-center valign-top">CRUD-based</th>
<th class="tableblock halign-center valign-top">Task-based</th>
<th class="tableblock halign-left valign-top">Commentary</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Usability</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon red"><i class="fa fa-thumbs-down"></i></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="icon green"><i class="fa fa-thumbs-up"></i></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task-based interfaces tend to provide more fine-grained controls that capture user intent a lot more explicitly, making them naturally more usable&#8201;&#8212;&#8201;especially in cases where the domain is complex.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reusability</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red"><span class="icon"><i class="fa fa-thumbs-down"></i></span></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="green"><span class="icon"><i class="fa fa-thumbs-up"></i></span></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task-based interfaces enable more complex features to be composed using simpler ones providing more flexibility to the consumers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scalability</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red"><span class="icon"><i class="fa fa-thumbs-down"></i></span></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="green"><span class="icon"><i class="fa fa-thumbs-up"></i></span></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task-based interfaces have an advantage because they can provide the ability to independently scale specific features. However, if the fine-grained task-based interfaces are used almost all the time in unison, it may be required to re-examine whether the users' intents are accurately captured.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red"><span class="icon"><i class="fa fa-thumbs-down"></i></span></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="green"><span class="icon"><i class="fa fa-thumbs-up"></i></span></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For task-based interfaces, security is enhanced from the producer&#8217;s perspective by enabling application of the <em>principle of least privilege<sup class="footnote">[<a id="_footnoteref_24" class="footnote" href="#_footnotedef_24" title="View footnote.">24</a>]</sup></em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complexity</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red"><span class="icon"><i class="fa fa-thumbs-down"></i></span></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="green"><span class="icon"><i class="fa fa-thumbs-up"></i></span></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complexity of the system as a whole is proportional to the number of features that need to be implemented. Assuming accidental complexity is avoided in both cases, task-based interfaces allow spreading complexity more or less uniformly across multiple simpler interfaces.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Latency</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="green"><span class="icon"><i class="fa fa-thumbs-up"></i></span></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red"><span class="icon"><i class="fa fa-thumbs-down"></i></span></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arguably, coarse-grained CRUD interfaces can enable consumers to achieve a lot more in less interactions, thereby providing low latency.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Management Overhead</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="green"><span class="icon"><i class="fa fa-thumbs-up"></i></span></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red"><span class="icon"><i class="fa fa-thumbs-down"></i></span></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For the provider, fine-grained interfaces require a lot more work managing a larger number of interfaces.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As we can see, the decision between CRUD-based and task-based interfaces is nuanced. We are not suggesting that you should choose one over the other. Which style you use will depend on your specific requirements and context. In our experience, task-based interfaces treat user intents as first class citizens and perpetrate the spirit of DDD&#8217;s ubiquitous language very elegantly. Our preference is to design interfaces as task-based where possible, because they result in more intuitive interfaces that better express the problem domain.</p>
</div>
<div class="paragraph">
<p>As systems evolve, and the support richer user experiences and multiple channels, CRUD-based seem to require additional translation layers to cater to user experience needs. The visual here depicts a typical layered architecture of a solution that supports multiple user experience channels:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/ui-patterns/bff.png" alt="bff">
</div>
</div>
<div class="paragraph">
<p>This set up is usually composed of:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Domain tier comprised of CRUD-based services that simply map closely to database entities.</p>
</li>
<li>
<p>Composite tier comprised of business capabilities that span more than one core service.</p>
</li>
<li>
<p>Backend-for-frontend (<a href="https://philcalcado.com/2015/09/18/the_back_end_for_front_end_pattern_bff.html">BFF</a><sup class="footnote">[<a id="_footnoteref_25" class="footnote" href="#_footnotedef_25" title="View footnote.">25</a>]</sup>) tier comprised of channel-specific APIs.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Do note that the composite and BFF tiers exist primarily as a means to map backend capabilities to user intent. In an ideal world, where backend APIs reflect user intent closely, the need for translations should be minimal (if at all). Our experience suggests that such a setup causes business logic to get pushed closer to the user channels as opposed to being encapsulated within the confines of well-factored business services. In addition, these tiers cause inconsistent experiences across channels for the same functionality, given that modern teams are structured along tier boundaries.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
We are not opposed to the use of layered architectures. We recognize that a layered architecture can bring modularity, separation of concerns and other related benefits. However, we are opposed to creating additional tiers merely as a means to compensate for poorly factored core domain APIs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A well factored API tier can have a profound effect on how great user experiences are built. However, this is a chapter on implementing the user interface. Let&#8217;s revert to creating the user interface for the LC application.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bootstrapping-the-ui"><a class="anchor" href="#bootstrapping-the-ui"></a><a class="link" href="#bootstrapping-the-ui">6.3. Bootstrapping the UI</a></h3>
<div class="paragraph">
<p>We will be building the UI for the LC issuance application we created in <a href="#_implementing_domain_logic">Chapter 5: Implementing Domain Logic</a>. For detailed instructions, refer to the section on <a href="#_bootstapping_the_application"><em>Bootstrapping the application</em></a>. In addition, we will need to add the following dependencies to the <code>dependencies</code> section of the Maven <code>pom.xml</code> file in the root directory of the project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td>
  <td class="code"><pre><span style="color:#070;font-weight:bold">&lt;dependencies&gt;</span>
    <span style="color:#777">&lt;!--...--&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.openjfx<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>javafx-controls<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${javafx.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.openjfx<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>javafx-graphics<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${javafx.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.openjfx<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>javafx-fxml<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${javafx.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>de.saxsys<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>mvvmfx<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${mvvmfx.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>de.saxsys<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>mvvmfx-spring-boot<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${mvvmfx.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#777">&lt;!--...--&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependencies&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To run UI tests, you will need to add the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
  <td class="code"><pre><span style="color:#070;font-weight:bold">&lt;dependencies&gt;</span>
    <span style="color:#777">&lt;!--...--&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.testfx<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>testfx-junit5<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#070;font-weight:bold">&lt;/scope&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${testfx-junit5.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.testfx<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>openjfx-monocle<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${openjfx-monocle.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>de.saxsys<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>mvvmfx-testing-utils<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${mvvmfx.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#070;font-weight:bold">&lt;/scope&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#777">&lt;!--...--&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependencies&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To be able to run the application from the command line, you will need to add the <code>javafx-maven-plugin</code> to the <code>plugins</code> section of your <code>pom.xml</code>, per the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre><span style="color:#070;font-weight:bold">&lt;plugin&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.openjfx<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>javafx-maven-plugin<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${javafx-maven-plugin.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;configuration&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;mainClass&gt;</span>com.premonition.lc.ch06.App<span style="color:#070;font-weight:bold">&lt;/mainClass&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/configuration&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/plugin&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To run the application from the command line, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mvn javafx:run</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are using a JDK greater that version 1.8, the JavaFX libraries may not be bundled with the JDK itself. When running the application from your IDE, you will likely need to add the following:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--module-path=&lt;path-to-javafx-sdk&gt;/lib/ \
   --add-modules=javafx.controls,javafx.graphics,javafx.fxml,javafx.media</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are making use of the mvvmFX framework to assemble the UI. To make this work with spring boot, the application launcher looks as depicted here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span style="color:#007">@SpringBootApplication</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">App</span> <span style="color:#088;font-weight:bold">extends</span> MvvmfxSpringApplication { <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#339;font-weight:bold">void</span> main(<span style="color:#0a8;font-weight:bold">String</span><span style="color:#339;font-weight:bold">[]</span> args) {
        Application.launch(args);
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> startMvvmfx(Stage stage) {
        stage.setTitle(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC Issuance</span><span style="color:#710">&quot;</span></span>);

        <span style="color:#088;font-weight:bold">final</span> Parent parent = FluentViewLoader
                .fxmlView(MainView.class)
                .load().getView();

        <span style="color:#088;font-weight:bold">final</span> Scene scene = <span style="color:#080;font-weight:bold">new</span> Scene(parent);
        stage.setScene(scene);
        stage.show();
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note that we are required to extend from the mvvmFX framework class <code>MvvmfxSpringApplication</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to the ch06 directory of the accompanying source code repository for the complete example.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="implementing-the-ui"><a class="anchor" href="#implementing-the-ui"></a><a class="link" href="#implementing-the-ui">6.4. Implementing the UI</a></h3>
<div class="paragraph">
<p>When working with user interfaces, it is fairly customary to use one of these presentation patterns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Model-View-Controller (MVC)</p>
</li>
<li>
<p>Model-View-Presenter (MVP)</p>
</li>
<li>
<p>Model-View-ViewModel (MVVM)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The MVC pattern has been around for the longest time. The idea of separating concerns among collaborating model, view and controller objects is a sound one. However, beyond the definition of these objects, actual implementations seem to vary wildly&#8201;&#8212;&#8201;with the controller becoming overly complex in a lot of cases. In contrast, MVP and MVVM, while being derivatives of MVC, seem to bring out better separation of concerns between the collaborating objects. MVVM, in particular when coupled with data binding constructs, make for code that is much more readable, maintainable and testable. In this book, we make use of MVVM because it enables test-driven development which is a strong personal preference for us. Let&#8217;s look at a quick MVVM primer as implemented in the <code>mvvmfx</code> framework.</p>
</div>
<div class="sect3">
<h4 id="model-view-view-model-mvvm-primer"><a class="anchor" href="#model-view-view-model-mvvm-primer"></a><a class="link" href="#model-view-view-model-mvvm-primer">6.4.1. Model View View-Model (MVVM) primer</a></h4>
<div class="paragraph">
<p>Modern UI frameworks started adopting a declarative style to express the view. MVVM was designed to remove all GUI code (code-behind) from the view by making use of binding expressions. This allowed for a cleaner separation of stylistic vs. programming concerns. A high level visual of how this pattern is implemented is shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/ui-patterns/mvvm.png" alt="mvvm">
</div>
<div class="title">Figure 1- 70. MVVM design pattern</div>
</div>
<div class="paragraph">
<p>The pattern comprises the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Model</strong>: responsible to house the business logic and managing the state of the application.</p>
</li>
<li>
<p><strong>View</strong>: responsible for presenting data to the user and notifying the view-model about user interactions through the view delegate.</p>
</li>
<li>
<p><strong>View Delegate</strong>: responsible for keeping the view and the view model in sync as changes are made by the user or on the view model. It is also responsible for transmitting actions performed on the view to the view model.</p>
</li>
<li>
<p><strong>View-Model</strong>: responsible for handling user interactions on behalf of the view. The view-model interacts with the view using the observer pattern (typically one-way or two-way data binding to make it more convenient). The view-model interacts with the model for updates and read operations.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-a-new-lc"><a class="anchor" href="#creating-a-new-lc"></a><a class="link" href="#creating-a-new-lc">6.4.2. Creating a new LC</a></h4>
<div class="paragraph">
<p>Let&#8217;s consider the example of creating a new LC. To start creation of a new LC, all we need is for the applicant to provide a friendly client reference. This is an easy to remember string of free text. A simple rendition of this UI is shown here:</p>
</div>
<div id="start-lc-creation-screen" class="imageblock text-center">
<div class="content">
<img src="./images/mvvm/start-lc-ui.png" alt="start lc ui">
</div>
<div class="title">Figure 1- 71. Start LC creation screen</div>
</div>
<div class="paragraph">
<p>Let&#8217;s examine the implementation and purpose of each component in more detail.</p>
</div>
<div class="sect4">
<h5 id="declarative-view"><a class="anchor" href="#declarative-view"></a><a class="link" href="#declarative-view">Declarative view</a></h5>
<div class="paragraph">
<p>When working with JavaFX, the view can be rendered using a declarative style in FXML format. Important excerpts from the <code>StartLCView.fxml</code> file to start creating a new LC are shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span style="color:#777">&lt;?import javafx.scene.layout.Pane?&gt;</span>
<span style="color:#777">&lt;?import javafx.scene.control.Button?&gt;</span>
<span style="color:#777">&lt;?import javafx.scene.control.TextField?&gt;</span>

<span style="color:#070;font-weight:bold">&lt;Pane</span> <span style="color:#b48">id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">start-lc</span><span style="color:#710">&quot;</span></span>  <span style="color:#b48">xmlns</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://javafx.com/javafx/16</span><span style="color:#710">&quot;</span></span>
                      <span style="color:#b48">xmlns:fx</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://javafx.com/fxml/1</span><span style="color:#710">&quot;</span></span>
      <span style="color:#b48">fx:controller</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">com.premonition.lc.ch06.ui.views.StartLCView</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>      <i class="conum" data-value="1"></i><b>(1)</b>
    ...

    <span style="color:#070;font-weight:bold">&lt;TextField</span> <span style="color:#b48">id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">client-reference</span><span style="color:#710">&quot;</span></span>
               <span style="color:#b48">fx:id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">clientReference</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>                                 <i class="conum" data-value="2"></i><b>(2)</b>

    <span style="color:#070;font-weight:bold">&lt;Button</span> <span style="color:#b48">id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">start-button</span><span style="color:#710">&quot;</span></span>
            <span style="color:#b48">fx:id</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">startButton</span><span style="color:#710">&quot;</span></span>
            <span style="color:#b48">text</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Start</span><span style="color:#710">&quot;</span></span>
            <span style="color:#b48">onAction</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#start</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">/&gt;</span>                                          <i class="conum" data-value="3"></i><b>(3)</b>
    ...
<span style="color:#070;font-weight:bold">&lt;/Pane&gt;</span>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>StartLCView</code> class acts as the view delegate for the FXML view and is assigned using the <code>fx:controller</code> attribute of the root element (<code>javafx.scene.layout.Pane</code> in this case).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In order to reference <code>client-reference</code> input field in the view delegate, we use the <code>fx:id</code> annotation&#8201;&#8212;&#8201;<code>clientReference</code> in this case.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Similarly, the <code>start-button</code> is referenced using <code>fx:id="startButton"</code> in the view delegate. Furthermore, the <code>start</code> method in the view delegate is assigned to handle the default action (the button press event for <code>javafx.scene.control.Button</code>).</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="view-delegate"><a class="anchor" href="#view-delegate"></a><a class="link" href="#view-delegate">View delegate</a></h5>
<div class="paragraph">
<p>Next, let&#8217;s look at the structure of the view delegate <code>com.premonition.lc.issuance.ui.views.StartLCView</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">javafx.fxml.FXML</span>;
<span style="color:#777">//...</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCView</span> {                     <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@FXML</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">TextField</span> clientReference;         <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#007">@FXML</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Button</span> startButton;                <i class="conum" data-value="3"></i><b>(3)</b>

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> start(<span style="color:#0a8;font-weight:bold">ActionEvent</span> event) {     <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#777">// Handle button press logic here</span>
    }

    <span style="color:#777">// Other parts omitted for brevity...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The view delegate class for the <code>StartLCView.fxml</code> view.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The Java binding for the <code>clientReference</code> textbox in the view. The name of the member needs to match exactly with the value of the <code>fx:id</code> attribute in the view. Further, it needs to be annotated with the <code>@javafx.fxml.FXML</code> annotation. The use of the <code>@FXML</code> annotation is optional if the member in the view delegate is <code>public</code> and matches the name in the view.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Similarly, the <code>startButton</code> is bound to the corresponding button widget in the view.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The method for the action handler when the <code>startButton</code> is pressed.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="view-model"><a class="anchor" href="#view-model"></a><a class="link" href="#view-model">View-Model</a></h5>
<div class="paragraph">
<p>The view-model class <code>StartLCViewModel</code> for the <code>StartLCView</code> is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">javafx.beans.property.StringProperty</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">de.saxsys.mvvmfx.ViewModel</span>;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewModel</span> <span style="color:#088;font-weight:bold">implements</span> ViewModel {       <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> StringProperty clientReference;          <i class="conum" data-value="2"></i><b>(2)</b>

    <span style="color:#088;font-weight:bold">public</span> StartLCViewModel() {
        <span style="color:#950">this</span>.clientReference = <span style="color:#080;font-weight:bold">new</span> SimpleStringProperty(); <i class="conum" data-value="3"></i><b>(3)</b>
    }

    <span style="color:#088;font-weight:bold">public</span> StringProperty clientReferenceProperty() {      <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#080;font-weight:bold">return</span> clientReference;
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> getClientReference() {
        <span style="color:#080;font-weight:bold">return</span> clientReference.get();
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> setClientReference(<span style="color:#0a8;font-weight:bold">String</span> clientReference) {
        <span style="color:#950">this</span>.clientReference.set(clientReference);
    }

    <span style="color:#777">// Other getters and setters omitted for brevity</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The view-model class for the <code>StartLCView</code>. Note that we are required to implement the <code>de.saxsys.mvvmfx.ViewModel</code> interface provided by the mvvmFX framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We are initializing the <code>clientReference</code> property using the <code>SimpleStringProperty</code> provided by JavaFX. There are several other property classes to define more complex types. Please refer to the JavaFX documentation for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The value of the <code>clientReference</code> in the view-model. We will look at how to associate this with value of the <code>clientReference</code> textbox in the view shortly. Note that we are using the <code>StringProperty</code> provided by <code>JavaFX</code>, which provides access to the underlying <code>String</code> value of the client reference.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>JavaFX</code> beans are required to create a special accessor for the property itself in addition to the standard getter and setter for the underlying value.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="binding-the-view-to-the-view-model"><a class="anchor" href="#binding-the-view-to-the-view-model"></a><a class="link" href="#binding-the-view-to-the-view-model">Binding the view to the view-model</a></h5>
<div class="paragraph">
<p>Next, let&#8217;s look at how to associate the view to the view-model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">de.saxsys.mvvmfx.Initialize</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">de.saxsys.mvvmfx.FxmlView</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">de.saxsys.mvvmfx.InjectViewModel</span>;
<span style="color:#777">//...</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCView</span> <span style="color:#088;font-weight:bold">implements</span> FxmlView&lt;StartLCViewModel&gt; {     <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@FXML</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">TextField</span> clientReference;
    <span style="color:#007">@FXML</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Button</span> startButton;

    <span style="color:#007">@InjectViewModel</span>
    <span style="color:#088;font-weight:bold">private</span> StartLCViewModel viewModel;                              <i class="conum" data-value="2"></i><b>(2)</b>

    <span style="color:#007">@Initialize</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> initialize() {                                      <i class="conum" data-value="3"></i><b>(3)</b>
        clientReference.textProperty()
            .bindBidirectional(viewModel.clientReferenceProperty()); <i class="conum" data-value="4"></i><b>(4)</b>
        startButton.disableProperty()
            .bind(viewModel.startDisabledProperty());                <i class="conum" data-value="5"></i><b>(5)</b>
    }

    <span style="color:#777">// Other parts omitted for brevity...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The mvvmFX framework requires that the view delegate implement the <code>FXMLView&lt;? extends ViewModelType&gt;</code>. In this case, the view-model type is <code>StartLCViewModel</code>. The mvvmFX framework supports other view types as well. Please refer to the framework documentation for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The framework provides a <code>@de.saxsys.mvvmfx.InjectViewModel</code> annotation to allow dependency injecting the view-model into the view delegate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The framework will invoke all methods annotated with the <code>@de.saxsys.mvvmfx.Initialize</code> annotation during the initialization process. The annotation can be omitted if the method is named <code>initialize</code> and is declared <code>public</code>. Please refer to the framework documentation for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We have now bound the text property of the <code>clientReference</code> textbox in the view delegate to the corresponding property in the view-model. Note that this is a <strong>bidirectional</strong> binding, which means that the value in the view and the view model are kept in sync if it changes on either side.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This is another variation of binding in action, where we are making use of a unidirectional binding. Here, we are binding the disabled property of the <code>start</code> button to the corresponding property on the view-model. We will look at why we need to do this shortly.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="enforcing-business-validations-in-the-ui"><a class="anchor" href="#enforcing-business-validations-in-the-ui"></a><a class="link" href="#enforcing-business-validations-in-the-ui">Enforcing business validations in the UI</a></h5>
<div class="paragraph">
<p>We have a business validation that the client reference for an LC needs to be at least 4 characters in length. This will be enforced on the back-end. However, to provide a richer user experience, we will also enforce this validation on the UI.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This may feel contrary to the notion of centralizing business validations on the back-end. While this may be a noble attempt at implementing the DRY (Don&#8217;t Repeat Yourself) principle, in reality, it poses a lot of practical problems. Distributed systems expert&#8201;&#8212;&#8201;Udi Dahan has a very interesting take on why this may not be such a virtuous thing to pursue<sup class="footnote">[<a id="_footnoteref_26" class="footnote" href="#_footnotedef_26" title="View footnote.">26</a>]</sup>. Ted Neward also talks about this in his blog titled <em>The Fallacies of Enterprise Computing</em><sup class="footnote">[<a id="_footnoteref_27" class="footnote" href="#_footnotedef_27" title="View footnote.">27</a>]</sup>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The advantage of using MVVM is that this logic is easily testable in a simple unit test of the view-model. Let&#8217;s see this in action test-drive this now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewModelTests</span> {

    <span style="color:#088;font-weight:bold">private</span> StartLCViewModel viewModel;

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> before() {
        <span style="color:#339;font-weight:bold">int</span> clientReferenceMinLength = <span style="color:#00D">4</span>;
        viewModel = <span style="color:#080;font-weight:bold">new</span> StartLCViewModel(clientReferenceMinLength);
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotEnableStartByDefault() {
        assertThat(viewModel.getStartDisabled()).isTrue();
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotEnableStartIfClientReferenceLesserThanMinimumLength() {
        viewModel.setClientReference(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">123</span><span style="color:#710">&quot;</span></span>);
        assertThat(viewModel.getStartDisabled()).isTrue();
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldEnableStartIfClientReferenceEqualToMinimumLength() {
        viewModel.setClientReference(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">1234</span><span style="color:#710">&quot;</span></span>);
        assertThat(viewModel.getStartDisabled()).isFalse();
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldEnableStartIfClientReferenceGreaterThanMinimumLength() {
        viewModel.setClientReference(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">12345</span><span style="color:#710">&quot;</span></span>);
        assertThat(viewModel.getStartDisabled()).isFalse();
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s look at the implementation for this functionality in the view-model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewModel</span> <span style="color:#088;font-weight:bold">implements</span> ViewModel {

    <span style="color:#777">//...</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> StringProperty clientReference;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> BooleanProperty startDisabled;                     <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">public</span> StartLCViewModel(<span style="color:#339;font-weight:bold">int</span> clientReferenceMinLength) {          <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#950">this</span>.clientReference = <span style="color:#080;font-weight:bold">new</span> SimpleStringProperty();
        <span style="color:#950">this</span>.startDisabled = <span style="color:#080;font-weight:bold">new</span> SimpleBooleanProperty();
        <span style="color:#950">this</span>.startDisabled
            .bind(<span style="color:#950">this</span>.clientReference.length()
                    .lessThan(clientReferenceMinLength));            <i class="conum" data-value="3"></i><b>(3)</b>
    }

    <span style="color:#777">//...</span>
}

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCView</span> <span style="color:#088;font-weight:bold">implements</span> FxmlView&lt;StartLCViewModel&gt; {

    <span style="color:#777">//...</span>
    <span style="color:#007">@Initialize</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> initialize() {
        startButton.disableProperty()
            .bind(viewModel.startDisabledProperty());                <i class="conum" data-value="4"></i><b>(4)</b>
        clientReference.textProperty()
            .bindBidirectional(viewModel.clientReferenceProperty());
    }
    <span style="color:#777">//...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We declare a <code>startDisabled</code> property in the view-model to manage when the start button should be disabled.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The minimum length for a valid client reference is injected into the view-model. It is conceivable that this value will be provided as part of external configuration, or possibly from the back-end.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We create a binding expression to match the business requirement.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We bind the view-model property to the disabled property of the start button in the view delegate.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s also look at how to write an end-to-end, headless UI test as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td>
  <td class="code"><pre>
<span style="color:#007">@UITest</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewTests</span> {                                   <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@Autowired</span>
    <span style="color:#088;font-weight:bold">private</span> ApplicationContext context;

    <span style="color:#007">@Init</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> init() {
        MvvmFX.setCustomDependencyInjector(context::getBean);     <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span style="color:#007">@Start</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> start(Stage stage) {                              <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="color:#088;font-weight:bold">final</span> Parent parent = FluentViewLoader
                .fxmlView(StartLCView.class)
                .load().getView();
        stage.setScene(<span style="color:#080;font-weight:bold">new</span> Scene(parent));
        stage.show();
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> blankClientReference(FxRobot robot) {
        robot.lookup(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#client-reference</span><span style="color:#710">&quot;</span></span>)                         <i class="conum" data-value="4"></i><b>(4)</b>
            .queryAs(<span style="color:#0a8;font-weight:bold">TextField</span>.class)
            .setText(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>);

        verifyThat(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#start-button</span><span style="color:#710">&quot;</span></span>, NodeMatchers.isDisabled());   <i class="conum" data-value="5"></i><b>(5)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> validClientReference(FxRobot robot) {
        robot.lookup(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#client-reference</span><span style="color:#710">&quot;</span></span>)
            .queryAs(<span style="color:#0a8;font-weight:bold">TextField</span>.class)
            .setText(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Test</span><span style="color:#710">&quot;</span></span>);

        verifyThat(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#start-button</span><span style="color:#710">&quot;</span></span>, NodeMatchers.isEnabled());    <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We have written a convenience <code>@UITest</code> extension to combine spring framework and TestFX testing. Please refer to the accompanying source code with the book for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We set up the spring context to act as the dependency injection provider for the mvvmFX framework and its injection annotations (for example, <code>@InjectViewModel</code>) to work.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We are using the <code>@Start</code> annotation provided by the TestFX framework to launch the UI.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The TestFX framework injects an instance of the <code>FxRobot</code> UI helper, which we can use to access UI elements.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We are using the The TestFX framework provided convenience matchers for test assertions.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, when we run the application, we can see that the start button is enabled when a valid client reference is entered:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/mvvm/valid-client-reference-input.png" alt="valid client reference input">
</div>
<div class="title">Figure 1- 72. The start button is enabled with a valid client reference</div>
</div>
<div class="paragraph">
<p>Now that we have the start button enabling correctly, let&#8217;s implement the actual creation of the LC itself by invoking the backend API.</p>
</div>
</div>
<div class="sect4">
<h5 id="integrating-with-the-backend"><a class="anchor" href="#integrating-with-the-backend"></a><a class="link" href="#integrating-with-the-backend">Integrating with the backend</a></h5>
<div class="paragraph">
<p>LC creation is a complex process, requiring information about a variety of items as evidenced in figure <a href="#revised-commands">Figure 1- 69</a> when we decomposed the LC creation process. In this section, we will integrate the UI with the command to start creation of a new LC. This happens when we press the <em>Start</em> button on the <a href="#start-lc-creation-screen">Figure 1- 71</a>. The revised <code>StartNewLCApplicationCommand</code> looks as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartNewLCApplicationCommand</span> {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> applicantId;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> LCApplicationId id;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> clientReference;

    <span style="color:#088;font-weight:bold">private</span> StartNewLCApplicationCommand(<span style="color:#0a8;font-weight:bold">String</span> applicantId, <span style="color:#0a8;font-weight:bold">String</span> clientReference) {
        <span style="color:#950">this</span>.id = LCApplicationId.randomId();
        <span style="color:#950">this</span>.applicantId = applicantId;
        <span style="color:#950">this</span>.clientReference = clientReference;
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> StartNewLCApplicationCommand startApplication( <i class="conum" data-value="1"></i><b>(1)</b>
                    <span style="color:#0a8;font-weight:bold">String</span> applicantId,
                    <span style="color:#0a8;font-weight:bold">String</span> clientReference) {
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> StartNewLCApplicationCommand(applicantId, clientReference);
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To start a new LC application, we need an <code>applicantId</code> and a <code>clientReference</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Given that we are using the MVVM pattern, the code to invoke the backend service is part of the view-model. Let&#8217;s test-drive this functionality:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span style="color:#007">@ExtendWith</span>(MockitoExtension.class)
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewModelTests</span> {

    <span style="color:#007">@Mock</span>
    <span style="color:#088;font-weight:bold">private</span> BackendService service;

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> before() {
        <span style="color:#339;font-weight:bold">int</span> clientReferenceMinLength = <span style="color:#00D">4</span>;
        viewModel = <span style="color:#080;font-weight:bold">new</span> StartLCViewModel(clientReferenceMinLength, service);
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotInvokeBackendIfStartButtonIsDisabled() {
        viewModel.setClientReference(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>);
        viewModel.startNewLC();

        Mockito.verifyNoInteractions(service);
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The view-model is enhanced accordingly to inject an instance of the <code>BackendService</code> and looks as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewModel</span> <span style="color:#088;font-weight:bold">implements</span> ViewModel {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> BackendService service;
    <span style="color:#777">// Other members omitted for brevity</span>

    <span style="color:#088;font-weight:bold">public</span> StartLCViewModel(<span style="color:#339;font-weight:bold">int</span> clientReferenceMinLength,
                            BackendService service) {
        <span style="color:#950">this</span>.service = service;
        <span style="color:#777">// Other code omitted for brevity</span>
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> startNewLC() {
        <span style="color:#777">// TODO: invoke backend!</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now a test to actually make sure that the backend gets invoked only when a valid client reference is input:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewModelTests</span> {
    <span style="color:#777">// ...</span>

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> before() {
        viewModel = <span style="color:#080;font-weight:bold">new</span> StartLCViewModel(<span style="color:#00D">4</span>, service);
        viewModel.setLoggedInUser(<span style="color:#080;font-weight:bold">new</span> LoggedInUserScope(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">test-applicant</span><span style="color:#710">&quot;</span></span>));   <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotInvokeBackendIfStartButtonIsDisabled() {
        viewModel.setClientReference(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>);
        viewModel.startNewLC();

        Mockito.verifyNoInteractions(service);                                <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldInvokeBackendWhenStartingCreationOfNewLC() {
        viewModel.setClientReference(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My first LC</span><span style="color:#710">&quot;</span></span>);
        viewModel.startNewLC();

        Mockito.verify(service).startNewLC(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">test-applicant</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My first LC</span><span style="color:#710">&quot;</span></span>);  <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We set the logged in user</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When the client reference is blank, there should be no interactions with the backend service.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When a valid value for the client reference is entered, the backend should be invoked with the entered value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation to make this test pass, then looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewModel</span> {
    <span style="color:#777">//...</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> startNewLC() {
        <span style="color:#080;font-weight:bold">if</span> (!getStartDisabled()) {                  <i class="conum" data-value="1"></i><b>(1)</b>
            service.startNewLC(
                    userScope.getLoggedInUserId(),
                    getClientReference());          <i class="conum" data-value="2"></i><b>(2)</b>
        }
    }
    <span style="color:#777">//...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We check that the start button is enabled before invoking the backend.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The actual backend call with the appropriate values.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at how to integrate the backend call from the view. We test this in a UI test as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td>
  <td class="code"><pre><span style="color:#007">@UITest</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewTests</span> {

    <span style="color:#007">@MockBean</span>
    <span style="color:#088;font-weight:bold">private</span> BackendService service;                                   <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#777">//...</span>

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldLaunchLCDetailsWhenCreationIsSuccessful(FxRobot robot) {
        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> clientReference = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My first LC</span><span style="color:#710">&quot;</span></span>;
        LCApplicationId lcApplicationId = LCApplicationId.randomId();

        when(service.startNewLC(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">test-applicant</span><span style="color:#710">&quot;</span></span>, clientReference))
                .thenReturn(lcApplicationId);                         <i class="conum" data-value="2"></i><b>(2)</b>

        robot.lookup(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#client-reference</span><span style="color:#710">&quot;</span></span>)
            .queryAs(<span style="color:#0a8;font-weight:bold">TextField</span>.class)
            .setText(clientReference);                                <i class="conum" data-value="3"></i><b>(3)</b>
        robot.clickOn(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#start-button</span><span style="color:#710">&quot;</span></span>);                               <i class="conum" data-value="4"></i><b>(4)</b>

        Mockito.verify(service).startNewLC(
                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">test-applicant</span><span style="color:#710">&quot;</span></span>, clientReference);                   <i class="conum" data-value="5"></i><b>(5)</b>

        verifyThat(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#lc-details-screen</span><span style="color:#710">&quot;</span></span>, isVisible());                <i class="conum" data-value="6"></i><b>(6)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We inject a mock instance of the backend service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We stub the call to the backend to return successfully.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We type in a valid value for the client reference.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We click on the <code>start</code> button.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We verify that the service was indeed invoked with the correct arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We verify that we have moved to the next screen in the UI (the LC details screen).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s also look at what happens when the service invocation fails in another test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCViewTests</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldStayOnCreateLCScreenOnCreationFailure(FxRobot robot) {
        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> clientReference = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My first LC</span><span style="color:#710">&quot;</span></span>;
        when(service.startNewLC(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">test-applicant</span><span style="color:#710">&quot;</span></span>, clientReference))
            .thenThrow(<span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">RuntimeException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Failed!!</span><span style="color:#710">&quot;</span></span>));   <i class="conum" data-value="1"></i><b>(1)</b>

        robot.lookup(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#client-reference</span><span style="color:#710">&quot;</span></span>)
            .queryAs(<span style="color:#0a8;font-weight:bold">TextField</span>.class)
            .setText(clientReference);
        robot.clickOn(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#start-button</span><span style="color:#710">&quot;</span></span>);

        verifyThat(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#start-lc-screen</span><span style="color:#710">&quot;</span></span>, isVisible());        <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We stub the backend service call to fail with an exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We verify that we continue to remain on the <code>start-lc-screen</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The view implementation for this functionality is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">javafx.concurrent.Service</span>;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StartLCView</span> {
    <span style="color:#777">//...</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> start(<span style="color:#0a8;font-weight:bold">ActionEvent</span> event) {
        <span style="color:#080;font-weight:bold">new</span> Service&lt;<span style="color:#0a8;font-weight:bold">Void</span>&gt;() {                    <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#007">@Override</span>
            <span style="color:#088;font-weight:bold">private</span> Task&lt;<span style="color:#0a8;font-weight:bold">Void</span>&gt; createTask() {
                <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> Task&lt;&gt;() {
                    <span style="color:#007">@Override</span>
                    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Void</span> call() {
                        viewModel.startNewLC();  <i class="conum" data-value="2"></i><b>(2)</b>
                        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">null</span>;
                    }
                };
            }

            <span style="color:#007">@Override</span>
            <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> succeeded() {
                Stage stage = UIUtils.getStage(event);
                showLCDetailsView(stage);        <i class="conum" data-value="3"></i><b>(3)</b>
            }

            <span style="color:#007">@Override</span>
            <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> failed() {
                <span style="color:#777">// Nothing for now. Remain on the same screen.</span>
            }
        }.start();
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JavaFX, like most frontend frameworks, is single-threaded and requires that long-running tasks not be invoked on the UI thread. For this purpose, it provides the <code>javafx.concurrent.Service</code> abstraction to handle such interactions elegantly in a background thread.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The actual invocation of the backend through the view-model happens here.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We show the next screen to enter more LC details here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, the service implementation itself is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.commandhandling.gateway.CommandGateway</span>;

<span style="color:#007">@Service</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">BackendService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> CommandGateway gateway;                         <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">public</span> BackendService(CommandGateway gateway) {
        <span style="color:#950">this</span>.gateway = gateway;
    }

    <span style="color:#088;font-weight:bold">public</span> LCApplicationId startNewLC(<span style="color:#0a8;font-weight:bold">String</span> applicantId, <span style="color:#0a8;font-weight:bold">String</span> clientReference) {
        <span style="color:#080;font-weight:bold">return</span> gateway.sendAndWait(                               <i class="conum" data-value="2"></i><b>(2)</b>
                  startApplication(applicantId, clientReference)
               );
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We inject the <code>org.axonframework.commandhandling.gateway.CommandGateway</code> provided by the Axon framework to invoke the command.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The actual invocation of the backend using the <code>sendAndWait</code> method happens here. In this case, we are blocking until the backend call completes. There are other variations that do not require this kind of blocking. Please refer to the Axon framework documentation for more details.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have now seen a complete example of how to implement the UI and invoke the backend API.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary-6"><a class="anchor" href="#summary-6"></a><a class="link" href="#summary-6">6.5. Summary</a></h3>
<div class="paragraph">
<p>In this chapter, we looked the nuances of API styles and clarified why it is very important to design APIs that capture the users' intent closely. We looked at the differences between CRUD-based and task-based APIs. Finally, we implemented the UI making use of the MVVM design pattern and demonstrated how it aids in test-driving frontend functionality.</p>
</div>
<div class="paragraph">
<p>Now that we have implemented the creation of new LC, for implementing the subsequent commands we will require access to an existing LC.  In the next chapter, we will look at how to implement the query side and how to keep it in sync with the command side.</p>
</div>
</div>
<div class="sect2">
<h3 id="questions-5"><a class="anchor" href="#questions-5"></a><a class="link" href="#questions-5">6.6. Questions</a></h3>
<div class="ulist">
<ul>
<li>
<p>What kind of APIs do you come up with in your domain? CRUD-based? Task-based? Something else?</p>
</li>
<li>
<p>How do consumers find your APIs? Do they have to implement further translations of your APIs to consume them meaningfully?</p>
</li>
<li>
<p>Are you able to test-drive your front-end functionality? Do you see merit in this approach?</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-5"><a class="anchor" href="#further-reading-5"></a><a class="link" href="#further-reading-5">6.7. Further reading</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Task-drien user interfaces</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oleksandr Sukholeyster</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.uxmatters.com/mt/archives/2014/12/task-driven-user-interfaces.php" class="bare">https://www.uxmatters.com/mt/archives/2014/12/task-driven-user-interfaces.php</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Business logic, a different perspective</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Udi Dahan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://vimeo.com/131757759" class="bare">https://vimeo.com/131757759</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Fallacies of Enterprise Computing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ted Neward</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://blogs.tedneward.com/post/enterprise-computing-fallacies/" class="bare">http://blogs.tedneward.com/post/enterprise-computing-fallacies/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GUI architectures</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/eaaDev/uiArchs.html" class="bare">https://martinfowler.com/eaaDev/uiArchs.html</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1 text-justify">
<h2 id="implementing-queries"><a class="anchor" href="#implementing-queries"></a><a class="link" href="#implementing-queries">7. Implementing Queries</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The best view comes after the hardest climb.
</blockquote>
<div class="attribution">
&#8212; Anonymous
</div>
</div>
<div class="paragraph">
<p>In the section on <a href="#_cqrs_pattern">CQRS</a> from <a href="#_where_does_ddd_fit">Chapter 3 - Where and How Does DDD Fit?</a>, we described how DDD and CQRS complement each other and how the query side (read models) can be used to create one or more representations of the underlying data. In this chapter, we will dive deeper into how we can construct read optimized representations of the data by listening to domain events. We will also look at persistence options for these read models.</p>
</div>
<div class="paragraph">
<p>When working with query models, we construct models by listening to events as they happen. We will examine how to deal with situations where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>New requirements evolve over a period of time requiring us to build new query models.</p>
</li>
<li>
<p>We discover a bug in our query model which requires us to recreate the model from scratch.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By the end of this chapter, you will learn to appreciate how to build query models by listening to domain events. You will also learn how to purpose build new query models to suit specific read requirements as opposed to being restricted by the data model that was chosen to service commands. You will finally look at how historic event replays work and how you can use it to create new query models to service new requirements.</p>
</div>
<div class="sect2">
<h3 id="technical-requirements-4"><a class="anchor" href="#technical-requirements-4"></a><a class="link" href="#technical-requirements-4">7.1. Technical requirements</a></h3>
<div class="paragraph">
<p>To follow the examples in this chapter, you will need access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 1.8+ (We have used Java 17 to compile sample sources)</p>
</li>
<li>
<p>Spring Boot 2.4.x</p>
</li>
<li>
<p>Axon framework 4.5.3</p>
</li>
<li>
<p>JUnit 5.7.x (Included with spring boot)</p>
</li>
<li>
<p>Project Lombok (To reduce verbosity)</p>
</li>
<li>
<p>Maven 3.x</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to the ch07 directory of the book&#8217;s accompanying source code repository for complete working examples.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="continuing-our-design-journey-2"><a class="anchor" href="#continuing-our-design-journey-2"></a><a class="link" href="#continuing-our-design-journey-2">7.2. Continuing our design journey</a></h3>
<div class="paragraph">
<p>In <a href="#_domain_analysis_and_modeling">Chapter 4 - Domain analysis and modeling</a>, we discussed eventstorming as a lightweight method to clarify business flows. As a reminder, this is the output produced from our eventstorming session:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/event-storming/05-query-models.png" alt="05 query models">
</div>
<div class="title">Figure 1- 73. Recap of eventstorming session</div>
</div>
<div class="paragraph">
<p>As mentioned previously, we are making use of the CQRS architecture pattern to create the solution. For a detailed explanation on why this is a sound method to employ, please refer to the "<a href="#_when_to_use_cqrs">When to use CQRS</a>" section in <a href="#_where_does_ddd_fit">Chapter 3</a>. In the diagram above, the <strong>green</strong> stickies represent <strong>read/query models</strong>. These query models are required when validating a command (for example: list of valid product identifiers when processing the <code>ValidateProduct</code> command) or if information is simply required to be presented to the user (for example: a list of LCs created by an applicant). Lets look at what it means to apply CQRS in practical terms for the query side.</p>
</div>
</div>
<div class="sect2">
<h3 id="implementing-the-query-side"><a class="anchor" href="#implementing-the-query-side"></a><a class="link" href="#implementing-the-query-side">7.3. Implementing the query side</a></h3>
<div class="paragraph">
<p>In <a href="#_implementing_the_command_side">Chapter 5</a>, we examined how to publish events when a command is successfully processed. Now, let&#8217;s look at how we can construct a query model by listening to these domain events. Logically, this will look something like how it is depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/cqrs/cqrs-query-side.png" alt="cqrs query side">
</div>
<div class="title">Figure 1- 74. CQRS application&#8201;&#8212;&#8201;query side</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to the section on <a href="#_implementing_the_command_side">implementing the command side</a> in Chapter 5 for a detailed explanation of how the command side is implemented.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The high level sequence on the query side is described here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An event listening component listens to these domain events published on the event bus.</p>
</li>
<li>
<p>Constructs a purpose-built query model to satisfy a specific query use case.</p>
</li>
<li>
<p>This query model is persisted in a datastore optimized for read operations.</p>
</li>
<li>
<p>This query model is then exposed in the form of an API.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note how there can exist more than one query side component to handle respective scenarios.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s implement each of these steps to see how this works for our LC issuance application.</p>
</div>
<div class="sect3">
<h4 id="tooling-choices-2"><a class="anchor" href="#tooling-choices-2"></a><a class="link" href="#tooling-choices-2">7.3.1. Tooling choices</a></h4>
<div class="paragraph">
<p>In a CQRS application, there is a separation between the command and query side. At this time, this separation is logical in our application because both the command and query side are running as components within the same application process. To illustrate the concepts, we will use conveniences provided by the Axon framework to implement the query side in this chapter. In Chapter 10, we will look at how it may not be necessary to use a specialized framework (like Axon) to implement the query side.</p>
</div>
<div class="paragraph">
<p>When implementing the query side, we have two concerns to solve for as depicted in the following picture :</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/cqrs/cqrs-query-side-dissected.png" alt="Query side dissected">
</div>
<div class="title">Figure 1- 75. Query side dissected</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Consuming domain events and persisting one or more query models.</p>
</li>
<li>
<p>Exposing the query model as an API.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Before we start implementing these concerns, let&#8217;s identify the queries we need to implement for our LC issuance application.</p>
</div>
</div>
<div class="sect3">
<h4 id="identifying-queries"><a class="anchor" href="#identifying-queries"></a><a class="link" href="#identifying-queries">7.3.2. Identifying queries</a></h4>
<div class="paragraph">
<p>From the eventstorming session, we have the following queries to start with:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/potential-commands.png" alt="potential commands" width="1209" height="674">
</div>
<div class="title">Figure 1- 76. Identified queries</div>
</div>
<div class="paragraph">
<p>The queries marked in green (in the output from eventstorming session), all require us to expose a collection of LCs in various states. To represent this, we can create an <code>LCView</code> as shown here:</p>
</div>
<div class="paragraph">
<p>The <code>LCView</code> class is an extremely simple object devoid of any logic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCView</span> {

    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> applicantId;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> clientReference;
    <span style="color:#088;font-weight:bold">private</span> LCState state;

    <span style="color:#777">// Getters and setters omitted for brevity</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>These query models are an absolute necessity to implement basic functionality dictated by business requirements. But it is possible and very likely that we will need additional query models as the system requirements evolve. We will enhance our application to support these queries as and when the need arises.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_query_model"><a class="anchor" href="#_creating_the_query_model"></a><a class="link" href="#_creating_the_query_model">7.3.3. Creating the query model</a></h4>
<div class="paragraph">
<p>As seen in chapter 5, when starting a new LC application, the importer sends a <code>StartNewLCApplicationCommand</code>, which results in the <code>LCApplicationStartedEvent</code> being emitted as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">//..</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> LCApplication(StartNewLCApplicationCommand command) {
        <span style="color:#777">// Validation code omitted for brevity</span>
        <span style="color:#777">// Refer to chapter 5 for details.</span>
        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationStartedEvent(command.getId(),
                command.getApplicantId(), command.getClientReference()));
    }
    <span style="color:#777">//..</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s write an event processing component which will listen to this event and construct a query model. When working with the Axon framework, we have a convenient way to do this by annotating the event listening method with the <code>@EventHandler</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.eventhandling.EventHandler</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.stereotype.Component</span>;

<span style="color:#007">@Component</span>
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationStartedEventHandler</span> {

    <span style="color:#007">@EventHandler</span>                                      <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationStartedEvent event) {
        LCView view = <span style="color:#080;font-weight:bold">new</span> LCView(event.getId(),
                        event.getApplicantId(),
                        event.getClientReference(),
                        event.getState());             <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#777">// Perform any transformations to optimize access</span>
        repository.save(view);                         <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To make any method an event listener, we annotate it with the <code>@EventHandler</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The handler method needs to specify the event that we intend to listen to. There are other arguments that are supported for event handlers. Please refer to the Axon framework documentation for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We finally save the query model into an appropriate query store. When persisting this data, we should consider storing it in a form that is optimized for data access. In other words, we want to reduce as much complexity and cognitive load when querying this data.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>@EventHandler</code> annotation should not be confused with the <code>@EventSourcingHandler</code> annotation which we looked at in chapter 5. The <code>@EventSourcingHandler</code> annotation is used to replay events and restore aggregate state when loading event-sourced aggregates on the command side, whereas the <code>@EventHandler</code> annotation is used to listen to events outside the context of the aggregate. In other words, the <code>@EventSourcingHandler</code> annotation is used exclusively within aggregates, whereas the <code>@EventHandler</code> annotation can be used anywhere there is a need to consume domain events. In this case, we are using it to construct a query model.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="query-side-persistence-choices"><a class="anchor" href="#query-side-persistence-choices"></a><a class="link" href="#query-side-persistence-choices">7.3.4. Query side persistence choices</a></h4>
<div class="paragraph">
<p>Segregating the query side this way enables us to choose a persistence technology most appropriate for the problem being solved on the query side. For example, if extreme performance and simple filtering criteria are prime, it may be prudent to choose an in-memory store like Redis or Memcached. If complex search/analytics requirements and large datasets are to be supported, then we may want to consider something like ElasticSearch. Or we may even simply choose to stick with just a relational database. The point we would like to emphasize is that employing CQRS affords a level of flexibility that was previously not available to us.</p>
</div>
</div>
<div class="sect3">
<h4 id="exposing-a-query-api"><a class="anchor" href="#exposing-a-query-api"></a><a class="link" href="#exposing-a-query-api">7.3.5. Exposing a query API</a></h4>
<div class="paragraph">
<p>Applicants like to view the LCs they created, specifically those in the draft state. Let&#8217;s look at how we can implement this functionality. Let&#8217;s start by defining a simple object to capture the query criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.data.domain.Pageable</span>;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyDraftLCsQuery</span> {

    <span style="color:#088;font-weight:bold">private</span> ApplicantId applicantId;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Pageable</span> page;

    <span style="color:#777">// Getters and setters omitted for brevity</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s implement the query using spring&#8217;s repository pattern to retrieve the results for these criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.queryhandling.QueryHandler</span>;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">LCViewRepository</span> <span style="color:#088;font-weight:bold">extends</span> JpaRepository&lt;LCView, LCApplicationId&gt; {

    Page&lt;LCView&gt; findByApplicantIdAndState(         <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#0a8;font-weight:bold">String</span> applicantId,
            LCState state,
            <span style="color:#0a8;font-weight:bold">Pageable</span> page);

    <span style="color:#007">@QueryHandler</span>                                   <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#080;font-weight:bold">default</span> Page&lt;LCView&gt; on(MyDraftLCsQuery query) {
        <span style="color:#080;font-weight:bold">return</span> findByApplicantIdAndState(           <i class="conum" data-value="3"></i><b>(3)</b>
                query.getApplicantId(),
                LCState.DRAFT,
                query.getPage());
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the dynamic spring data finder method we will use to query the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>@QueryHandler</code> annotation provided by Axon framework routes query requests to the respective handler.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally, we invoke the finder method to return results.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the above example, we have implemented the <code>QueryHandler</code> method within the <code>Repository</code> itself for brevity. The <code>QueryHandler</code> can be placed elsewhere as well.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To connect this to the UI, we add a new method in the <code>BackendService</code> (originally introduced in Chapter 6) to invoke the query as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.queryhandling.QueryGateway</span>;

<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">BackendService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> QueryGateway queryGateway;                    <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;LCView&gt; findMyDraftLCs(<span style="color:#0a8;font-weight:bold">String</span> applicantId) {
        <span style="color:#080;font-weight:bold">return</span> queryGateway.query(                              <i class="conum" data-value="2"></i><b>(2)</b>
                <span style="color:#080;font-weight:bold">new</span> MyDraftLCsQuery(applicantId),
                        ResponseTypes.multipleInstancesOf(LCView.class))
                .join();

    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Axon framework provides the <code>QueryGateway</code> convenience that allows us to invoke the query.For more details on how to use the <code>QueryGateway</code>, please refer to the Axon framework documentation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We execute the query using the <code>MyDraftLCsQuery</code> object to return results.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What we looked at above, is an example of a very simple query implementation where we have a single <code>@QueryHandler</code> to service the query results.This implementation returns results as a one-time fetch.Let&#8217;s look at more complex query scenarios.</p>
</div>
</div>
<div class="sect3">
<h4 id="advanced-query-scenarios"><a class="anchor" href="#advanced-query-scenarios"></a><a class="link" href="#advanced-query-scenarios">7.3.6. Advanced query scenarios</a></h4>
<div class="paragraph">
<p>Our focus currently is on active LC applications.Maintaining issued LCs happens in a different bounded context of the system.Consider a scenario where we need to provide a consolidated view of currently active LC applications and issued LCs.In such a scenario, it is necessary to obtain this information by querying two distinct sources (ideally in parallel)&#8201;&#8212;&#8201;commonly referred to as the <a href="https://www.enterpriseintegrationpatterns.com/BroadcastAggregate.html">scatter-gather</a><sup class="footnote">[<a id="_footnoteref_28" class="footnote" href="#_footnotedef_28" title="View footnote.">28</a>]</sup> pattern.Please refer to the section on scatter-gather queries in the Axon framework documentation for more details.</p>
</div>
<div class="paragraph">
<p>In other cases, we may want to remain up to date on dynamically changing data.For example, consider a real-time stock ticker application tracking price changes.One way to implement this is by polling for price changes.A more efficient way to do this is to push price changes as and when they occur&#8201;&#8212;&#8201;commonly referred to as the <a href="https://www.enterpriseintegrationpatterns.com/PublishSubscribeChannel.html">publish-subscribe</a><sup class="footnote">[<a id="_footnoteref_29" class="footnote" href="#_footnotedef_29" title="View footnote.">29</a>]</sup> pattern.Please refer to the section on subscription queries in the Axon framework documentation for more details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_historic_event_replays"><a class="anchor" href="#_historic_event_replays"></a><a class="link" href="#_historic_event_replays">7.4. Historic event replays</a></h3>
<div class="paragraph">
<p>The example we have looked at thus far allows us to listen to events as they occur.Consider a scenario where we need to build a new query from historic events to satisfy an unanticipated new requirement.This new requirement may necessitate the need to create a new query model or in a more extreme case, a completely new bounded context.Another scenario might be when we may need to correct a bug in the way we had built an existing query model and now need to recreate it from scratch.Given that we have a record of all events that have transpired in the event store, we can use replay events to enable us to construct both new and/or correct existing query models with relative ease.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We have used the term <em>event replay</em> in the context of reconstituting state of event-sourced aggregate instances (discussed in <a href="#_event_sourced_aggregates">event-sourced aggregates</a> in <a href="#_implementing_domain_logic">Chapter 5</a>).The event replay mentioned here, although similar in concept, is still very different.In the case of domain object event replay, we work with a single aggregate root instance and only load events for that one instance.In this case though, we will likely work with events that span more than one aggregate.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how the different types of replays and how we can use each of them.</p>
</div>
<div class="sect3">
<h4 id="types-of-replays"><a class="anchor" href="#types-of-replays"></a><a class="link" href="#types-of-replays">7.4.1. Types of replays</a></h4>
<div class="paragraph">
<p>When replaying events, there are at least two types of replays depending on the requirements we need to meet.Let&#8217;s look at each type in turn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Full event replay</strong> is one where we replay all the events in the event store. This can be used in a scenario where we need to support a completely new bounded context which is dependent on this subdomain. This can also be used in cases where we need to support a completely new query model or reconstruct an existing, erroneously built query model. Depending on the number of events in the event store, this can be a fairly long and complex process.</p>
</li>
<li>
<p><strong>Partial/Adhoc event replay</strong> is one where we need to replay all the events on a subset of aggregate instances or a subset of events on all aggregate instances or a combination of both. When working with partial event replays, we will need to specify filtering criteria to select subsets of aggregate instances and events. This means that the event store needs to have the flexibility to support these use cases. Using specialized event store solutions (like <a href="https://axoniq.io/product-overview/axon">Axon Server</a><sup class="footnote">[<a id="_footnoteref_30" class="footnote" href="#_footnotedef_30" title="View footnote.">30</a>]</sup> and <a href="https://www.eventstore.com/eventstoredb">EventStoreDB</a><sup class="footnote">[<a id="_footnoteref_31" class="footnote" href="#_footnotedef_31" title="View footnote.">31</a>]</sup> to name a few) can be extremely beneficial.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="event-replay-considerations"><a class="anchor" href="#event-replay-considerations"></a><a class="link" href="#event-replay-considerations">7.4.2. Event replay considerations</a></h4>
<div class="paragraph">
<p>The ability to replay events and create new query models can be invaluable. However, like everything else, there are considerations that we need to keep in mind when working with replays. Let&#8217;s examine some of these in more detail:</p>
</div>
<div class="sect4">
<h5 id="event-store-design"><a class="anchor" href="#event-store-design"></a><a class="link" href="#event-store-design">Event store design</a></h5>
<div class="paragraph">
<p>As mentioned in Chapter 5, when working with event-sourced aggregates, we persist immutable events in the persistence store. The primary use-cases that we need to support are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Provide consistent and predictable <strong>write</strong> performance when acting as an append-only store.</p>
</li>
<li>
<p>Provide consistent and predictable <strong>read</strong> performance when querying for events using the aggregate identifier.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, replays (especially partial/adhoc) require the event store to support much richer querying capabilities. Consider a scenario where we found an issue where the amount is incorrectly reported for LCs that were approved during a certain time period only for a certain currency. To fix this issue, we need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identify affected LCs from the event store.</p>
</li>
<li>
<p>Fix the issue in the application.</p>
</li>
<li>
<p>Reset the query store for these affected aggregates</p>
</li>
<li>
<p>Do a replay of a subset of events for the affected aggregates and reconstruct the query model.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Identifying affected aggregates from the event store can be tricky if we don&#8217;t support querying capabilities that allow us to introspect the event payload. Even if this kind of adhoc querying were to be supported, these queries can adversely impact command handling performance of the event store. One of the primary reasons to employ CQRS was to make use of query-side stores for such complex read scenarios.</p>
</div>
<div class="paragraph">
<p>Event replays seem to introduce a chicken and egg problem where the query store has an issue which can only be corrected by querying the event store. A few options to mitigate this issue are discussed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>General purpose store</strong>: Choose an event store that offers predictable performance for both scenarios (command handling and replay querying).</p>
</li>
<li>
<p><strong>Built-in datastore replication</strong>: Make use of read replicas for event replay querying</p>
</li>
<li>
<p><strong>Distinct datastores</strong>: Make use of two distinct data stores to solve each problem on its own (for example, use a relational database/key-value store for command handling and a search-optimized document store for event replay querying).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Do note that the <strong>distinct datastores</strong> approach for replays is used to satisfy an operational problem as opposed to query-side business use-cases discussed earlier in this chapter. Arguably, it is more complex because the technology team on the command side has to be equipped to maintain more than one database technology.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="event-design"><a class="anchor" href="#event-design"></a><a class="link" href="#event-design">7.4.3. Event design</a></h4>
<div class="paragraph">
<p>Event replays are required to reconstitute state from an event stream. In this article on what it means to be <a href="https://martinfowler.com/articles/201701-event-driven.html">event-driven</a><sup class="footnote">[<a id="_footnoteref_32" class="footnote" href="#_footnotedef_32" title="View footnote.">32</a>]</sup>, Martin Fowler talks about three different styles of events. If we employ the <em>event carried state transfer</em> approach (in Martin&#8217;s article) to reconstitute state, it might require us to only replay the latest event for a given aggregate, as opposed to replaying all the events for that aggregate in order of occurrence. While this may seem convenient, it also has its downsides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All events may now require to carry a lot of additional information that may not be relevant to that event. Assembling all this information when publishing the event can add to the cognitive complexity on the command side.</p>
</li>
<li>
<p>The amount of data that needs to be stored and flow through the wire can increase drastically.</p>
</li>
<li>
<p>On the query side, it can increase cognitive complexity when understanding the structure of the event and processing it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In a lot of ways, this leads back to the CRUD-based vs task-based approach for APIs discussed in Chapter 5. Our general preference is to design events with as lean a payload as possible. However, your experiences may be different depending on your specific problem or situation.</p>
</div>
<div class="sect4">
<h5 id="application-availability"><a class="anchor" href="#application-availability"></a><a class="link" href="#application-availability">Application availability</a></h5>
<div class="paragraph">
<p>In an event-driven system, it is common to accumulate an extremely large number of events over a period of time, even in a relatively simple application. Replaying a large number of events can be time-consuming. Let&#8217;s look at the mechanics of how replays typically work:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We suspend listening to new events in preparation for a replay.</p>
</li>
<li>
<p>Clear the query store for impacted aggregates.</p>
</li>
<li>
<p>Start an event replay for impacted aggregates.</p>
</li>
<li>
<p>Resume listening to new events after replay is complete.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Based on the above, while the replay is running (step 3 above), we may not be able to provide reliable answers to queries that are impacted by the replay. This obviously has an impact on application availability. When using event replays, care needs to be taken to ensure that <a href="https://sre.google/sre-book/service-level-objectives/">SLOs</a><sup class="footnote">[<a id="_footnoteref_33" class="footnote" href="#_footnotedef_33" title="View footnote.">33</a>]</sup> (service level objectives) are continued to be met.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="event-handlers-with-side-effects"><a class="anchor" href="#event-handlers-with-side-effects"></a><a class="link" href="#event-handlers-with-side-effects">7.4.4. Event handlers with side effects</a></h4>
<div class="paragraph">
<p>When replaying events, we re-trigger event handlers either to fix logic that was previously erroneous or to support new functionality. Invoking most (if not all) event handlers usually results in some sort of side effect (for example, update a query store). This means that some event handlers may not be running for the first time. To prevent unwanted side effects, it is important to undo the effects of having invoked these event handlers previously or code event handlers in an idempotent manner (for example, by using an <em>upsert</em> instead of a simple insert or an update). The effect of some event handlers can be hard (if not impossible) to undo (for example, invoking a command, sending an email or SMS). In such cases, it might be required to mark such event handlers as being ineligible to run during replay. When using the Axon framework, this is fairly simple to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.eventhandling.DisallowReplay</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationEventHandlers</span> {
    <span style="color:#007">@EventHandler</span>
    <span style="color:#007">@DisallowReplay</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(CardIssuedEvent event) {
        <span style="color:#777">// Behavior that we don't want replayed</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@DisallowReplay</code> (or its counterpart <code>@AllowReplay</code>) can be used to explicitly mark event handlers ineligible to run during replay.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="events-as-an-api"><a class="anchor" href="#events-as-an-api"></a><a class="link" href="#events-as-an-api">Events as an API</a></h5>
<div class="paragraph">
<p>In an event-sourced system where events are persisted instead of domain state, it is natural for the structure of events to evolve over a period of time. Consider an example of an <code>BeneficiaryInformationChangedEvent</code> that has evolved over a period of time as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/cqrs/event-evolution.png" alt="event evolution">
</div>
<div class="title">Figure 1- 77. Event evolution</div>
</div>
<div class="paragraph">
<p>Given that the event store is immutable, it is conceivable that we may have one or more combinations of these event versions for a given LC. This can present a number of decisions we will need to make when performing an event replay:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The producer can simply provide the historic event as it exists in the event store and allow consumers to deal with resolving how to deal with older versions of the event.</p>
</li>
<li>
<p>The producer can upgrade older versions of events to the latest version before exposing it to the consumer.</p>
</li>
<li>
<p>Allow the consumer to specify an explicit version of the event that they are able to work with and upgrade it to that version before exposing it to the consumer.</p>
</li>
<li>
<p>Migrate the events in the event store to the latest version as evolutions occur. This may not be feasible given the immutable promise of events in the event store.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Which approach you choose really depends on your specific context and the maturity of the producer/consumer ecosystem. The axon framework makes provisions for a process they call <a href="https://docs.axoniq.io/reference-guide/axon-framework/events/event-versioning#event-upcasting"><strong>event upcasting</strong></a><sup class="footnote">[<a id="_footnoteref_34" class="footnote" href="#_footnotedef_34" title="View footnote.">34</a>]</sup> that allows upgrading events just-in-time before they are consumed. Please refer to the Axon framework documentation for more details.</p>
</div>
<div class="paragraph">
<p>In an event-driven system, events are your API. This means that you will need to apply the same rigor that one applies to APIs when making lifecycle management decisions (for example, versioning, deprecation, backwards compatibility, etc.).</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary-7"><a class="anchor" href="#summary-7"></a><a class="link" href="#summary-7">7.5. Summary</a></h3>
<div class="paragraph">
<p>In this chapter we examined how to implement the query side of a CQRS-based system. We looked at how domain events can be consumed in real-time to construct materialized views that can be used to service query APIs. We looked at the different query types that can be used to efficiently access the underlying query models. We rounded off by looking at persistence options for the query side. Finally, we looked at historic event replays and how it can be used to correct errors or introduce new functionality in an event-driven system.</p>
</div>
<div class="paragraph">
<p>This chapter should give you a good idea of how to build and evolve the query side of a CQRS-based system to meet changing business requirements while retaining all the business logic on the command side.</p>
</div>
<div class="paragraph">
<p>Thus far, we have looked at how to consume events in a stateless manner (where no two event handlers have knowledge of each other&#8217;s existence), in the next chapter, we will continue to look at how to consume events, but this time in a stateful manner in the form of long-running user transactions (also known as sagas).</p>
</div>
</div>
<div class="sect2">
<h3 id="questions-6"><a class="anchor" href="#questions-6"></a><a class="link" href="#questions-6">7.6. Questions</a></h3>
<div class="ulist">
<ul>
<li>
<p>In your context, are you segregating commands and queries (even if the segregation is logical)?</p>
</li>
<li>
<p>What read/query models are you able to come up with?</p>
</li>
<li>
<p>What do you do if you build a query model, and it turns out to be wrong?</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 text-justify">
<h2 id="long-running-workflows"><a class="anchor" href="#long-running-workflows"></a><a class="link" href="#long-running-workflows">8. Long-Running Workflows</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
In the long run, the pessimist may be proven right, but the optimist has a better time on the trip.
</blockquote>
<div class="attribution">
&#8212; Daniel Reardon
</div>
</div>
<div class="paragraph">
<p>In the previous chapters, we have looked at handling commands and queries within the context of a single aggregate. All the scenarios we have looked at thus far, have been limited to a single interaction. However, not all capabilities can be implemented in the form of a simple request-response interaction, requiring coordination across multiple external systems or human-centric operations or both. In other cases, there may be a need to react to triggers that are nondeterministic (occur conditionally or not at all) and/or be time-bound (based on a deadline). This may require managing business transactions across multiple bounded contexts that may run over a long duration of time, while continuing to maintain consistency (<strong>saga</strong>).</p>
</div>
<div class="paragraph">
<p>There are at least two common patterns to implement the saga pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Explicit orchestration</strong>: A designated component acts as a centralized coordinator&#8201;&#8212;&#8201;where the system relies on the coordinator to react to domain events to manage the flow.</p>
</li>
<li>
<p><strong>Implicit choreography</strong>: No single component is required to act as a centralized coordinator&#8201;&#8212;&#8201;where the components simply react to domain events in other components to manage the flow.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By the end of this chapter, you will have learned how to implement sagas using both techniques. You will also have learnt how to work with deadlines when no explicit events occur within the system. You will finally be able to appreciate when/whether to choose an explicit orchestrator or simply stick to implicit choreography without resorting to the use of potentially expensive distributed transactions.</p>
</div>
<div class="sect2">
<h3 id="technical-requirements-5"><a class="anchor" href="#technical-requirements-5"></a><a class="link" href="#technical-requirements-5">8.1. Technical requirements</a></h3>
<div class="paragraph">
<p>To follow the examples in this chapter, you will need access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 1.8+ (We have used Java 17 to compile sample sources)</p>
</li>
<li>
<p>Spring Boot 2.4.x</p>
</li>
<li>
<p>Axon framework 4.5.3</p>
</li>
<li>
<p>JUnit 5.7.x (Included with spring boot)</p>
</li>
<li>
<p>Project Lombok (To reduce verbosity)</p>
</li>
<li>
<p>Maven 3.x</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to the ch08 directory of the book&#8217;s accompanying source code repository for complete working examples.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="continuing-our-design-journey-3"><a class="anchor" href="#continuing-our-design-journey-3"></a><a class="link" href="#continuing-our-design-journey-3">8.2. Continuing our design journey</a></h3>
<div class="paragraph">
<p>In <a href="#_domain_analysis_and_modeling">Chapter 4 - Domain analysis and modeling</a>, we discussed eventstorming as a lightweight method to clarify business flows. As a reminder, this is the output produced from our eventstorming session:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/sagas/event-storming-auto-approval-saga.png" alt="event storming auto approval saga">
</div>
<div class="title">Figure 1- 78. Recap of eventstorming session</div>
</div>
<div class="paragraph">
<p>As depicted in the visual above, some aspects of Letter of Credit (LC) application processing happens outside our current bounded context), before the trade finance manager makes a decision to either approve or decline the application as listed here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Product value is validated</p>
</li>
<li>
<p>Product legality is validated</p>
</li>
<li>
<p>Applicant&#8217;s credit worthiness is validated</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Currently, the final approval is a manual process. It is pertinent to note that the product value and legality checks happen as part of the work done by the product analysis department, whereas applicant credit worthiness checks happens in the credit analysis department. Both departments make use of their own systems to perform these functions and notify us through the respective events. An LC application is <strong>not ready</strong> to either be approved or declined until <strong>each</strong> of these checks are completed. Each of these processes happen mostly independently of the other and may take a nondeterministic amount of time (typically in the order of a few days). After these checks have happened, the trade finance manager manually reviews the application and makes the final decision.</p>
</div>
<div class="paragraph">
<p>Given the growing volumes of LC applications received, the bank is looking to introduce a process optimization to automatically approve applications with an amount below a certain threshold (<strong>USD 10,000</strong> at this time). The business has deemed that the three checks above are sufficient and that no further human intervention is required when approving such applications.</p>
</div>
<div class="paragraph">
<p>From an overall system perspective, it is pertinent to note that the product analyst system notifies us through the <code>ProductValueValidatedEvent</code> and <code>ProductLegalityValidatedEvent</code>, whereas the credit analyst system does the same through the <code>ApplicantCreditValidatedEvent</code> event. Each of these events can and indeed happen independently of the other. For us to be able to auto-approve applications our solution needs to wait for all of these events to occur. Once these events have occurred, we need to examine the outcome of each of these events to finally make a decision.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this context, we are using the term <strong><em>long-running</em></strong> to denote a complex business process that takes several steps to complete. As these steps occur, the process transitions from one state to another. In other words, we are referring to a <a href="https://en.wikipedia.org/wiki/state_machine"><strong>state machine</strong></a><sup class="footnote">[<a id="_footnoteref_35" class="footnote" href="#_footnotedef_35" title="View footnote.">35</a>]</sup>. This is not to be confused with a long-running software process (for example, a complex SQL query or an image processing routine) that is computationally intensive.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As is evident from the diagram above, the LC auto-approval functionality is an example of a long-running business process where <em>some thing</em> in our system needs to keep track of the fact that these independent events have occurred before proceeding further.  Such functionality can be implemented using the saga pattern. Let&#8217;s look at how we can do this.</p>
</div>
</div>
<div class="sect2">
<h3 id="implementing-sagas"><a class="anchor" href="#implementing-sagas"></a><a class="link" href="#implementing-sagas">8.3. Implementing sagas</a></h3>
<div class="paragraph">
<p>Before we delve into how we can implement this auto-approval functionality, let&#8217;s take a look at how this works from a logical perspective as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/sagas/auto-approval-saga-logical.png" alt="auto approval saga logical">
</div>
<div class="title">Figure 1- 79. Auto-approval process&#8201;&#8212;&#8201;logical view</div>
</div>
<div class="paragraph">
<p>As is depicted in the visual above, there are three bounded contexts in play:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>LC Application (the bounded context we have been implementing thus far)</p>
</li>
<li>
<p>The Applicant bounded context</p>
</li>
<li>
<p>The Product bounded context</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The flow gets triggered when the LC application is submitted. This in turn sets in motion three independent functions that establish the:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Value of the product being transacted</p>
</li>
<li>
<p>Legality of the product being transacted</p>
</li>
<li>
<p>Credit worthiness of the applicant</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>LC approval can proceed only after <strong>all</strong> of these functions have completed. Furthermore, to <strong>auto-approve</strong>, all of these checks have to complete <strong>favorably</strong> and as mentioned earlier, the LC amount has to be lesser than the <strong>USD 10000</strong> threshold.</p>
</div>
<div class="paragraph">
<p>As shown in the event storming artifact, the <code>LC Application</code> aggregate is able to handle an <code>ApproveLCApplicationCommand</code>, which results in a LCApplicationApprovedEvent`. To auto-approve, this command needs to be invoked automatically when all the conditions mentioned earlier are satisfied. We are building an event-driven system, and we can see that each of these validations produce events when their respective actions complete. There are at least two ways to implement this functionality:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Orchestration</strong>: where a single component in the system coordinates the state of the flow and triggers subsequent actions as necessary.</p>
</li>
<li>
<p><strong>Choreography</strong>: where actions in the flow are triggered without requiring an explicit coordinating component.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s examine these methods in more detail:</p>
</div>
<div class="sect3">
<h4 id="orchestration"><a class="anchor" href="#orchestration"></a><a class="link" href="#orchestration">8.3.1. Orchestration</a></h4>
<div class="paragraph">
<p>When implementing sagas using an orchestrating component, the system looks similar to the one depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/sagas/auto-approval-saga-orchestrator.png" alt="auto approval saga orchestrator">
</div>
<div class="title">Figure 1- 80. Saga implementation using an orchestrator</div>
</div>
<div class="paragraph">
<p>The orchestrator starts tracking the flow when the LC application is submitted. It will then need to wait for each of the <code>ProductValueValidatedEvent</code>, <code>ProductLegalityValidatedEvent</code> and <code>ApplicantCreditValidatedEvent</code> events to occur and decide if it is appropriate to trigger the <code>ApproveLCApplicationCommand</code>. Finally, the saga lifecycle ends unconditionally when the LC application is approved. There are other conditions that may cause the saga to end abruptly. We will examine those scenarios in detail later. It is pertinent to note that there will be a <strong>distinct</strong> auto-approval saga instance for each LC application that gets submitted. Let&#8217;s look at how to implement this functionality using the Axon framework. As usual, let&#8217;s test drive this functionality that a new auto approval saga instance is created when an LC application is submitted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.test.saga.FixtureConfiguration</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.test.saga.SagaTestFixture</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSagaTests</span> {

    <span style="color:#088;font-weight:bold">private</span> FixtureConfiguration fixture;                                       <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> setUp() {
        fixture = <span style="color:#080;font-weight:bold">new</span> SagaTestFixture&lt;&gt;(AutoApprovalSaga.class);                <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldStartSagaOnSubmit() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId lcApplicationId = LCApplicationId.randomId();
        fixture.givenNoPriorActivity()                                          <i class="conum" data-value="2"></i><b>(2)</b>
                .whenPublishingA(                                               <i class="conum" data-value="3"></i><b>(3)</b>
                        <span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(lcApplicationId,
                            AUTO_APPROVAL_THRESHOLD_AMOUNT
                               .subtract(ONE_DOLLAR)))
                .expectActiveSagas(<span style="color:#00D">1</span>);                                          <i class="conum" data-value="4"></i><b>(4)</b>
    }

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We make use of the Axon provided <code>FixtureConfiguration</code> and <code>SagaTestFixture</code> that allow us to test saga functionality.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Given no prior activity has occurred (from the perspective of the saga)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When a <code>LCApplicationSubmittedEvent</code> is published</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We expect one active saga to exist</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation to make this test pass looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.modelling.saga.SagaEventHandler</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.modelling.saga.StartSaga</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.spring.stereotype.Saga</span>;

<span style="color:#007">@Saga</span>                                                          <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSaga</span> {

    <span style="color:#007">@SagaEventHandler</span>(associationProperty = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">lcApplicationId</span><span style="color:#710">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#007">@StartSaga</span>                                                 <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationSubmittedEvent event) {
        <span style="color:#777">//</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When working with Axon and Spring, the orchestrator is annotated with the <code>@Saga</code> annotation to mark it as a spring bean. In order to track each submitted LC application, the <code>@Saga</code> annotation is prototype-scoped (as opposed to singleton-scoped), to allow creation of multiple saga instances. Please refer to the Axon and Spring documentation for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The saga listens to the <code>LCApplicationSubmittedEvent</code> to keep track of the flow (as denoted by the <code>@SagaEventHandler</code> annotation). Conceptually, the <code>@SagaEventHandler</code> annotation is very similar to the <code>@EventHandler</code> annotation that we discussed previously in <a href="#_creating_the_query_model">Chapter 7</a>. However, the <code>@SagaEventHandler</code> annotation is used specifically for event listeners within a saga. The <code>associationProperty</code> attribute on the <code>@SagaEventHandler</code> annotation causes this event handler method to get invoked only for the saga with matching value of the <code>lcApplicationId</code> attribute in the event payload. Also, the <code>@SagaEventHandler</code> is a transaction boundary. Every time such a method completes successfully, the Axon framework commits a transaction, thereby allowing it to keep track of state stored in the saga. We will look at this in more detail shortly.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Every saga needs to have at least one <code>@SagaEventHandler</code> method that is also annotated with the <code>@StartSaga</code> annotation to denote the beginning of the saga.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have a requirement that an LC cannot be auto-approved if its amount exceeds the threshold (USD 10000 in our case). The test for this scenario looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSagaTests</span> {
    <span style="color:#777">//...</span>

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldEndSagaImmediatelyIfAmountGreaterThanAutoApprovalThreshold() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId lcApplicationId = LCApplicationId.randomId();
        fixture.givenAggregate(lcApplicationId.toString()).published()
                .whenPublishingA(
                        <span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(lcApplicationId,
                            AUTO_APPROVAL_THRESHOLD_AMOUNT.add(ONE_DOLLAR))) <i class="conum" data-value="1"></i><b>(1)</b>
                .expectActiveSagas(<span style="color:#00D">0</span>);                                       <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When the LC amount exceeds the auto approval threshold amount</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We expect no active sagas to exist for that LC</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation to satisfy this condition looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.modelling.saga.SagaLifecycle</span>;

<span style="color:#007">@Saga</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSaga</span> {

    <span style="color:#007">@SagaEventHandler</span>(associationProperty = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">lcApplicationId</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#007">@StartSaga</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationSubmittedEvent event) {
        <span style="color:#080;font-weight:bold">if</span> (AUTO_APPROVAL_THRESHOLD_AMOUNT.isLessThan(event.getAmount())) { <i class="conum" data-value="1"></i><b>(1)</b>
            SagaLifecycle.end();                                            <i class="conum" data-value="2"></i><b>(2)</b>
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We check for the condition of the LC amount being greater than the threshold amount</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If so, we end the saga using the framework provided <code>SagaLifecycle.end()</code> method. Here we end the saga programmatically. It is also possible to declaratively end the saga as well using the <code>@EndSaga</code> annotation when the <code>LCApplicationApprovedEvent</code> occurs. Please refer to the full code examples included with this chapter for more information.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We need to auto-approve the saga if all of <code>ApplicantCreditValidatedEvent</code>, <code>ProductLegalityValidatedEvent</code> and <code>ProductValueValidatedEvent</code> have occurred successfully. The test to verify this functionality is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSagaTests</span> {

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldAutoApprove() {
        <span style="color:#777">// Initialization code removed for brevity</span>

        fixture.givenAggregate(lcApplicationId.toString())
            .published(submitted, legalityValidated, valueValidated)        <i class="conum" data-value="1"></i><b>(1)</b>
                .whenPublishingA(applicantValidated)                        <i class="conum" data-value="2"></i><b>(2)</b>
                .expectActiveSagas(<span style="color:#00D">1</span>)                                       <i class="conum" data-value="3"></i><b>(3)</b>
                .expectDispatchedCommands(
                        <span style="color:#080;font-weight:bold">new</span> ApproveLCApplicationCommand(lcApplicationId));  <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the LC application has been submitted and the <code>ProductValueValidatedEvent</code> and the <code>ProductLegalityValidatedEvent</code> have occurred successfully.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When the <code>ApplicantCreditValidatedEvent</code> is published</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect one active saga instance AND</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We expect the <code>ApproveLCApplicationCommand</code> to be dispatched for that LC</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation for this looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSaga</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> productValueValidated;                              <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> productLegalityValidated;                           <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> applicantValidated;                                 <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@Autowired</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">transient</span> CommandGateway gateway;                           <i class="conum" data-value="2"></i><b>(2)</b>

    <span style="color:#777">// Other event handlers omitted for brevity</span>

    <span style="color:#007">@SagaEventHandler</span>(associationProperty = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">lcApplicationId</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(ApplicantCreditValidatedEvent event) {               <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="color:#080;font-weight:bold">if</span> (event.getDecision().isRejected()) {                         <i class="conum" data-value="4"></i><b>(4)</b>
            SagaLifecycle.end();
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#950">this</span>.applicantValidated = <span style="color:#069">true</span>;                             <i class="conum" data-value="5"></i><b>(5)</b>
            <span style="color:#080;font-weight:bold">if</span> (productValueValidated &amp;&amp; productLegalityValidated) {    <i class="conum" data-value="6"></i><b>(6)</b>
                LCApplicationId id = event.getLcApplicationId();
                gateway.send(ApproveLCApplicationCommand.with(id));     <i class="conum" data-value="7"></i><b>(7)</b>
            }
        }
    }

    <span style="color:#777">// Other event handlers omitted for brevity</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As mentioned previously, sagas can maintain state. In this case, we are maintaining three boolean variables, each to denote the occurrence of the respective event.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We have declared the Axon <code>CommandGateway</code> as a <code>transient</code> member because we need it to dispatch commands, but not be persisted along with other saga state.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This event handler intercepts the <code>ApplicantCreditValidatedEvent</code> for the specific LC application (as denoted by the <code>associationProperty</code> in the @SagaEventHandler annotation).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the decision from the <code>ApplicantCreditValidatedEvent</code> is rejected, we end the saga immediately.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Otherwise, we <em>remember</em> the fact that the applicant&#8217;s credit has been validated.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We then check to see if the product&#8217;s value and legality have already been validated.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If so, we issue the command to auto-approve the LC.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The logic in the <code>ProductValueValidatedEvent</code> and <code>ProductLegalityValidatedEvent</code> is very similar to that in the saga event handler for the <code>ApplicantCreditValidatedEvent</code>. We have omitted it here for brevity. Please refer to the source code for this chapter for the full example along with the tests.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, we can end the saga when we receive the LCApplicationApprovedEvent for this application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSagaTests</span> {
    <span style="color:#007">@Test</span>
    <span style="color:#007">@DisplayName</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">should end saga after auto approval</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#339;font-weight:bold">void</span> shouldEndSagaAfterAutoApproval() {
        <span style="color:#777">// Initialization code omitted for brevity</span>

        fixture.givenAggregate(lcApplicationId.toString())
                .published(
                    submitted, applicantValidated,
                    legalityValidated, valueValidated)                             <i class="conum" data-value="1"></i><b>(1)</b>
                .whenPublishingA(<span style="color:#080;font-weight:bold">new</span> LCApplicationApprovedEvent(lcApplicationId))  <i class="conum" data-value="2"></i><b>(2)</b>
                .expectActiveSagas(<span style="color:#00D">0</span>)                                              <i class="conum" data-value="3"></i><b>(3)</b>
                .expectNoDispatchedCommands();                                     <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the LC has been submitted and all the validations have been completed successfully.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When a <code>LCApplicationApprovedEvent</code> is published.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect zero active sagas to be running.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we also expect to not dispatch any commands.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have looked at how to implement sagas using an orchestrator, let&#8217;s examine some design decisions that we may need to consider when working with them.</p>
</div>
<div class="sect4">
<h5 id="pros"><a class="anchor" href="#pros"></a><a class="link" href="#pros">Pros</a></h5>
<div class="ulist">
<ul>
<li>
<p><strong>Complex workflows</strong>: Having an explicit orchestrator can be very helpful when dealing with flows that involve multiple participants and have a lot of conditionals because the orchestrator can keep track of the overall progress in a fine-grained manner.</p>
</li>
<li>
<p><strong>Testing</strong>: As we have seen in the implementation above, testing flow logic in isolation is relatively straightforward.</p>
</li>
<li>
<p><strong>Debugging</strong>: Given that we have a single coordinator, debugging the current state of the flow can be relatively easier.</p>
</li>
<li>
<p><strong>Handling exceptions</strong>: Given that the orchestrator has fine-grained control of the flow, recovering gracefully from exceptions can be easier.</p>
</li>
<li>
<p><strong>System knowledge</strong>: Components in different bounded contexts do not need to have knowledge of each other&#8217;s internals (e.g. commands and events) to progress the flow.</p>
</li>
<li>
<p><strong>Cyclic dependencies</strong>: Having a central coordinator allows avoiding accidental cyclic dependencies between components.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cons"><a class="anchor" href="#cons"></a><a class="link" href="#cons">Cons</a></h5>
<div class="ulist">
<ul>
<li>
<p><strong>Single point of failure</strong>: From an operational perspective, orchestrators can become single points of failure because they are the only ones that have knowledge of the flow. This means that these components need to exhibit higher resilience characteristics as compared to other components.</p>
</li>
<li>
<p><strong>Leaking of domain logic</strong>: In an ideal world, the aggregate will remain the custodian of all domain logic. Given that the orchestrator is also stateful, business logic may inadvertently shift to the orchestrator. Care should be taken to ensure that the orchestrator only has flow-control logic while business invariants remains within the confines of the aggregate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The above implementation should give you a good idea of how to implement a saga orchestrator. Now let&#8217;s look at how we can do this without the use of an explicit orchestrator.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="choreography"><a class="anchor" href="#choreography"></a><a class="link" href="#choreography">8.3.2. Choreography</a></h4>
<div class="paragraph">
<p>Saga orchestrators keep track of the current state of the flow, usually making use of some kind of data store. Another way to implement this functionality is without using any stateful component. Logically, this looks like the setup shown in the diagram here:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/sagas/auto-approval-saga-choreography.png" alt="Saga implementation using choreography">
</div>
<div class="title">Figure 1- 81. Saga implementation using choreography</div>
</div>
<div class="paragraph">
<p>As you can see, there is no single component that tracks the saga lifecycle. However, to make the auto-approval decision, each of these stateless event handlers need to have knowledge of the same three events having occurred:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Product value is validated</p>
</li>
<li>
<p>Product legality is validated</p>
</li>
<li>
<p>Applicant&#8217;s credit worthiness is validated</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Given that the event listeners themselves are stateless, there are at least two ways to provide this information to them:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each of the events carry this information in their respective payloads.</p>
</li>
<li>
<p>The event listeners query the source systems (in this case, the product and applicant bounded contexts respectively).</p>
</li>
<li>
<p>The LC application bounded context maintains a query model to keep track of these events having occurred.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Just like in the orchestrator example, when all events have occurred and the LC amount is below the specified threshold, these event listeners can issue the <code>ApproveLCApplicationCommand</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We will skip covering code examples for the choreography implementation because this is no different from the material we have covered previously in this and prior chapters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have looked at how to implement the choreography style of sagas, let&#8217;s examine some design decisions that we may need to consider when working with them.</p>
</div>
<div class="sect4">
<h5 id="pros-2"><a class="anchor" href="#pros-2"></a><a class="link" href="#pros-2">Pros</a></h5>
<div class="ulist">
<ul>
<li>
<p><strong>Simple workflows</strong>: For simple flows, the choreography approach can be relatively straightforward because it does not require the overhead of an additional coordinating component.</p>
</li>
<li>
<p><strong>No single points of failure</strong>: From an operational perspective, there is one less  high resilience component to worry about.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cons-2"><a class="anchor" href="#cons-2"></a><a class="link" href="#cons-2">Cons</a></h5>
<div class="ulist">
<ul>
<li>
<p><strong>Workflow tracking</strong>: Especially with complex workflows that involve numerous steps and conditionals, tracking and debugging the current state of the flow may become challenging.</p>
</li>
<li>
<p><strong>Cyclic dependencies</strong>: It is possible to inadvertently introduce cyclic dependencies among components when workflows become gnarly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sagas enable applications to maintain data and transactional consistency when more than one bounded context is required to complete the business functionality without having to resort to using <a href="https://en.wikipedia.org/wiki/Distributed_transaction"><em>distributed transactions</em></a><sup class="footnote">[<a id="_footnoteref_36" class="footnote" href="#_footnotedef_36" title="View footnote.">36</a>]</sup>. However, it does introduce a level of complexity to the programming model, especially when it comes to handling failures. We will look at exception handling in a lot more detail when we discuss working with distributed systems in upcoming chapters. Let&#8217;s look at how to progress flows when there are no explicit stimuli by looking at how deadlines work.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="handling-deadlines"><a class="anchor" href="#handling-deadlines"></a><a class="link" href="#handling-deadlines">8.4. Handling deadlines</a></h3>
<div class="paragraph">
<p>Thus far, we have looked at events that are caused by human (for example, the applicant submitting an LC application) or system (for example, the auto-approval of an LC application) action. However, in an event-driven system, not all events occur due to an explicit human or system stimulus. Events may need to be emitted either due to inactivity over a period of time, or on a recurring schedule based on prevailing conditions.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s examine the case where the bank needs <em>submitted LC applications</em> to be decisioned as quickly as possible. When applications are not acted upon by the trade finance managers within ten calendar days, the system should send them reminders.</p>
</div>
<div class="paragraph">
<p>To deal with such inactivity, we need a means to trigger system action (read&#8201;&#8212;&#8201;emit events) based on the passage of time&#8201;&#8212;&#8201;in other words, perform actions when a <em>deadline</em> expires. In a happy path scenario, we expect either the user or the system to take certain action. In such cases, we will also need to account for cases we will need to cancel the trigger scheduled to occur on deadline expiry. Let&#8217;s look at how to test-drive this functionality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldCreateSubmissionReminderDeadlineWhenApplicationIsSubmitted() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId id = LCApplicationId.randomId();
        fixture.given(<span style="color:#080;font-weight:bold">new</span> LCApplicationStartedEvent(id, ApplicantId.randomId(),
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My LC</span><span style="color:#710">&quot;</span></span>, LCState.DRAFT),
                        <span style="color:#080;font-weight:bold">new</span> LCAmountChangedEvent(id, THOUSAND_DOLLARS),
                        <span style="color:#080;font-weight:bold">new</span> MerchandiseChangedEvent(id, merchandise()))

                .when(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(id)) <i class="conum" data-value="1"></i><b>(1)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(id,
                                THOUSAND_DOLLARS))

                .expectScheduledDeadlineWithName(
                        <span style="color:#0a8;font-weight:bold">Duration</span>.ofDays(<span style="color:#00D">10</span>),
                        LC_APPROVAL_PENDING_REMINDER);    <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When the LC application is submitted</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We expect a deadline for the reminder to be scheduled</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation for this is fairly straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.deadline.DeadlineManager</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(SubmitLCApplicationCommand command,
                    DeadlineManager deadlineManager) { <i class="conum" data-value="1"></i><b>(1)</b>
        assertPositive(amount);
        assertMerchandise(merchandise);
        assertInDraft(state);
        apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(id, amount));

        deadlineManager.schedule(<span style="color:#0a8;font-weight:bold">Duration</span>.ofDays(<span style="color:#00D">10</span>),  <i class="conum" data-value="2"></i><b>(2)</b>
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC_APPROVAL_REMINDER</span><span style="color:#710">&quot;</span></span>,
            LCApprovalPendingNotification.first(id));  <i class="conum" data-value="3"></i><b>(3)</b>
    }
    <span style="color:#777">//...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To allow working with deadlines, the Axon framework provides a <code>DeadlineManager</code> that allows working with deadlines. This is injected into the command handler method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use the <code>deadlineManager</code> to schedule a named deadline (<code>"LC_APPROVAL_REMINDER"</code> in this case) that will expire in 10 days.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the deadline is met, it will result in a <code>LCApprovalPendingNotification</code> which can be handled just like a command. Except in this case, the behavior is triggered by the passage of time.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If no action is taken for ten days, this is what we expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldTriggerApprovalPendingEventTenDaysAfterSubmission() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId id = LCApplicationId.randomId();
        fixture.given(<span style="color:#080;font-weight:bold">new</span> LCApplicationStartedEvent(id, ApplicantId.randomId(),
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My LC</span><span style="color:#710">&quot;</span></span>, LCState.DRAFT),
                        <span style="color:#080;font-weight:bold">new</span> LCAmountChangedEvent(id, THOUSAND_DOLLARS),
                        <span style="color:#080;font-weight:bold">new</span> MerchandiseChangedEvent(id, merchandise()))
                .andGivenCommands(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(id)) <i class="conum" data-value="1"></i><b>(1)</b>
                .whenThenTimeElapses(<span style="color:#0a8;font-weight:bold">Duration</span>.ofDays(<span style="color:#00D">10</span>))             <i class="conum" data-value="2"></i><b>(2)</b>
                .expectDeadlinesMet(
                        LCApprovalPendingNotification.first(id))      <i class="conum" data-value="3"></i><b>(3)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApprovalPendingEvent(id));        <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the LC application is submitted.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When the period of ten days elapses.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The deadline should be met.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And the <code>LCApprovalPendingEvent</code> should be emitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how to implement this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.deadline.annotation.DeadlineHandler</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {

    <span style="color:#007">@DeadlineHandler</span>(deadlineName = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC_APPROVAL_REMINDER</span><span style="color:#710">&quot;</span></span>)       <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(LCApprovalPendingNotification notification) {  <i class="conum" data-value="2"></i><b>(2)</b>

        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApprovalPendingEvent(id)); <i class="conum" data-value="3"></i><b>(3)</b>

    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Deadlines are handled by annotating handler methods with the <code>@DeadlineHandler</code> annotation. Note that the same deadline name used previously is being referenced here.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the deadline handler method and uses the same payload that was passed along when it was scheduled.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We emit the <code>LCApprovalPendingEvent</code> when the deadline expires.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The deadline handling logic should only be triggered if no action is taken. However, if the LC is either approved or rejected within a duration of ten days, none of this behavior should be triggered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotTriggerPendingReminderIfApplicationIsApprovedWithinTenDays() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId id = LCApplicationId.randomId();
        fixture.given(<span style="color:#080;font-weight:bold">new</span> LCApplicationStartedEvent(id, ApplicantId.randomId(),
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My LC</span><span style="color:#710">&quot;</span></span>, LCState.DRAFT),
                        <span style="color:#080;font-weight:bold">new</span> LCAmountChangedEvent(id, THOUSAND_DOLLARS),
                        <span style="color:#080;font-weight:bold">new</span> MerchandiseChangedEvent(id, merchandise()))
                .andGivenCommands(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(id)) <i class="conum" data-value="1"></i><b>(1)</b>

                .when(<span style="color:#080;font-weight:bold">new</span> ApproveLCApplicationCommand(id))            <i class="conum" data-value="2"></i><b>(2)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApplicationApprovedEvent(id))
                .expectNoScheduledDeadlines();                        <i class="conum" data-value="3"></i><b>(3)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotTriggerPendingReminderIfApplicationIsDeclinedWithinTenDays() {
        <span style="color:#777">// Test code is very similar. Excluded for brevity</span>
    }

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the LC application is submitted</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When it is approved within a duration of ten days (in this case, almost immediately)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect no scheduled deadlines</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the implementation for this looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(ApproveLCApplicationCommand command,
                   DeadlineManager deadlineManager) {
        assertInSubmitted(state);
        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationApprovedEvent(id));
        deadlineManager.cancelAllWithinScope(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC_APPROVAL_REMINDER</span><span style="color:#710">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(DeclineLCApplicationCommand command,
                   DeadlineManager deadlineManager) {
        assertInSubmitted(state);
        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationDeclinedEvent(id));
        deadlineManager.cancelAllWithinScope(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC_APPROVAL_REMINDER</span><span style="color:#710">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#777">//...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We cancel all the deadlines with the name <code>LC_APPROVAL_REMINDER</code> (in this case, we only have one deadline with that name) within the scope of this aggregate.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="summary-8"><a class="anchor" href="#summary-8"></a><a class="link" href="#summary-8">8.5. Summary</a></h3>
<div class="paragraph">
<p>In this chapter, we examined how to work with long-running workflows using sagas and the different styles we can use to implement them. We also looked at the implications of using explicit orchestration versus implicit choreography. We finally looked at how we can handle deadlines when there are no user-initiated actions.</p>
</div>
<div class="paragraph">
<p>You should have learnt how sagas can act as a first-class citizen in addition to aggregates when designing a system that makes use of domain-driven design principles.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will look at how we can interact with external systems while respecting bounded context boundaries between core and peripheral systems.</p>
</div>
</div>
<div class="sect2">
<h3 id="questions-7"><a class="anchor" href="#questions-7"></a><a class="link" href="#questions-7">8.6. Questions</a></h3>
<div class="ulist">
<ul>
<li>
<p>Are you seeing the need to implement long-running workflows in your current ecosystem?</p>
</li>
<li>
<p>Do you see yourself picking one style over the other most of the time?</p>
</li>
<li>
<p>Are you using external deadline handlers (for instance, batch jobs) in your existing systems as opposed to embedding time-based logic in the core?</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-6"><a class="anchor" href="#further-reading-6"></a><a class="link" href="#further-reading-6">8.7. Further reading</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 35.7142%;">
<col style="width: 21.4285%;">
<col style="width: 42.8573%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saga persistence and event-driven architectures</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Udi Dahan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://udidahan.com/2009/04/20/saga-persistence-and-event-driven-architectures/" class="bare">https://udidahan.com/2009/04/20/saga-persistence-and-event-driven-architectures/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sagas solve stupid transaction timeouts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Udi Dahan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://udidahan.com/2008/06/23/sagas-solve-stupid-transaction-timeouts/" class="bare">https://udidahan.com/2008/06/23/sagas-solve-stupid-transaction-timeouts/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microservices&#8201;&#8212;&#8201;when to react vs. orchestrate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Andrew Bonham</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://medium.com/capital-one-tech/microservices-when-to-react-vs-orchestrate-c6b18308a14c" class="bare">https://medium.com/capital-one-tech/microservices-when-to-react-vs-orchestrate-c6b18308a14c</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saga orchestration for microservices using the outbox pattern</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gunnar Morling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.infoq.com/articles/saga-orchestration-outbox/" class="bare">https://www.infoq.com/articles/saga-orchestration-outbox/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Patterns for distributed transactions within a microservices architecture</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keyang Xiang</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.redhat.com/blog/2018/10/01/patterns-for-distributed-transactions-within-a-microservices-architecture" class="bare">https://developers.redhat.com/blog/2018/10/01/patterns-for-distributed-transactions-within-a-microservices-architecture</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1 text-justify">
<h2 id="_integrating_with_external_systems"><a class="anchor" href="#_integrating_with_external_systems"></a><a class="link" href="#_integrating_with_external_systems">9. Integrating with External Systems</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Wholeness is not achieved by cutting off a portion of one&#8217;s being, but by integration of the contraries.
</blockquote>
<div class="attribution">
&#8212; Carl Jung
</div>
</div>
<div class="paragraph">
<p>Thus far, we have used DDD to implement a robust core for our application. However, most solutions (by extension&#8201;&#8212;&#8201;bounded contexts) usually have both upstream and downstream dependencies which change at a pace that is different from these core components. To maintain both agility, reliability and enable loose coupling, it is important to integrate with peripheral systems in a manner that shields the core from everything else that surrounds it.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will look at the LC application processing solution and examine means by which we can integrate with other components in the ecosystem. You will learn to recognize relationship patterns between components. We will round off by looking at common implementation patterns when integrating with other applications.</p>
</div>
<div class="sect2">
<h3 id="continuing-our-design-journey-4"><a class="anchor" href="#continuing-our-design-journey-4"></a><a class="link" href="#continuing-our-design-journey-4">9.1. Continuing our design journey</a></h3>
<div class="paragraph">
<p>From our domain analysis in the earlier chapters, we have arrived at four bounded contexts for our application as depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application.png" alt="lc application" width="529" height="533">
</div>
<div class="title">Figure 1- 82. Relationship between bounded contexts</div>
</div>
<div class="paragraph">
<p>Thus far, our focus has been on the implementation of the internals of the <strong>LC Application</strong> bounded context.
While the LC Application bounded context is independent of the other bounded contexts, it is not completely isolated from them.
For example, when processing an LC application, we need to perform merchandise and applicant checks which require interactions with the <strong>Compliance</strong> and <strong>Customer Onboarding</strong> bounded contexts respectively.
This means that these bounded contexts have a relationship with each other.
These relationships are driven by the nature of collaboration between the teams working on the respective bounded contexts.
Let&#8217;s examine how these team dynamics influence integration mechanisms between bounded contexts in a way that continues to preserve their individual integrity.</p>
</div>
</div>
<div class="sect2">
<h3 id="bounded-context-relationships"><a class="anchor" href="#bounded-context-relationships"></a><a class="link" href="#bounded-context-relationships">9.2. Bounded context relationships</a></h3>
<div class="paragraph">
<p>We need bounded contexts to be as independent as possible.
However, this does not mean that bounded contexts are completely isolated from each other.
Bounded contexts need to collaborate with others to provide business value.
Whenever there is collaboration required between two bounded contexts, the nature of their relationship is not only influenced by their individual goals and priorities, but also by the prevailing organizational realities.
In a high performing environment, it is fairly common to have a single team assume ownership of a bounded context.
The relationships between the teams owning these bounded contexts, play a significant role in influencing the integration patterns employed to arrive at a solution.
At a high level, there are two categories of relationships:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Symmetric</p>
</li>
<li>
<p>Asymmetric</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s look at these relationship types in more detail.</p>
</div>
<div class="sect3">
<h4 id="symmetric-relationship-patterns"><a class="anchor" href="#symmetric-relationship-patterns"></a><a class="link" href="#symmetric-relationship-patterns">9.2.1. Symmetric relationship patterns</a></h4>
<div class="paragraph">
<p>Two teams can be said to have a symmetric relationship when they have an equal amount of influence in the decision-making process to arrive at a solution.
Both teams are in a position to and indeed, do contribute more or less equally towards the outcome, as depicted here :</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/symmetric-relationship.png" alt="symmetric relationship">
</div>
<div class="title">Figure 1- 83. Both teams have an equal say in influencing the solution</div>
</div>
<div class="paragraph">
<p>There are three variations of symmetric relationships, each of which we outline in more detail in the following sub-sections.</p>
</div>
<div class="sect4">
<h5 id="partnership"><a class="anchor" href="#partnership"></a><a class="link" href="#partnership">Partnership</a></h5>
<div class="paragraph">
<p>In a partnership, both teams integrate in an ad hoc manner.
There are no fixed responsibilities assigned when needing complete integration work.
Each team picks up work as and when needed without the need for any specific ceremony or fanfare.
The nature of the integration is usually two-way with both teams exchanging solution artifacts as and when needed.
Such relationships require extremely high degrees of collaboration and understanding of the work done by both teams, as depicted here :</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/partnership.png" alt="partnership">
</div>
<div class="title">Figure 1- 84. There is an ad hoc, mutual dependency between teams in a partnership relationship</div>
</div>
<div class="sect5">
<h6 id="example"><a class="anchor" href="#example"></a><a class="link" href="#example">Example</a></h6>
<div class="paragraph">
<p>A web front-end team working in close collaboration with the APIs team building the <a href="https://philcalcado.com/2015/09/18/the_back_end_for_front_end_pattern_bff.html">BFF</a>s for the front-end.
The BFF team creates experience APIs meant to be used exclusively by the front-end.
To fulfill any functionality, the front-end team requires capabilities to be exposed by the APIs team.
On the other hand, the APIs team is dependent on the front-end team to provide advice on what capabilities to build and the order in which to build them.
Both teams freely make use of each other&#8217;s domain models (for example, the same set of request and response objects that define the API) to implement functionality.
Such reuse happens mostly arbitrarily and when API changes happen, the both teams coordinate changes to keep things working.</p>
</div>
</div>
<div class="sect5">
<h6 id="when-to-use"><a class="anchor" href="#when-to-use"></a><a class="link" href="#when-to-use">When to use</a></h6>
<div class="paragraph">
<p>Partnership between teams require high levels of collaboration, trust and understanding.
Teams tend to use this when team boundaries are informal.
It also helps if these teams are co-located and/or have a significant working time overlap.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls"><a class="anchor" href="#potential-pitfalls"></a><a class="link" href="#potential-pitfalls">Potential pitfalls</a></h6>
<div class="paragraph">
<p>Partnership relationships between teams can lead to a situation where individual team responsibilities become very unclear leading the solution towards the dreaded <em><a href="#_big_ball_of_mud">big ball of mud</a></em>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="shared-kernel"><a class="anchor" href="#shared-kernel"></a><a class="link" href="#shared-kernel">Shared kernel</a></h5>
<div class="paragraph">
<p>Unlike in a partnership, when using a shared kernel, teams have a clear understanding of the solution artifacts and models they choose to share between themselves.
Both teams take equal responsibility in the upkeep of these shared artifacts.</p>
</div>
<div class="sect5">
<h6 id="example-2"><a class="anchor" href="#example-2"></a><a class="link" href="#example-2">Example</a></h6>
<div class="paragraph">
<p>The <em>LC Application Processing</em> and <em>Customer Onboarding</em> teams in our LC application may choose to use a common model to represent the <code>CustomerCreditValidatedEvent</code>.
Any enhancements or changes to the event schema can affect both teams.
The responsibility to make any changes is owned by both teams.
Intentionally, these teams do not share anything beyond this mutually agreed upon models and artifacts.  Here is the representation of shared kernel relationships in teams.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/shared-kernel.png" alt="shared kernel">
</div>
<div class="title">Figure 1- 85. Teams have an explicit understanding of shared models</div>
</div>
</div>
<div class="sect5">
<h6 id="when-to-use-2"><a class="anchor" href="#when-to-use-2"></a><a class="link" href="#when-to-use-2">When to use</a></h6>
<div class="paragraph">
<p>The shared kernel form of collaboration works well if shared artifacts are required to be consumed in an identical fashion in both contexts.
Furthermore, it is attractive for multiple teams to coordinate and continue sharing, as opposed to duplicating identical models in both contexts.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-2"><a class="anchor" href="#potential-pitfalls-2"></a><a class="link" href="#potential-pitfalls-2">Potential pitfalls</a></h6>
<div class="paragraph">
<p>Changes made to the shared kernel affect both bounded contexts.
This means that any change made to the shared kernel needs to remain compatible for both teams.
Needless to say, as the number of teams using the shared kernel increases, the cost of coordination goes up manifold.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="separate-ways"><a class="anchor" href="#separate-ways"></a><a class="link" href="#separate-ways">Separate ways</a></h5>
<div class="paragraph">
<p>When two teams choose to not share any artifacts or models between them, they go their own separate ways.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/separate-ways.png" alt="separate ways">
</div>
<div class="title">Figure 1- 86. Teams go separate ways and not share anything between them</div>
</div>
<div class="sect5">
<h6 id="example-3"><a class="anchor" href="#example-3"></a><a class="link" href="#example-3">Example</a></h6>
<div class="paragraph">
<p>The <em>LC Application Processing</em> and the <em>Customer Onboarding</em> teams may start with sharing the same build/deployment scripts for their services.
Over a period of time, deployment requirements may diverge to a point where the shared cost of maintaining these scripts becomes prohibitively expensive, causing these teams to fork their deployments to regain independence from the other team.</p>
</div>
</div>
<div class="sect5">
<h6 id="when-to-use-3"><a class="anchor" href="#when-to-use-3"></a><a class="link" href="#when-to-use-3">When to use</a></h6>
<div class="paragraph">
<p>In some cases, two teams may be unable to collaborate for a variety of reasons, ranging from a drift in individual team requirements to organizational politics.
Whatever the case may be, these teams may decide that the cost of collaboration is too high, resulting in them going their own separate ways.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-3"><a class="anchor" href="#potential-pitfalls-3"></a><a class="link" href="#potential-pitfalls-3">Potential pitfalls</a></h6>
<div class="paragraph">
<p>Choosing to go separate ways may result in duplicate work across affected bounded contexts.
When working in bounded contexts that map to the core subdomains, this may prove counter-productive as it could lead to inconsistent behaviors unintentionally.</p>
</div>
<div class="paragraph">
<p>It is possible to transition from one relationship type to another over a period of time.
In our experience, transitioning from any one of these relationships may not be straightforward.
In cases where requirements are relatively clear at the outset, it may be easier to start with a <em>shared kernel</em>.
On the contrary, if requirements are unclear, it may be prudent to start either with a loose <em>partnership</em> or go <em>separate ways</em> until requirements become clear.
In any of these scenarios, it is important to keep evaluating the nature of the relationship and transition to a more appropriate type based on our enhanced understanding of the requirements and/or the relationship itself.</p>
</div>
<div class="paragraph">
<p>In each of the relationships characterized above, the teams involved have a more or less equal say in how the relationship evolved and the resulting outcomes.
However, this may not always be the case.
Let&#8217;s look at examples of cases where one team may have a clear upper hand in terms of how the relationship evolves.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="asymmetric-relationship-patterns"><a class="anchor" href="#asymmetric-relationship-patterns"></a><a class="link" href="#asymmetric-relationship-patterns">9.2.2. Asymmetric relationship patterns</a></h4>
<div class="paragraph">
<p>Two teams can be said to have an asymmetric relationship when one of the teams has a stronger influence in the decision-making process to arrive at a solution.
In other words, there is a clear customer-supplier (or upstream-downstream) relationship where either the customer or the supplier plays a dominant role that affects solution design approaches.
It is also likely that the customer and the supplier do not share common goals.  Here is the representation of an asymmetric relationship between customer and supplier.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/asymmetric-relationship.png" alt="asymmetric relationship">
</div>
<div class="title">Figure 1- 87. One of the teams has a dominant say in influencing the solution</div>
</div>
<div class="paragraph">
<p>There are at least three solution patterns when teams are in an asymmetric relationship, each of which we outline in more detail in the following sub-sections.</p>
</div>
<div class="sect4">
<h5 id="_conformist"><a class="anchor" href="#_conformist"></a><a class="link" href="#_conformist">Conformist (CF)</a></h5>
<div class="paragraph">
<p>It is not unusual for the side playing the supplier role to have a dominant say in how the relationship with one or more customers is implemented.
Furthermore, the customer may simply choose to conform with the supplier-provided solution as is, making it an integral part of their own solution.
In other words, the supplier provides a set of models and the customer uses those same models to build their solution.
In this case, the customer is termed to be a <em>conformist</em>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/conformist.png" alt="conformist">
</div>
<div class="title">Figure 1- 88. Customer accepts dependency on supplier model</div>
</div>
<div class="sect5">
<h6 id="example-4"><a class="anchor" href="#example-4"></a><a class="link" href="#example-4">Example</a></h6>
<div class="paragraph">
<p>When building a solution to validate United States postal addresses of LC applicants, we chose to conform to the <a href="https://www.usps.com/business/web-tools-apis/">USPS Web Tools</a> address validation API schema.
Given that the business started with just US-based applicants, this made sense.
This means that any references to the address model in our bounded contexts mimic the schema prescribed by the USPS.
This further means that we will need to keep up with changes that occur in the USPS API as and when they occur (regardless of whether that change is needed for our own functionality).</p>
</div>
</div>
<div class="sect5">
<h6 id="when-to-use-4"><a class="anchor" href="#when-to-use-4"></a><a class="link" href="#when-to-use-4">When to use</a></h6>
<div class="paragraph">
<p>Being a conformist is not necessarily a negative thing.
The supplier&#8217;s models may be a well accepted industry standard, or they may simply be good enough for our needs.
It may also be that the team may not have the necessary skills, motivation or immediate needs to do something different from what the supplier has provided.
This approach also enables teams to make quick progress, leveraging work mostly done by other experts.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-4"><a class="anchor" href="#potential-pitfalls-4"></a><a class="link" href="#potential-pitfalls-4">Potential pitfalls</a></h6>
<div class="paragraph">
<p>An overuse of the conformist pattern may dilute the ubiquitous language of our own bounded contexts, resulting in a situation where there is no clear separation between the supplier and customer concepts.
It may also be that concepts that are core to the supplier&#8217;s context leaks into our own, despite those concepts carrying little to no meaning in our context.
This may result in these bounded contexts being very tightly coupled with each other.
And if a need arises to switch to another supplier or support multiple suppliers, the cost of change may be prohibitively expensive.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_anti_corruption_layer_acl"><a class="anchor" href="#_anti_corruption_layer_acl"></a><a class="link" href="#_anti_corruption_layer_acl">Anti-corruption layer (ACL)</a></h5>
<div class="paragraph">
<p>There may be scenarios where a customer may need to collaborate with the supplier, but may want to shield itself from the supplier&#8217;s ubiquitous language and models.
In such cases, it may be prudent to redefine these conflicting models in the customer&#8217;s own ubiquitous language using a translation layer at the time of integration, also known as an <em>anti-corruption layer</em> (ACL).  This is depicted in the following figure :</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/anti-corruption-layer.png" alt="anti corruption layer">
</div>
<div class="title">Figure 1- 89. Customer wants to protect itself from supplier models</div>
</div>
<div class="sect5">
<h6 id="example-5"><a class="anchor" href="#example-5"></a><a class="link" href="#example-5">Example</a></h6>
<div class="paragraph">
<p>In the address validation example referenced in the <a href="#_conformist">Conformist</a> section, the <em>LC Application Processing</em> team may need to support Canadian applicants as well.
In such a case, being a conformist to a system that supports only US addresses may prove restrictive and even confusing.
For example, the US <em>state</em> is analogous to a <em>province</em> in Canada.
Similarly, <em>zip code</em> in the US is referred to <em>postal code</em> in Canada.
In addition, US zip codes are numeric whereas Canadian postal codes are alphanumeric.
Most importantly, we currently do not have the notion of a <em>country code</em> in our address model, but now we will need to introduce this concept to differentiate addresses within the respective countries.
Let&#8217;s look at the address models from the respective countries here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/acl-example.png" alt="acl example">
</div>
<div class="title">Figure 1- 90. Address Models of different countries</div>
</div>
<div class="paragraph">
<p>While we initially conformed to the USPS model, we have now evolved to support more countries.
For example, <em>region</em> is used to represent the concept of <em>state</em>/<em>province</em>.
Also, we have introduced the <em>country</em> value object, which was missing earlier.</p>
</div>
</div>
<div class="sect5">
<h6 id="when-to-use-5"><a class="anchor" href="#when-to-use-5"></a><a class="link" href="#when-to-use-5">When to use</a></h6>
<div class="paragraph">
<p>Anti-corruption layers come in handy when the customer models are part of a core domain.
The ACL shields the customer from changes in the supplier&#8217;s models and can help produce more loosely coupled integrations.
It may also be necessary when we are looking to integrate similar concepts from multiple suppliers.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-5"><a class="anchor" href="#potential-pitfalls-5"></a><a class="link" href="#potential-pitfalls-5">Potential pitfalls</a></h6>
<div class="paragraph">
<p>Using an anti-corruption layer may be tempting in a lot of cases.
However, it is less beneficial when the concepts being integrated don&#8217;t often change, or are defined by a well-known authority.
Using an ACL with a custom language may only cause more confusion.
Creating an ACL usually requires additional translations and thereby may increase the overall complexity of the customer&#8217;s bounded context and may be considered premature optimization.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_open_host_service_ohs"><a class="anchor" href="#_open_host_service_ohs"></a><a class="link" href="#_open_host_service_ohs">Open host service (OHS)</a></h5>
<div class="paragraph">
<p>Unlike the conformist and the anti-corruption layer, where customers do not have a formal means to interface with the supplier, with the open host service, the supplier defines a clear interface to interact with its customers.
This interface may be made available in the form of a well-known published language (for example, a REST interface or a client SDK):</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/open-host-service.png" alt="open host service">
</div>
<div class="title">Figure 1- 91. Open host service (OHS) using a published language (PL).</div>
</div>
<div class="sect5">
<h6 id="example-6"><a class="anchor" href="#example-6"></a><a class="link" href="#example-6">Example</a></h6>
<div class="paragraph">
<p>The LC Application Processing bounded context can expose an HTTP interface for each of its commands as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"># Start a new LC application
curl POST /applications/start \
        -d '{&quot;applicant-id&quot;: &quot;8ed2d2fe&quot;, &quot;clientReference&quot;: &quot;Test LC&quot;}' \
        -H 'content-type:application/vnd.lc-application.v2+json'

# Change the amount on an existing application
curl POST /applications/ac130002/change-amount \
        -d '{&quot;amount&quot;: 100, &quot;currency&quot;: &quot;USD&quot;}' \
        -H 'content-type:application/vnd.lc-application.v2+json'

# Other commands omitted for brevity</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an augment to the HTTP interface shown here, we may even provide a client SDK in some of the more popular languages used by our customers.
This helps hide more implementation details such the MIME type and version from customers.</p>
</div>
</div>
<div class="sect5">
<h6 id="when-to-use-6"><a class="anchor" href="#when-to-use-6"></a><a class="link" href="#when-to-use-6">When to use</a></h6>
<div class="paragraph">
<p>When the supplier wants to hide its internal models (ubiquitous language), making an open host service enables the supplier to evolve while providing a stable interface to its customers.
In a sense, the open-host service pattern is a reversal of the anti-corruption layer pattern: instead of the customer, the supplier implements the translation of its internal model.
Also, the supplier can consider providing an open host service when it is interested in providing a richer user experience for its customers.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-6"><a class="anchor" href="#potential-pitfalls-6"></a><a class="link" href="#potential-pitfalls-6">Potential pitfalls</a></h6>
<div class="paragraph">
<p>While suppliers may have good intentions by providing an open host service for its customers, it may result in increased implementation complexity (for example, there may be a need to support multiple versions of an API, or client SDKs in multiple languages).
If the open host service does not take into account common usage patterns of its customers, it may result in a poor customer usability and also in degraded performance for the supplier.</p>
</div>
<div class="paragraph">
<p>It is important to note that the conformist and the anti-corruption layer are patterns that customers implement, whereas the open host service is a supplier-side pattern.
For example, the following scenario with the supplier providing an <em>open host service</em> and one customer is a <em>conformist</em> while another has an <em>anti-corruption layer</em>, can be true as depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/asymmetric-multiple-customers.png" alt="asymmetric multiple customers">
</div>
<div class="title">Figure 1- 92. Asymmetric relationships with multiple customers.</div>
</div>
<div class="paragraph">
<p>Now that we have seen the various ways in which bounded contexts can integrate with each other, here is one possible implementation for our LC application depicted in the form of a context map:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/bounded-context-relationships/lc-application-context-map.png" alt="lc application context map">
</div>
<div class="title">Figure 1- 93. Simplified context map for the LC application.</div>
</div>
<div class="paragraph">
<p>Thus far we have examined the various ways in which inter-team dynamics influence integration mechanisms.
While having clarity at the conceptual level helps, let&#8217;s see how these relationships manifest themselves at the implementation level.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementation-patterns"><a class="anchor" href="#implementation-patterns"></a><a class="link" href="#implementation-patterns">9.3. Implementation patterns</a></h3>
<div class="paragraph">
<p>We have looked integration between bounded contexts at a design level, but these concepts need to be translated into code.
There are three broad categories that can be employed when integrating two bounded contexts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Data-based</p>
</li>
<li>
<p>Code-based</p>
</li>
<li>
<p>API-based</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s look at each method in more detail now.</p>
</div>
<div class="sect3">
<h4 id="data-based"><a class="anchor" href="#data-based"></a><a class="link" href="#data-based">9.3.1. Data-based</a></h4>
<div class="paragraph">
<p>In this style of integration, the bounded contexts in question share data between each other. If the relationship is symmetric, the teams owning these bounded contexts may choose to share entire databases with free access to both read, write and change underlying structures. Whereas in an asymmetric relationship, the supplier may constrain the scope of access, based on the type of relationship.</p>
</div>
<div class="sect4">
<h5 id="shared-database"><a class="anchor" href="#shared-database"></a><a class="link" href="#shared-database">Shared database</a></h5>
<div class="paragraph">
<p>The simplest form of data integration is the use of a shared database. In this style of integration, all participating bounded contexts have unrestricted access to the schemas and the underlying data as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/integration-patterns/symmetric-shared-data.png" alt="symmetric shared data">
</div>
<div class="title">Figure 1- 94. Integration using a shared database</div>
</div>
<div class="sect5">
<h6 id="when-to-use-7"><a class="anchor" href="#when-to-use-7"></a><a class="link" href="#when-to-use-7">When to use</a></h6>
<div class="paragraph">
<p>The shared database presents a very low barrier to entry for teams looking to quickly enable new or enhance existing functionality by providing ready access to data for read and/or write use-cases. More importantly, it also allows the use of local database transactions, which usually provides strong consistency, lower complexity and better performance (especially when working with relational databases).</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-7"><a class="anchor" href="#potential-pitfalls-7"></a><a class="link" href="#potential-pitfalls-7">Potential pitfalls</a></h6>
<div class="paragraph">
<p>However, this symmetric integration style where multiple teams have shared ownership is usually frowned upon because it often leads to a situation where there is no clear ownership. Furthermore, the shared databases can become a source of tight coupling, accelerating the path towards the dreaded <em>big ball of mud</em>. Additionally, users of the shared database can suffer from the <em>noisy neighbor</em> effect where one co-tenant monopolizing resources adversely affects all other tenants. For these reasons, teams will be well advised to choose this style of integration sparingly.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="replicated-data"><a class="anchor" href="#replicated-data"></a><a class="link" href="#replicated-data">Replicated data</a></h5>
<div class="paragraph">
<p>In the case of asymmetric relationships, suppliers may be unwilling to provide direct access to their data. However, they may choose to integrate with customers using a mechanism based on data sharing. An alternate form of integration is to provide a copy of the data required by consumers. There are many variations on how this can be implemented, we depict the more common ways here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/integration-patterns/asymmetric-shared-data.png" alt="asymmetric shared data">
</div>
<div class="title">Figure 1- 95. Integration using data replication.</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Database views</strong>: In this form, the consumer gets or is provided access to a subset of the data using query-based or materialized views. In either case, the customer usually has read-only access to the data and both supplier and customer continue to share the same physical resources (usually the DB engine).</p>
</li>
<li>
<p><strong>Full read replica</strong>: In this form, the customer gets access to a read replica of the supplier&#8217;s entire database, usually on physically disparate infrastructure.</p>
</li>
<li>
<p><strong>Partial read replica</strong>: In this form, the customer gets access to a read replica of a subset of the supplier&#8217;s database, again on physically disparate infrastructure.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="when-to-use-8"><a class="anchor" href="#when-to-use-8"></a><a class="link" href="#when-to-use-8">When to use</a></h6>
<div class="paragraph">
<p>This style of integration may be required when there is an asymmetric relationship between the supplier and the customer. Like the shared database, this integration style usually requires less upfront effort to integrate. This is also apt when suppliers intend to provide read-only access to a subset of their data. It may also suffice to use data replication when customers only require to read a subset of the supplier&#8217;s data.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-8"><a class="anchor" href="#potential-pitfalls-8"></a><a class="link" href="#potential-pitfalls-8">Potential pitfalls</a></h6>
<div class="paragraph">
<p>If we choose to use database views, we may continue to suffer from the noisy neighbor effect. On the other hand, if we choose to create physically disparate replicas, we will need to incur the cost of additional operational complexity. More importantly, the consumers remain tightly coupled to the supplier&#8217;s domain models and ubiquitous language.</p>
</div>
<div class="paragraph">
<p>Next, let&#8217;s look at some ways to make the most of data-based integrations.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="increasing-effectiveness"><a class="anchor" href="#increasing-effectiveness"></a><a class="link" href="#increasing-effectiveness">Increasing effectiveness</a></h5>
<div class="paragraph">
<p>When sharing data, the schema (the structure of the database) acts as a means to enforce contracts, especially when using databases that require specifying a formal structure (for example, relational databases). When multiple parties are involved, managing the schema can become a challenge.</p>
</div>
<div class="paragraph">
<p>To mitigate undesirable changes, teams sharing data may want to consider the use of a schema migration tool. Relational databases work well with tools like <a href="https://www.liquibase.org/">liquibase</a><sup class="footnote">[<a id="_footnoteref_37" class="footnote" href="#_footnotedef_37" title="View footnote.">37</a>]</sup> or <a href="https://flywaydb.org/">flyway</a><sup class="footnote">[<a id="_footnoteref_38" class="footnote" href="#_footnotedef_38" title="View footnote.">38</a>]</sup>. When working with databases that do not formally enforce a schema, it may be best to avoid employing this style of integration, especially when working in  symmetric relationships where ownership is unclear.</p>
</div>
<div class="paragraph">
<p>In any case, if using one of the shared data styles of integration is unavoidable, teams may want to strongly consider employing one or more techniques mentioned in <a href="https://databaserefactoring.com/">refactoring databases</a> to make it more manageable.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="code-based"><a class="anchor" href="#code-based"></a><a class="link" href="#code-based">9.3.2. Code-based</a></h4>
<div class="paragraph">
<p>In this style of integration, teams coordinate by sharing code artifacts, either directly in the form of source code and/or binaries. At a high level, there are two forms:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sharing source code</p>
</li>
<li>
<p>Sharing binaries</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We describe each of these here:</p>
</div>
<div class="sect4">
<h5 id="sharing-source-code"><a class="anchor" href="#sharing-source-code"></a><a class="link" href="#sharing-source-code">Sharing source code</a></h5>
<div class="paragraph">
<p>A fairly common practice within organizations is to share source code with the objective of promoting reuse and standardization. This may include utilities (like logging, authentication, etc.), build/deployment scripts, data transfer objects, etc. In other words, any piece of source code where the cost of duplication is seen to be higher than reuse.</p>
</div>
<div class="sect5">
<h6 id="when-to-use-9"><a class="anchor" href="#when-to-use-9"></a><a class="link" href="#when-to-use-9">When to use</a></h6>
<div class="paragraph">
<p>Depending on the relationship type (symmetric/asymmetric), teams sharing code may have varied levels of influence in how the shared artifacts evolve. This works well in a symmetric relationship, both teams are empowered to make changes compatible with each other. Similarly, in an asymmetric relationship, the supplier may accept changes from customers, while retaining ownership and control of the shared artifacts. This also tends to work well in case of non-core, infrequently changing code artifacts. Sharing source code also enables higher levels of transparency and visibility into the internals of the shared artifacts (case in point - open source software).</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-9"><a class="anchor" href="#potential-pitfalls-9"></a><a class="link" href="#potential-pitfalls-9">Potential pitfalls</a></h6>
<div class="paragraph">
<p>Sharing code artifacts means that individual teams take on responsibility to make sure that the process of converting source code into binary executables is uniform and compatible with requirements for all parties. This may include code conventions, static quality checks, tests (presence or lack thereof), compilation/build flags, versioning, and so on. When a relatively large number of teams are involved, maintaining this form of compatibility may become burdensome.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sharing-binary-artifacts"><a class="anchor" href="#sharing-binary-artifacts"></a><a class="link" href="#sharing-binary-artifacts">Sharing binary artifacts</a></h5>
<div class="paragraph">
<p>Another relatively common practice is to share artifacts at the binary level. In this scenario, the consumers may or may not have direct access to source code artifacts. Examples include third-party libraries, client SDKs, API documentation, and so on. This form of integration is fairly common when the relationship between the coordinating parties is asymmetric. The supplier of the library has a clear ownership of maintaining the lifecycle of the shared artifacts.</p>
</div>
<div class="sect5">
<h6 id="when-to-use-10"><a class="anchor" href="#when-to-use-10"></a><a class="link" href="#when-to-use-10">When to use</a></h6>
<div class="paragraph">
<p>Sharing just binary artifacts may be necessary when the supplier is unable/unwilling to share source artifacts, possibly because they may be proprietary and/or part of the supplier&#8217;s intellectual property. Because the supplier takes ownership of the <em>build</em> process, it behooves the supplier to produce artifacts that are compatible with most potential consumers. Hence, this works well when the supplier is willing to do that. On the other hand, it requires that the customer place high levels of <a href="https://www.thoughtworks.com/en-us/insights/podcasts/technology-podcasts/securing-software-supply-chain">trust</a><sup class="footnote">[<a id="_footnoteref_39" class="footnote" href="#_footnotedef_39" title="View footnote.">39</a>]</sup> in the supplier&#8217;s <a href="https://blog.sonatype.com/software-supply-chain-a-definition-and-introductory-guide">software supply chain</a><sup class="footnote">[<a id="_footnoteref_40" class="footnote" href="#_footnotedef_40" title="View footnote.">40</a>]</sup> when producing these artifacts.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-10"><a class="anchor" href="#potential-pitfalls-10"></a><a class="link" href="#potential-pitfalls-10">Potential pitfalls</a></h6>
<div class="paragraph">
<p>Integration through the use of binary artifact sharing reduces the visibility into the build process of the shared artifacts for the consumers. If consumers rely on slow-moving suppliers, this can become untenable. For example, if a critical security bug is discovered in the shared binary, the consumer is solely reliant on the supplier to remediate. This can be a huge risk if such dependencies are in critical, business-differentiating aspects of the solution (especially in the core subdomain). This risk can be exacerbated without the use of appropriate <a href="#_anti_corruption_layer_acl">anti-corruption layers</a> (ACLs) and/or service level agreements (SLAs).</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_increasing_effectiveness_code_based"><a class="anchor" href="#_increasing_effectiveness_code_based"></a><a class="link" href="#_increasing_effectiveness_code_based">Increasing effectiveness</a></h5>
<div class="paragraph">
<p>When sharing code artifacts, it becomes a lot more important to be explicit in how changes are made while continuing to maintain high levels of quality&#8201;&#8212;&#8201;especially when multiple teams are involved. Let&#8217;s examine some of these techniques in more detail:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Static analysis</strong>: This can be as simple as adhering to a set of coding standards using a tool like <a href="https://checkstyle.sourceforge.io/">checkstyle</a>. More importantly, these tools can be used to conform to a set of naming conventions to allow the firmer use of the ubiquitous language throughout the codebase. In addition, tools like <a href="https://spotbugs.github.io/">spotbugs</a>, <a href="https://pmd.github.io/">PMD/CPD</a> can be used to statically analyze code for the presence of bugs and duplicate code.</p>
</li>
<li>
<p><strong>Code architecture tests</strong>: While static inspection tools are effective at operating at the level of a single compilation unit, runtime inspection can take this one level further to identify package cycles, dependency checks, inheritance trees, etc. to apply lightweight architecture governance. The use of tools like <a href="https://github.com/clarkware/jdepend">JDepend</a> and <a href="https://www.archunit.org/">ArchUnit</a> can help here.</p>
</li>
<li>
<p><strong>Unit tests</strong>: When working with shared codebases, team members are looking to make changes in a safe and reliable manner. The presence of a comprehensive suite of fast-running unit tests can go a long way to wards increasing confidence. We strongly recommend employing test-driven design to further maximize creating a codebase that is well-designed and one that enables easier refactoring.</p>
</li>
<li>
<p><strong>Code reviews</strong>: While automation can go a long way, augmenting the process where a human reviews changes can be highly effective for multiple reasons. This can take the form of offline reviews (using pull requests) or active peer reviews (using paired programming). All of these techniques serve to enhance collective understanding, thereby reducing risk when changes are made.</p>
</li>
<li>
<p><strong>Documentation</strong>: Needless to say, well-structured documentation can be invaluable when making contributions and also when consuming binary code artifacts. Teams will be well advised to proliferate the use of the ubiquitous language by striving to write self-documenting code all throughout to maximize benefits derived.</p>
</li>
<li>
<p><strong>Dependency management</strong>: When sharing binary code artifacts, managing dependencies can become fairly complicated due to having too many dependencies, long dependency chains, conflicting/cyclic dependencies, and so on. Teams should strive to reduce afferent (incoming) coupling as much as possible to mitigate the problems described above.</p>
</li>
<li>
<p><strong>Versioning</strong>: In addition to minimizing the amount of afferent coupling, using an explicit versioning strategy can go a long way towards making dependency management easier. We strongly recommend considering the use of a technique like <a href="https://semver.org/">semantic versioning</a> for shared code artifacts.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ipc-based"><a class="anchor" href="#ipc-based"></a><a class="link" href="#ipc-based">9.3.3. IPC-based</a></h4>
<div class="paragraph">
<p>In this style of integration, the bounded contexts exchange messages using some form of inter-process communication (IPC) to interact with each other. This may take the form of synchronous or asynchronous communication.</p>
</div>
<div class="sect4">
<h5 id="synchronous-messaging"><a class="anchor" href="#synchronous-messaging"></a><a class="link" href="#synchronous-messaging">Synchronous messaging</a></h5>
<div class="paragraph">
<p>Synchronous messaging is a style of communication where the sender of the request waits for a response from the receiver, which implies that the sender and the receiver need to be active for this style to work. Usually, this form of communication is point-to-point. HTTP is one of the commonly used protocols for this style of communication. A visual representation of this form of communication is shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/integration-patterns/synchronous-messaging.png" alt="synchronous messaging">
</div>
<div class="title">Figure 1- 96. Synchronous messaging</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please take a look at the HTTP APIs for the commands used during LC application processing included with the code examples for this chapter.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="when-to-use-11"><a class="anchor" href="#when-to-use-11"></a><a class="link" href="#when-to-use-11">When to use</a></h6>
<div class="paragraph">
<p>This form of integration is used when the customer is interested in the supplier&#8217;s response to the request. The response is then used to determine whether the request was successful or not. Given that the customer needs to wait for the response, it is advisable to use this style of messaging for low latency operations. This form of integration is popular when exposing public APIs over the internet (for example, <a href="https://docs.github.com/en/rest">Github&#8217;s REST API</a><sup class="footnote">[<a id="_footnoteref_41" class="footnote" href="#_footnotedef_41" title="View footnote.">41</a>]</sup>).</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-11"><a class="anchor" href="#potential-pitfalls-11"></a><a class="link" href="#potential-pitfalls-11">Potential pitfalls</a></h6>
<div class="paragraph">
<p>When using synchronous messaging, the customer&#8217;s ability to scale is heavily dependent on the supplier to satisfy the customer&#8217;s requirements. On the flip side, customers making requests at too high a rate may compromise the supplier&#8217;s ability to serve customers in a predictable manner. If there is a chain of synchronous messaging, the probability of cascading failure becomes much higher.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="asynchronous-messaging"><a class="anchor" href="#asynchronous-messaging"></a><a class="link" href="#asynchronous-messaging">Asynchronous messaging</a></h5>
<div class="paragraph">
<p>Asynchronous messaging is a style of communication where the sender does not wait for an explicit response from the receiver.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We are using the terms sender and receiver, instead of customer and supplier because they both can play either role of sender or receiver.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is typically achieved by introducing an intermediary in the form of a message channel. The presence of the intermediary enables both one-to-one and one-to-many modes of communication. Typically, the intermediary can take the form of a shared filesystem, database or a queueing system.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/integration-patterns/asynchronous-messaging.png" alt="asynchronous messaging">
</div>
<div class="title">Figure 1- 97. Asynchronous messaging</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please take a look at the event APIs for the commands used during LC application processing included with the code examples for this chapter.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="when-to-use-12"><a class="anchor" href="#when-to-use-12"></a><a class="link" href="#when-to-use-12">When to use</a></h6>
<div class="paragraph">
<p>This form of integration is used when the sender does not care about receiving an <strong>immediate</strong> response from the receiver(s), resulting in the respective systems becoming a lot more decoupled from each other. This further enables these systems to scale independently. This also makes it possible to have the same message to be processed by multiple receivers. For example, in our LC application processing system, the <code>LCApplicationSubmittedEvent</code> is received by both the <em>Compliance</em> and <em>Customer Onboarding</em> systems.</p>
</div>
</div>
<div class="sect5">
<h6 id="potential-pitfalls-12"><a class="anchor" href="#potential-pitfalls-12"></a><a class="link" href="#potential-pitfalls-12">Potential pitfalls</a></h6>
<div class="paragraph">
<p>The introduction of the intermediary component adds complexity to the overall solution. The <a href="#_ignoring_non_functional_requirements">non-functional</a> characteristics of the intermediary can have a profound effect on the resilience characteristics of the system as a whole. It can also be tempting to add processing logic to the intermediary, thereby coupling the overall system very tightly to this component. To ensure reliable communication between the sender and the receiver, the intermediary may have to support a variety of enhanced capabilities (such as ordering, producer flow control, durability, transactions, and so on.)</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="increasing-effectiveness-2"><a class="anchor" href="#increasing-effectiveness-2"></a><a class="link" href="#increasing-effectiveness-2">Increasing effectiveness</a></h5>
<div class="paragraph">
<p>When implementing integration using some form of IPC, a lot of the techniques discussed in the <a href="#_increasing_effectiveness_code_based">code-based implementation</a> patterns section continue to apply. As discussed earlier, API documentation plays a significant role in reducing friction for customers. In addition, here are a few more techniques that apply specifically when using IPC-based integration. We outline some of these techniques here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Typed protocols</strong>: When working with this form of integration, it is important to minimize the amount of time taken to gather feedback on structural validations. This is especially important given that the supplier and the customer may be in a constant state of independent evolution. The use of typed protocols such as protocol buffers, Avro, Netflix&#8217;s Falcor, GraphQL, and so on. can make it easier for customers to interact with suppliers while maintaining a lightweight mechanism to validate correctness of requests.</p>
</li>
</ol>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The operative word here is <strong>lightweight</strong>. It is pertinent to note that we are not advising against the use of JSON-based HTTP APIs (typically advertised as being RESTful) which do not enforce the use of an explicit schema. Neither are we promoting the use of (arguably) legacy protocols like SOAP, WSDL, CORBA, etc. Each of these, while being well-meaning suffered from being fairly heavyweight.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p><strong>Self discovery</strong>: As outlined above, when working with a IPC-based integration mechanism, we should look to reduce the barrier to entry. When working with RESTful APIs, the use of <a href="https://restfulapi.net/hateoas">HATEOAS</a><sup class="footnote">[<a id="_footnoteref_42" class="footnote" href="#_footnotedef_42" title="View footnote.">42</a>]</sup>, although difficult for suppliers to implement, can make it easier for customers to understand and consume APIs. In addition, making use of a service registry and/or a schema registry can further reduce consumption friction.</p>
</li>
<li>
<p><strong>Contract tests</strong>: In the spirit of failing fast and shifting left, the practice of contract testing and <a href="https://martinfowler.com/articles/consumerDrivenContracts.html">consumer-driven contracts</a> can further increase the quality and speed of integration. Tools such as <a href="https://pact.io/">Pact</a><sup class="footnote">[<a id="_footnoteref_43" class="footnote" href="#_footnotedef_43" title="View footnote.">43</a>]</sup> and <a href="https://spring.io/projects/spring-cloud-contract">Spring Cloud Contract</a><sup class="footnote">[<a id="_footnoteref_44" class="footnote" href="#_footnotedef_44" title="View footnote.">44</a>]</sup> make the adoption of these practices relatively simple.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Thus far, we discussed implementation patterns, broadly categorized into data-based, code-based and IPC-based integrations.  Hopefully, this gives you a good idea to consciously choose the appropriate approach considering the benefits and the caveats that they bring along with them.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary-9"><a class="anchor" href="#summary-9"></a><a class="link" href="#summary-9">9.4. Summary</a></h3>
<div class="paragraph">
<p>In this chapter, we looked at the different types of bounded context relationships. We also examined common integration patterns that can be used when implementing these bounded context relationships.</p>
</div>
<div class="paragraph">
<p>You have learned when specific techniques can be used, potential pitfalls and ideas on how to increase effectiveness when employing these methods.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will explore means to distribute these bounded contexts into independently deployable components (in other words, employ a microservices-based architecture).</p>
</div>
</div>
<div class="sect2">
<h3 id="questions-8"><a class="anchor" href="#questions-8"></a><a class="link" href="#questions-8">9.5. Questions</a></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In your ecosystem, can you identify bounded context boundaries and the integration mechanism in use?</p>
</li>
<li>
<p>Will you be able to draw a context map for your system?</p>
</li>
<li>
<p>Will you recommend any changes to the existing styles of integration based on the learnings from this chapter?</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-7"><a class="anchor" href="#further-reading-7"></a><a class="link" href="#further-reading-7">9.6. Further reading</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 35.7142%;">
<col style="width: 21.4285%;">
<col style="width: 42.8573%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integration database</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/bliki/IntegrationDatabase.html" class="bare">https://martinfowler.com/bliki/IntegrationDatabase.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REST APIs must be hypertext-driven</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Roy T. Fielding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven" class="bare">https://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<h1 id="part-3-advanced-patterns" class="sect0"><a class="anchor" href="#part-3-advanced-patterns"></a><a class="link" href="#part-3-advanced-patterns">Part 3: Advanced Patterns</a></h1>
<div class="openblock partintro">
<div class="content">
In Part 3, we will extend the application we built in Part 2 to utilize more modern, cloud native technologies. We will look at implementing an ecosystem of microservices and further extend these to be expressed to employ a serverless architecture.
</div>
</div>
<div class="sect1 text-justify">
<h2 id="distributing-into-remote-components"><a class="anchor" href="#distributing-into-remote-components"></a><a class="link" href="#distributing-into-remote-components">10. Distributing into remote components</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
A distributed system is one in which the failure of a computer you didn&#8217;t even know existed can render your own computer unusable.
</blockquote>
<div class="attribution">
&#8212; Leslie Lamport
</div>
</div>
<div class="paragraph">
<p>Thus far, we have a working application for <em>LC Application Processing</em>, which is bundled along with other components as a single package. Although, we have discussed the idea of subdomains and bounded contexts, the separation between these components is logical, rather than physical. Furthermore, we have focused primarily on the <em>LC Application Processing</em> aspect of the overall solution.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will look at extracting the <em>LC Application Processing</em> bounded context into components that are physically disparate, and hence enable us to deploy them independently of the rest of the solution. We will discuss various options available to us, the rationale for choosing a given option, along with the implications that we will need to be cognizant of.</p>
</div>
<div class="paragraph">
<p>By the end of this chapter, you will have learned what it takes to design well-factored APIs&#8201;&#8212;&#8201;both remote procedure call and event-based. For event-based APIs, you will gain an understanding of the various guarantees that may be needed to create robust solutions. Finally, you will also learn how to manage consistency when distributing data stores.</p>
</div>
<div class="sect2">
<h3 id="continuing-our-design-journey-5"><a class="anchor" href="#continuing-our-design-journey-5"></a><a class="link" href="#continuing-our-design-journey-5">10.1. Continuing our design journey</a></h3>
<div class="paragraph">
<p>In preceding chapters, we have created a solution for <em>LC Application Processing</em> that works as in-process component of the remainder of the overall application. From a logical perspective, our realization of the Letter of Credit application looks like the visual depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith.png" alt="lc application monolith" width="75%">
</div>
<div class="title">Figure 1- 98. Current view of the LC application monolith</div>
</div>
<div class="paragraph">
<p>Although the <em>LC Application Processing</em> component is loosely coupled from the rest of the application, we are still required to coordinate with several other teams to realize business value. This may inhibit our ability to innovate at a pace faster than the slowest contributor in the ecosystem. This is because all teams need to be production ready before a deployment can happen. This can be further exacerbated by the fact that individual teams may be at different levels of engineering maturity. Let&#8217;s look at some options on how we can achieve a level of independence from the rest of the ecosystem by physically decomposing our components into distinctly deployable artifacts.</p>
</div>
</div>
<div class="sect2">
<h3 id="decomposing-our-monolith"><a class="anchor" href="#decomposing-our-monolith"></a><a class="link" href="#decomposing-our-monolith">10.2. Decomposing our monolith</a></h3>
<div class="paragraph">
<p>First and foremost, the <em>LC Application Processing</em> component exposes only in-process APIs when other components interact with it. This includes interactions with:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Frontend</p>
</li>
<li>
<p>Published/consumed events</p>
</li>
<li>
<p>Database</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To extract <em>LC Application Processing</em> functionality out into its own independently deployable component, remotely invokable interfaces will have to be supported instead of the in-process ones we have currently. Let&#8217;s examine remote API options for each.</p>
</div>
<div class="sect3">
<h4 id="changes-for-frontend-interactions"><a class="anchor" href="#changes-for-frontend-interactions"></a><a class="link" href="#changes-for-frontend-interactions">10.2.1. Changes for frontend interactions</a></h4>
<div class="paragraph">
<p>Currently, the JavaFX frontend interacts with the rest of the application by making request-response style in-process method calls (<code>CommandGateway</code> for commands and <code>QueryGateway</code> for queries) as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td>
  <td class="code"><pre><span style="color:#007">@Service</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">BackendService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> QueryGateway queryGateway;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> CommandGateway commandGateway;

    <span style="color:#088;font-weight:bold">public</span> BackendService(QueryGateway queryGateway,
                          CommandGateway gateway) {
        <span style="color:#950">this</span>.queryGateway = queryGateway;
        <span style="color:#950">this</span>.commandGateway = gateway;
    }

    <span style="color:#088;font-weight:bold">public</span> LCApplicationId startNewLC(ApplicantId applicantId, <span style="color:#0a8;font-weight:bold">String</span> clientReference) {
        <span style="color:#080;font-weight:bold">return</span> commandGateway.sendAndWait(
                startApplication(applicantId, clientReference));
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;LCView&gt; findMyDraftLCs(ApplicantId applicantId) {
        <span style="color:#080;font-weight:bold">return</span> queryGateway.query(
                <span style="color:#080;font-weight:bold">new</span> MyDraftLCsQuery(applicantId),
                        ResponseTypes.multipleInstancesOf(LCView.class))
                .join();

    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>One very simple way to replace these in-process calls will be to introduce some form of remote procedure call (RPC). Now our application looks like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-1.png" alt="lc application monolith stage 1" width="75%">
</div>
<div class="title">Figure 1- 99. Remote interaction with the frontend introduced</div>
</div>
<div class="paragraph">
<p>When working with in-process interactions, we are simply invoking methods on objects within the confines of the same process. However, when we switch to using out-of-process calls, we have quite a few considerations. These days when working with remote APIs, we have several popular choices in the form of JSON-based web services, GraphQL, gRPC, etc. While it is possible to make use of a completely custom format to facilitate the communication, DDD advocates the use of the <a href="#_open_host_service_ohs">open host service</a> pattern using a published language that we covered in Chapter 9. Even with the open host service style of communication, there are a few considerations, some of which we discuss in the following subsections:</p>
</div>
<div class="sect4">
<h5 id="protocol-options"><a class="anchor" href="#protocol-options"></a><a class="link" href="#protocol-options">Protocol options</a></h5>
<div class="paragraph">
<p>There are several options available to us when exposing remote APIs. These days using a JSON-based API (often labeled as REST) seems to be quite popular. However, this isn&#8217;t the only option available to us. In a resource-based approach, the first step is to identify a resource (noun) and then map the interactions (verbs) associated with the resource as a next step. In an action-based approach, the focus is on the actions to be performed. Arguably, REST takes a resource-based approach, whereas graphQL, gRPC, SOAP, etc. seem to be action-based. Let&#8217;s take an example of an API where we want to submit an LC. In a RESTful world, this may look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre># Start a new LC application
curl POST /lc-applications/start \
        -d '{&quot;applicant-id&quot;: &quot;8ed2d2fe&quot;, \
             &quot;clientReference&quot;: &quot;Test LC&quot;}' \
        -H 'content-type:application/vnd.lc-application.v2+json'</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>whereas with a graphQL implementation, this may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="graphql"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>mutation StartLCApplication {
  startLCApplication(applicantId: &quot;8ed2d2fe&quot;,
                     clientReference: &quot;Test LC&quot;) {
    lcApplicationId
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In our experience, designing APIs using REST does result in some form of dilution when attempting to mirror the language of the domain&#8201;&#8212;&#8201;because the focus is first and foremost on resources. Purists will be quick to point out that the example above is not RESTful because there is no resource named <code>start</code>. Our approach is to place more importance to remaining true to the ubiquitous language as opposed to being dogmatic about adherence to technical purity.</p>
</div>
</div>
<div class="sect4">
<h5 id="transport-format"><a class="anchor" href="#transport-format"></a><a class="link" href="#transport-format">Transport format</a></h5>
<div class="paragraph">
<p>Here we have two broad choices: text-based (for example, JSON or XML) versus binary (for example, <a href="https://developers.google.com/protocol-buffers">protocol buffers</a><sup class="footnote">[<a id="_footnoteref_45" class="footnote" href="#_footnotedef_45" title="View footnote.">45</a>]</sup> or <a href="https://avro.apache.org/">avro</a><sup class="footnote">[<a id="_footnoteref_46" class="footnote" href="#_footnotedef_46" title="View footnote.">46</a>]</sup>). If non-functional requirements (such as performance, scalability, availability, etc.) are met, our preference is to use text-based protocols as a starting point, because it can afford the flexibility of not needing any additional tools to visually interpret the data (when debugging).</p>
</div>
<div class="paragraph">
<p>When designing a remote API, we have the option of choosing a format that enforces a schema (for example, protocol buffers or avro) or something less formal such as plain JSON. In such cases, in order to stay true to the ubiquitous language, the process may have to include additional governance in the form of more formal design and code reviews, documentation, and more.</p>
</div>
</div>
<div class="sect4">
<h5 id="compatibility-and-versioning"><a class="anchor" href="#compatibility-and-versioning"></a><a class="link" href="#compatibility-and-versioning">Compatibility and versioning</a></h5>
<div class="paragraph">
<p>As requirements evolve, there will be a need to enhance the interfaces to reflect these changes. This will mean that our ubiquitous language will also change over time, rendering old concepts to become obsolete. The general principle is to maintain backwards compatibility with consumers for as long as possible. But this does come with a cost of having to maintain old and new concepts together&#8201;&#8212;&#8201;leading to a situation where it can become hard to tell what is relevant versus what is not. Using an explicit versioning strategy can help in managing this complexity to an extent&#8201;&#8212;&#8201;where newer versions may be able to break backwards compatibility with older ones. But it is also not feasible to continue supporting a large number of incompatible versions indefinitely. Hence, it is important to make sure that the versioning strategy makes deprecation and retirement agreements explicit.</p>
</div>
</div>
<div class="sect4">
<h5 id="rest-apis"><a class="anchor" href="#rest-apis"></a><a class="link" href="#rest-apis">REST APIs</a></h5>
<div class="paragraph">
<p>We recognize that there are several options when exposing web-based APIs, claims of using a REST (Representation State Transfer) approach seem quite common these days. REST was coined by Roy Fielding as part of his doctoral dissertation. The idea of what constitutes REST has been a matter of debate and arguably remains ambiguous even today. Leonard Richardson introduced the notion of a maturity model for HTTP-based REST APIs that somewhat helped provide some clarity. The model describes broad conformance to REST in three levels, with each level being more mature than the preceding one:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Adhoc</strong>: Where APIs are designed without the use of any perceptible structure.</p>
</li>
<li>
<p><strong>Resources</strong>: Where APIs are designed around a <strong><em>thing</em></strong> that makes sense on its own (usually a noun). Here, a very small subset of verbs (either a GET or a POST) may be used to model all operations.</p>
</li>
<li>
<p><strong>HTTP Verbs</strong>: Where APIs are designed by making use of a standard set of operations that can be performed on a resource (for example, GET for reads, POST for creates, PUT for updates, DELETE for deletes, etc.)</p>
</li>
<li>
<p><strong>HATEOAS</strong>: Where APIs include hypermedia links to help clients discover our API in a self-service manner.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Most web service based solutions that claim to be RESTful seem to stop at level 2. Roy Fielding, the inventor or REST seems to claim that <a href="https://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven">REST APIs must be hypertext-driven</a><sup class="footnote">[<a id="_footnoteref_47" class="footnote" href="#_footnotedef_47" title="View footnote.">47</a>]</sup>. In our opinion, the use of hypertext controls in APIs allows them to become self-documenting and thereby promotes the use of the ubiquitous language more explicitly. More importantly, it also indicates what operations are applicable for a given resource at that time in its lifecycle. For example, let&#8217;s look at a sample response where all pending LC applications are listed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="http"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
<strong class="highlighted">15</strong>
16
17
18
19
20
21
22
23
24
25
<strong class="highlighted">26</strong>
27
28
<strong class="highlighted">29</strong>
30
31
32
33
34
35
36
</pre></td>
  <td class="code"><pre>GET /lc-applications?status=pending HTTP/1.1
Content-Type: application/json

HTTP/1.1 200 OK
Content-Type: application/prs.hal-forms+json
{
  &quot;_embedded&quot; : {
    &quot;lc-applications&quot; : [
      {
       &quot;clientReference&quot; : &quot;Test LC&quot;,
       &quot;_links&quot; : {
         &quot;self&quot; : {
           &quot;href&quot; : &quot;/lc-applications/582fe5f8&quot;
         },
         &quot;submit&quot; : {
           &quot;href&quot; : &quot;/lc-applications/582fe5f8/submit&quot;
         }
       }
      },
      {
       &quot;clientReference&quot; : &quot;Another LC&quot;,
       &quot;_links&quot; : {
         &quot;self&quot; : {
           &quot;href&quot; : &quot;/lc-applications/7689da3e&quot;
         },
         &quot;approve&quot; : {
           &quot;href&quot; : &quot;/lc-applications/7689da3e/approve&quot;
         },
         &quot;reject&quot; : {
           &quot;href&quot; : &quot;/lc-applications/7689da3e/reject&quot;
         }
       }
      }
    ]
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, there are two <code>lc-applications</code> listed. Based on the current status of the LC, the links provide a means to act on the LC appropriately. In addition to the <em>self</em> link, the first LC application shows a <em>submit</em> link denoting that it can be submitted, whereas the second application shows the <em>approve</em> and <em>reject</em> links, but not a submit link presumably because it has already been submitted. Notice how the response also does not need to include a <code>status</code> attribute so that they can use this to deduce which operations are relevant for LC application at that time (an example of the <a href="https://martinfowler.com/bliki/TellDontAsk.html"><em>tell don&#8217;t ask</em></a><sup class="footnote">[<a id="_footnoteref_48" class="footnote" href="#_footnotedef_48" title="View footnote.">48</a>]</sup> principle). While this may be a subtle nuance, we felt that it is valuable to point out in the context of our DDD journey.</p>
</div>
<div class="paragraph">
<p>We have looked at a few considerations when moving from an in-process to an out-of-process API. There are quite a few other considerations, specifically pertaining to non-functional requirements (such as performance, resilience, error handling, etc.) We will look at these in more detail in Chapter 11.</p>
</div>
<div class="paragraph">
<p>Now that we have a handle on how we can work with APIs that interact with the front-end, let&#8217;s look at how we can handle event publication and consumption <strong>remotely</strong>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="changes-for-event-interactions"><a class="anchor" href="#changes-for-event-interactions"></a><a class="link" href="#changes-for-event-interactions">10.2.2. Changes for event interactions</a></h4>
<div class="paragraph">
<p>Currently, our application publishes and consumes domain events over an in-process bus that the Axon framework makes available.</p>
</div>
<div class="paragraph">
<p>We publish events when processing commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {

    <span style="color:#777">// Boilerplate code omitted for brevity</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> LCApplication(StartNewLCApplicationCommand command) {
        <span style="color:#777">//...</span>
        AggregateLifecycle.apply( <i class="conum" data-value="1"></i><b>(1)</b>
                <span style="color:#080;font-weight:bold">new</span> LCApplicationStartedEvent(command.getId(),
                command.getApplicantId(), command.getClientReference(), LCState.DRAFT));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Publishing an event when processing a command successfully.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>and consume events to expose query APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationSummaryEventHandler</span> {

    <span style="color:#777">// Boilerplate code omitted for brevity</span>

    <span style="color:#007">@EventHandler</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationStartedEvent event) {
        <span style="color:#777">//...</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Subscribing to an event using the Axon provided <code>@EventHandler</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to process events remotely, we need to introduce an explicit infrastructure component in the form of an event bus. Common options include message brokers like ActiveMQ, RabbitMQ or a distributed event streaming platform like Apache Kafka. Application components can continue to publish and consume events as before&#8201;&#8212;&#8201;only now they will happen using an out-of-process invocation style. Logically, this causes our application to now look something like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-2.png" alt="lc application monolith stage 2" width="75%">
</div>
<div class="title">Figure 1- 100. Out of process event bus introduced</div>
</div>
<div class="paragraph">
<p>When working with events within the confines of a single process, assuming synchronous processing (event publishing and consumption on the same thread), we do not encounter a majority of problems that only become apparent when the publisher and the consumer are distributed across multiple processes. Let&#8217;s examine some of these in more detail next.</p>
</div>
<div class="sect4">
<h5 id="atomicity-guarantees"><a class="anchor" href="#atomicity-guarantees"></a><a class="link" href="#atomicity-guarantees">Atomicity guarantees</a></h5>
<div class="paragraph">
<p>Previously, when the publisher processed a command by publishing an event and the consumer(s) handled it, transaction processing occurred as a single atomic unit as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-acid-transaction.png" alt="lc application monolith acid transaction" width="60%">
</div>
<div class="title">Figure 1- 101. ACID transaction processing within the monolith</div>
</div>
<div class="paragraph">
<p>Notice how all the highlighted operations in the preceding diagram happen as part of a single database transaction. This allowed the system to be strongly consistent end-to-end. When the event bus is distributed to work within its own process, atomicity cannot be guaranteed like it was previously. Each of the preceding numbered operations work as independent transactions. This means that they can fail independently, which can lead to data inconsistencies.</p>
</div>
<div class="paragraph">
<p>To solve this problem, let&#8217;s look at each step in the process in more detail, starting with command processing as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-distributed-transaction.png" alt="lc application monolith distributed transaction" width="30%">
</div>
<div class="title">Figure 1- 102. Command processing transaction semantics</div>
</div>
<div class="paragraph">
<p>Consider the situation where we save to the database but fail to publish the event. Consumers will remain oblivious of the event occurring and become inconsistent. On the flip side, if we publish the event but fail to save in the database, the command processing side itself becomes inconsistent. Not to mention that the query side now thinks that a domain event occurred, when in fact it did not. Again, this leads to inconsistency. This <a href="https://developers.redhat.com/articles/2021/07/30/avoiding-dual-writes-event-driven-applications"><strong>dual write</strong></a><sup class="footnote">[<a id="_footnoteref_49" class="footnote" href="#_footnotedef_49" title="View footnote.">49</a>]</sup> problem is fairly common in distributed event-driven applications. If command processing has to work in a foolproof manner, saving to the database and the publishing to the event bus have to happen atomically - both operations should succeed or fail in unison. Here are a few solutions that we have used to solve this issue (in increasing order of complexity):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Do nothing</strong>: It is arguable that this approach is not really a solution, however it may be the only placeholder until a more robust solution is in place. While it may be puzzling to see this being listed as an option, we have seen several occasions where this is indeed how event-driven systems have been implemented. We leave this here as a word of caution so that teams become cognizant of the pitfalls.</p>
</li>
<li>
<p><strong>Transaction synchronization</strong>: In this approach, multiple resource managers are synchronized in a way that failure in any one system, triggers a cleanup in the others where the transaction has already been committed. It is pertinent to note that this may not be foolproof in that it may lead to cascading failures.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The spring framework provides support for this style of behavior through the <code>TransactionSynchronization</code> and the now deprecated <code>ChainedTransactionManager</code> interfaces. Please refer to the framework documentation for more details. Needless to say, this interface should not be used without careful consideration to business requirements.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><strong>Distributed transactions</strong>: Another approach is to make use of distributed transactions and <a href="https://martinfowler.com/articles/patterns-of-distributed-systems/two-phase-commit.html">two-phase commit</a><sup class="footnote">[<a id="_footnoteref_50" class="footnote" href="#_footnotedef_50" title="View footnote.">50</a>]</sup>. Typically, this functionality is implemented using pessimistic locking on the underlying resource managers (databases) and may present scaling challenges in highly concurrent environments.</p>
</li>
<li>
<p><strong>Transactional outbox</strong>: All the preceding methods are not completely foolproof in the sense that there still exists a window of opportunity where the database and the event bus can become inconsistent (this is true even with two-phase commits). One way to circumvent this problem is by completely eliminating the dual write problem. In this solution, the command processor writes to its database and the intended event to an <em>outbox</em> table in a local transaction. A separate poller component polls the outbox table and writes to the event bus. Polling can be computationally intensive and may again lead back to the dual write problem because the poller has to keep track of the last written event. This may be avoided by making event processing idempotent on the consumer so that processing duplicate events do not cause issues, especially in extremely high concurrency and volume scenarios. Another way to mitigate this issue is to use a <a href="https://en.wikipedia.org/wiki/Change_data_capture">change data capture</a><sup class="footnote">[<a id="_footnoteref_51" class="footnote" href="#_footnotedef_51" title="View footnote.">51</a>]</sup> (CDC) tool (such as <a href="https://debezium.io/">Debezium</a><sup class="footnote">[<a id="_footnoteref_52" class="footnote" href="#_footnotedef_52" title="View footnote.">52</a>]</sup>) and <a href="https://en.wikipedia.org/wiki/Oracle_LogMiner">Oracle LogMiner</a><sup class="footnote">[<a id="_footnoteref_53" class="footnote" href="#_footnotedef_53" title="View footnote.">53</a>]</sup>. Most modern databases ship with tools to make this easier and may be worth exploring. Here is one way to implement this using the <em>transactional outbox pattern</em> as shown here:</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-transactional-outbox.png" alt="lc application monolith transactional outbox" width="75%">
</div>
<div class="title">Figure 1- 103. Transactional outbox</div>
</div>
<div class="paragraph">
<p>The transactional outbox is a robust approach to dealing with the dual write problem. But it also introduces a non-trivial amount of operational complexity. In one of our previous implementations, we made use of the transactional synchronization to ensure that we never missed writes to the database. We also ensured that the event bus was highly available through redundancy on both the compute and storage tiers, and most importantly by avoiding <strong>any</strong> business logic on the event bus.</p>
</div>
</div>
<div class="sect4">
<h5 id="delivery-guarantees"><a class="anchor" href="#delivery-guarantees"></a><a class="link" href="#delivery-guarantees">Delivery guarantees</a></h5>
<div class="paragraph">
<p>Previously, because all of our components worked within a single process, delivery of events to the consumers was guaranteed at least as long as the process stayed alive. Even if event processing failed on the consumer side, it was fairly straightforward to detect the failure because exception handling was fairly straightforward. Furthermore, rollbacks were straightforward because the production and consumption of events happened as part of a single database transaction. With the LC processing application now becoming a remote component, event delivery becomes a lot more challenging. When it comes to message delivery semantics, there are three basic categories:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>At-most once delivery</strong>: It means that each message may be delivered once or not at all. This style of delivery is arguably the easiest to implement because the producer creates messages in a fire and forget fashion. This may be okay in environments where loss of some messages may be tolerated. For example, data from click-stream analytics or logging might fall in this category.</p>
</li>
<li>
<p><strong>At-least once delivery</strong>: It means that each message may be delivered more than once with no messages being lost. Undelivered messages are retried to be delivered&#8201;&#8212;&#8201;potentially infinitely. This style of delivery may be required when it is not feasible to lose messages, but where it may be tolerable to process the same message more than once. For example, analytical environments may tolerate duplicate message delivery or have duplicate detection logic to discard already processed messages.</p>
</li>
<li>
<p><strong>Exactly once delivery</strong>: It means that each message is delivered exactly once without either being lost or duplicated. This style of message delivery is extremely hard to implement and a lot of solutions may approach exactly once semantics with some implementation help from the consumers where duplicate messages are detected and discarded with the producer sticking to at least once delivery semantics.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For the purposes of domain event processing, most teams will obviously prefer to have exactly once processing semantics, given that they would not want to lose any of these events. However, given the practical difficulties guaranteeing <em>exactly once</em> semantics, it is not unusual to approach exactly once processing by having the consumers process events in an idempotent manner or designing events to make it easier to detect errors. For example, consider a <code>MonetaryAmountWithdrawn</code> event, which includes the <code>accountId</code> and the <code>withdrawalAmount</code>. This event may carry an additional <code>currentBalance</code> attribute so that the consumer may know if they are out of sync with the producer when processing the withdrawal. Another way to do this might be for the consumer to keep track of the last "n" events processed. When processing an event, the consumer can check if this event has already been processed. If so, they can detect it as a duplicate and simply discard it. All the preceding methods again add a level of complexity to the overall system. Despite all these safeguards, consumers may still find themselves out of sync with the system of record (the command side that produces the event). If so, as a last resort, it may be required to use a partial or full <a href="#_historic_event_replays">event replays</a> which was discussed in Chapter 7.</p>
</div>
</div>
<div class="sect4">
<h5 id="ordering-guarantees"><a class="anchor" href="#ordering-guarantees"></a><a class="link" href="#ordering-guarantees">Ordering guarantees</a></h5>
<div class="paragraph">
<p>In an event-driven system like the one we are building, it is desirable for consumers to receive events in a deterministic order. Not knowing the order or receiving it in the wrong order may result in inaccurate outcomes. Consider the example of an <code>LCApplicationAddressChangedEvent</code> occurring twice in <em>quick succession</em>. If these changes are processed in the wrong order, we may end up displaying the wrong address as their current one. This does not necessarily mean that events need to be ordered for all use cases. Consider another example where we receive an <code>LCApplicationSubmittedEvent</code> more than once erroneously when it is not possible to submit a given LC application more than once. All such notifications after the first may be ignored.</p>
</div>
<div class="paragraph">
<p>As a consumer it is important to know if events will be ordered or not, so that we can make design considerations for out-of-order events. A reasonable approach might be to accommodate for out-of-order events as a default. In our experience, this does tend to make the resulting design more complicated, especially in cases where the order does matter. We discuss three event ordering strategies and their implications for both the producer and the consumer here:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 26.6666%;">
<col style="width: 26.6666%;">
<col style="width: 26.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strategy</th>
<th class="tableblock halign-left valign-top">Producer</th>
<th class="tableblock halign-left valign-top">Event Bus</th>
<th class="tableblock halign-left valign-top">Consumer</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>No ordering</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arguably the easiest to implement because there is no expectation from the producer to support ordering.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Without additional metadata, the event bus may only be able to guarantee ordering in the sequence of receipt (FIFO order).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the consumer depends on ordering, it may have to implement ordering through some form of special processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Per aggregate ordering</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The producer needs to make sure that each event includes an identifier to enable grouping by aggregate.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The event bus needs to support the notion of grouping (in this case by the aggregate identifier). For events belonging to the same aggregate instance, messages are emitted in FIFO order.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">To guarantee ordering, events originating from the same aggregate instance need to be processed by the same consumer instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Global ordering</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The producer needs to make sure that each event includes the notion of a sequence.</p></td>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">Either the event bus or the consumer need to implement ordering logic.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In most applications, per aggregate ordering might be a good place to start and cater to most business scenarios.</p>
</div>
</div>
<div class="sect4">
<h5 id="durability-and-persistence-guarantees"><a class="anchor" href="#durability-and-persistence-guarantees"></a><a class="link" href="#durability-and-persistence-guarantees">Durability and persistence guarantees</a></h5>
<div class="paragraph">
<p>When an event is published to the event bus, the happy path scenario is that the intended consumer(s) are able to process it successfully. However, there are scenarios that may cause message processing to be impacted adversely. Let&#8217;s examine each of these scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Slow consumer</strong>: The consumer is unable to process events as fast as the producers are publishing them.</p>
</li>
<li>
<p><strong>Offline consumer</strong>: The consumer is unavailable (down) at the time of the events being published.</p>
</li>
<li>
<p><strong>Failing consumer</strong>: The consumer is experiencing errors when trying to process events.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In each of these cases, there can develop a backlog of unprocessed events. Because these are domain events, we need to prevent the loss of these events until the consumer has been able to process them successfully. There are two communication characteristics that need to be true for this to work successfully:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/event-persistence-durability.png" alt="event persistence durability" width="50%">
</div>
<div class="title">Figure 1- 104. Persistence versus durability</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Persistence</strong>: This is the communication style between the producer and the event bus.</p>
</li>
<li>
<p><strong>Durability</strong>: This is the communication style between the event bus and the consumer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Firstly, messages need to be persistent (stored on disk) and secondly the message subscription (relationship between the consumer and the event bus) needs to be durable (persist across event bus restarts). It is important to note that events have to be made persistent by the producer for them to be consumed durably by the consumer.</p>
</div>
</div>
<div class="sect4">
<h5 id="processing-guarantees"><a class="anchor" href="#processing-guarantees"></a><a class="link" href="#processing-guarantees">Processing guarantees</a></h5>
<div class="paragraph">
<p>When an event is processed by the query side component as shown here, the following steps occur:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/event-processing-failure-points.png" alt="event processing failure points" width="30%">
</div>
<div class="title">Figure 1- 105. Event processing failure scenarios</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The event is consumed (either through a push or a pull) from the event bus</p>
</li>
<li>
<p>Transformation logic is applied on the payload o the event</p>
</li>
<li>
<p>The transformed payload is saved in the query side store.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each of these steps can encounter failures. Irrespective of the cause of failure, the event should be durable (as discussed earlier) so that it can be processed later when the issue is fixed. These errors can be broadly segregated into four categories:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 37.5%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Error Cause</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Remediation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Transient</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network blip resulting in temporary connectivity issues to either the event bus or the query store.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A finite number of retries potentially with a backoff strategy before giving up with either a fatal error.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Configuration</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event bus or database URL misconfiguration.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manual intervention with updated configuration and/or restart.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Code Logic</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implementation bugs either in the transformation logic.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manual intervention with updated logic and redeployment</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Data</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unexpected or erroneous data in the event payload.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Manual intervention that requires segregating spurious data (for example, by automatically moving problematic events to a <em>dead letter queue</em>) and/or fixing code logic.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We have now looked at the changes that we need to make because of the introduction of an out-of-process event bus.Having done this allows us to actually extract the <em>LC Application Processing</em> component into its own independently deployable unit, which will look something like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-3.png" alt="lc application monolith stage 3" width="75%">
</div>
<div class="title">Figure 1- 106. LC Application processing deployed independently</div>
</div>
<div class="paragraph">
<p>However, we are continuing to use a common datastore for the <em>LC Application Processing</em> component.Let&#8217;s look at what is involved in segregating this into its own store.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_changes_for_database_interactions"><a class="anchor" href="#_changes_for_database_interactions"></a><a class="link" href="#_changes_for_database_interactions">10.2.3. Changes for database interactions</a></h4>
<div class="paragraph">
<p>While we have extracted our application component into its own unit, we continue to be coupled at the database tier.If we are to achieve true independence from the monolith, we need to break this database dependency.Let&#8217;s look at the changes involved in making this happen.</p>
</div>
<div class="sect4">
<h5 id="data-migration"><a class="anchor" href="#data-migration"></a><a class="link" href="#data-migration">Data migration</a></h5>
<div class="paragraph">
<p>As a first step to start using a database of our own, we will need to start migrating data from the command side event store and the query store(s) as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-3.1.png" alt="lc application monolith stage 3.1" width="75%">
</div>
<div class="title">Figure 1- 107. Data migration</div>
</div>
<div class="paragraph">
<p>In our case, we have the command side event store and the query store(s) that will need to be migrated out. To minimize effort at the outset, it might be prudent to do a simple homogenous migration by keeping the source and target database technologies identical. In advance of the cut-over, among other things, it will be essential to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Profile</strong> to make sure that latency numbers are within tolerable limits.</p>
</li>
<li>
<p><strong>Test</strong> to make sure that the data has migrated correctly.</p>
</li>
<li>
<p><strong>Minimize downtime</strong> by understanding and agreeing on <strong>SLAs</strong> such as RTO (Recovery Time Objective) and RPO (Recovery Point Objective).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cut-over"><a class="anchor" href="#cut-over"></a><a class="link" href="#cut-over">Cut-over</a></h5>
<div class="paragraph">
<p>If we have made it thus far, we are now ready to complete the migration of the <em>LC Application Processing</em> from the rest of the monolith. The logical architecture of our solution now looks like the diagram shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-4.png" alt="lc application monolith stage 4" width="75%">
</div>
<div class="title">Figure 1- 108. Independent data persistence</div>
</div>
<div class="paragraph">
<p>With this step, we have successfully completed the migration of our first component. There is still quite a lot of work to do. Arguably, our component was already well-structured and loosely coupled from the rest of the application. Despite that, moving from an in-process to an out-of-process model between bounded contexts is quite an involved process&#8201;&#8212;&#8201;as should be evident from the work we have done in this chapter.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary-10"><a class="anchor" href="#summary-10"></a><a class="link" href="#summary-10">10.3. Summary</a></h3>
<div class="paragraph">
<p>In this chapter, we learnt how we can extract a bounded context from an existing monolith, although one could argue that this was from a reasonably well-structured one. We looked at the challenges involved in decomposing the monolith from various interaction points such as the frontend, event exchanges and the database. You should have an understanding of what it takes to go from in-process event-driven application to a distributed one.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will look at how to extract pieces out of a monolith that may not be as well-structured, possibly very close to the dreaded big ball of mud.</p>
</div>
</div>
</div>
</div>
<div class="sect1 text-justify">
<h2 id="decomposing-into-finer-grained-components"><a class="anchor" href="#decomposing-into-finer-grained-components"></a><a class="link" href="#decomposing-into-finer-grained-components">11. Decomposing into finer grained components</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous chapter, we decomposed the <em>LC Application Processing</em> functionality out of the monolith. In this chapter, we will further decompose these components into even more fine-grained components. In addition, we will examine if and when such a decomposition is justified.</p>
</div>
<div class="paragraph">
<p>At the end of this chapter, you will be able to appreciate both technical and non-technical factors that play towards where we should draw the line on decomposing these components.</p>
</div>
<div class="sect2">
<h3 id="continuing-our-design-journey-6"><a class="anchor" href="#continuing-our-design-journey-6"></a><a class="link" href="#continuing-our-design-journey-6">11.1. Continuing our design journey</a></h3>
<div class="paragraph">
<p>Currently, our application looks close to the visual depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-4.png" alt="lc application monolith stage 4" width="75%">
</div>
</div>
<div class="paragraph">
<p>The <em>LC Application Processing</em> functionality lives as its own independent component from the rest of the application. It communicates with the monolith through the exchange of domain events using the event bus. It makes use of its own persistence store and exposes HTTP-based APIs that the frontend consumes. Let&#8217;s examine if it is possible to further decompose the application into finer grained components. The <code>AutoApprovalSaga</code> component currently lives within the confines of the monolith. But this is mostly an artifact of our previous design as opposed to an intentional design choice. Let&#8217;s look at how we can extract this out into its own component next.</p>
</div>
<div class="sect3">
<h4 id="saga-as-standalone-component"><a class="anchor" href="#saga-as-standalone-component"></a><a class="link" href="#saga-as-standalone-component">11.1.1. Saga as standalone component</a></h4>
<div class="paragraph">
<p>Currently, the <code>AutoApprovalSaga</code> component (discussed in detail in Chapter 8) works by listening to domain events as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/auto-approval-saga-dependencies.png" alt="auto approval saga dependencies" width="75%">
</div>
<div class="title">Figure 1- 109. <code>AutoApprovalSaga</code> functionality dissected.</div>
</div>
<div class="paragraph">
<p>Given that these events are published by different bounded contexts onto the event bus, there is no need for <code>AutoApprovalSaga</code> to be embedded within the monolith. This means that it can be safely pulled out into its own deployable unit along with its private datastore. This means that our system now looks like the visual depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-5.png" alt="lc application monolith stage 5" width="75%">
</div>
<div class="title">Figure 1- 110. <code>AutoApprovalSaga</code> extracted into an independent component.</div>
</div>
</div>
<div class="sect3">
<h4 id="commands-and-queries-as-standalone-components"><a class="anchor" href="#commands-and-queries-as-standalone-components"></a><a class="link" href="#commands-and-queries-as-standalone-components">11.1.2. Commands and queries as standalone components</a></h4>
<div class="paragraph">
<p>As we have seen in the section on the <a href="#_cqrs_pattern">CQRS pattern</a> in earlier chapters, the primary benefit that we derive is gaining the ability to evolve and scale these components independently of each other. This is important because commands and queries have completely different usage patterns and thus require the use of distinct domain models. This makes it fairly natural to further split our bounded contexts along these boundaries. Thus far, the segregation is logical. A physical separation will enable us to truly scale these components independently as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-6.png" alt="lc application monolith stage 6" width="75%">
</div>
<div class="title">Figure 1- 111. Commands and queries as independent components.</div>
</div>
<div class="paragraph">
<p>It is pertinent to note that the command processing component is now shown to have access to two distinct datastores:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>aggregate store</strong>: which stores either an event-sourced or state-stored representation of aggregate state</p>
</li>
<li>
<p>The <strong>lookup store</strong>: which can be used to store lookup data when performing business validations when processing commands. This is applicable when requiring to access data that is/cannot be stored as part of aggregate state.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The reason we bring this up is that we may have to continue making lookups for data that still remain in the monolith. To achieve full independence, this lookup data must also be migrated using techniques like a <a href="#_historic_event_replays">historic event replay</a> (discussed in Chapter 7) or other conventional <a href="#_changes_for_database_interactions">data migration</a> techniques (discussed in Chapter 10).</p>
</div>
</div>
<div class="sect3">
<h4 id="distributing-individual-query-components"><a class="anchor" href="#distributing-individual-query-components"></a><a class="link" href="#distributing-individual-query-components">11.1.3. Distributing individual query components</a></h4>
<div class="paragraph">
<p>At this point, we have achieved segregation along command and query boundaries. But we do not need to stop here. Each of the queries we service need not necessarily remain a single component. Let&#8217;s consider an example where we need to implement a fuzzy LC search feature for the UI and a view of LC facts for analytical use cases. It is conceivable that these requirements may be implemented by a different set of teams, thereby necessitating the need for distinct components. Even if these are not distinct teams, the disparity in usage patterns may warrant the use of different persistence stores and APIs, again requiring us to look at implementing at least a subset of these as distinct components as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-7.png" alt="lc application monolith stage 7" width="75%">
</div>
<div class="title">Figure 1- 112. Queries split into individual components.</div>
</div>
<div class="paragraph">
<p>Owning domains should strive to create query APIs that exhibit the characteristics of a good <a href="https://martinfowler.com/articles/data-monolith-to-mesh.html#DomainDataAsAProduct">domain data product</a><sup class="footnote">[<a id="_footnoteref_54" class="footnote" href="#_footnotedef_54" title="View footnote.">54</a>]</sup>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="even-more-fine-grained-distribution"><a class="anchor" href="#even-more-fine-grained-distribution"></a><a class="link" href="#even-more-fine-grained-distribution">11.2. Even more fine-grained distribution</a></h3>
<div class="paragraph">
<p>At this stage, is there any further decomposition that is required  and feasible? These days, whether rightfully or otherwise, the serverless architecture (specifically, <em>Functions-As-A-Service</em>) is arguably becoming quite the rage. As we pointed in Chapter 2, this means that we may be able to decompose our command side in a manner that each command becomes its own independently deployable unit (hence a bounded context). In other words, the <code>LCApplicationSubmitCommand</code> and the <code>LCApplicationCancelCommand</code> can be deployed independently.</p>
</div>
<div class="paragraph">
<p>But just because this is technically possible, should we do it? While it is easy to dismiss this as a passing fad, there may be good reasons to split applications along command boundaries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Risk profile</strong>: Certain pieces of functionality present a higher risk when changes are made. For example, submit an LC application may be deemed a lot more critical than the ability to cancel it. But that is not to say that <em>cancel</em> is unimportant. Being decoupled from <em>submit</em> allows <em>cancel</em> changes to be made with a lot less scrutiny. This may make it easier to innovate at pace for more experimental features with minimal fear of causing large disruptions.</p>
</li>
<li>
<p><strong>Scalability needs</strong>: Scaling needs can differ wildly for various commands in the system. For example, <em>submit</em> may need to scale a lot more than <em>cancel</em>. But being coupled will force us to treat them as equals, which can be inefficient.</p>
</li>
<li>
<p><strong>Cost attribution</strong>: Having fine-grained components allows us to more accurately measure the amount of effort and the resulting ROI dedicated to each individual command. This can make it easier to focus our efforts on the most critical functionality (the "core" of the core) and minimize waste.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="effects-on-the-domain-model"><a class="anchor" href="#effects-on-the-domain-model"></a><a class="link" href="#effects-on-the-domain-model">11.2.1. Effects on the domain model</a></h4>
<div class="paragraph">
<p>These finer grainer components are leading us to a point where it may appear that the deployment model is starting to have a big influence on the design. The fact that it is now feasible to deploy individual "tasks" independently, requires us to re-examine how we arrive at bounded contexts. For example, we started by working on the <em>LC Application Processing</em> bounded context. And our aggregate design was based on all functionality included in the scope of application processing. Now, our aggregate design can be a lot more fine-grained. This means that we can have an aggregate specifically for <em>start</em> functionality and another for <em>cancel</em> as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/fine-grained-aggregate.png" alt="fine grained aggregate" width="75%">
</div>
<div class="title">Figure 1- 113. Fine-grained bounded contexts example.</div>
</div>
<div class="paragraph">
<p>The most fine-grained decomposition may lead us to a bounded context per command. But that does not necessarily mean that we have to decompose the system this way. In the above example, we have chosen to create a single bounded context for the <em>submit</em> and <em>approve</em> commands. However, <em>start</em> and <em>cancel</em> have their own bounded contexts. The actual decision that you make in your own ecosystems will depend on maintaining a balance among reuse, coupling, transactional consistency and other considerations that we discussed earlier. It is important to note that the aggregate labeled as <code>LCApplication</code>, although named identically, is distinct from a domain model perspective in its respective bounded context. The only attribute they will need to share is a <strong>common identifier</strong>. If we choose to decompose the system into a bounded context per command, our overall solution will look like the visual shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-8.png" alt="lc application monolith stage 8" width="75%">
</div>
<div class="title">Figure 1- 114. Decomposition per command.</div>
</div>
<div class="paragraph">
<p>It is pertinent to note that the <em>command</em> functions continue to share a single event store, although they may make use of their own individual lookup stores. We understand that this decomposition likely feels unnecessary and forced. However, this does allow us to focus our energies on the <em><strong>core</strong> of the core</em>. For example, LC application processing may be our business differentiator. But an even more careful examination may reveal that it is our ability to <em>decision</em> LCs near real-time that is our real business differentiator. This means that it may be prudent to isolate that functionality from the rest of the system. In fact, doing so may enable us to optimize our business process without adding additional risk to the overall solution. While it is not strictly necessary to decompose the system in this way to arrive at such insights, the fine-grained decomposition may enable us to refine the idea of what is most important to our business. Having to share a persistent store can be a wrinkle to achieve complete independence. So a final decomposition may look something like what we show here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-8.1.png" alt="lc application monolith stage 8.1" width="75%">
</div>
<div class="title">Figure 1- 115. Command components with individual event stores.</div>
</div>
<div class="paragraph">
<p>Obviously, there is no free lunch! This fine-grained decomposition may require additional coordination and duplication of data among these components&#8201;&#8212;&#8201;to a point where it may not be attractive anymore. But we felt that it is important to illustrate the art of the possible.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="decomposing-the-frontend"><a class="anchor" href="#decomposing-the-frontend"></a><a class="link" href="#decomposing-the-frontend">11.3. Decomposing the frontend</a></h3>
<div class="paragraph">
<p>Thus far, we have focussed on decomposing and distributing the backend components while keeping the frontend untouched as part of the existing monolithic system. It is worth considering breaking down the frontend to align more closely along functional boundaries. Patterns like <a href="https://micro-frontends.org/">micro-frontends</a><sup class="footnote">[<a id="_footnoteref_55" class="footnote" href="#_footnotedef_55" title="View footnote.">55</a>]</sup><sup class="footnote">[<a id="_footnoteref_56" class="footnote" href="#_footnotedef_56" title="View footnote.">56</a>]</sup> extend the concepts of microservices to the frontend. Micro-frontends promote team structures to support end-to-end ownership of a set of features.  It is conceivable that a cross-functional, polyglot team owns both the experience (frontend) and the business logic (backend) functions eliminating communication overheads drastically (along the lines of the <a href="#_vertical_slice_architecture">vertical slice architecture</a> conversation in Chapter 2). Even if such a team organization where the frontend and backend being one team is not feasible in your current ecosystem, this approach still has many merits such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Increased end-to-end collaboration</strong>: Creating solutions that work end-to-end is what ultimately provides value. Having a set of backend services isolated from their respective customer experiences will only cause us to accumulate unused inventory. To reduce the possibility of failure, the closer the collaboration between the backend capability and frontend experience teams, the higher our chances of reducing waste due to misaligned requirements. Including the customer experiences to become part of the vertical slice allows us to apply the ubiquitous language through the entire stack.</p>
</li>
<li>
<p><strong>Uniform omnichannel experiences</strong>: These days it is very common to surface the same functionality across more than one experience channel. Having an inconsistent experience across channels can lead to customer dissatisfaction and/or adverse business consequences. Aligning teams closely along functional boundaries (within the same <em>swim lane</em>) can promote high levels of collaboration and consistency when exposing business functionality. Consider the example shown here. Within a vertical slice, the allegiance is to the functionality being developed, although there may be a need to use disparate technologies to build each channel (iOS, Android, web, etc.). Within a vertical slice, each box depicted in the diagram may operate as a team of its own, while maintaining strong cohesion with the functional team within the same swim lane as shown here:</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-8.2.png" alt="lc application monolith stage 8.2" width="50%">
</div>
<div class="title">Figure 1- 116. Teams aligned along functional boundaries.</div>
</div>
<div class="paragraph">
<p>While there are many advantages in employing this approach, like everything else, it does come with a few gotchas that you may need to be mindful of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>End-to-end testing complexity</strong>: While this is true for a lot of distributed architectures, this problem is exacerbated in the case of user experiences because of it being a visual medium. Especially if real components come together close to the end of the cycle, it may become harder to visualize the end-to-end flow until almost all the visual elements are in place.</p>
</li>
<li>
<p><strong>Deployment complexity</strong>: In the example above, we have split the application along functional boundaries. However, they have to come together as a single artifact at the time of deployment (this is especially true in the case of mobile applications). This can add quite a bit of deployment complexity when the complete application is assembled. It is important to be cognizant of the relationship patterns between teams (covered in chapter 9) to work through kinks.</p>
</li>
<li>
<p><strong>Dependency management</strong>: Given that teams may need to ultimately deploy the application as a unit, managing dependencies between individual modules may become cumbersome. This may manifest itself in the form of conflicting dependency versions, leading to unpredictable and inefficient runtime behaviour and performance. For example, two teams may use the different versions of the same frontend library and that may add to the overall payload that gets downloaded to the browser. In addition to being wasteful, this may also result in unpredictable, hard  to diagnose errors and eventually, poor customer experience.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we proceed to continue decomposing our application as suggested above, our application will end up looking like the visual shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application-monolith-stage-9.png" alt="lc application monolith stage 9" width="75%">
</div>
<div class="title">Figure 1- 117. Commands and query frontends decomposed into individual functions.</div>
</div>
<div class="paragraph">
<p>As we have seen, there are multiple ways to approach decomposing an application into finer-grained components. Just because it is possible to do it, doesn&#8217;t mean that we should. Let&#8217;s look at when decomposition starts to become too expensive to sustain productivity.</p>
</div>
</div>
<div class="sect2">
<h3 id="where-to-draw-the-line"><a class="anchor" href="#where-to-draw-the-line"></a><a class="link" href="#where-to-draw-the-line">11.4. Where to draw the line?</a></h3>
<div class="paragraph">
<p>In general, the smaller the size of our bounded contexts, the easier it becomes to manage complexity. Does that mean we should decompose our systems into as fine-grained a granularity as possible? On the other hand, having extremely fine-grained components can increase coupling among them to an extent where it becomes very hard to manage operational complexity. Hence, decomposing a system into well-factored, collaborating components can be a bit tricky, seeming to work more like an art, rather than an exact science. There is no right or wrong answer here. In general, if things feel and become painful, you most likely got it more wrong than right. Here are some non-technical heuristics that might help guide this process:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Existing organization boundaries</strong>: Look to align along current organization structures. Identify which applications your business unit/department/team already owns and assign responsibilities in a manner that causes minimal disruption.</p>
</li>
<li>
<p><strong>End-user roles and responsibilities</strong>: What work do your end users carry out? What enables them to do their work with the least friction possible? If too many people need to get involved to get a piece of work done, that may be a sign that the current decomposition may be suboptimal. On the other hand, if it is hard to assign a said task to a specific user, it may again be a sign of incorrect decomposition.</p>
</li>
<li>
<p><strong>Change in vernacular</strong>: Look for subtle changes in the usage of common terms (the <em>ubiquitous language</em>). Does someone call something that is/feels the same in the physical world by different names? For example, a credit card may be called "plastic", "payment instrument", "account" by different people or the same people in a different context. The point at which the vernacular changes may be a potential candidate to split functionality.</p>
</li>
<li>
<p><strong>Existing (modular/monolithic/distributed) applications</strong>: How are your current applications segregated logically? How are they segregated physically? This might provide some inspiration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of the above techniques draw inspiration from existing constructs. But what if one or more of the above are wrong/cumbersome/suboptimal? In such a case, our work as developers/architects is a bit more involved.</p>
</div>
<div class="paragraph">
<p>It is also pertinent to note that it is not uncommon to get domain boundaries wrong. Coming up with an initial breakdown that seems to make more sense and applying a series of <em>what if</em> questions to assess suitability can help. If the reasoning is able to stand up to scrutiny by domain experts, architects and other stakeholders, you might be in a good place. If you do choose to go this route, it may be prudent to adjust existing organization structures to match your proposed architecture. This will help reduce friction (in other words, apply what is called the <a href="https://www.thoughtworks.com/en-us/radar/techniques/inverse-conway-maneuver"><strong><em>inverse Conway maneuver</em></strong></a><sup class="footnote">[<a id="_footnoteref_57" class="footnote" href="#_footnotedef_57" title="View footnote.">57</a>]</sup>).</p>
</div>
<div class="paragraph">
<p>This style of team organization can be quite complex. The people at Spotify popularized the idea of a multidisciplinary, mostly autonomous team structure aligning closely along functional boundaries (called <em>squads</em>) as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/spotify-model.png" alt="spotify model" width="50%">
</div>
<div class="title">Figure 1- 118. The "Spotify" model of team organization.</div>
</div>
<div class="paragraph">
<p>The team structure has other components like chapters, tribes, guilds, etc. which enables better flow of change, clarifying team responsibilities, promoting better intra and inter-team collaboration, among others. You can find out more details about it in this <a href="https://blog.crisp.se/wp-content/uploads/2012/11/SpotifyScaling.pdf">blog post</a><sup class="footnote">[<a id="_footnoteref_58" class="footnote" href="#_footnotedef_58" title="View footnote.">58</a>]</sup>  However, there is no one-size-fits-all, and you will need to account for your own organizational structures and realities before looking to adopt this style. To find out more about the <a href="https://www.youtube.com/watch?v=4GK1NDTWbkY">limitations of the <em>Spotify model</em></a><sup class="footnote">[<a id="_footnoteref_59" class="footnote" href="#_footnotedef_59" title="View footnote.">59</a>]</sup> and how you can arrive at a team organization that better suits your own requirements, you may want to take a look at the work done by Matthew Skelton and Manuel Pais in their popular book <a href="https://teamtopologies.com/book"><em>Team Topologies</em></a><sup class="footnote">[<a id="_footnoteref_60" class="footnote" href="#_footnotedef_60" title="View footnote.">60</a>]</sup>. On a related note, it may also be helpful to look at the chapter on Team Design from the book <a href="https://www.amazon.com/Agile-Organization-Design-Transformation-Continuous/dp/0133903354">Agile IT Organization Design</a><sup class="footnote">[<a id="_footnoteref_61" class="footnote" href="#_footnotedef_61" title="View footnote.">61</a>]</sup> by Sriram Narayan where he talks about outcome-oriented versus activity-oriented teams.</p>
</div>
<div class="paragraph">
<p>Despite all our due diligence and noble intentions, it is still possible to get these boundaries wrong. Or a change in business priorities or competitor offerings may render decisions that appeared perfectly valid at the time to become incorrect. Instead of looking to arrive at the perfect decomposition, it might be prudent to embrace change and invest in building designs that are flexible while being prepared to evolve and refactor the architecture iteratively. The book on <a href="https://evolutionaryarchitecture.com/">building evolutionary architectures</a><sup class="footnote">[<a id="_footnoteref_62" class="footnote" href="#_footnotedef_62" title="View footnote.">62</a>]</sup> has some great advice on how to do precisely that.</p>
</div>
<div class="paragraph">
<p>In order to attain a reasonable level of success, there will be a need to maintain a fine balance between how domains are modeled, what the team organizations are and how applications are architected. When all of these are in agreement, it is likely that you get pretty close to achieving high levels of success.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/maintaining-balance.png" alt="maintaining balance" width="40%">
</div>
<div class="title">Figure 1- 119. Forces influencing component decomposition.</div>
</div>
<div class="paragraph">
<p>As a general guideline, it helps to start with a coarse-grained decomposition at the outset when requirements and/or our understanding are likely still unclear, leaving finer-grained decomposition to a time when our understanding improves.</p>
</div>
</div>
<div class="sect2">
<h3 id="summary-11"><a class="anchor" href="#summary-11"></a><a class="link" href="#summary-11">11.5. Summary</a></h3>
<div class="paragraph">
<p>In this chapter, we learnt how an already fine-grained application can be further decomposed to the level of individual functions, each of which may be deployed as its own independent unit. We looked at how we stand to benefit from keeping end-to-end functionality (thin vertical slice) as a cohesive unit which includes components from the frontend experience, all the way to the backend.</p>
</div>
<div class="paragraph">
<p>Further, we looked at how Conway&#8217;s law can play an important role in the evolution of our architecture. We also looked at how we may be able to course correct cumbersome organizational structures by applying the inverse Conway maneuver. Finally, we briefly touched on popular methods of team organization that you can take inspiration from when designing your own organization structures.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will look at a variety of non-functional characteristics that play a significant role in how we decompose and distribute applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="further-reading-8"><a class="anchor" href="#further-reading-8"></a><a class="link" href="#further-reading-8">11.6. Further reading</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 36.3636%;">
<col style="width: 9.0909%;">
<col style="width: 54.5455%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">How to Move Beyond a Monolithic Data Lake to a Distributed Data Mesh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zhamak Dehghani</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/articles/data-monolith-to-mesh.html#DomainDataAsAProduct" class="bare">https://martinfowler.com/articles/data-monolith-to-mesh.html#DomainDataAsAProduct</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Micro Frontends</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Michael Geers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://micro-frontends.org/" class="bare">https://micro-frontends.org/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Micro Frontends</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cam Jackson</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/articles/micro-frontends.html" class="bare">https://martinfowler.com/articles/micro-frontends.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inverse Conway Maneuver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Thoughtworks Tech Radar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.thoughtworks.com/en-us/radar/techniques/inverse-conway-maneuver" class="bare">https://www.thoughtworks.com/en-us/radar/techniques/inverse-conway-maneuver</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scaling Agile @ Spotify with Tribes, Squads, Chapters &amp; Guilds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Henrik Kniberg &amp; Anders Ivarsson</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://blog.crisp.se/wp-content/uploads/2012/11/SpotifyScaling.pdf" class="bare">https://blog.crisp.se/wp-content/uploads/2012/11/SpotifyScaling.pdf</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spotify Engineering Culture - Part 1 of 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Henrik Kniberg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.youtube.com/watch?v=4GK1NDTWbkY" class="bare">https://www.youtube.com/watch?v=4GK1NDTWbkY</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spotify Engineering Culture - Part 2 of 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Henrik Kniberg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.youtube.com/watch?v=vOt4BbWLWQw" class="bare">https://www.youtube.com/watch?v=vOt4BbWLWQw</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Team Topologies</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Matthew Skelton and Manuel Pais</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://teamtopologies.com/book" class="bare">https://teamtopologies.com/book</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Agile IT Organization Design</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sriram Narayan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.amazon.com/Agile-Organization-Design-Transformation-Continuous/dp/0133903354" class="bare">https://www.amazon.com/Agile-Organization-Design-Transformation-Continuous/dp/0133903354</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Building Evolutionary Architectures</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rebecca Parsons, Neal Ford and Pat Kua</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://evolutionaryarchitecture.com/" class="bare">https://evolutionaryarchitecture.com/</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="non-functional-requirements-25-pages"><a class="anchor" href="#non-functional-requirements-25-pages"></a><a class="link" href="#non-functional-requirements-25-pages">12. Non-Functional Requirements (25 pages)</a></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Sometimes I feel like I am being forgotten.
</blockquote>
<div class="attribution">
&#8212; Anonymous
</div>
</div>
<div class="paragraph">
<p>While the functional requirements of the core of the system may be met adequately, it is just as important to place focus on the operational characteristics of the system. In this chapter, we will look at common pitfalls and how to get past them.</p>
</div>
<div class="sect2">
<h3 id="dealing-with-eventual-consistency"><a class="anchor" href="#dealing-with-eventual-consistency"></a><a class="link" href="#dealing-with-eventual-consistency">12.1. Dealing With Eventual Consistency</a></h3>

</div>
<div class="sect2">
<h3 id="scaling-the-event-store-with-snapshots"><a class="anchor" href="#scaling-the-event-store-with-snapshots"></a><a class="link" href="#scaling-the-event-store-with-snapshots">12.2. Scaling the Event Store with Snapshots</a></h3>

</div>
<div class="sect2">
<h3 id="event-versioning-and-upcasting"><a class="anchor" href="#event-versioning-and-upcasting"></a><a class="link" href="#event-versioning-and-upcasting">12.3. Event Versioning and Upcasting</a></h3>

</div>
<div class="sect2">
<h3 id="monitoring-metrics-and-tracing"><a class="anchor" href="#monitoring-metrics-and-tracing"></a><a class="link" href="#monitoring-metrics-and-tracing">12.4. Monitoring, Metrics and Tracing</a></h3>

</div>
<div class="sect2">
<h3 id="enhancing-performance"><a class="anchor" href="#enhancing-performance"></a><a class="link" href="#enhancing-performance">12.5. Enhancing Performance</a></h3>
<div class="sect3">
<h4 id="scaling-the-event-bus"><a class="anchor" href="#scaling-the-event-bus"></a><a class="link" href="#scaling-the-event-bus">12.5.1. Scaling the event bus</a></h4>

</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://www.thoughtworks.com/en-us/radar/techniques/inverse-conway-maneuver" class="bare">https://www.thoughtworks.com/en-us/radar/techniques/inverse-conway-maneuver</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://wiki.c2.com/?PrimitiveObsession" class="bare">https://wiki.c2.com/?PrimitiveObsession</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://martinfowler.com/eaaCatalog/repository.html" class="bare">https://martinfowler.com/eaaCatalog/repository.html</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. <a href="https://martinfowler.com/bliki/AnemicDomainModel.html" class="bare">https://martinfowler.com/bliki/AnemicDomainModel.html</a>
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. <a href="https://alistair.cockburn.us/hexagonal-architecture/" class="bare">https://alistair.cockburn.us/hexagonal-architecture/</a>
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. <a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/" class="bare">https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/</a>
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. <a href="https://blog.cleancoder.com/uncle-bob/2020/10/18/Solid-Relevance.html" class="bare">https://blog.cleancoder.com/uncle-bob/2020/10/18/Solid-Relevance.html</a>
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. <a href="https://www.archunit.org/" class="bare">https://www.archunit.org/</a>
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. <a href="https://jimmybogard.com/vertical-slice-architecture/" class="bare">https://jimmybogard.com/vertical-slice-architecture/</a>
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. <a href="https://martinfowler.com/bliki/ServiceOrientedAmbiguity.html" class="bare">https://martinfowler.com/bliki/ServiceOrientedAmbiguity.html</a>
</div>
<div class="footnote" id="_footnotedef_11">
<a href="#_footnoteref_11">11</a>. <a href="https://martinfowler.com/articles/microservices.html#HowBigIsAMicroservice" class="bare">https://martinfowler.com/articles/microservices.html#HowBigIsAMicroservice</a>
</div>
<div class="footnote" id="_footnotedef_12">
<a href="#_footnoteref_12">12</a>. <a href="https://www.infoq.com/news/2016/02/services-distributed-monolith/" class="bare">https://www.infoq.com/news/2016/02/services-distributed-monolith/</a>
</div>
<div class="footnote" id="_footnotedef_13">
<a href="#_footnoteref_13">13</a>. <a href="https://martinfowler.com/articles/201701-event-driven.html" class="bare">https://martinfowler.com/articles/201701-event-driven.html</a>
</div>
<div class="footnote" id="_footnotedef_14">
<a href="#_footnoteref_14">14</a>. <a href="https://www.thoughtworks.com/de-de/radar/techniques/lightweight-architecture-decision-records" class="bare">https://www.thoughtworks.com/de-de/radar/techniques/lightweight-architecture-decision-records</a>
</div>
<div class="footnote" id="_footnotedef_15">
<a href="#_footnoteref_15">15</a>. <a href="https://blog.leanstack.com/what-is-the-right-fill-order-for-a-lean-canvas/" class="bare">https://blog.leanstack.com/what-is-the-right-fill-order-for-a-lean-canvas/</a>
</div>
<div class="footnote" id="_footnotedef_16">
<a href="#_footnoteref_16">16</a>. <a href="https://ordina-jworks.github.io/domain-driven%20design/2016/02/02/A-Decade-Of-DDD-CQRS-And-Event-Sourcing.html" class="bare">https://ordina-jworks.github.io/domain-driven%20design/2016/02/02/A-Decade-Of-DDD-CQRS-And-Event-Sourcing.html</a>
</div>
<div class="footnote" id="_footnotedef_17">
<a href="#_footnoteref_17">17</a>. <a href="http://axonframework.org/" class="bare">http://axonframework.org/</a>
</div>
<div class="footnote" id="_footnotedef_18">
<a href="#_footnoteref_18">18</a>. <a href="https://www.lagomframework.com/" class="bare">https://www.lagomframework.com/</a>
</div>
<div class="footnote" id="_footnotedef_19">
<a href="#_footnoteref_19">19</a>. <a href="https://eventuate.io/" class="bare">https://eventuate.io/</a>
</div>
<div class="footnote" id="_footnotedef_20">
<a href="#_footnoteref_20">20</a>. <a href="https://www.eventstore.com/" class="bare">https://www.eventstore.com/</a>
</div>
<div class="footnote" id="_footnotedef_21">
<a href="#_footnoteref_21">21</a>. <a href="https://axoniq.io/product-overview/axon-server" class="bare">https://axoniq.io/product-overview/axon-server</a>
</div>
<div class="footnote" id="_footnotedef_22">
<a href="#_footnoteref_22">22</a>. <a href="https://www.martinfowler.com/bliki/AnemicDomainModel.html" class="bare">https://www.martinfowler.com/bliki/AnemicDomainModel.html</a>
</div>
<div class="footnote" id="_footnotedef_23">
<a href="#_footnoteref_23">23</a>. <a href="https://openjfx.com/" class="bare">https://openjfx.com/</a>
</div>
<div class="footnote" id="_footnotedef_24">
<a href="#_footnoteref_24">24</a>. <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege" class="bare">https://en.wikipedia.org/wiki/Principle_of_least_privilege</a>
</div>
<div class="footnote" id="_footnotedef_25">
<a href="#_footnoteref_25">25</a>. <a href="https://philcalcado.com/2015/09/18/the_back_end_for_front_end_pattern_bff.html" class="bare">https://philcalcado.com/2015/09/18/the_back_end_for_front_end_pattern_bff.html</a>
</div>
<div class="footnote" id="_footnotedef_26">
<a href="#_footnoteref_26">26</a>. <a href="https://vimeo.com/131757759" class="bare">https://vimeo.com/131757759</a>
</div>
<div class="footnote" id="_footnotedef_27">
<a href="#_footnoteref_27">27</a>. <a href="http://blogs.tedneward.com/post/enterprise-computing-fallacies/" class="bare">http://blogs.tedneward.com/post/enterprise-computing-fallacies/</a>
</div>
<div class="footnote" id="_footnotedef_28">
<a href="#_footnoteref_28">28</a>. <a href="https://www.enterpriseintegrationpatterns.com/BroadcastAggregate.html" class="bare">https://www.enterpriseintegrationpatterns.com/BroadcastAggregate.html</a>
</div>
<div class="footnote" id="_footnotedef_29">
<a href="#_footnoteref_29">29</a>. <a href="https://www.enterpriseintegrationpatterns.com/PublishSubscribeChannel.html" class="bare">https://www.enterpriseintegrationpatterns.com/PublishSubscribeChannel.html</a>
</div>
<div class="footnote" id="_footnotedef_30">
<a href="#_footnoteref_30">30</a>. <a href="https://axoniq.io/product-overview/axon" class="bare">https://axoniq.io/product-overview/axon</a>
</div>
<div class="footnote" id="_footnotedef_31">
<a href="#_footnoteref_31">31</a>. <a href="https://www.eventstore.com/eventstoredb" class="bare">https://www.eventstore.com/eventstoredb</a>
</div>
<div class="footnote" id="_footnotedef_32">
<a href="#_footnoteref_32">32</a>. <a href="https://martinfowler.com/articles/201701-event-driven.html" class="bare">https://martinfowler.com/articles/201701-event-driven.html</a>
</div>
<div class="footnote" id="_footnotedef_33">
<a href="#_footnoteref_33">33</a>. <a href="https://sre.google/sre-book/service-level-objectives" class="bare">https://sre.google/sre-book/service-level-objectives</a>
</div>
<div class="footnote" id="_footnotedef_34">
<a href="#_footnoteref_34">34</a>. <a href="https://docs.axoniq.io/reference-guide/axon-framework/events/event-versioning#event-upcasting" class="bare">https://docs.axoniq.io/reference-guide/axon-framework/events/event-versioning#event-upcasting</a>
</div>
<div class="footnote" id="_footnotedef_35">
<a href="#_footnoteref_35">35</a>. <a href="https://en.wikipedia.org/wiki/state_machine" class="bare">https://en.wikipedia.org/wiki/state_machine</a>
</div>
<div class="footnote" id="_footnotedef_36">
<a href="#_footnoteref_36">36</a>. <a href="https://en.wikipedia.org/wiki/Distributed_transaction" class="bare">https://en.wikipedia.org/wiki/Distributed_transaction</a>
</div>
<div class="footnote" id="_footnotedef_37">
<a href="#_footnoteref_37">37</a>. <a href="https://www.liquibase.org/" class="bare">https://www.liquibase.org/</a>
</div>
<div class="footnote" id="_footnotedef_38">
<a href="#_footnoteref_38">38</a>. <a href="https://flywaydb.org/" class="bare">https://flywaydb.org/</a>
</div>
<div class="footnote" id="_footnotedef_39">
<a href="#_footnoteref_39">39</a>. <a href="https://www.thoughtworks.com/en-us/insights/podcasts/technology-podcasts/securing-software-supply-chain" class="bare">https://www.thoughtworks.com/en-us/insights/podcasts/technology-podcasts/securing-software-supply-chain</a>
</div>
<div class="footnote" id="_footnotedef_40">
<a href="#_footnoteref_40">40</a>. <a href="https://blog.sonatype.com/software-supply-chain-a-definition-and-introductory-guide" class="bare">https://blog.sonatype.com/software-supply-chain-a-definition-and-introductory-guide</a>
</div>
<div class="footnote" id="_footnotedef_41">
<a href="#_footnoteref_41">41</a>. <a href="https://docs.github.com/en/rest" class="bare">https://docs.github.com/en/rest</a>
</div>
<div class="footnote" id="_footnotedef_42">
<a href="#_footnoteref_42">42</a>. <a href="https://restfulapi.net/hateoas" class="bare">https://restfulapi.net/hateoas</a>
</div>
<div class="footnote" id="_footnotedef_43">
<a href="#_footnoteref_43">43</a>. <a href="https://pact.io/" class="bare">https://pact.io/</a>
</div>
<div class="footnote" id="_footnotedef_44">
<a href="#_footnoteref_44">44</a>. <a href="https://spring.io/projects/spring-cloud-contract" class="bare">https://spring.io/projects/spring-cloud-contract</a>
</div>
<div class="footnote" id="_footnotedef_45">
<a href="#_footnoteref_45">45</a>. <a href="https://developers.google.com/protocol-buffers" class="bare">https://developers.google.com/protocol-buffers</a>
</div>
<div class="footnote" id="_footnotedef_46">
<a href="#_footnoteref_46">46</a>. <a href="https://avro.apache.org/" class="bare">https://avro.apache.org/</a>
</div>
<div class="footnote" id="_footnotedef_47">
<a href="#_footnoteref_47">47</a>. <a href="https://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven" class="bare">https://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven</a>
</div>
<div class="footnote" id="_footnotedef_48">
<a href="#_footnoteref_48">48</a>. <a href="https://martinfowler.com/bliki/TellDontAsk.html" class="bare">https://martinfowler.com/bliki/TellDontAsk.html</a>
</div>
<div class="footnote" id="_footnotedef_49">
<a href="#_footnoteref_49">49</a>. <a href="https://developers.redhat.com/articles/2021/07/30/avoiding-dual-writes-event-driven-applications" class="bare">https://developers.redhat.com/articles/2021/07/30/avoiding-dual-writes-event-driven-applications</a>
</div>
<div class="footnote" id="_footnotedef_50">
<a href="#_footnoteref_50">50</a>. <a href="https://martinfowler.com/articles/patterns-of-distributed-systems/two-phase-commit.html" class="bare">https://martinfowler.com/articles/patterns-of-distributed-systems/two-phase-commit.html</a>
</div>
<div class="footnote" id="_footnotedef_51">
<a href="#_footnoteref_51">51</a>. <a href="https://en.wikipedia.org/wiki/Change_data_capture" class="bare">https://en.wikipedia.org/wiki/Change_data_capture</a>
</div>
<div class="footnote" id="_footnotedef_52">
<a href="#_footnoteref_52">52</a>. <a href="https://debezium.io/" class="bare">https://debezium.io/</a>
</div>
<div class="footnote" id="_footnotedef_53">
<a href="#_footnoteref_53">53</a>. <a href="https://en.wikipedia.org/wiki/Oracle_LogMiner" class="bare">https://en.wikipedia.org/wiki/Oracle_LogMiner</a>
</div>
<div class="footnote" id="_footnotedef_54">
<a href="#_footnoteref_54">54</a>. <a href="https://martinfowler.com/articles/data-monolith-to-mesh.html#DomainDataAsAProduct" class="bare">https://martinfowler.com/articles/data-monolith-to-mesh.html#DomainDataAsAProduct</a>
</div>
<div class="footnote" id="_footnotedef_55">
<a href="#_footnoteref_55">55</a>. <a href="https://micro-frontends.org/" class="bare">https://micro-frontends.org/</a>
</div>
<div class="footnote" id="_footnotedef_56">
<a href="#_footnoteref_56">56</a>. <a href="https://martinfowler.com/articles/micro-frontends.html" class="bare">https://martinfowler.com/articles/micro-frontends.html</a>
</div>
<div class="footnote" id="_footnotedef_57">
<a href="#_footnoteref_57">57</a>. <a href="https://www.thoughtworks.com/en-us/radar/techniques/inverse-conway-maneuver" class="bare">https://www.thoughtworks.com/en-us/radar/techniques/inverse-conway-maneuver</a>
</div>
<div class="footnote" id="_footnotedef_58">
<a href="#_footnoteref_58">58</a>. <a href="https://blog.crisp.se/wp-content/uploads/2012/11/SpotifyScaling.pdf" class="bare">https://blog.crisp.se/wp-content/uploads/2012/11/SpotifyScaling.pdf</a>
</div>
<div class="footnote" id="_footnotedef_59">
<a href="#_footnoteref_59">59</a>. <a href="https://www.youtube.com/watch?v=4GK1NDTWbkY" class="bare">https://www.youtube.com/watch?v=4GK1NDTWbkY</a>
</div>
<div class="footnote" id="_footnotedef_60">
<a href="#_footnoteref_60">60</a>. <a href="https://teamtopologies.com/book" class="bare">https://teamtopologies.com/book</a>
</div>
<div class="footnote" id="_footnotedef_61">
<a href="#_footnoteref_61">61</a>. <a href="https://www.amazon.com/Agile-Organization-Design-Transformation-Continuous/dp/0133903354" class="bare">https://www.amazon.com/Agile-Organization-Design-Transformation-Continuous/dp/0133903354</a>
</div>
<div class="footnote" id="_footnotedef_62">
<a href="#_footnoteref_62">62</a>. <a href="https://evolutionaryarchitecture.com/" class="bare">https://evolutionaryarchitecture.com/</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.0-SNAPSHOT<br>
Last updated 2022-05-15 23:04:45 UTC
</div>
</div>
</body>
</html>