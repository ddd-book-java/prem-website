<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Implementing domain logic</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_implementing_domain_logic">Implementing domain logic</a>
<ul class="sectlevel2">
<li><a href="#technical-requirements">Technical requirements</a></li>
<li><a href="#continuing-our-design-journey">Continuing our design journey</a></li>
<li><a href="#_implementing_the_command_side">Implementing the command side</a>
<ul class="sectlevel3">
<li><a href="#tooling-choices">Tooling choices</a></li>
<li><a href="#_bootstapping_the_application">Bootstrapping the application</a></li>
<li><a href="#identifying-commands">Identifying commands</a></li>
<li><a href="#_identifying_aggregates">Identifying aggregates</a></li>
<li><a href="#discovering-bounded-contexts">Discovering bounded contexts</a></li>
<li><a href="#correlating-aggregates-to-bounded-contexts">Correlating aggregates to bounded contexts</a></li>
<li><a href="#test-driving-the-system">Test-driving the system</a></li>
<li><a href="#implementing-the-command">Implementing the command</a></li>
<li><a href="#_implementing_the_event">Implementing the event</a></li>
<li><a href="#designing-the-aggregate">Designing the aggregate</a></li>
</ul>
</li>
<li><a href="#_persisting_aggregates">Persisting aggregates</a>
<ul class="sectlevel3">
<li><a href="#_state_stored_aggregates">State stored aggregates</a></li>
<li><a href="#_event_sourced_aggregates">Event sourced aggregates</a></li>
<li><a href="#persistence-technology-choices">Persistence technology choices</a></li>
<li><a href="#which-persistence-mechanism-should-we-choose">Which persistence mechanism should we choose?</a></li>
</ul>
</li>
<li><a href="#enforcing-policies">Enforcing policies</a>
<ul class="sectlevel3">
<li><a href="#structural-validations">Structural validations</a></li>
<li><a href="#business-rule-enforcements">Business rule enforcements</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#questions">Questions</a></li>
<li><a href="#further-reading">Further reading</a></li>
<li><a href="#answers">Answers</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1 text-justify">
<h2 id="_implementing_domain_logic"><a class="anchor" href="#_implementing_domain_logic"></a>Implementing domain logic</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
To communicate effectively, the code must be based on the same language used to write the requirements—the same language that the developers speak with each other and with domain experts.
</blockquote>
<div class="attribution">
&#8212; Eric Evans
</div>
</div>
<div class="paragraph">
<p>In the Command Query Responsibility Segregation (CQRS) section, we describe how DDD and CQRS complement each other and how the command side (write requests) is the home of business logic. In this chapter, we will implement the command side API for the LC application using Spring Boot and Axon Framework, JSR-303 Bean Validations and persistence options by contrasting between state-stored vs event-sourced aggregates. The list of topics to be covered is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identifying aggregates</p>
</li>
<li>
<p>Handling commands and emitting events</p>
</li>
<li>
<p>Test-driving the application</p>
</li>
<li>
<p>Persisting aggregates</p>
</li>
<li>
<p>Performing validations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By the end of this chapter, you would have learned how to implement the core of your system (the domain logic) in a robust, well encapsulated manner. You will also learn how to decouple your domain model from persistence concerns. Finally, you will be able to appreciate how to perform DDD&#8217;s tactical design using services, repositories, aggregates, entities and value objects.</p>
</div>
<div class="sect2">
<h3 id="technical-requirements"><a class="anchor" href="#technical-requirements"></a>Technical requirements</h3>
<div class="paragraph">
<p>To follow the examples in this chapter, you will need access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 1.8+ (We have used Java 16 to compile sample sources)</p>
</li>
<li>
<p>Maven 3.x</p>
</li>
<li>
<p>Spring Boot 2.4.x</p>
</li>
<li>
<p>JUnit 5.7.x (Included with spring boot)</p>
</li>
<li>
<p>Axon Framework 4.4.7 (DDD and CQRS Framework)</p>
</li>
<li>
<p>Project Lombok (To reduce verbosity)</p>
</li>
<li>
<p>Moneta 1.4.x (Money and currency reference implementation - JSR 354)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="continuing-our-design-journey"><a class="anchor" href="#continuing-our-design-journey"></a>Continuing our design journey</h3>
<div class="paragraph">
<p>In the previous chapter, we discussed eventstorming as  a lightweight method to clarify business flows. As a reminder, this is the output produced from our eventstorming session:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/event-storming/05-query-models.png" alt="05 query models">
</div>
<div class="title">Figure 1. Recap of eventstorming session</div>
</div>
<div class="paragraph">
<p>As mentioned previously, the <strong>blue</strong> stickies in this diagram represent <strong>commands</strong>. We will be using the  <a href="#_cqrs_pattern">Command Query Responsibility Segregation (CQRS)</a> pattern as a high level architecture approach to implement the domain logic for our LC issuance application. Let&#8217;s examine the mechanics of using CQRS and how it can result in an elegant solution. For a recap of what CQRS is and when it is appropriate to apply this pattern, please refer to the "<a href="#_when_to_use_cqrs">When to use CQRS</a>" section in <a href="#_where_does_ddd_fit">Chapter 2</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
CQRS is by no means a silver bullet. Although it is general-purpose enough to be used in a variety of scenarios, it is a paradigm shift as applied to mainstream software problems. Like any other architecture decision, you should apply due diligence when choosing to adopt CQRS to your situation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let’s look at how this works in practice by implementing a representative sliver of the <strong>command</strong> side of the Letter of Credit application using the Spring and Axon frameworks.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_the_command_side"><a class="anchor" href="#_implementing_the_command_side"></a>Implementing the command side</h3>
<div class="paragraph">
<p>In this section, we will focus on implementing the command side of the application. This is where we expect all the business logic of the application to be implemented. Logically, it looks as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/cqrs/cqrs-command-side.png" alt="cqrs command side">
</div>
<div class="title">Figure 2. CQRS application&#8201;&#8212;&#8201;command side</div>
</div>
<div class="paragraph">
<p>The high level sequence on the command side is described here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A request to mutate state (command) is received.</p>
</li>
<li>
<p>In an event-sourced system, the command model is constructed by replaying existing events that have occurred for that instance. In a state-stored system, we would simply restore state by reading state from the persistence store.</p>
</li>
<li>
<p>If business invariants (validations) are satisfied, one or more domain events are readied with the intention to be published.</p>
</li>
<li>
<p>In an event-sourced system, the domain event is persisted on the command side. In a state-stored system, we would update the state of the instance in the persistence store.</p>
</li>
<li>
<p>The external world is notified by publishing these domain events onto an event bus. The event bus is an infrastructure component onto which events are published.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how we can implement this in the context of our Letter of Credit (LC) issuance application.</p>
</div>
<div class="sect3">
<h4 id="tooling-choices"><a class="anchor" href="#tooling-choices"></a>Tooling choices</h4>
<div class="paragraph">
<p>Implementing CQRS does not require the use of any framework. Greg Young, who is considered the father of the CQRS pattern, advises against rolling our own CQRS framework in this <a href="https://ordina-jworks.github.io/domain-driven%20design/2016/02/02/A-Decade-Of-DDD-CQRS-And-Event-Sourcing.html">essay</a><sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>, which is worth taking a look at. Using a <em>good</em> framework can help enhance developer effectiveness and accelerate the delivery of business functionality, while abstracting the low-level plumbing and non-functional requirements without limiting flexibility. In this book we will make use of the <a href="http://axonframework.org/">Axon Framework</a><sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> to implement application functionality as we have real-world experience of having used it in large scale enterprise development with success. There are other frameworks that work comparably, like <a href="https://www.lagomframework.com/">Lagom Framework</a><sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> and <a href="https://eventuate.io/">Eventuate</a><sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup> that are worth exploring as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bootstapping_the_application"><a class="anchor" href="#_bootstapping_the_application"></a>Bootstrapping the application</h4>
<div class="paragraph">
<p>To get started, let&#8217;s create a simple spring boot application. There are several ways to do this. You can always use the Spring starter application at <a href="https://start.spring.io" class="bare">https://start.spring.io</a> to create this application. Here, we will make use of the <code>spring</code> CLI to bootstrap the application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To install the <code>spring</code> CLI for your platform, please refer to the detailed instructions at <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.installing" class="bare">https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.installing</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To bootstrap the application, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>spring init \
      --dependencies 'web,data-jpa,lombok,validation,h2,actuator' \
      --name lc-issuance-api \
      --artifactId lc-issuance-api \
      --groupId com.example.api \
      --packaging jar \
      --description 'LC Issuance API' \
      --package-name com.example.api \
      --force</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The entire command is split into multiple lines for better readability. Unix based operating systems requires us to use backslash [ \ ] character to split the command into multiple lines. If you are using Windows OS, then please make sure to replace the backslash character with back-tick [ ` &nbsp; ] character before running the command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This should create a file named <code>lc-issuance-api.zip</code> in the current directory. Unzip this file to a location of your choice and add a dependency on the Axon framework in the <code>dependencies</code> section of the <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.axonframework<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>axon-spring-boot-starter<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${axon-framework.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You may need to change the version. We are at version <code>4.5.3</code> at the time of writing this book.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also, add the following dependency on the <code>axon-test</code> library to enable unit testing of aggregates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.axonframework<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>axon-test<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#070;font-weight:bold">&lt;/scope&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>${axon-framework.version}<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the above set up, you should be able to run the application and start implementing the LC issuance functionality.</p>
</div>
</div>
<div class="sect3">
<h4 id="identifying-commands"><a class="anchor" href="#identifying-commands"></a>Identifying commands</h4>
<div class="paragraph">
<p>From the eventstorming session in the previous chapter, we have the following commands to start with:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/potential-commands.png" alt="potential commands" width="680" height="408">
</div>
<div class="title">Figure 3. Identified commands</div>
</div>
<div class="paragraph">
<p>Commands are always directed to an aggregate (the root entity) for processing (handling). This means that we need to resolve each of these commands to be handled by an aggregate. While the sender of the command does not care which component within the system handles it, we need to decide which aggregate will handle each command. It is also important to note that any given command can only be handled by a single aggregate within the system. Let&#8217;s look at how to group these commands and assign them to aggregates. To be able to do that, we need to identify the aggregates in the system first.</p>
</div>
</div>
<div class="sect3">
<h4 id="_identifying_aggregates"><a class="anchor" href="#_identifying_aggregates"></a>Identifying aggregates</h4>
<div class="paragraph">
<p>Looking at the output of the eventstorming session of our LC (Letter of Credit) application, one potential grouping of commands can be as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/aggregate-design/aggregate-design-01.png" alt="aggregate design 01">
</div>
<div class="title">Figure 4. First cut attempt at aggregate design</div>
</div>
<div class="paragraph">
<p>Before we arrive at aggregates, the grouping above allows us to identify entities. Some or all of these entities may be aggregates (For a more detailed explanation on the difference between <a href="#_aggregates">aggregates</a> and <a href="#_entities">entities</a>, please refer to <a href="#_the_rationale_for_domain_driven_design">Chapter 1</a>
).</p>
</div>
<div class="paragraph">
<p>At first glance, it appears that we have four potential aggregates to handle these commands:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/potential-aggregates.png" alt="potential aggregates" width="304" height="237">
</div>
<div class="title">Figure 5. Potential aggregates at first glance</div>
</div>
<div class="paragraph">
<p>However, it is a bit more nuanced than that. Before we conclude this conversation on aggregates, let&#8217;s also examine our current organizational structures because they can and will play a very influential role in how we choose aggregates. When implementing the solution, these organizational structures decompose into bounded contexts, so let&#8217;s also examine how that works.</p>
</div>
</div>
<div class="sect3">
<h4 id="discovering-bounded-contexts"><a class="anchor" href="#discovering-bounded-contexts"></a>Discovering bounded contexts</h4>
<div class="paragraph">
<p>Our current organization is segregated to handle the business functions outlined here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application.png" alt="lc application" width="410" height="251">
</div>
</div>
<div class="paragraph">
<p>As a starting point, we can use these business functions as natural boundaries to act as <a href="#_scope_of_domain_models_and_the_bounded_context">bounded contexts</a> for our solution. We may evolve this design in the future as we gain more understanding of the problem and the solution, but for now, this will suffice. Aggregates live within the confines of a single bounded context, so we need to correlate the two concepts. Let&#8217;s look at how this works.</p>
</div>
</div>
<div class="sect3">
<h4 id="correlating-aggregates-to-bounded-contexts"><a class="anchor" href="#correlating-aggregates-to-bounded-contexts"></a>Correlating aggregates to bounded contexts</h4>
<div class="paragraph">
<p>If we examine the lifecycle of the letter of credit (LC) as a whole, we notice the structure outlined here. Each of these bounded contexts work with the same entities, but call them by different names making use of their own ubiquitous language. The context map for the system looks like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/lc-application.png" alt="lc application" width="529" height="533">
</div>
<div class="title">Figure 6. Relationship between bounded contexts</div>
</div>
<div class="paragraph">
<p>Notice how the <code>Customer</code> in the Customer Onboarding bounded context is called an <code>Applicant</code> in the LC Application Processing context. Similarly, Compliance works with a <code>Product</code> entity, whereas LC Application Processing calls it <code>Merchandise</code>. Within the LC Application Processing bounded context, we always work within the purview of an <code>LC Application</code>, not directly with either the <code>Applicant</code> or the <code>Merchandise</code>. This leads us to the conclusion (at least for now), that the <code>Applicant</code> and <code>Merchandise</code> entities are not aggregates within the LC Application Processing context. The <code>LC Application</code> entity acts as the <strong>aggregate</strong> for this bounded context. Furthermore, it is at the root of the aggregate hierarchy, hence it is termed as the <strong>aggregate root</strong>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Colloquially, the terms aggregate and aggregate root are sometimes used interchangeably to mean the same thing. Aggregates can be hierarchical, and it is possible for aggregates to contain child aggregates. While both aggregates and aggregate roots handle commands, only one aggregate can exist as the root in a given context, and it encapsulates access to its child aggregates, entities and value objects.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is important to note that entities may be required to be treated as aggregates in a different bounded context and this kind of treatment is entirely context dependent.</p>
</div>
<div class="paragraph">
<p>When we look at the output of our eventstorming session, the <code>LC Application</code> transitions to become an <code>LC</code> much later in the lifecycle in the Issuance context. Our focus right now is to optimize and automate the LC application flow of the overall issuance process. Now that we have settled on working with the <code>LC Application</code> aggregate (root), let&#8217;s start writing our first command to see how this manifests itself in code.</p>
</div>
</div>
<div class="sect3">
<h4 id="test-driving-the-system"><a class="anchor" href="#test-driving-the-system"></a>Test-driving the system</h4>
<div class="paragraph">
<p>While we have a reasonably good conceptual understanding of the system, we are still in the process of refining this understanding. Test-driving the system allows us to exercise our understanding by acting as the first client of the solution that we are producing.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The practice of test-driving the system is very well illustrated in the best-selling book&#8201;&#8212;&#8201;<em>Growing Object-Oriented Software, Guided by Tests</em> by authors Nat Price and Steve Freeman. This is worth looking at, to gain a deeper understanding of this practice.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So let&#8217;s start with the first test. To the external world, an event-driven system typically works in a manner depicted below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/event-driven-system.png" alt="event driven system">
</div>
<div class="title">Figure 7. An event-driven system</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An optional set of domain events may have occurred in the past.</p>
</li>
<li>
<p>A command is received by the system (initiated manually by a user or automatically by a part of the system), which acts as a stimulus.</p>
</li>
<li>
<p>The command is handled by an aggregate which then proceeds to validate the received command to enforce invariants (structural and domain validations).</p>
</li>
<li>
<p>The system then reacts in one of two ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>Emit one or more events</p>
</li>
<li>
<p>Throw an exception</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Axon framework allows us to express tests in the following form.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code snippets shown in this chapter are excerpts to highlight significant concepts and techniques. For the full working example, please refer to the accompanying source code for this chapter (included in the ch05 directory).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {

    <span style="color:#088;font-weight:bold">private</span> FixtureConfiguration&lt;LCApplication&gt; fixture;                          <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> setUp() {
        fixture = <span style="color:#080;font-weight:bold">new</span> AggregateTestFixture&lt;&gt;(LCApplication.class);                <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldPublishLCApplicationCreated() {
        fixture.given()                                                           <i class="conum" data-value="3"></i><b>(3)</b>

                .when(<span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommand())                           <i class="conum" data-value="4"></i><b>(4)</b>

                .expectEventsMatching(exactSequenceOf(                            <i class="conum" data-value="5"></i><b>(5)</b>
                        messageWithPayload(any(LCApplicationCreatedEvent.class)), <i class="conum" data-value="6"></i><b>(6)</b>
                        andNoMore()                                               <i class="conum" data-value="7"></i><b>(7)</b>
                ));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>FixtureConfiguration</code> is an Axon framework utility to aid testing of aggregate behaviour using a BDD style given-when-then syntax.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>AggregateTestFixture</code> is a concrete implementation of <code>FixtureConfiguration</code> where you need to register your aggregate class&#8201;&#8212;&#8201;<code>LCApplication</code> in our case as the candidate to handle commands directed to our solution.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Since this is the start of the business process, there are no events that have occurred thus far. This is signified by the fact that we do not pass any arguments to the <code>given</code> method. In other examples we will discuss later, there will likely be events that have already occurred prior to receiving this command.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is where we instantiate a new instance of the command object. Command objects are usually similar to data transfer objects, carrying a set of information. This command will be routed to our aggregate for handling. We will take a look at how this works in detail shortly.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here we are declaring that we expect events matching an exact sequence.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here we are expecting an event of type <code>LCApplicationCreated</code> to be emitted as a result of successfully handling the command.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>We are finally saying that we do not expect any more events&#8201;&#8212;&#8201;which means that we expect exactly one event to be emitted.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="implementing-the-command"><a class="anchor" href="#implementing-the-command"></a>Implementing the command</h4>
<div class="paragraph">
<p>The <code>CreateLCApplicationCommand</code> in the previous simplistic example does not carry any state. Realistically, the command will likely look something like what is depicted as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Data</span>;

<span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommand</span> {  <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;            <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#088;font-weight:bold">private</span> ClientId clientId;
    <span style="color:#088;font-weight:bold">private</span> Party applicant;               <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> Party beneficiary;
    <span style="color:#088;font-weight:bold">private</span> AdvisingBank advisingBank;     <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> LocalDate issueDate;
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount amount;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> merchandiseDescription;

}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The command class. When naming commands, we typically use an imperative style i.e. they usually begin with a verb denoting the action required. Note that this is a data transfer object. In other words, it is simply a bag of data attributes. Also note how it is devoid of any logic (at least at the moment).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The identifier for the LC Application. We are assuming client generated identifiers in this case. The topic of using server-generated versus client-generated identifiers is out of scope for the subject of this book. You may use either depending on what is advantageous in your context. Also note that we are using a strong type for the identifier <code>LCApplicationId</code> as opposed to a primitive such as a numeric or a string value. It is also common in some cases to use UUIDs as the identifier. However, we prefer using strong types to be able to differentiate between identifier types. Notice how we are using a type <code>ClientId</code> to represent the creator of the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>Party</code> and <code>AdvisingBank</code> types are complex types to represent those concepts in our solution. Care should be taken to consistently use names that are relevant in the problem (business) domain as opposed to using names that only make sense in the solution (technology) domain. Note the attempt to make use of the <em>ubiquitous language</em> of the domain experts in both cases. This is a practice that we should always be conscious of when naming things in the system.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is worth noting that the <code>merchandiseDescription</code> is left as a primitive <code>String</code> type. This may feel contradictory to the commentary we present above. We will address this in the upcoming section on Structural validations.</p>
</div>
<div class="paragraph">
<p>Now let’s look at what the event we will emit as a result of successfully processing the command will look like.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_the_event"><a class="anchor" href="#_implementing_the_event"></a>Implementing the event</h4>
<div class="paragraph">
<p>In an event-driven system, mutating system state by successfully processing a command usually results in a domain event being emitted to signal the state mutation to the rest of the system. A simplified representation of a real-world <code>LCApplicationCreatedEvent</code> is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Data</span>;

<span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationCreatedEvent</span> {   <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;
    <span style="color:#088;font-weight:bold">private</span> ClientId clientId;
    <span style="color:#088;font-weight:bold">private</span> Party applicant;
    <span style="color:#088;font-weight:bold">private</span> Party beneficiary;
    <span style="color:#088;font-weight:bold">private</span> AdvisingBank advisingBank;
    <span style="color:#088;font-weight:bold">private</span> LocalDate issueDate;
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount amount;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> merchandiseDescription;

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The event type. When naming events, we typically use names in the past tense to denote things that have already occurred and are to be accepted unconditionally as empirical facts that cannot be changed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will likely notice that the structure of the event is currently identical to that of the command. While this is true in this case, it may not always be that way. The amount of information that we choose to disclose in an event is context-dependent. It is important to consult with domain experts when publishing information as part of events. One may choose to withhold certain information in the event payload. For example, consider a <code>ChangePasswordCommand</code> which contains the newly changed password. It might be prudent to not include the changed password in the resulting <code>PasswordChangedEvent</code>.</p>
</div>
<div class="paragraph">
<p>We have looked at the command and the resulting event in the previous test. Let&#8217;s look at how this is implemented under the hood by looking at the aggregate implementation.</p>
</div>
</div>
<div class="sect3">
<h4 id="designing-the-aggregate"><a class="anchor" href="#designing-the-aggregate"></a>Designing the aggregate</h4>
<div class="paragraph">
<p>The aggregate is the place where commands are handled and events are emitted. The good thing about the test that we have written is that it is expressed in a manner that hides the implementation details. But let&#8217;s look at the implementation to be able to appreciate how we can get our tests to pass and meet the business requirement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {

    <span style="color:#007">@AggregateIdentifier</span>                                                            <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;

    <span style="color:#007">@SuppressWarnings</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">unused</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> LCApplication() {
        <span style="color:#777">// Required by the framework</span>
    }

    <span style="color:#007">@CommandHandler</span>                                                                 <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#088;font-weight:bold">public</span> LCApplication(CreateLCApplicationCommand command) {                      <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="color:#777">// TODO: perform validations here</span>
        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(command.getId()));   <i class="conum" data-value="4"></i><b>(4)</b>
    }

    <span style="color:#007">@EventSourcingHandler</span>                                                           <i class="conum" data-value="5"></i><b>(5)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationCreatedEvent event) {
        <span style="color:#950">this</span>.id = event.getId();
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The aggregate identifier for the <code>LCApplication</code> aggregate. For an aggregate, the identifier uniquely identifies one instance from another. For this reason, all aggregates are required to declare an identifier and mark it so using the <code>@AggregateIdentifier</code> annotation provided by the framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The method that is handling the command needs to be annotated with the <code>@CommandHandler</code> annotation. In this case, the command handler happens to be the constructor of the class given that this the first command that can be received by this aggregate. We will see examples of subsequent commands being handled by other methods later in the chapter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>@CommandHandler</code> annotation marks a method as being a command handler. The exact command that this method can handle needs to be passed as a parameter to the method. Do note that there can only be one command handler in the <strong>entire</strong> system for any given command.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Here, we are emitting the <code>LCApplicationCreatedEvent</code> using the <code>AggregateLifecycle</code> utility provided by the framework. In this very simple case, we are emitting an event unconditionally on receipt of the command. In a real-world scenario, it is conceivable that a set of validations will be performed before deciding to either emit one or more events or failing the command with an exception. We will look at more realistic examples later in the chapter.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The need for the <code>@EventSourcingHandler</code> and its role are likely very unclear at this time. We will explain the need for this in detail in an upcoming section of this chapter.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This was a whirlwind introduction to a simple event-driven system. We still need to understand the role of the
<code>@EventSourcingHandler</code>. To understand that, we will need to appreciate how aggregate persistence works and the implications it has on our overall design.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_persisting_aggregates"><a class="anchor" href="#_persisting_aggregates"></a>Persisting aggregates</h3>
<div class="paragraph">
<p>When working with any system of even moderate complexity, we are required to make interactions durable. That is, interactions need to outlast system restarts, crashes, etc. So the need for persistence is a given. While we should always endeavour to abstract persistence concerns from the rest of the system, our persistence technology choices can have a significant impact on the way we architect our overall solution. We have a couple of choices in terms of how we choose to persist aggregate state that are worth mentioning:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>State stored</p>
</li>
<li>
<p>Event sourced</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s examine each of these techniques in more detail below:</p>
</div>
<div class="sect3">
<h4 id="_state_stored_aggregates"><a class="anchor" href="#_state_stored_aggregates"></a>State stored aggregates</h4>
<div class="paragraph">
<p>Saving current values of entities is by far the most popular way to persist state&#8201;&#8212;&#8201;thanks to the immense popularity of relational databases and object-relational mapping (ORM) tools like Hibernate. And there is good reason for this ubiquity. Until recently, a majority of enterprise systems used relational databases almost as a default to create business solutions, with ORMs arguably providing a very convenient mechanism to interact with relational databases and their object representations. For example, for our <code>LCApplication</code>, it is conceivable that we could use a relational database with a structure that would look something like below:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/relational-structure.png" alt="relational structure" width="818" height="475">
</div>
<div class="title">Figure 8. Typical entity relationship model</div>
</div>
<div class="paragraph">
<p>Irrespective of whether we choose to use a relational database or a more modern NoSql store&#8201;&#8212;&#8201;for instance, a document store, key-value store, column family store, etc., the style we use to persist information remains more or less the same&#8201;&#8212;&#8201;which is to store the current values of the attributes of the said aggregate/entity. When the values of attributes change, we simply overwrite old values with newer ones i.e. we store the current state of aggregates and entities&#8201;&#8212;&#8201;hence the name <em>state stored</em>. This technique has served us very well over the years, but there is at least one more mechanism that we can use to persist information. We will look at this in more detail below.</p>
</div>
</div>
<div class="sect3">
<h4 id="_event_sourced_aggregates"><a class="anchor" href="#_event_sourced_aggregates"></a>Event sourced aggregates</h4>
<div class="paragraph">
<p>Developers have also been relying on logs for a variety of diagnostic purposes for a very long time. Similarly, relational databases have been employing commit logs to store information durably almost since their inception. However, developers' use of logs as a first class persistence solution for structured information in mainstream systems remains extremely rare.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A log is an extremely simple, append-only sequence of immutable records ordered by time. The diagram here illustrates the structure of a log where records are written sequentially. In essence, a log is an append-only data structure as depicted here:.
</td>
</tr>
</table>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/log-records.png" alt="log records" width="600" height="154">
</div>
<div class="title">Figure 9. The log data structure</div>
</div>
<div class="paragraph">
<p>Writing to a log as compared to a more complex data structure like a table is a relatively simple and fast operation and can handle extremely high volumes of data while providing predictable performance. Indeed, a modern event streaming platform like Kafka makes use of this pattern to scale to support extremely high volumes. We do feel that this can be applied to act as a persistence store when processing commands in mainstream systems because this has benefits beyond the technical advantages listed above. Consider the example of an online order flow below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 37.5%;">
<col style="width: 37.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">User Action</th>
<th class="tableblock halign-left valign-top">Traditional Store</th>
<th class="tableblock halign-left valign-top">Event Store</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add milk to cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Milk in cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add white bread to cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Milk, White bread in cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart<br>
E3: White bread added to cart</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove White bread from cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Milk in cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart<br>
E3: White bread added to cart<br>
E4: White bread removed from cart</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add Wheat bread to cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Milk, Wheat bread in cart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart<br>
E3: White bread added to cart<br>
E4: White bread removed from cart<br>
E5: Wheat bread added to cart</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Confirm cart checkout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Order 123: Ordered Milk, Wheat bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added to cart<br>
E3: White bread added to cart<br>
E4: White bread removed from cart<br>
E5: Wheat bread added to cart<br>
E6: Order 123 confirmed</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As you can see, in the event store, we continue to have full visibility of all user actions performed. This allows us to reason about these behaviors more holistically. In the traditional store, we lost the information that the user replaced white with wheat bread. While this does not impact the order itself, we lose the opportunity to gather insights from this user behavior. We recognize that this information can be captured in other ways using specialized analytical solutions, however, the event log mechanism provides a natural way to do this without requiring any additional effort. It also acts as an audit log providing full history of all events that have occurred thus far. This fits well with the essence of domain-driven design where we are constantly exploring ways in which to reduce complexity.</p>
</div>
<div class="paragraph">
<p>However, there are implications to persisting data in the form of a simple event log. Before processing any command, we will need to hydrate past events in exact order of occurrence and reconstruct aggregate state to allow us to perform validations. For example, when confirming checkout, just having the ordered set of elapsed events will not suffice. We still need to compute the exact items that are in the cart before allowing the order to be placed. This <em>event replay</em> to restore aggregate state (at least those attributes that are required to validate said command) is necessary before processing that command. For example, we need to know which items are in the cart currently before processing the <code>RemoveItemFromCartCommand</code>.This is illustrated in the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 29.4117%;">
<col style="width: 17.647%;">
<col style="width: 23.5294%;">
<col style="width: 29.4119%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Elapsed Events</th>
<th class="tableblock halign-left valign-top">Aggregate State</th>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Event(s) Emitted</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add item: milk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#<em>123</em> created<br>
E2: Milk added</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cart Items</strong>:<br>
Milk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add item: white bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E2: White bread added</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added<br>
E3: White bread added</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cart Items</strong>:<br>
Milk,<br>
White Bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove item: white bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E3: White bread removed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added<br>
E3: White bread added<br>
E4: White bread removed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cart Items</strong>:<br>
Milk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add item: wheat bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E4: Wheat bread added</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">E1: Cart#123 created<br>
E2: Milk added<br>
E3: White bread added<br>
E4: White bread removed<br>
E5: Wheat bread added</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cart Items</strong>:<br>
Milk<br>
Wheat bread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Confirm checkout for Cart#123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E5: Order created!</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The corresponding source code for the whole scenario is illustrated in the following code snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Cart</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> isNew;
    <span style="color:#088;font-weight:bold">private</span> CartItems items;
    <span style="color:#777">//..</span>

    <span style="color:#088;font-weight:bold">private</span> Cart() {                                             <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#777">// Required by the framework</span>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> addItem(AddItemToCartCommand command) {
        <span style="color:#777">// Business validations here</span>
        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">this</span>.isNew) {
            apply(<span style="color:#080;font-weight:bold">new</span> CartCreatedEvent(command.getId()));        <i class="conum" data-value="2"></i><b>(2)</b>
        }
        apply(<span style="color:#080;font-weight:bold">new</span> ItemAddedEvent(id, command.getItem()));        <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> removeItem(RemoveItemFromCartCommand command) {
        <span style="color:#777">// Business validations here</span>
        apply(<span style="color:#080;font-weight:bold">new</span> ItemRemovedEvent(id, commmand.getItem()));
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> checkout(ConfirmCheckoutCommand command) {
        <span style="color:#777">// Business validations here</span>
        apply(<span style="color:#080;font-weight:bold">new</span> OrderCreatedEvent(<span style="color:#950">this</span>.items));
    }

    <span style="color:#007">@EventSourcingHandler</span>                                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(CartCreatedEvent event) {
        <span style="color:#950">this</span>.id = event.getCartId();
        <span style="color:#950">this</span>.items = <span style="color:#080;font-weight:bold">new</span> CartItems();
        <span style="color:#950">this</span>.isNew = <span style="color:#069">true</span>;
    }

    <span style="color:#007">@EventSourcingHandler</span>                                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(ItemAddedEvent event) {
        <span style="color:#950">this</span>.items.add(event.getItem());
        <span style="color:#950">this</span>.isNew = <span style="color:#069">false</span>;
    }

    <span style="color:#007">@EventSourcingHandler</span>                                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(ItemRemovedEvent event) {
        <span style="color:#950">this</span>.items.remove(event.getItem());
    }

    <span style="color:#007">@EventSourcingHandler</span>                                        <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(CheckoutConfirmedEvent event) {
        <span style="color:#777">// ..</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Before processing any command, the aggregate loading process commences by first invoking the no-args constructor. For this reason, we need the no-args constructor to be <strong>empty</strong> i.e. it should <strong>not</strong> have any code that restores state. State restoration <strong>must</strong> happen only in those methods that trigger an event replay. In the case of the Axon framework, this translates to methods embellished with the <code>@EventSourcingHandler</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is important to note that it is possible (but not necessary) to emit <strong>more than one event</strong> after processing a command. This is illustrated in the first instance of the <code>AddItemCommand</code> in the previous code where we emit <code>CartCreatedEvent</code> and <code>ItemAddedEvent</code>.Command handlers do not mutate state of the aggregate. They only make use of existing aggregate state to enforce invariants (validations) and emit events if those invariants hold true.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The loading process continues through the invocation of event sourcing handler methods in exactly the order of occurrence for that aggregate instance. Event sourcing handlers are only needed to hydrate aggregate state on the basis of past events. This means that they usually are devoid of any business (conditional) logic. It goes without saying that these methods do not emit any events. Event emission is restricted to happen within command handlers when invariants are successfully enforced.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When working with event sourced aggregates, it is very important to be disciplined about the kind of code that one can write:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type of Method</th>
<th class="tableblock halign-left valign-top">State Restoration</th>
<th class="tableblock halign-left valign-top">Business Logic</th>
<th class="tableblock halign-left valign-top">Event Emission</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@CommandHandler</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@EventSourcingHandler</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If there are a large number of historic events to restore state, the aggregate loading process can become a time-consuming operation&#8201;&#8212;&#8201;directly proportional to the number of elapsed events for that aggregate. There are techniques (like snapshotting) we can employ to overcome this. We will cover this in more detail in Chapter 11 – Non-Functional Requirements.</p>
</div>
</div>
<div class="sect3">
<h4 id="persistence-technology-choices"><a class="anchor" href="#persistence-technology-choices"></a>Persistence technology choices</h4>
<div class="paragraph">
<p>If you are using a state store to persist your aggregates, using your usual evaluation process for choosing your persistence technology should suffice. However, if you are looking at event-sourced aggregates, the decision can be a bit more nuanced. In our experience, even a simple relational database can do the trick. Indeed, we had made use of a relational database to act as an event store for a high volume transactional application with billions of events. This setup worked just fine for us. It is worth noting that we were only using the event store to insert new events and loading events for a given aggregate in sequential order. However, there are a multitude of specialized technologies that have been purpose built to act as an event store that support several other value-added features such as time travel, full event replay, event payload introspection, etc. If you have such requirements, it might be worth considering other options such as NoSql databases (document stores like MongoDB or column family stores like Cassandra) or purpose-built commercial offerings such as EventStoreDB<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup> and Axon Server<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup> to evaluate feasibility in your context.</p>
</div>
</div>
<div class="sect3">
<h4 id="which-persistence-mechanism-should-we-choose"><a class="anchor" href="#which-persistence-mechanism-should-we-choose"></a>Which persistence mechanism should we choose?</h4>
<div class="paragraph">
<p>Now that we have a reasonably good understanding of the two types of aggregate persistence mechanisms (<a href="#_state_stored_aggregates">state-stored</a> and <a href="#_event_sourced_aggregates">event-sourced</a>), it begs the question of which one we should choose. We list a few benefits of using event sourcing below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We get to use the events as a <strong>natural audit log</strong> in high compliance scenarios.</p>
</li>
<li>
<p>It provides the ability to perform <strong>more insightful analytics</strong> on the basis of the fine-grained events data.</p>
</li>
<li>
<p>It arguably produces more flexible designs when we work with an system based on <strong>immutable events</strong>&#8201;&#8212;&#8201;because the complexity of the persistence model is capped. Also, there is no need to deal with complex ORM impedance mismatch problems.</p>
</li>
<li>
<p>The domain model is much more <strong>loosely coupled</strong> with the persistence model&#8201;&#8212;&#8201;enabling it to evolve mostly independently from the persistence model.</p>
</li>
<li>
<p>Enables going back in time to be able to create <strong>adhoc views and reports</strong> without having to deal with upfront complexity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On the flip side, these are some challenges that you might have to consider when implementing an event sourced solution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Event sourcing requires a <strong>paradigm shift</strong>. Which means that development and business teams will have to spend time and effort understanding how it works.</p>
</li>
<li>
<p>The persistence model does not store state directly. This means that <strong>adhoc querying</strong> directly on the persistence model can be a lot more <strong>challenging</strong>. This can be alleviated by materializing new views, however there is added complexity in doing that.</p>
</li>
<li>
<p>Event sourcing usually tends to work very well when implemented in conjunction with <strong>CQRS</strong> which arguably may add more complexity to the application. It also requires applications to pay closer attention to strong vs <strong>eventual consistency</strong> concerns.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our experiences indicate that event sourced systems bring a lot of benefits in modern event-driven systems. However, you will need to be cognizant of the considerations presented above in the context of your own ecosystems when making persistence choices.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enforcing-policies"><a class="anchor" href="#enforcing-policies"></a>Enforcing policies</h3>
<div class="paragraph">
<p>When processing commands, we need to enforce policies or rules. Policies come in two broad categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Structural rules&#8201;&#8212;&#8201;those that enforce that the syntax of the dispatched command is valid.</p>
</li>
<li>
<p>Domain rules&#8201;&#8212;&#8201;those that enforce that business rules are adhered to.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It may also be prudent to perform these validations in different layers of the system. And it is also common for some or all of these policy enforcements to be repeated in more than one layer of the system. However, the important thing to note is that before a command is successfully handled, all these policy enforcements are uniformly applied. Let&#8217;s look at some examples of these in the upcoming section.</p>
</div>
<div class="sect3">
<h4 id="structural-validations"><a class="anchor" href="#structural-validations"></a>Structural validations</h4>
<div class="paragraph">
<p>Currently, to create an LC application, one is required to dispatch a <code>CreateLCApplicationCommand</code>. While the command dictates a structure, none of it is enforced at the moment. Let&#8217;s correct that.</p>
</div>
<div class="paragraph">
<p>To be able to enable validations declaratively, we will make use of the JSR-303 bean validation libraries. We can add that easily using the <code>spring-boot-starter-validation</code> dependency to our <code>pom.xml</code> file as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>    <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-validation<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can add validations to the command object using the JSR-303 annotations as depicted below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Data</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">javax.validation</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">javax.validation.constraints</span>.*;

<span style="color:#007">@Data</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommand</span> {

    <span style="color:#007">@NotNull</span>
    <span style="color:#088;font-weight:bold">private</span> LCApplicationId id;

    <span style="color:#007">@NotNull</span>
    <span style="color:#088;font-weight:bold">private</span> ClientId clientId;

    <span style="color:#007">@NotNull</span>
    <span style="color:#007">@Valid</span>
    <span style="color:#088;font-weight:bold">private</span> Party applicant;

    <span style="color:#007">@NotNull</span>
    <span style="color:#007">@Valid</span>
    <span style="color:#088;font-weight:bold">private</span> Party beneficiary;

    <span style="color:#007">@NotNull</span>
    <span style="color:#007">@Valid</span>
    <span style="color:#088;font-weight:bold">private</span> AdvisingBank advisingBank;

    <span style="color:#007">@Future</span>
    <span style="color:#088;font-weight:bold">private</span> LocalDate issueDate;

    <span style="color:#007">@Positive</span>
    <span style="color:#088;font-weight:bold">private</span> MonetaryAmount amount;

    <span style="color:#007">@NotBlank</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> merchandiseDescription;
}
</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Most structural validations can be accomplished using the built-in validator annotations. It is also possible to create custom validators for individual fields or to validate the entire object (for example, to validate inter-dependent attributes). For more details on how to do this, please refer to the bean validation specification at <a href="https://beanvalidation.org/2.0/" class="bare">https://beanvalidation.org/2.0/</a> and the reference implementation at <a href="http://hibernate.org/validator/" class="bare">http://hibernate.org/validator/</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="business-rule-enforcements"><a class="anchor" href="#business-rule-enforcements"></a>Business rule enforcements</h4>
<div class="paragraph">
<p>Structural validations can be accomplished using information that is already available in the command. However, there is another class of validations that requires information that is not present in the incoming command itself. This kind of information can be present in one of two places: within the aggregate that we are operating on or outside of the aggregate itself, but made available within the bounded context.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at an example of a validation that requires state present within the aggregate. Consider the example of submitting an LC. While we can make several edits to the LC when it is in draft state, no changes can be made after it is submitted. This means that we can only submit an LC once. This act of submitting the LC is achieved by issuing the <code>SubmitLCApplicationCommand</code> as shown in the artifact from the eventstorming session:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/aggregate-state-validation.png" alt="aggregate state validation">
</div>
<div class="title">Figure 10. Validations during the submit LC process</div>
</div>
<div class="paragraph">
<p>Let&#8217;s begin with a test to express our intent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {
    <span style="color:#777">//..</span>
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldAllowSubmitOnlyInDraftState() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId applicationId = LCApplicationId.randomId();

        fixture.given(<span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(applicationId))            <i class="conum" data-value="1"></i><b>(1)</b>
                .when(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(applicationId))           <i class="conum" data-value="2"></i><b>(2)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(applicationId)); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the <code>LCApplicationCreatedEvent</code> has already occurred&#8201;&#8212;&#8201;in other words, the LC application is already created.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When we try to submit the application by issuing the <code>SubmitLCApplicationCommand</code> for the same application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect the <code>LCApplicationSubmittedEvent</code> to be emitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The corresponding implementation will look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">// ..</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> submit(SubmitLCApplicationCommand command) {
        apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(id));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation above allows us to submit an LC application unconditionally&#8201;&#8212;&#8201;more than once. However, we want to restrict users to be able to submit only once. To be able to do that, we need to remember that the LC application has already been submitted. We can do that in the <code>@EventSourcingHandler</code> of the corresponding events as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">// ..</span>
    <span style="color:#007">@EventSourcingHandler</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationSubmittedEvent event) {
        <span style="color:#950">this</span>.state = State.SUBMITTED; <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When the <code>LCApplicationSubmittedEvent</code> is replayed, we set the state of the <code>LCApplication</code> to <code>SUBMITTED</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While we have remembered that the application has changed to be in <code>SUBMITTED</code> state, we are still not preventing more than one submit attempt. We can fix that by writing a test as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotAllowSubmitOnAnAlreadySubmittedLC() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId applicationId = LCApplicationId.randomId();

        fixture.given(
                <span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(applicationId),           <i class="conum" data-value="1"></i><b>(1)</b>
                <span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(applicationId))         <i class="conum" data-value="1"></i><b>(1)</b>

                .when(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(applicationId))    <i class="conum" data-value="2"></i><b>(2)</b>

                .expectException(AlreadySubmittedException.class)       <i class="conum" data-value="3"></i><b>(3)</b>
                .expectNoEvents();                                      <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>LCApplicationCreatedEvent</code> and <code>LCApplicationSubmittedEvent</code> have already happened&#8201;&#8212;&#8201;which means that the <code>LCApplication</code> has been submitted once.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We now dispatch another <code>SubmitLCApplicationCommand</code> to the system.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect an <code>AlreadySubmittedException</code> to be thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We also expect no events to be emitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation of the command handler to make this work is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">// ..</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> submit(SubmitLCApplicationCommand command) {
        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#950">this</span>.state != State.DRAFT) {                                     <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> AlreadySubmittedException(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC is already submitted!</span><span style="color:#710">&quot;</span></span>);
        }
        apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(id));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note how we are using the state attribute from the <code>LCApplication</code> aggregate to perform the validation. If the application is not in <code>DRAFT</code> state, we fail with the <code>AlreadySubmittedException</code> domain exception.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s also look at an example where information needed to perform the validation is not part of either the command or the aggregate. Let&#8217;s consider the scenario where country regulations prohibit transacting with a set of so called <em>sanctioned</em> countries. Changes to this list of countries may be affected by external factors. Hence it does not make sense to pass this list of sanctioned countries as part of the command payload. Neither does it make sense to maintain it as part of every single aggregate&#8217;s state&#8201;&#8212;&#8201;given that it can change (albeit very infrequently). In such a case, we may want to consider making use of a command handler that is outside the confines of the aggregate class. Thus far, we have only seen examples of <code>@CommandHandler</code> methods within the aggregate. But the <code>@CommandHandler</code> annotation can appear on any other class external to the aggregate. However, in such a case, we need to load the aggregate ourselves. The Axon framework provides a <code>org.axonframework.modelling.command. Repository</code> interface to allow us to do that. It is important to note that this <code>Repository</code> is distinct from spring framework&#8217;s interface that is part of the spring data libraries. An example of how this works is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.modelling.command.Repository</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyCustomCommandHandler</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Repository&lt;LCApplication&gt; repository;                 <i class="conum" data-value="1"></i><b>(1)</b>

    MyCustomCommandHandler(Repository&lt;LCApplication&gt; repository) {
        <span style="color:#950">this</span>.repository = repository;                                   <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> handle(SomeCommand command) {
        Aggregate&lt;LCApplication&gt; application
            = repository.load(command.getAggregateId());                <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#777">// Command handling code</span>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> handle(AnotherCommand command) {
        Aggregate&lt;LCApplication&gt; application
            = repository.load(command.getAggregateId());
        <span style="color:#777">// Command handling code</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We are injecting the Axon <code>Repository</code> to allow us to load aggregates. This was not required previously because the <code>@CommandHandler</code> annotation appeared on aggregate methods directly.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We are using the <code>Repository</code> to load aggregates and work with them. The <code>Repository</code> interface supports other convenience methods to work with aggregates. Please refer to the Axon framework documentation for more usage examples.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Coming back to the sanctioned countries example, let&#8217;s look at how we need to set up the test slightly differently:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommandHandlerTests</span> {
    <span style="color:#088;font-weight:bold">private</span> FixtureConfiguration&lt;LCApplication&gt; fixture;

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> setUp() {
        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctioned = <span style="color:#0a8;font-weight:bold">Set</span>.of(SOKOVIA);
        fixture = <span style="color:#080;font-weight:bold">new</span> AggregateTestFixture&lt;&gt;(LCApplication.class);              <i class="conum" data-value="1"></i><b>(1)</b>

        <span style="color:#088;font-weight:bold">final</span> Repository&lt;LCApplication&gt; repository = fixture.getRepository();   <i class="conum" data-value="2"></i><b>(2)</b>

        CreateLCApplicationCommandHandler handler =
                <span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommandHandler(repository, sanctioned);  <i class="conum" data-value="3"></i><b>(3)</b>
        fixture.registerAnnotatedCommandHandler(handler);                       <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We are creating a new aggregate fixture as usual</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We are using the fixture to obtain an instance of the Axon <code>Repository</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We instantiate the custom command handler passing in the <code>Repository</code> instance. Also note how we inject the collection of sanctioned countries into the handler using simple dependency injection. In real life, this set of sanctioned countries will likely be obtained from external configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We finally need to register the command handler with the fixture, so that it can route commands to this handler as well.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The tests for this look fairly straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommandHandlerTests</span> {
    <span style="color:#777">// ..</span>

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> setUp() {
    <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctioned = <span style="color:#0a8;font-weight:bold">Set</span>.of(SOKOVIA);                            <i class="conum" data-value="1"></i><b>(1)</b>
        fixture = <span style="color:#080;font-weight:bold">new</span> AggregateTestFixture&lt;&gt;(LCApplication.class);

        <span style="color:#088;font-weight:bold">final</span> Repository&lt;LCApplication&gt; repository = fixture.getRepository();

        CreateLCApplicationCommandHandler handler =
                <span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommandHandler(repository, sanctioned);  <i class="conum" data-value="2"></i><b>(2)</b>
        fixture.registerAnnotatedCommandHandler(handler);
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldFailIfBeneficiaryCountryIsSanctioned() {
        fixture.given()
                .when(<span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommand(randomId(), SOKOVIA))      <i class="conum" data-value="3"></i><b>(3)</b>
                .expectNoEvents()
                .expectException(CannotTradeWithSanctionedCountryException.class);
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldCreateIfCountryIsNotSanctioned() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId applicationId = randomId();
        fixture.given()
                .when(<span style="color:#080;font-weight:bold">new</span> CreateLCApplicationCommand(applicationId, WAKANDA))   <i class="conum" data-value="4"></i><b>(4)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(applicationId));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For the purposes of the test, we mark the country <code>SOKOVIA</code> as a <em>sanctioned</em> country. In a more realistic scenario, this will likely come from some form external configuration (e.g. a lookup table or form of external configuration). However, this is appropriate for our unit test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then inject this set of <em>sanctioned countries</em> into the command handler.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the <code>LCApplication</code> is created for the sanctioned country, we expect no events to be emitted and furthermore, the <code>CannotTradeWithSanctionedCountryException</code> exception to be thrown.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally, when the beneficiary belongs to a non-sanctioned country, we emit the <code>LCApplicationCreatedEvent</code> to be emitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation of the command handler is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.stereotype.Service</span>;

<span style="color:#007">@Service</span>                                                         <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CreateLCApplicationCommandHandler</span> {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Repository&lt;LCApplication&gt; repository;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctionedCountries;

    <span style="color:#088;font-weight:bold">public</span> CreateLCApplicationCommandHandler(Repository&lt;LCApplication&gt; repository,
                                             <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctionedCountries) {
        <span style="color:#950">this</span>.repository = repository;
        <span style="color:#950">this</span>.sanctionedCountries = sanctionedCountries;
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> handle(CreateLCApplicationCommand command) {
        <span style="color:#777">// Validations can be performed here as well                </span><i class="conum" data-value="2"></i><b>(2)</b>
        repository.newInstance(()
            -&gt; <span style="color:#080;font-weight:bold">new</span> LCApplication(command, sanctionedCountries)); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mark the class as a <code>@Service</code> to mark it as a component devoid of encapsulated state and enable auto-discovery when using annotation-based configuration or classpath scanning. As such, it can be used to perform any "plumbing" activities.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Do note that the validation for the beneficiary&#8217;s country being sanctioned could have been performed on line 18 as well. Some would argue that this would be ideal because we could avoid a potentially unnecessary invocation of the Axon <code>Repository</code> method if we did that. However, we prefer encapsulating business validations within the confines of the aggregate as much as possible&#8201;&#8212;&#8201;so that we don&#8217;t suffer from the problem of creating an <a href="https://www.martinfowler.com/bliki/AnemicDomainModel.html">anemic domain model</a><sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, the aggregate implementation along with the validation is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
<span style="color:#777">// ...</span>
    <span style="color:#088;font-weight:bold">public</span> LCApplication(CreateLCApplicationCommand command, <span style="color:#0a8;font-weight:bold">Set</span>&lt;Country&gt; sanctioned) {
        <span style="color:#080;font-weight:bold">if</span> (sanctioned.contains(command.getBeneficiaryCountry())) { <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> CannotTradeWithSanctionedCountryException();
        }
        apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationCreatedEvent(command.getId()));
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The validation itself is fairly straightforward. We throw a <code>CannotTradeWithSanctionedCountryException</code> when the validation fails.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the above examples, we looked at different ways to implement the policy enforcements encapsulated within the boundaries the aggregate.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary"><a class="anchor" href="#summary"></a>Summary</h3>
<div class="paragraph">
<p>In this chapter, we used the outputs of the eventstorming session and used it as a primary aid to create a domain model for our bounded context. We looked at how to implement this using the command query responsibility segregation (CQRS) architecture pattern. We looked at persistence options and the implications of using event sourced vs state stored aggregates. Finally, we rounded off by looking at a variety of ways in which to perform business validations. We looked at all this through a set of code examples using Spring boot and the Axon framework.</p>
</div>
<div class="paragraph">
<p>With this knowledge, we should be able to implement robust, well encapsulated, event-driven domain models. In the next chapter, we will look at implementing a user interface for these domain capabilities and examine a few options such as CRUD-based vs task-based UIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="questions"><a class="anchor" href="#questions"></a>Questions</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Can you examine the eventstorming session artifact from the last chapter, and identify the possible aggregates that would be required?</p>
</li>
<li>
<p>In your problem domain, can you determine the right approach for persisting aggregates? What are the reasons for choosing one approach over the other?</p>
</li>
<li>
<p>Based on your current understanding, would you apply CQRS architecture pattern in your solution? And how would you justify the choice to your team ?</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="further-reading"><a class="anchor" href="#further-reading"></a>Further reading</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CQRS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/bliki/CQRS.html" class="bare">https://martinfowler.com/bliki/CQRS.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bootiful CQRS and Event Sourcing with Axon Framework</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SpringDeveloper and Allard Buijze</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.youtube.com/watch?v=7e5euKxHhTE" class="bare">https://www.youtube.com/watch?v=7e5euKxHhTE</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Log: What every software engineer should know about real-time data&#8217;s unifying abstraction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jay Kreps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying" class="bare">https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event Sourcing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://martinfowler.com/eaaDev/EventSourcing.html" class="bare">https://martinfowler.com/eaaDev/EventSourcing.html</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using a DDD Approach for Validating Business Rules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fabian Lopez</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.infoq.com/articles/ddd-business-rules/" class="bare">https://www.infoq.com/articles/ddd-business-rules/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anemic Domain Model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Fowler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.martinfowler.com/bliki/AnemicDomainModel.html" class="bare">https://www.martinfowler.com/bliki/AnemicDomainModel.html</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="answers"><a class="anchor" href="#answers"></a>Answers</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Refer to section <a href="#_identifying_aggregates">Identifying aggregates</a></p>
</li>
<li>
<p>Refer to section <a href="#_persisting_aggregates">Persisting aggregates</a>, note down the pros and cons of state stored and event sourced approach, and discuss the reasons for your choice with your teammates.</p>
</li>
<li>
<p>Refer to section <a href="#_when_to_use_cqrs">[_when_to_use_cqrs]</a> to list down the advantages of the approach versus the traditional approach.  Share the reasoning with your teammates.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://ordina-jworks.github.io/domain-driven%20design/2016/02/02/A-Decade-Of-DDD-CQRS-And-Event-Sourcing.html" class="bare">https://ordina-jworks.github.io/domain-driven%20design/2016/02/02/A-Decade-Of-DDD-CQRS-And-Event-Sourcing.html</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="http://axonframework.org/" class="bare">http://axonframework.org/</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://www.lagomframework.com/" class="bare">https://www.lagomframework.com/</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. <a href="https://eventuate.io/" class="bare">https://eventuate.io/</a>
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. <a href="https://www.eventstore.com/" class="bare">https://www.eventstore.com/</a>
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. <a href="https://axoniq.io/product-overview/axon-server" class="bare">https://axoniq.io/product-overview/axon-server</a>
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. <a href="https://www.martinfowler.com/bliki/AnemicDomainModel.html" class="bare">https://www.martinfowler.com/bliki/AnemicDomainModel.html</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.0-SNAPSHOT<br>
Last updated 2022-07-04 13:07:13 UTC
</div>
</div>
</body>
</html>