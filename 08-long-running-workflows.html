<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Long-Running Workflows</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#long-running-workflows">Long-Running Workflows</a>
<ul class="sectlevel2">
<li><a href="#technical-requirements">Technical requirements</a></li>
<li><a href="#continuing-our-design-journey">Continuing our design journey</a></li>
<li><a href="#implementing-sagas">Implementing sagas</a>
<ul class="sectlevel3">
<li><a href="#orchestration">Orchestration</a></li>
<li><a href="#choreography">Choreography</a></li>
</ul>
</li>
<li><a href="#handling-deadlines">Handling deadlines</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#questions">Questions</a></li>
<li><a href="#further-reading">Further reading</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1 text-justify">
<h2 id="long-running-workflows"><a class="anchor" href="#long-running-workflows"></a>Long-Running Workflows</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
In the long run, the pessimist may be proven right, but the optimist has a better time on the trip.
</blockquote>
<div class="attribution">
&#8212; Daniel Reardon
</div>
</div>
<div class="paragraph">
<p>In the previous chapters, we have looked at handling commands and queries within the context of a single aggregate. All the scenarios we have looked at thus far, have been limited to a single interaction. However, not all capabilities can be implemented in the form of a simple request-response interaction, requiring coordination across multiple external systems or human-centric operations or both. In other cases, there may be a need to react to triggers that are nondeterministic (occur conditionally or not at all) and/or be time-bound (based on a deadline). This may require managing business transactions across multiple bounded contexts that may run over a long duration of time, while continuing to maintain consistency (<strong>saga</strong>).</p>
</div>
<div class="paragraph">
<p>There are at least two common patterns to implement the saga pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Explicit orchestration</strong>: A designated component acts as a centralized coordinator&#8201;&#8212;&#8201;where the system relies on the coordinator to react to domain events to manage the flow.</p>
</li>
<li>
<p><strong>Implicit choreography</strong>: No single component is required to act as a centralized coordinator&#8201;&#8212;&#8201;where the components simply react to domain events in other components to manage the flow.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By the end of this chapter, you will have learned how to implement sagas using both techniques. You will also have learnt how to work with deadlines when no explicit events occur within the system. You will finally be able to appreciate when/whether to choose an explicit orchestrator or simply stick to implicit choreography without resorting to the use of potentially expensive distributed transactions.</p>
</div>
<div class="sect2">
<h3 id="technical-requirements"><a class="anchor" href="#technical-requirements"></a>Technical requirements</h3>
<div class="paragraph">
<p>To follow the examples in this chapter, you will need access to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 1.8+ (We have used Java 17 to compile sample sources)</p>
</li>
<li>
<p>Spring Boot 2.4.x</p>
</li>
<li>
<p>Axon framework 4.5.3</p>
</li>
<li>
<p>JUnit 5.7.x (Included with spring boot)</p>
</li>
<li>
<p>Project Lombok (To reduce verbosity)</p>
</li>
<li>
<p>Maven 3.x</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please refer to the ch08 directory of the book&#8217;s accompanying source code repository for complete working examples.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="continuing-our-design-journey"><a class="anchor" href="#continuing-our-design-journey"></a>Continuing our design journey</h3>
<div class="paragraph">
<p>In <a href="#_domain_analysis_and_modeling">Chapter 4 - Domain analysis and modeling</a>, we discussed eventstorming as a lightweight method to clarify business flows. As a reminder, this is the output produced from our eventstorming session:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/sagas/event-storming-auto-approval-saga.png" alt="event storming auto approval saga">
</div>
<div class="title">Figure 1. Recap of eventstorming session</div>
</div>
<div class="paragraph">
<p>As depicted in the visual above, some aspects of Letter of Credit (LC) application processing happens outside our current bounded context), before the trade finance manager makes a decision to either approve or decline the application as listed here:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Product value is validated</p>
</li>
<li>
<p>Product legality is validated</p>
</li>
<li>
<p>Applicant&#8217;s credit worthiness is validated</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Currently, the final approval is a manual process. It is pertinent to note that the product value and legality checks happen as part of the work done by the product analysis department, whereas applicant credit worthiness checks happens in the credit analysis department. Both departments make use of their own systems to perform these functions and notify us through the respective events. An LC application is <strong>not ready</strong> to either be approved or declined until <strong>each</strong> of these checks are completed. Each of these processes happen mostly independently of the other and may take a nondeterministic amount of time (typically in the order of a few days). After these checks have happened, the trade finance manager manually reviews the application and makes the final decision.</p>
</div>
<div class="paragraph">
<p>Given the growing volumes of LC applications received, the bank is looking to introduce a process optimization to automatically approve applications with an amount below a certain threshold (<strong>USD 10,000</strong> at this time). The business has deemed that the three checks above are sufficient and that no further human intervention is required when approving such applications.</p>
</div>
<div class="paragraph">
<p>From an overall system perspective, it is pertinent to note that the product analyst system notifies us through the <code>ProductValueValidatedEvent</code> and <code>ProductLegalityValidatedEvent</code>, whereas the credit analyst system does the same through the <code>ApplicantCreditValidatedEvent</code> event. Each of these events can and indeed happen independently of the other. For us to be able to auto-approve applications our solution needs to wait for all of these events to occur. Once these events have occurred, we need to examine the outcome of each of these events to finally make a decision.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this context, we are using the term <strong><em>long-running</em></strong> to denote a complex business process that takes several steps to complete. As these steps occur, the process transitions from one state to another. In other words, we are referring to a <a href="https://en.wikipedia.org/wiki/state_machine"><strong>state machine</strong></a><sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>. This is not to be confused with a long-running software process (for example, a complex SQL query or an image processing routine) that is computationally intensive.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As is evident from the diagram above, the LC auto-approval functionality is an example of a long-running business process where <em>some thing</em> in our system needs to keep track of the fact that these independent events have occurred before proceeding further.  Such functionality can be implemented using the saga pattern. Let&#8217;s look at how we can do this.</p>
</div>
</div>
<div class="sect2">
<h3 id="implementing-sagas"><a class="anchor" href="#implementing-sagas"></a>Implementing sagas</h3>
<div class="paragraph">
<p>Before we delve into how we can implement this auto-approval functionality, let&#8217;s take a look at how this works from a logical perspective as shown here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/sagas/auto-approval-saga-logical.png" alt="auto approval saga logical">
</div>
<div class="title">Figure 2. Auto-approval process&#8201;&#8212;&#8201;logical view</div>
</div>
<div class="paragraph">
<p>As is depicted in the visual above, there are three bounded contexts in play:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>LC Application (the bounded context we have been implementing thus far)</p>
</li>
<li>
<p>The Applicant bounded context</p>
</li>
<li>
<p>The Product bounded context</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The flow gets triggered when the LC application is submitted. This in turn sets in motion three independent functions that establish the:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Value of the product being transacted</p>
</li>
<li>
<p>Legality of the product being transacted</p>
</li>
<li>
<p>Credit worthiness of the applicant</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>LC approval can proceed only after <strong>all</strong> of these functions have completed. Furthermore, to <strong>auto-approve</strong>, all of these checks have to complete <strong>favorably</strong> and as mentioned earlier, the LC amount has to be lesser than the <strong>USD 10000</strong> threshold.</p>
</div>
<div class="paragraph">
<p>As shown in the event storming artifact, the <code>LC Application</code> aggregate is able to handle an <code>ApproveLCApplicationCommand</code>, which results in a LCApplicationApprovedEvent`. To auto-approve, this command needs to be invoked automatically when all the conditions mentioned earlier are satisfied. We are building an event-driven system, and we can see that each of these validations produce events when their respective actions complete. There are at least two ways to implement this functionality:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Orchestration</strong>: where a single component in the system coordinates the state of the flow and triggers subsequent actions as necessary.</p>
</li>
<li>
<p><strong>Choreography</strong>: where actions in the flow are triggered without requiring an explicit coordinating component.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s examine these methods in more detail:</p>
</div>
<div class="sect3">
<h4 id="orchestration"><a class="anchor" href="#orchestration"></a>Orchestration</h4>
<div class="paragraph">
<p>When implementing sagas using an orchestrating component, the system looks similar to the one depicted here:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/sagas/auto-approval-saga-orchestrator.png" alt="auto approval saga orchestrator">
</div>
<div class="title">Figure 3. Saga implementation using an orchestrator</div>
</div>
<div class="paragraph">
<p>The orchestrator starts tracking the flow when the LC application is submitted. It will then need to wait for each of the <code>ProductValueValidatedEvent</code>, <code>ProductLegalityValidatedEvent</code> and <code>ApplicantCreditValidatedEvent</code> events to occur and decide if it is appropriate to trigger the <code>ApproveLCApplicationCommand</code>. Finally, the saga lifecycle ends unconditionally when the LC application is approved. There are other conditions that may cause the saga to end abruptly. We will examine those scenarios in detail later. It is pertinent to note that there will be a <strong>distinct</strong> auto-approval saga instance for each LC application that gets submitted. Let&#8217;s look at how to implement this functionality using the Axon framework. As usual, let&#8217;s test drive this functionality that a new auto approval saga instance is created when an LC application is submitted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.test.saga.FixtureConfiguration</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.test.saga.SagaTestFixture</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSagaTests</span> {

    <span style="color:#088;font-weight:bold">private</span> FixtureConfiguration fixture;                                       <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@BeforeEach</span>
    <span style="color:#339;font-weight:bold">void</span> setUp() {
        fixture = <span style="color:#080;font-weight:bold">new</span> SagaTestFixture&lt;&gt;(AutoApprovalSaga.class);                <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldStartSagaOnSubmit() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId lcApplicationId = LCApplicationId.randomId();
        fixture.givenNoPriorActivity()                                          <i class="conum" data-value="2"></i><b>(2)</b>
                .whenPublishingA(                                               <i class="conum" data-value="3"></i><b>(3)</b>
                        <span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(lcApplicationId,
                            AUTO_APPROVAL_THRESHOLD_AMOUNT
                               .subtract(ONE_DOLLAR)))
                .expectActiveSagas(<span style="color:#00D">1</span>);                                          <i class="conum" data-value="4"></i><b>(4)</b>
    }

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We make use of the Axon provided <code>FixtureConfiguration</code> and <code>SagaTestFixture</code> that allow us to test saga functionality.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Given no prior activity has occurred (from the perspective of the saga)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When a <code>LCApplicationSubmittedEvent</code> is published</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We expect one active saga to exist</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation to make this test pass looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.modelling.saga.SagaEventHandler</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.modelling.saga.StartSaga</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.spring.stereotype.Saga</span>;

<span style="color:#007">@Saga</span>                                                          <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSaga</span> {

    <span style="color:#007">@SagaEventHandler</span>(associationProperty = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">lcApplicationId</span><span style="color:#710">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#007">@StartSaga</span>                                                 <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationSubmittedEvent event) {
        <span style="color:#777">//</span>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When working with Axon and Spring, the orchestrator is annotated with the <code>@Saga</code> annotation to mark it as a spring bean. In order to track each submitted LC application, the <code>@Saga</code> annotation is prototype-scoped (as opposed to singleton-scoped), to allow creation of multiple saga instances. Please refer to the Axon and Spring documentation for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The saga listens to the <code>LCApplicationSubmittedEvent</code> to keep track of the flow (as denoted by the <code>@SagaEventHandler</code> annotation). Conceptually, the <code>@SagaEventHandler</code> annotation is very similar to the <code>@EventHandler</code> annotation that we discussed previously in <a href="#_creating_the_query_model">Chapter 7</a>. However, the <code>@SagaEventHandler</code> annotation is used specifically for event listeners within a saga. The <code>associationProperty</code> attribute on the <code>@SagaEventHandler</code> annotation causes this event handler method to get invoked only for the saga with matching value of the <code>lcApplicationId</code> attribute in the event payload. Also, the <code>@SagaEventHandler</code> is a transaction boundary. Every time such a method completes successfully, the Axon framework commits a transaction, thereby allowing it to keep track of state stored in the saga. We will look at this in more detail shortly.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Every saga needs to have at least one <code>@SagaEventHandler</code> method that is also annotated with the <code>@StartSaga</code> annotation to denote the beginning of the saga.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have a requirement that an LC cannot be auto-approved if its amount exceeds the threshold (USD 10000 in our case). The test for this scenario looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSagaTests</span> {
    <span style="color:#777">//...</span>

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldEndSagaImmediatelyIfAmountGreaterThanAutoApprovalThreshold() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId lcApplicationId = LCApplicationId.randomId();
        fixture.givenAggregate(lcApplicationId.toString()).published()
                .whenPublishingA(
                        <span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(lcApplicationId,
                            AUTO_APPROVAL_THRESHOLD_AMOUNT.add(ONE_DOLLAR))) <i class="conum" data-value="1"></i><b>(1)</b>
                .expectActiveSagas(<span style="color:#00D">0</span>);                                       <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When the LC amount exceeds the auto approval threshold amount</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We expect no active sagas to exist for that LC</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation to satisfy this condition looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.modelling.saga.SagaLifecycle</span>;

<span style="color:#007">@Saga</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSaga</span> {

    <span style="color:#007">@SagaEventHandler</span>(associationProperty = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">lcApplicationId</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#007">@StartSaga</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(LCApplicationSubmittedEvent event) {
        <span style="color:#080;font-weight:bold">if</span> (AUTO_APPROVAL_THRESHOLD_AMOUNT.isLessThan(event.getAmount())) { <i class="conum" data-value="1"></i><b>(1)</b>
            SagaLifecycle.end();                                            <i class="conum" data-value="2"></i><b>(2)</b>
        }
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We check for the condition of the LC amount being greater than the threshold amount</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If so, we end the saga using the framework provided <code>SagaLifecycle.end()</code> method. Here we end the saga programmatically. It is also possible to declaratively end the saga as well using the <code>@EndSaga</code> annotation when the <code>LCApplicationApprovedEvent</code> occurs. Please refer to the full code examples included with this chapter for more information.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We need to auto-approve the saga if all of <code>ApplicantCreditValidatedEvent</code>, <code>ProductLegalityValidatedEvent</code> and <code>ProductValueValidatedEvent</code> have occurred successfully. The test to verify this functionality is shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSagaTests</span> {

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldAutoApprove() {
        <span style="color:#777">// Initialization code removed for brevity</span>

        fixture.givenAggregate(lcApplicationId.toString())
            .published(submitted, legalityValidated, valueValidated)        <i class="conum" data-value="1"></i><b>(1)</b>
                .whenPublishingA(applicantValidated)                        <i class="conum" data-value="2"></i><b>(2)</b>
                .expectActiveSagas(<span style="color:#00D">1</span>)                                       <i class="conum" data-value="3"></i><b>(3)</b>
                .expectDispatchedCommands(
                        <span style="color:#080;font-weight:bold">new</span> ApproveLCApplicationCommand(lcApplicationId));  <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the LC application has been submitted and the <code>ProductValueValidatedEvent</code> and the <code>ProductLegalityValidatedEvent</code> have occurred successfully.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When the <code>ApplicantCreditValidatedEvent</code> is published</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect one active saga instance AND</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We expect the <code>ApproveLCApplicationCommand</code> to be dispatched for that LC</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation for this looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSaga</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> productValueValidated;                              <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> productLegalityValidated;                           <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">boolean</span> applicantValidated;                                 <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#007">@Autowired</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">transient</span> CommandGateway gateway;                           <i class="conum" data-value="2"></i><b>(2)</b>

    <span style="color:#777">// Other event handlers omitted for brevity</span>

    <span style="color:#007">@SagaEventHandler</span>(associationProperty = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">lcApplicationId</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(ApplicantCreditValidatedEvent event) {               <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="color:#080;font-weight:bold">if</span> (event.getDecision().isRejected()) {                         <i class="conum" data-value="4"></i><b>(4)</b>
            SagaLifecycle.end();
        } <span style="color:#080;font-weight:bold">else</span> {
            <span style="color:#950">this</span>.applicantValidated = <span style="color:#069">true</span>;                             <i class="conum" data-value="5"></i><b>(5)</b>
            <span style="color:#080;font-weight:bold">if</span> (productValueValidated &amp;&amp; productLegalityValidated) {    <i class="conum" data-value="6"></i><b>(6)</b>
                LCApplicationId id = event.getLcApplicationId();
                gateway.send(ApproveLCApplicationCommand.with(id));     <i class="conum" data-value="7"></i><b>(7)</b>
            }
        }
    }

    <span style="color:#777">// Other event handlers omitted for brevity</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As mentioned previously, sagas can maintain state. In this case, we are maintaining three boolean variables, each to denote the occurrence of the respective event.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We have declared the Axon <code>CommandGateway</code> as a <code>transient</code> member because we need it to dispatch commands, but not be persisted along with other saga state.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This event handler intercepts the <code>ApplicantCreditValidatedEvent</code> for the specific LC application (as denoted by the <code>associationProperty</code> in the @SagaEventHandler annotation).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the decision from the <code>ApplicantCreditValidatedEvent</code> is rejected, we end the saga immediately.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Otherwise, we <em>remember</em> the fact that the applicant&#8217;s credit has been validated.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We then check to see if the product&#8217;s value and legality have already been validated.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If so, we issue the command to auto-approve the LC.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The logic in the <code>ProductValueValidatedEvent</code> and <code>ProductLegalityValidatedEvent</code> is very similar to that in the saga event handler for the <code>ApplicantCreditValidatedEvent</code>. We have omitted it here for brevity. Please refer to the source code for this chapter for the full example along with the tests.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, we can end the saga when we receive the LCApplicationApprovedEvent for this application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AutoApprovalSagaTests</span> {
    <span style="color:#007">@Test</span>
    <span style="color:#007">@DisplayName</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">should end saga after auto approval</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#339;font-weight:bold">void</span> shouldEndSagaAfterAutoApproval() {
        <span style="color:#777">// Initialization code omitted for brevity</span>

        fixture.givenAggregate(lcApplicationId.toString())
                .published(
                    submitted, applicantValidated,
                    legalityValidated, valueValidated)                             <i class="conum" data-value="1"></i><b>(1)</b>
                .whenPublishingA(<span style="color:#080;font-weight:bold">new</span> LCApplicationApprovedEvent(lcApplicationId))  <i class="conum" data-value="2"></i><b>(2)</b>
                .expectActiveSagas(<span style="color:#00D">0</span>)                                              <i class="conum" data-value="3"></i><b>(3)</b>
                .expectNoDispatchedCommands();                                     <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the LC has been submitted and all the validations have been completed successfully.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When a <code>LCApplicationApprovedEvent</code> is published.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect zero active sagas to be running.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we also expect to not dispatch any commands.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have looked at how to implement sagas using an orchestrator, let&#8217;s examine some design decisions that we may need to consider when working with them.</p>
</div>
<div class="sect4">
<h5 id="pros"><a class="anchor" href="#pros"></a>Pros</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Complex workflows</strong>: Having an explicit orchestrator can be very helpful when dealing with flows that involve multiple participants and have a lot of conditionals because the orchestrator can keep track of the overall progress in a fine-grained manner.</p>
</li>
<li>
<p><strong>Testing</strong>: As we have seen in the implementation above, testing flow logic in isolation is relatively straightforward.</p>
</li>
<li>
<p><strong>Debugging</strong>: Given that we have a single coordinator, debugging the current state of the flow can be relatively easier.</p>
</li>
<li>
<p><strong>Handling exceptions</strong>: Given that the orchestrator has fine-grained control of the flow, recovering gracefully from exceptions can be easier.</p>
</li>
<li>
<p><strong>System knowledge</strong>: Components in different bounded contexts do not need to have knowledge of each other&#8217;s internals (e.g. commands and events) to progress the flow.</p>
</li>
<li>
<p><strong>Cyclic dependencies</strong>: Having a central coordinator allows avoiding accidental cyclic dependencies between components.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cons"><a class="anchor" href="#cons"></a>Cons</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Single point of failure</strong>: From an operational perspective, orchestrators can become single points of failure because they are the only ones that have knowledge of the flow. This means that these components need to exhibit higher resilience characteristics as compared to other components.</p>
</li>
<li>
<p><strong>Leaking of domain logic</strong>: In an ideal world, the aggregate will remain the custodian of all domain logic. Given that the orchestrator is also stateful, business logic may inadvertently shift to the orchestrator. Care should be taken to ensure that the orchestrator only has flow-control logic while business invariants remains within the confines of the aggregate.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The above implementation should give you a good idea of how to implement a saga orchestrator. Now let&#8217;s look at how we can do this without the use of an explicit orchestrator.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="choreography"><a class="anchor" href="#choreography"></a>Choreography</h4>
<div class="paragraph">
<p>Saga orchestrators keep track of the current state of the flow, usually making use of some kind of data store. Another way to implement this functionality is without using any stateful component. Logically, this looks like the setup shown in the diagram here:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/sagas/auto-approval-saga-choreography.png" alt="Saga implementation using choreography">
</div>
<div class="title">Figure 4. Saga implementation using choreography</div>
</div>
<div class="paragraph">
<p>As you can see, there is no single component that tracks the saga lifecycle. However, to make the auto-approval decision, each of these stateless event handlers need to have knowledge of the same three events having occurred:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Product value is validated</p>
</li>
<li>
<p>Product legality is validated</p>
</li>
<li>
<p>Applicant&#8217;s credit worthiness is validated</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Given that the event listeners themselves are stateless, there are at least two ways to provide this information to them:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each of the events carry this information in their respective payloads.</p>
</li>
<li>
<p>The event listeners query the source systems (in this case, the product and applicant bounded contexts respectively).</p>
</li>
<li>
<p>The LC application bounded context maintains a query model to keep track of these events having occurred.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Just like in the orchestrator example, when all events have occurred and the LC amount is below the specified threshold, these event listeners can issue the <code>ApproveLCApplicationCommand</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We will skip covering code examples for the choreography implementation because this is no different from the material we have covered previously in this and prior chapters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have looked at how to implement the choreography style of sagas, let&#8217;s examine some design decisions that we may need to consider when working with them.</p>
</div>
<div class="sect4">
<h5 id="pros-2"><a class="anchor" href="#pros-2"></a>Pros</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Simple workflows</strong>: For simple flows, the choreography approach can be relatively straightforward because it does not require the overhead of an additional coordinating component.</p>
</li>
<li>
<p><strong>No single points of failure</strong>: From an operational perspective, there is one less  high resilience component to worry about.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="cons-2"><a class="anchor" href="#cons-2"></a>Cons</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Workflow tracking</strong>: Especially with complex workflows that involve numerous steps and conditionals, tracking and debugging the current state of the flow may become challenging.</p>
</li>
<li>
<p><strong>Cyclic dependencies</strong>: It is possible to inadvertently introduce cyclic dependencies among components when workflows become gnarly.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sagas enable applications to maintain data and transactional consistency when more than one bounded context is required to complete the business functionality without having to resort to using <a href="https://en.wikipedia.org/wiki/Distributed_transaction"><em>distributed transactions</em></a><sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>. However, it does introduce a level of complexity to the programming model, especially when it comes to handling failures. We will look at exception handling in a lot more detail when we discuss working with distributed systems in upcoming chapters. Let&#8217;s look at how to progress flows when there are no explicit stimuli by looking at how deadlines work.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="handling-deadlines"><a class="anchor" href="#handling-deadlines"></a>Handling deadlines</h3>
<div class="paragraph">
<p>Thus far, we have looked at events that are caused by human (for example, the applicant submitting an LC application) or system (for example, the auto-approval of an LC application) action. However, in an event-driven system, not all events occur due to an explicit human or system stimulus. Events may need to be emitted either due to inactivity over a period of time, or on a recurring schedule based on prevailing conditions.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s examine the case where the bank needs <em>submitted LC applications</em> to be decisioned as quickly as possible. When applications are not acted upon by the trade finance managers within ten calendar days, the system should send them reminders.</p>
</div>
<div class="paragraph">
<p>To deal with such inactivity, we need a means to trigger system action (read&#8201;&#8212;&#8201;emit events) based on the passage of time&#8201;&#8212;&#8201;in other words, perform actions when a <em>deadline</em> expires. In a happy path scenario, we expect either the user or the system to take certain action. In such cases, we will also need to account for cases we will need to cancel the trigger scheduled to occur on deadline expiry. Let&#8217;s look at how to test-drive this functionality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldCreateSubmissionReminderDeadlineWhenApplicationIsSubmitted() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId id = LCApplicationId.randomId();
        fixture.given(<span style="color:#080;font-weight:bold">new</span> LCApplicationStartedEvent(id, ApplicantId.randomId(),
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My LC</span><span style="color:#710">&quot;</span></span>, LCState.DRAFT),
                        <span style="color:#080;font-weight:bold">new</span> LCAmountChangedEvent(id, THOUSAND_DOLLARS),
                        <span style="color:#080;font-weight:bold">new</span> MerchandiseChangedEvent(id, merchandise()))

                .when(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(id)) <i class="conum" data-value="1"></i><b>(1)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(id,
                                THOUSAND_DOLLARS))

                .expectScheduledDeadlineWithName(
                        <span style="color:#0a8;font-weight:bold">Duration</span>.ofDays(<span style="color:#00D">10</span>),
                        LC_APPROVAL_PENDING_REMINDER);    <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When the LC application is submitted</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We expect a deadline for the reminder to be scheduled</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation for this is fairly straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.deadline.DeadlineManager</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(SubmitLCApplicationCommand command,
                    DeadlineManager deadlineManager) { <i class="conum" data-value="1"></i><b>(1)</b>
        assertPositive(amount);
        assertMerchandise(merchandise);
        assertInDraft(state);
        apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationSubmittedEvent(id, amount));

        deadlineManager.schedule(<span style="color:#0a8;font-weight:bold">Duration</span>.ofDays(<span style="color:#00D">10</span>),  <i class="conum" data-value="2"></i><b>(2)</b>
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC_APPROVAL_REMINDER</span><span style="color:#710">&quot;</span></span>,
            LCApprovalPendingNotification.first(id));  <i class="conum" data-value="3"></i><b>(3)</b>
    }
    <span style="color:#777">//...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To allow working with deadlines, the Axon framework provides a <code>DeadlineManager</code> that allows working with deadlines. This is injected into the command handler method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use the <code>deadlineManager</code> to schedule a named deadline (<code>"LC_APPROVAL_REMINDER"</code> in this case) that will expire in 10 days.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the deadline is met, it will result in a <code>LCApprovalPendingNotification</code> which can be handled just like a command. Except in this case, the behavior is triggered by the passage of time.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If no action is taken for ten days, this is what we expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldTriggerApprovalPendingEventTenDaysAfterSubmission() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId id = LCApplicationId.randomId();
        fixture.given(<span style="color:#080;font-weight:bold">new</span> LCApplicationStartedEvent(id, ApplicantId.randomId(),
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My LC</span><span style="color:#710">&quot;</span></span>, LCState.DRAFT),
                        <span style="color:#080;font-weight:bold">new</span> LCAmountChangedEvent(id, THOUSAND_DOLLARS),
                        <span style="color:#080;font-weight:bold">new</span> MerchandiseChangedEvent(id, merchandise()))
                .andGivenCommands(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(id)) <i class="conum" data-value="1"></i><b>(1)</b>
                .whenThenTimeElapses(<span style="color:#0a8;font-weight:bold">Duration</span>.ofDays(<span style="color:#00D">10</span>))             <i class="conum" data-value="2"></i><b>(2)</b>
                .expectDeadlinesMet(
                        LCApprovalPendingNotification.first(id))      <i class="conum" data-value="3"></i><b>(3)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApprovalPendingEvent(id));        <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the LC application is submitted.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When the period of ten days elapses.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The deadline should be met.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And the <code>LCApprovalPendingEvent</code> should be emitted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how to implement this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td>
  <td class="code"><pre><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.axonframework.deadline.annotation.DeadlineHandler</span>;

<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {

    <span style="color:#007">@DeadlineHandler</span>(deadlineName = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC_APPROVAL_REMINDER</span><span style="color:#710">&quot;</span></span>)       <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(LCApprovalPendingNotification notification) {  <i class="conum" data-value="2"></i><b>(2)</b>

        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApprovalPendingEvent(id)); <i class="conum" data-value="3"></i><b>(3)</b>

    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Deadlines are handled by annotating handler methods with the <code>@DeadlineHandler</code> annotation. Note that the same deadline name used previously is being referenced here.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the deadline handler method and uses the same payload that was passed along when it was scheduled.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We emit the <code>LCApprovalPendingEvent</code> when the deadline expires.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The deadline handling logic should only be triggered if no action is taken. However, if the LC is either approved or rejected within a duration of ten days, none of this behavior should be triggered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplicationAggregateTests</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotTriggerPendingReminderIfApplicationIsApprovedWithinTenDays() {
        <span style="color:#088;font-weight:bold">final</span> LCApplicationId id = LCApplicationId.randomId();
        fixture.given(<span style="color:#080;font-weight:bold">new</span> LCApplicationStartedEvent(id, ApplicantId.randomId(),
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">My LC</span><span style="color:#710">&quot;</span></span>, LCState.DRAFT),
                        <span style="color:#080;font-weight:bold">new</span> LCAmountChangedEvent(id, THOUSAND_DOLLARS),
                        <span style="color:#080;font-weight:bold">new</span> MerchandiseChangedEvent(id, merchandise()))
                .andGivenCommands(<span style="color:#080;font-weight:bold">new</span> SubmitLCApplicationCommand(id)) <i class="conum" data-value="1"></i><b>(1)</b>

                .when(<span style="color:#080;font-weight:bold">new</span> ApproveLCApplicationCommand(id))            <i class="conum" data-value="2"></i><b>(2)</b>
                .expectEvents(<span style="color:#080;font-weight:bold">new</span> LCApplicationApprovedEvent(id))
                .expectNoScheduledDeadlines();                        <i class="conum" data-value="3"></i><b>(3)</b>
    }

    <span style="color:#007">@Test</span>
    <span style="color:#339;font-weight:bold">void</span> shouldNotTriggerPendingReminderIfApplicationIsDeclinedWithinTenDays() {
        <span style="color:#777">// Test code is very similar. Excluded for brevity</span>
    }

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given that the LC application is submitted</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When it is approved within a duration of ten days (in this case, almost immediately)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We expect no scheduled deadlines</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the implementation for this looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LCApplication</span> {
    <span style="color:#777">//...</span>
    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(ApproveLCApplicationCommand command,
                   DeadlineManager deadlineManager) {
        assertInSubmitted(state);
        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationApprovedEvent(id));
        deadlineManager.cancelAllWithinScope(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC_APPROVAL_REMINDER</span><span style="color:#710">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#007">@CommandHandler</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> on(DeclineLCApplicationCommand command,
                   DeadlineManager deadlineManager) {
        assertInSubmitted(state);
        AggregateLifecycle.apply(<span style="color:#080;font-weight:bold">new</span> LCApplicationDeclinedEvent(id));
        deadlineManager.cancelAllWithinScope(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LC_APPROVAL_REMINDER</span><span style="color:#710">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span style="color:#777">//...</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We cancel all the deadlines with the name <code>LC_APPROVAL_REMINDER</code> (in this case, we only have one deadline with that name) within the scope of this aggregate.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="summary"><a class="anchor" href="#summary"></a>Summary</h3>
<div class="paragraph">
<p>In this chapter, we examined how to work with long-running workflows using sagas and the different styles we can use to implement them. We also looked at the implications of using explicit orchestration versus implicit choreography. We finally looked at how we can handle deadlines when there are no user-initiated actions.</p>
</div>
<div class="paragraph">
<p>You should have learnt how sagas can act as a first-class citizen in addition to aggregates when designing a system that makes use of domain-driven design principles.</p>
</div>
<div class="paragraph">
<p>In the next chapter, we will look at how we can interact with external systems while respecting bounded context boundaries between core and peripheral systems.</p>
</div>
</div>
<div class="sect2">
<h3 id="questions"><a class="anchor" href="#questions"></a>Questions</h3>
<div class="ulist">
<ul>
<li>
<p>Are you seeing the need to implement long-running workflows in your current ecosystem?</p>
</li>
<li>
<p>Do you see yourself picking one style over the other most of the time?</p>
</li>
<li>
<p>Are you using external deadline handlers (for instance, batch jobs) in your existing systems as opposed to embedding time-based logic in the core?</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="further-reading"><a class="anchor" href="#further-reading"></a>Further reading</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 35.7142%;">
<col style="width: 21.4285%;">
<col style="width: 42.8573%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Title</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saga persistence and event-driven architectures</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Udi Dahan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://udidahan.com/2009/04/20/saga-persistence-and-event-driven-architectures/" class="bare">https://udidahan.com/2009/04/20/saga-persistence-and-event-driven-architectures/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sagas solve stupid transaction timeouts</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Udi Dahan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://udidahan.com/2008/06/23/sagas-solve-stupid-transaction-timeouts/" class="bare">https://udidahan.com/2008/06/23/sagas-solve-stupid-transaction-timeouts/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microservices&#8201;&#8212;&#8201;when to react vs. orchestrate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Andrew Bonham</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://medium.com/capital-one-tech/microservices-when-to-react-vs-orchestrate-c6b18308a14c" class="bare">https://medium.com/capital-one-tech/microservices-when-to-react-vs-orchestrate-c6b18308a14c</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saga orchestration for microservices using the outbox pattern</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gunnar Morling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.infoq.com/articles/saga-orchestration-outbox/" class="bare">https://www.infoq.com/articles/saga-orchestration-outbox/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Patterns for distributed transactions within a microservices architecture</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keyang Xiang</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://developers.redhat.com/blog/2018/10/01/patterns-for-distributed-transactions-within-a-microservices-architecture" class="bare">https://developers.redhat.com/blog/2018/10/01/patterns-for-distributed-transactions-within-a-microservices-architecture</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://en.wikipedia.org/wiki/state_machine" class="bare">https://en.wikipedia.org/wiki/state_machine</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://en.wikipedia.org/wiki/Distributed_transaction" class="bare">https://en.wikipedia.org/wiki/Distributed_transaction</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.0-SNAPSHOT<br>
Last updated 2022-05-11 22:13:27 UTC
</div>
</div>
</body>
</html>